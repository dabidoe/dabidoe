<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Features Test - Character Foundry</title>
  <style>
    :root {
      --surface-color: #1a1a1a;
      --background-color: #0f0f0f;
      --border-color: #333;
      --accent-color: #4a90e2;
      --accent-hover: #357abd;
      --text-primary: #fff;
      --text-secondary: #888;
      --hover-color: #252525;
      --battle-color: #e74c3c;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--background-color);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
    }

    .test-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header with Hamburger */
    .test-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 40px;
      padding: 20px 30px;
      background: var(--surface-color);
      border-radius: 12px;
      border: 2px solid var(--border-color);
      position: relative;
    }

    .hamburger-btn {
      width: 40px;
      height: 40px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .hamburger-btn:hover {
      border-color: var(--accent-color);
      background: var(--hover-color);
    }

    .hamburger-btn span {
      width: 20px;
      height: 2.5px;
      background: var(--text-primary);
      border-radius: 2px;
      transition: all 0.2s ease;
    }

    .header-content {
      flex: 1;
      text-align: center;
    }

    .header-center {
      flex: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* Header HP Bar */
    .header-hp-bar {
      width: 120px;
      margin-top: 8px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
      height: 24px;
    }

    .header-hp-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
      transition: width 0.3s ease;
      position: absolute;
      top: 0;
      left: 0;
    }

    .header-hp-fill.high {
      background: linear-gradient(90deg, #27ae60 0%, #229954 100%);
    }

    .header-hp-fill.medium {
      background: linear-gradient(90deg, #f39c12 0%, #d68910 100%);
    }

    .header-hp-text {
      position: relative;
      z-index: 2;
      font-size: 0.75rem;
      font-weight: 700;
      text-align: center;
      line-height: 24px;
      color: var(--text-primary);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      cursor: pointer;
    }

    .header-hp-text:hover {
      color: var(--accent-color);
    }

    .header-ac {
      margin-top: 4px;
      font-size: 0.7rem;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .header-ac:hover {
      color: var(--accent-color);
    }

    .header-content h1 {
      font-size: 2rem;
      margin-bottom: 5px;
      color: var(--accent-color);
    }

    .current-character {
      font-size: 1.2rem;
      color: var(--text-secondary);
    }

    .current-character-emoji {
      font-size: 1.5rem;
      margin-right: 8px;
    }

    /* Character Menu Overlay */
    .character-menu {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100vh;
      background: var(--surface-color);
      border-right: 2px solid var(--border-color);
      z-index: 9999;
      transition: left 0.3s ease;
      overflow-y: auto;
      box-shadow: 2px 0 20px rgba(0, 0, 0, 0.5);
    }

    .character-menu.open {
      left: 0;
    }

    .menu-header {
      padding: 20px;
      background: var(--background-color);
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .menu-header h3 {
      color: var(--accent-color);
    }

    .close-menu-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 1.2rem;
    }

    .character-list {
      padding: 10px;
    }

    .character-item {
      padding: 15px;
      margin-bottom: 10px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .character-item:hover {
      border-color: var(--accent-color);
      transform: translateX(5px);
    }

    .character-item.active {
      background: var(--accent-color);
      border-color: var(--accent-color);
    }

    .character-item-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .character-item-emoji {
      font-size: 2rem;
    }

    .character-item-info {
      flex: 1;
    }

    .character-item-name {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 3px;
    }

    .character-item-class {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .character-item.active .character-item-class {
      color: rgba(255, 255, 255, 0.8);
    }

    .character-item-stats {
      display: flex;
      gap: 15px;
      font-size: 0.85rem;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }

    .character-item.active .character-item-stats {
      border-top-color: rgba(255, 255, 255, 0.3);
    }

    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9998;
      display: none;
    }

    .menu-overlay.show {
      display: block;
    }

    .demo-layout {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .demo-section {
      background: var(--surface-color);
      border-radius: 12px;
      padding: 20px;
      border: 2px solid var(--border-color);
    }

    .demo-section h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: var(--accent-color);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
    }

    /* Image Tabs */
    .image-tabs-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
    }

    .tab-button {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }

    .tab-button:hover {
      background: var(--hover-color);
      color: var(--text-primary);
    }

    .tab-button.active {
      background: var(--accent-color);
      color: white;
    }

    .image-display {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      background: var(--background-color);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .image-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
    }

    .placeholder-emoji {
      font-size: 4rem;
      margin-bottom: 10px;
      opacity: 0.3;
    }

    .portrait-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .canvas-display {
      position: relative;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
    }

    .character-overlay {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid var(--accent-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
      overflow: hidden;
      background: var(--background-color);
    }

    .character-overlay img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .location-name {
      position: absolute;
      top: 15px;
      left: 15px;
      padding: 8px 16px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 20px;
      font-size: 0.9rem;
      color: white;
      backdrop-filter: blur(10px);
    }

    .editable-stat {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .editable-stat:hover {
      background: var(--hover-color);
      outline: 1px solid var(--accent-color);
    }

    /* Portrait Types - Removed for cleaner mobile UI */
    .portrait-types {
      display: none;
    }

    .portrait-type-btn {
      display: none;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-block {
      padding: 15px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      text-align: center;
    }

    .stat-name {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--text-primary);
    }

    .stat-modifier {
      font-size: 0.9rem;
      color: var(--accent-color);
      font-weight: 700;
    }

    .hp-display {
      margin-bottom: 15px;
      padding: 15px;
      background: var(--background-color);
      border-radius: 8px;
    }

    .hp-bar {
      position: relative;
      height: 30px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 15px;
      border: 2px solid var(--border-color);
      overflow: hidden;
      margin-top: 10px;
    }

    .hp-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, #e74c3c, #c0392b);
      transition: width 0.3s ease;
    }

    .hp-text {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: white;
      font-weight: bold;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    }

    /* Chat Modes */
    .chat-modes {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
    }

    .mode-btn {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .mode-btn:hover {
      background: var(--hover-color);
      color: var(--text-primary);
    }

    .mode-btn.active {
      background: var(--accent-color);
      color: white;
    }

    /* Stat Tabs */
    .stat-tab-btn {
      flex: 1;
      padding: 10px 15px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s ease;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .stat-tab-btn:hover {
      background: var(--hover-color);
      color: var(--text-primary);
    }

    .stat-tab-btn.active {
      background: var(--accent-color);
      color: white;
    }

    /* Turn Tracker */
    .turn-tracker {
      margin-bottom: 15px;
      padding: 12px;
      background: var(--background-color);
      border: 2px solid var(--battle-color);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .turn-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .turn-number {
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--battle-color);
    }

    .turn-controls button {
      padding: 8px 16px;
      background: var(--battle-color);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .turn-controls button:hover {
      opacity: 0.8;
    }

    /* State Selector */
    .state-selector {
      margin-bottom: 15px;
      padding: 12px;
      background: var(--background-color);
      border-radius: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .state-selector select {
      flex: 1;
      padding: 8px;
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    /* Messages */
    .messages-area {
      height: 350px;
      overflow-y: auto;
      padding: 15px;
      background: var(--background-color);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .message {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.player {
      flex-direction: row-reverse;
    }

    .message.system {
      justify-content: center;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .message.system .message-avatar {
      background: var(--battle-color);
    }

    .message-content {
      flex: 1;
      padding: 12px;
      background: var(--surface-color);
      border-radius: 12px;
      max-width: 70%;
    }

    .message.player .message-content {
      background: var(--accent-color);
    }

    .message.system .message-content {
      background: rgba(231, 76, 60, 0.2);
      border: 2px solid var(--battle-color);
      max-width: 90%;
      text-align: center;
    }

    .message-header {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--accent-color);
    }

    .message.player .message-header {
      color: rgba(255, 255, 255, 0.9);
    }

    .message-text {
      line-height: 1.5;
    }

    /* Battle Actions */
    .battle-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .action-btn {
      padding: 12px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .action-btn:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
    }

    /* Abilities */
    .abilities-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .ability-card {
      padding: 15px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ability-card:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
    }

    .ability-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .ability-icon {
      font-size: 2rem;
    }

    .ability-info {
      flex: 1;
    }

    .ability-name {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .ability-damage {
      font-size: 0.85rem;
      color: var(--accent-color);
      font-weight: 700;
    }

    .ability-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* Skills Grid */
    .skills-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    .skill-btn {
      padding: 12px 8px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .skill-btn:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .skill-emoji {
      font-size: 1.8rem;
      display: block;
      margin-bottom: 5px;
    }

    .skill-name {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .skill-modifier {
      font-size: 0.7rem;
      color: var(--accent-color);
      font-weight: 700;
    }

    .skills-section {
      margin-bottom: 20px;
    }

    .skills-section h3 {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    /* Spells */
    .spell-level-section {
      margin-bottom: 20px;
    }

    .spell-level-header {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
      font-weight: 600;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border-color);
    }

    /* Minimal spell card for list view */
    .spell-card {
      padding: 12px 15px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .spell-card.prepared {
      border-color: var(--accent-color);
      background: rgba(74, 144, 226, 0.05);
    }

    .spell-card:hover {
      transform: translateX(4px);
      border-color: var(--accent-color);
      box-shadow: 0 2px 8px rgba(74, 144, 226, 0.2);
    }

    .spell-card .spell-icon {
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    .spell-card .spell-name {
      flex: 1;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .spell-card .spell-check {
      font-size: 1.1rem;
      color: var(--accent-color);
      flex-shrink: 0;
    }

    /* Spell slot progress bars */
    .spell-slots-overview {
      padding: 15px;
      background: var(--surface-color);
      border-radius: 8px;
      border: 2px solid var(--border-color);
      margin-bottom: 20px;
    }

    .slots-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .slots-title {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .prepared-count {
      font-size: 0.85rem;
      color: var(--accent-color);
      font-weight: 600;
    }

    .slots-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .slot-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slot-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      min-width: 30px;
      font-weight: 600;
    }

    .slot-bar {
      flex: 1;
      height: 18px;
      background: var(--background-color);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
      border: 1px solid var(--border-color);
    }

    .slot-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), #357abd);
      transition: width 0.3s ease;
    }

    .slot-text {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-primary);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    /* Spell picker modal - lower z-index so detail modal appears on top */
    .spell-picker-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .spell-picker-overlay.show {
      display: flex;
    }

        /* Spell detail modal */
    .spell-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10100;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .spell-modal-overlay.show {
      display: flex;
    }

    .spell-modal {
      background: var(--surface-color);
      border: 3px solid var(--accent-color);
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .spell-modal-header {
      padding: 20px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--background-color);
      border-radius: 10px 10px 0 0;
      position: relative;
    }

    .spell-modal-icon {
      font-size: 2.5rem;
    }

    .spell-modal-title {
      flex: 1;
    }

    .spell-modal-name {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .spell-modal-level {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .spell-modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 32px;
      height: 32px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .spell-modal-close:hover {
      border-color: var(--battle-color);
      color: var(--battle-color);
    }

    .spell-modal-body {
      padding: 20px;
    }

    .spell-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .spell-stat {
      background: var(--background-color);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }

    .spell-stat-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .spell-stat-value {
      font-size: 0.9rem;
      color: var(--text-primary);
      font-weight: 600;
    }

    .spell-description {
      margin-bottom: 20px;
      line-height: 1.6;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .spell-modal-actions {
      display: flex;
      gap: 10px;
      padding-top: 15px;
      border-top: 2px solid var(--border-color);
    }

    .spell-btn-cast {
      flex: 2;
      padding: 15px;
      background: var(--accent-color);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .spell-btn-cast:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    }

    .spell-btn-cast:disabled {
      background: var(--border-color);
      cursor: not-allowed;
      transform: none;
    }

    .spell-btn-prepare {
      flex: 1;
      padding: 15px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .spell-btn-prepare:hover {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .spell-btn-prepare.prepared {
      border-color: var(--accent-color);
      background: rgba(74, 144, 226, 0.1);
      color: var(--accent-color);
    }

    /* Spell Picker Modal */
    .spell-picker-modal {
      background: var(--surface-color);
      border: 3px solid var(--accent-color);
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      max-height: 85vh;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .spell-picker-header {
      padding: 20px;
      border-bottom: 2px solid var(--border-color);
      background: var(--background-color);
      border-radius: 10px 10px 0 0;
      position: relative;
    }

    .spell-picker-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 15px;
    }

    .spell-picker-search {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }

    .spell-picker-search input {
      flex: 1;
      padding: 10px 15px;
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .spell-picker-search input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .spell-picker-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .spell-picker-filter {
      padding: 6px 12px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .spell-picker-filter:hover,
    .spell-picker-filter.active {
      border-color: var(--accent-color);
      background: rgba(74, 144, 226, 0.1);
      color: var(--accent-color);
    }

    .spell-picker-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .spell-picker-loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .spell-picker-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .spell-picker-item {
      padding: 12px 15px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .spell-picker-item:hover {
      border-color: var(--accent-color);
      transform: translateX(4px);
    }

    .spell-picker-item-info {
      flex: 1;
    }

    .spell-picker-item-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-primary);
      margin-bottom: 3px;
    }

    .spell-picker-item-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .spell-picker-item-add {
      padding: 6px 12px;
      background: var(--accent-color);
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .spell-picker-item-add:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    .spell-picker-item-add:disabled {
      background: var(--border-color);
      cursor: not-allowed;
      transform: none;
    }

    .spell-picker-empty {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    /* Inventory */
    .inventory-category {
      margin-bottom: 20px;
    }

    .inventory-category-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    .inventory-item {
      padding: 12px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
    }

    .inventory-item.equipped {
      border-color: var(--accent-color);
      background: rgba(74, 144, 226, 0.1);
    }

    .inventory-item:hover {
      border-color: var(--accent-color);
      transform: translateY(-1px);
    }

    .inventory-item.consumable-item:hover {
      background: rgba(46, 204, 113, 0.1);
      border-color: #2ecc71;
      cursor: pointer;
    }

    .inventory-item.consumable-item:active {
      transform: scale(0.98);
    }

    .inventory-item-info {
      flex: 1;
    }

    .inventory-item-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .inventory-item-type {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: capitalize;
    }

    .inventory-item-quantity {
      padding: 4px 10px;
      background: var(--surface-color);
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .equipped-badge {
      padding: 3px 8px;
      background: var(--accent-color);
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      color: white;
    }

    /* Dice Overlay */
    .dice-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      display: none;
    }

    .dice-overlay.show {
      display: block;
      animation: diceEnter 0.5s ease-out;
    }

    @keyframes diceEnter {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5) rotate(-180deg);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
      }
    }

    .dice-result {
      padding: 30px 40px;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(26, 26, 26, 0.95));
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), 0 0 20px rgba(74, 144, 226, 0.3);
      text-align: center;
      backdrop-filter: blur(10px);
      min-width: 200px;
    }

    .dice-icon {
      font-size: 3rem;
      margin-bottom: 10px;
      animation: diceRoll 0.5s ease-out;
    }

    @keyframes diceRoll {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(90deg); }
      50% { transform: rotate(180deg); }
      75% { transform: rotate(270deg); }
    }

    .dice-type {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    .dice-value {
      font-size: 3.5rem;
      font-weight: 900;
      text-shadow: 0 2px 10px currentColor;
      animation: resultPulse 0.5s ease-out;
      line-height: 1;
      margin-bottom: 8px;
    }

    .dice-breakdown {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-family: 'Courier New', monospace;
      margin-top: 8px;
    }

    @keyframes resultPulse {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }

    .dice-result.critical-success {
      border-color: #2ecc71;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(46, 204, 113, 0.6);
    }

    .dice-result.critical-success .dice-value {
      color: #2ecc71;
    }

    .dice-result.critical-fail {
      border-color: #e74c3c;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(231, 76, 60, 0.6);
      animation: criticalFailShake 0.5s ease-out;
    }

    .dice-result.critical-fail .dice-value {
      color: #e74c3c;
    }

    @keyframes criticalFailShake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* Floating Action Button */
    .fab-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 65px;
      height: 65px;
      background: var(--accent-color);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      transition: all 0.3s ease;
      z-index: 999;
    }

    .fab-btn:hover {
      background: var(--accent-hover);
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    }

    .fab-btn:active {
      transform: scale(0.95);
    }

    /* Dice Popup */
    .dice-popup {
      position: fixed;
      bottom: 110px;
      right: 30px;
      width: 350px;
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 998;
      display: none;
      animation: popupSlideIn 0.3s ease-out;
    }

    .dice-popup.show {
      display: block;
    }

    @keyframes popupSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dice-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 2px solid var(--border-color);
    }

    .dice-popup-header h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .close-popup-btn {
      width: 30px;
      height: 30px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .close-popup-btn:hover {
      border-color: var(--accent-color);
      background: var(--hover-color);
    }

    .dice-popup-content {
      padding: 20px;
    }

    .test-btn {
      padding: 10px 20px;
      background: var(--accent-color);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    .test-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }

    @media (max-width: 1200px) {
      .demo-layout {
        display: flex;
        flex-direction: column;
      }

      /* Mobile order: Chat (1), Stats (2) */
      .section-chat { order: 1; }
      .section-stats { order: 2; }
    }

    @media (max-width: 768px) {
      /* Shrink portrait images for mobile */
      .image-display {
        aspect-ratio: auto;
        height: 200px;
        max-height: 200px;
      }

      .image-placeholder {
        height: 200px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .battle-actions {
        grid-template-columns: repeat(2, 1fr);
      }

      .skills-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .test-controls {
        bottom: 10px;
        right: 10px;
        flex-direction: column;
      }

      /* Fix tab bar overflow on mobile */
      .stat-tabs {
        flex-wrap: wrap;
      }

      .stat-tab-btn {
        font-size: 0.75rem;
        padding: 8px 6px;
        flex: 1 1 auto;
        min-width: fit-content;
      }
    }

    @media (max-width: 480px) {
      /* Extra small screens - even smaller tabs */
      .stat-tab-btn {
        font-size: 0.7rem;
        padding: 6px 4px;
      }
    }

    /* Text overflow fixes */
    .spell-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .spell-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .character-item-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 150px;
    }

    .modal-spell-name, .spell-modal-name {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    /* Ensure tabs don't overflow */
    .stat-tabs {
      flex-wrap: wrap;
    }

  </style>
</head>
<body>
  <div class="test-container">
    <!-- Header with Hamburger -->
    <div class="test-header">
      <!-- Portrait Upper Left with HP Bar -->
      <div style="display: flex; flex-direction: column; align-items: center; flex-shrink: 0;">
        <div class="header-portrait" style="width: 160px; height: 160px; border-radius: 50%; overflow: hidden; border: 3px solid var(--accent-color);">
          <div id="headerPortrait" style="width: 100%; height: 100%; background: var(--background-color); display: flex; align-items: center; justify-content: center; font-size: 4.5rem;">
            üèπ
          </div>
        </div>

        <!-- HP Bar beneath portrait -->
        <div class="header-hp-bar">
          <div id="headerHpFill" class="header-hp-fill high" style="width: 100%;"></div>
          <div id="headerHpText" class="header-hp-text stat-readonly" data-stat="hpCurrent" onclick="!statsLocked && editHeaderHP()">85/85</div>
        </div>

        <!-- AC beneath HP bar -->
        <div id="headerAc" class="header-ac stat-readonly" data-stat="ac" onclick="!statsLocked && editStat('ac', this)">AC 16</div>
      </div>

      <div class="header-center" style="flex: 1; margin-left: 20px;">
        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 3px;">Character Foundry</div>
        <h2 style="font-size: 1.5rem; margin: 0; color: var(--text-primary);">
          <span id="currentCharName">Aelindra Moonwhisper</span>
        </h2>
        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;" id="characterDetails">
          <span id="charAlignment">Neutral Good</span> ‚Ä¢
          Level <span id="charLevel">8</span>
          <span id="charRace">Half-Elf</span>
          <span id="charClass">Ranger</span>
        </div>
      </div>

      <!-- Hamburger Upper Right -->
      <button class="hamburger-btn" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <!-- Character Menu -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
    <div class="character-menu" id="characterMenu">
      <div class="menu-header">
        <h3>Characters</h3>
        <button class="close-menu-btn" onclick="closeMenu()">‚úï</button>
      </div>
            <button onclick="openCharacterCreator()" style="width: calc(100% - 20px); margin: 10px 10px 15px 10px; padding: 12px; background: var(--accent-color); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <span style="font-size: 1.3rem;">+</span> NEW CHARACTER
      </button>
      <div class="character-list" id="characterList">
        <!-- Will be populated by JS -->
      </div>
    </div>

    <!-- Demo Layout -->
    <div class="demo-layout">
      <!-- Stats/Skills/Inventory Tabbed Container -->
      <div class="section-stats" data-order="3">
        <div class="demo-section">
          <!-- Tabs -->
          <div class="stat-tabs" style="display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid var(--border-color);">
            <button class="stat-tab-btn active" onclick="switchStatTab('stats')" id="statsTabBtn">Stats</button>
            <button class="stat-tab-btn" onclick="switchStatTab('skills')" id="skillsTabBtn">Skills</button>
            <button class="stat-tab-btn" onclick="switchStatTab('abilities')" id="abilitiesTabBtn">Abilities</button>
            <button class="stat-tab-btn" onclick="switchStatTab('spells')" id="spellsTabBtn">Spells</button>
            <button class="stat-tab-btn" onclick="switchStatTab('inventory')" id="inventoryTabBtn">Inventory</button>
          </div>

          <!-- Stats Tab -->
          <div id="statsTab">
            <div class="stats-grid">
              <div class="stat-block" onclick="rollSavingThrow('str')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div class="stat-name">STR üé≤</div>
                <div class="stat-value stat-readonly" id="strValue" data-stat="str">12</div>
                <div class="stat-modifier stat-readonly" id="strMod">+1</div>
              </div>
              <div class="stat-block" onclick="rollSavingThrow('dex')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div class="stat-name">DEX üé≤</div>
                <div class="stat-value stat-readonly" id="dexValue" data-stat="dex">18</div>
                <div class="stat-modifier stat-readonly" id="dexMod">+4</div>
              </div>
              <div class="stat-block" onclick="rollSavingThrow('con')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div class="stat-name">CON üé≤</div>
                <div class="stat-value stat-readonly" id="conValue" data-stat="con">14</div>
                <div class="stat-modifier stat-readonly" id="conMod">+2</div>
              </div>
              <div class="stat-block" onclick="rollSavingThrow('int')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div class="stat-name">INT üé≤</div>
                <div class="stat-value stat-readonly" id="intValue" data-stat="int">13</div>
                <div class="stat-modifier stat-readonly" id="intMod">+1</div>
              </div>
              <div class="stat-block" onclick="rollSavingThrow('wis')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div class="stat-name">WIS üé≤</div>
                <div class="stat-value stat-readonly" id="wisValue" data-stat="wis">16</div>
                <div class="stat-modifier stat-readonly" id="wisMod">+3</div>
              </div>
              <div class="stat-block" onclick="rollSavingThrow('cha')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div class="stat-name">CHA üé≤</div>
                <div class="stat-value stat-readonly" id="chaValue" data-stat="cha">10</div>
                <div class="stat-modifier stat-readonly" id="chaMod">+0</div>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
              <div style="padding: 10px; background: var(--background-color); border-radius: 6px; text-align: center;">
                <div style="font-size: 0.8rem; color: var(--text-secondary);">AC</div>
                <div class="stat-readonly" style="font-size: 1.5rem; font-weight: 900;" id="acValue" data-stat="ac">16</div>
              </div>
              <div style="padding: 10px; background: var(--background-color); border-radius: 6px; text-align: center;">
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Initiative</div>
                <div style="font-size: 1.5rem; font-weight: 900; color: var(--accent-color);" id="initValue">+4</div>
              </div>
            </div>

            <div style="margin-top: 15px; padding: 10px; background: var(--background-color); border-radius: 6px;">
              <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">State</div>
              <select id="characterStateStats" onchange="updateCharacterState()" style="width: 100%; padding: 8px; background: var(--surface-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; cursor: pointer;">
                <option value="normal">Normal</option>
                <option value="paralyzed">Paralyzed</option>
                <option value="poisoned">Poisoned</option>
                <option value="prone">Prone</option>
                <option value="unconscious">Unconscious</option>
              </select>
            </div>

            <div style="margin-top: 15px; padding: 10px; background: var(--background-color); border-radius: 6px;">
              <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">Temporary Modifiers</div>
              <div style="display: grid; grid-template-columns: 1fr 60px; gap: 8px; margin-bottom: 8px;">
                <input type="text" id="tempModName" placeholder="Modifier name (e.g., Bless)" style="padding: 8px; background: var(--surface-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.9rem;">
                <input type="number" id="tempModValue" placeholder="+/-" style="padding: 8px; background: var(--surface-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; text-align: center;">
              </div>
              <button onclick="addTempModifier()" style="width: 100%; padding: 8px; background: var(--accent-color); border: none; border-radius: 6px; color: white; font-size: 0.9rem; cursor: pointer;">Add Modifier</button>
              <div id="tempModifiersList" style="margin-top: 10px;">
                <!-- Temporary modifiers will appear here -->
              </div>
            </div>

            <!-- Edit Button (lower right corner) -->
            <div style="text-align: right; margin-top: 15px;">
              <button id="statsLockBtn" onclick="toggleStatsLock()" style="padding: 6px 12px; background: var(--background-color); border: 2px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; cursor: pointer;">
                <span id="lockText">Edit</span>
              </button>
            </div>
          </div>

          <!-- Skills Tab -->
          <div id="skillsTab" style="display: none;">
            <div class="skills-section">
              <h3>üß† Intelligence Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Arcana', 'int')">
                  <span class="skill-emoji">‚ú®</span>
                  <div class="skill-name">Arcana</div>
                  <div class="skill-modifier" id="skill-arcana">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('History', 'int')">
                  <span class="skill-emoji">üìú</span>
                  <div class="skill-name">History</div>
                  <div class="skill-modifier" id="skill-history">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Investigation', 'int')">
                  <span class="skill-emoji">üîç</span>
                  <div class="skill-name">Investigation</div>
                  <div class="skill-modifier" id="skill-investigation">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Nature', 'int')">
                  <span class="skill-emoji">üåø</span>
                  <div class="skill-name">Nature</div>
                  <div class="skill-modifier" id="skill-nature">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Religion', 'int')">
                  <span class="skill-emoji">‚õ™</span>
                  <div class="skill-name">Religion</div>
                  <div class="skill-modifier" id="skill-religion">+1</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üßò Wisdom Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Animal Handling', 'wis')">
                  <span class="skill-emoji">üê¥</span>
                  <div class="skill-name">Animal Handling</div>
                  <div class="skill-modifier" id="skill-animalhandling">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Insight', 'wis')">
                  <span class="skill-emoji">üëÅÔ∏è</span>
                  <div class="skill-name">Insight</div>
                  <div class="skill-modifier" id="skill-insight">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Medicine', 'wis')">
                  <span class="skill-emoji">‚öïÔ∏è</span>
                  <div class="skill-name">Medicine</div>
                  <div class="skill-modifier" id="skill-medicine">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Perception', 'wis')">
                  <span class="skill-emoji">üëÄ</span>
                  <div class="skill-name">Perception</div>
                  <div class="skill-modifier" id="skill-perception">+7</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Survival', 'wis')">
                  <span class="skill-emoji">üèïÔ∏è</span>
                  <div class="skill-name">Survival</div>
                  <div class="skill-modifier" id="skill-survival">+7</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üòä Charisma Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Deception', 'cha')">
                  <span class="skill-emoji">üé≠</span>
                  <div class="skill-name">Deception</div>
                  <div class="skill-modifier" id="skill-deception">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Intimidation', 'cha')">
                  <span class="skill-emoji">üò†</span>
                  <div class="skill-name">Intimidation</div>
                  <div class="skill-modifier" id="skill-intimidation">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Performance', 'cha')">
                  <span class="skill-emoji">üé™</span>
                  <div class="skill-name">Performance</div>
                  <div class="skill-modifier" id="skill-performance">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Persuasion', 'cha')">
                  <span class="skill-emoji">ü§ù</span>
                  <div class="skill-name">Persuasion</div>
                  <div class="skill-modifier" id="skill-persuasion">+0</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>ü§∏ Dexterity Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Acrobatics', 'dex')">
                  <span class="skill-emoji">ü§∏</span>
                  <div class="skill-name">Acrobatics</div>
                  <div class="skill-modifier" id="skill-acrobatics">+7</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Sleight of Hand', 'dex')">
                  <span class="skill-emoji">üëã</span>
                  <div class="skill-name">Sleight of Hand</div>
                  <div class="skill-modifier" id="skill-sleight">+4</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Stealth', 'dex')">
                  <span class="skill-emoji">ü•∑</span>
                  <div class="skill-name">Stealth</div>
                  <div class="skill-modifier" id="skill-stealth">+10</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üí™ Strength Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Athletics', 'str')">
                  <span class="skill-emoji">üí™</span>
                  <div class="skill-name">Athletics</div>
                  <div class="skill-modifier" id="skill-athletics">+1</div>
                </button>
              </div>
            </div>
          </div>

          <!-- Abilities Tab -->
          <div id="abilitiesTab" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px;">
              <div style="font-size: 0.9rem; color: var(--text-secondary);">Class Abilities & Features</div>
              <button onclick="addMoreAbilities()" style="padding: 6px 12px; background: var(--secondary-color, #6c757d); border: none; border-radius: 6px; color: white; font-size: 0.85rem; cursor: pointer; font-weight: 600;">
                üîÑ Update
              </button>
            </div>
            <div style="margin-bottom: 15px;">
              <strong style="color: var(--text-primary);">Combat Abilities</strong>
            </div>
                        <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
              <button onclick="openAbilityPicker()" style="padding: 6px 12px; background: var(--accent-color); border: none; border-radius: 6px; color: white; font-size: 0.85rem; cursor: pointer; font-weight: 600;">
                + Add Ability
              </button>
            </div>

            <div id="abilitiesContent">
              <!-- Will be populated dynamically with abilities only -->
            </div>
          </div>

          <!-- Spells Tab -->
          <div id="spellsTab" style="display: none;">
            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
              <strong style="color: var(--text-primary);">Spells</strong>
              <button onclick="openSpellPicker()" style="padding: 6px 12px; background: var(--accent-color); border: none; border-radius: 6px; color: white; font-size: 0.85rem; cursor: pointer; font-weight: 600;">
                + Add Spell
              </button>
              <button onclick="updateSpells()" style="padding: 6px 12px; background: var(--secondary-color, #6c757d); border: none; border-radius: 6px; color: white; font-size: 0.85rem; cursor: pointer; font-weight: 600; margin-left: 8px;">
                üîÑ Update
              </button>
            </div>

            <!-- Spell Slots Overview -->
            
            <div id="castingTypeInfo" style="padding: 10px; margin-bottom: 10px; background: var(--background-color); border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.85rem;">
              <!-- Will show casting type info -->
            </div>

            <div class="spell-slots-overview" id="spellSlotsDisplay">
              <!-- Will be populated dynamically -->
            </div>

            <!-- Spells List -->
            <div id="spellsContent">
              <!-- Will be populated dynamically with spells -->
            </div>
          </div>

          <!-- Inventory Tab -->
          <div id="inventoryTab" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px;">
              <div style="font-size: 0.9rem; color: var(--text-secondary);">Equipment & Items</div>
              <button onclick="updateInventory_autoAdd()" style="padding: 6px 12px; background: var(--secondary-color, #6c757d); border: none; border-radius: 6px; color: white; font-size: 0.85rem; cursor: pointer; font-weight: 600;">
                üîÑ Update
              </button>
            </div>
            <div id="inventoryGrid">
              <!-- Will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Section -->
      <div class="section-chat" data-order="2">
        <div class="demo-section">
          <!-- Mode Selector (above chat) -->
          <div class="chat-modes" style="margin-bottom: 15px;">
            <button class="mode-btn active" onclick="switchChatMode('conversation')">Chat</button>
            <button class="mode-btn" onclick="switchChatMode('battle')">Battle</button>
          </div>

          <!-- Conversation Mode -->
          <div id="conversationMode">
            <div class="messages-area" id="messagesArea">
              <div class="message">
                <div class="message-avatar">üèπ</div>
                <div class="message-content">
                  <div class="message-header" id="characterNameHeader">Aelindra</div>
                  <div class="message-text" id="greetingMessage">
                    You find me studying tracks in the forest. The creatures here have been acting strangely...
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
              <input
                type="text"
                id="messageInput"
                placeholder="Type a message..."
                style="flex: 1; padding: 12px; background: var(--background-color); border: 2px solid var(--border-color); border-radius: 8px; color: var(--text-primary);"
                onkeypress="if(event.key === 'Enter') sendMessage()"
              >
              <button class="test-btn" onclick="sendMessage()">Send</button>
            </div>

            <!-- State Selector (below chat) -->
            <div style="padding-top: 15px; border-top: 1px solid var(--border-color);">
              <div class="state-selector">
                <label style="color: var(--text-secondary); font-weight: 600;">Mood:</label>
                <select id="characterState" onchange="changeCharacterState()">
                  <option value="default">Default (Calm)</option>
                  <option value="battle">Battle (Focused)</option>
                  <option value="injured">Injured (Pained)</option>
                  <option value="angry">Angry (Furious)</option>
                  <option value="triumphant">Triumphant (Joyful)</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Battle Mode -->
          <div id="battleMode" style="display: none;">
            <!-- HP Editor for Battle Mode -->
            <div style="background: var(--surface-color); border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong style="color: var(--text-primary);">Hit Points</strong>
                <button onclick="editBattleHP()" style="padding: 6px 12px; background: var(--accent-color); border: none; border-radius: 6px; color: white; font-size: 0.85rem; cursor: pointer; font-weight: 600;">‚úèÔ∏è Edit HP</button>
              </div>
              <div class="hp-bar" style="height: 30px; margin-bottom: 10px;">
                <div class="hp-fill" id="battleHpFill" style="width: 85%"></div>
                <div class="hp-text" id="battleHpText" style="line-height: 30px;">58 / 68</div>
              </div>
            </div>

            <!-- Battle Log -->
            <div style="margin-bottom: 15px;">
              <strong style="color: var(--text-primary);">Battle Log</strong>
            </div>
            <div id="battleLog" style="min-height: 200px; max-height: 300px; overflow-y: auto; background: var(--background-color); border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
              <div style="color: var(--text-secondary); font-size: 0.9rem; text-align: center; padding: 20px;">
                Battle actions and rolls will appear here...
              </div>
            </div>

            <div style="margin-bottom: 15px;">
              <strong style="color: var(--text-primary);">Quick Actions</strong>
            </div>

            <div class="battle-actions">
              <button class="action-btn" onclick="rollMeleeAttack()">‚öîÔ∏è Melee Attack</button>
              <button class="action-btn" onclick="rollRangedAttack()">üèπ Ranged Attack</button>
              <button class="action-btn" onclick="castCantrip()">‚ú® Cantrip</button>

              <button class="action-btn" onclick="quickAction('dash')">üèÉ Dash</button>
              <button class="action-btn" onclick="quickAction('dodge')">üí® Dodge</button>

            </div>

            <div class="turn-tracker">
              <div class="turn-info">
                <div>
                  <strong style="color: var(--text-secondary); font-size: 0.85rem;">Turn</strong>
                  <div class="turn-number" id="turnNumber">1</div>
                </div>
                <div style="border-left: 2px solid var(--border-color); padding-left: 15px; margin-left: 15px;">
                  <div style="font-size: 0.75rem; color: var(--text-secondary);">Current</div>
                  <div style="font-weight: 600; color: var(--text-primary);" id="currentTurn">Your Turn</div>
                </div>
              </div>
              <div class="turn-controls" style="display: flex; gap: 8px;">
                <button onclick="rollInitiative()" style="flex: 1;">üé≤ Initiative</button>
                <button onclick="nextTurn()" style="flex: 1;">Next Turn ‚û§</button>
              </div>
            </div>
          </div>

          <!-- Skills Mode -->
          <div id="skillsMode" style="display: none;">
            <div style="padding: 15px; background: var(--background-color); border-radius: 8px; margin-bottom: 15px;">
              <strong style="color: var(--text-primary); margin-bottom: 10px; display: block;">D&D 5e Skill Checks</strong>
              <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                Click any skill to roll a check. Modifiers are automatically calculated based on your character's stats and proficiencies.
              </p>
            </div>

            <div class="skills-section">
              <h3>üß† Intelligence Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Arcana', 'int')">
                  <span class="skill-emoji">üîÆ</span>
                  <div class="skill-name">Arcana</div>
                  <div class="skill-modifier" id="skill-arcana">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('History', 'int')">
                  <span class="skill-emoji">üìú</span>
                  <div class="skill-name">History</div>
                  <div class="skill-modifier" id="skill-history">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Investigation', 'int')">
                  <span class="skill-emoji">üîç</span>
                  <div class="skill-name">Investigation</div>
                  <div class="skill-modifier" id="skill-investigation">+4</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Nature', 'int')">
                  <span class="skill-emoji">üåø</span>
                  <div class="skill-name">Nature</div>
                  <div class="skill-modifier" id="skill-nature">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Religion', 'int')">
                  <span class="skill-emoji">‚õ™</span>
                  <div class="skill-name">Religion</div>
                  <div class="skill-modifier" id="skill-religion">+1</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üëÅÔ∏è Wisdom Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Animal Handling', 'wis')">
                  <span class="skill-emoji">üê∫</span>
                  <div class="skill-name">Animal Handling</div>
                  <div class="skill-modifier" id="skill-animal">+6</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Insight', 'wis')">
                  <span class="skill-emoji">üí≠</span>
                  <div class="skill-name">Insight</div>
                  <div class="skill-modifier" id="skill-insight">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Medicine', 'wis')">
                  <span class="skill-emoji">‚öïÔ∏è</span>
                  <div class="skill-name">Medicine</div>
                  <div class="skill-modifier" id="skill-medicine">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Perception', 'wis')">
                  <span class="skill-emoji">üëÅÔ∏è</span>
                  <div class="skill-name">Perception</div>
                  <div class="skill-modifier" id="skill-perception">+6</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Survival', 'wis')">
                  <span class="skill-emoji">üèïÔ∏è</span>
                  <div class="skill-name">Survival</div>
                  <div class="skill-modifier" id="skill-survival">+9</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>‚ú® Charisma Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Deception', 'cha')">
                  <span class="skill-emoji">üé≠</span>
                  <div class="skill-name">Deception</div>
                  <div class="skill-modifier" id="skill-deception">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Intimidation', 'cha')">
                  <span class="skill-emoji">üò†</span>
                  <div class="skill-name">Intimidation</div>
                  <div class="skill-modifier" id="skill-intimidation">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Performance', 'cha')">
                  <span class="skill-emoji">üé™</span>
                  <div class="skill-name">Performance</div>
                  <div class="skill-modifier" id="skill-performance">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Persuasion', 'cha')">
                  <span class="skill-emoji">ü§ù</span>
                  <div class="skill-name">Persuasion</div>
                  <div class="skill-modifier" id="skill-persuasion">+0</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>ü§∏ Dexterity Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Acrobatics', 'dex')">
                  <span class="skill-emoji">ü§∏</span>
                  <div class="skill-name">Acrobatics</div>
                  <div class="skill-modifier" id="skill-acrobatics">+7</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Sleight of Hand', 'dex')">
                  <span class="skill-emoji">üëã</span>
                  <div class="skill-name">Sleight of Hand</div>
                  <div class="skill-modifier" id="skill-sleight">+4</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Stealth', 'dex')">
                  <span class="skill-emoji">ü•∑</span>
                  <div class="skill-name">Stealth</div>
                  <div class="skill-modifier" id="skill-stealth">+10</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üí™ Strength Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Athletics', 'str')">
                  <span class="skill-emoji">üí™</span>
                  <div class="skill-name">Athletics</div>
                  <div class="skill-modifier" id="skill-athletics">+1</div>
                </button>
              </div>
            </div>
          </div>

          <!-- Inventory Mode -->
          <div id="inventoryMode" style="display: none;">
            <div style="padding: 15px; background: var(--background-color); border-radius: 8px; margin-bottom: 15px;">
              <strong style="color: var(--text-primary); margin-bottom: 10px; display: block;">Character Inventory</strong>
              <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                Manage your equipment, weapons, and consumables. Click items to use or equip them.
              </p>
            </div>

            <div id="inventoryGrid">
              <!-- Will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab-btn" onclick="toggleDicePopup()" title="Dice & Quick Actions">
      üé≤
    </button>

    <!-- Dice Popup -->
    <div class="dice-popup" id="dicePopup">
      <div class="dice-popup-header">
        <h3>üé≤ Dice & Actions</h3>
        <button class="close-popup-btn" onclick="toggleDicePopup()">‚úï</button>
      </div>
      <div class="dice-popup-content">
        <div style="margin-bottom: 15px;" id="combatRollsSection">
          <strong style="display: block; margin-bottom: 8px;">Combat Rolls</strong>
          <div style="display: grid; gap: 8px;">
            <!-- Attack & Ranged buttons (populated dynamically) -->
            <div id="attackButtons" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
            <!-- Spell buttons (populated dynamically) -->
            <div id="spellButtons" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
          </div>
        </div>

        <div style="margin-bottom: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
          <strong style="display: block; margin-bottom: 8px;">Custom Dice Roll</strong>
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <input type="number" id="numDice" value="1" min="1" max="10" style="width: 50px; padding: 8px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 4px;">
            <select id="diceTypeSelect" style="padding: 8px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 4px;">
              <option value="4">d4</option>
              <option value="6">d6</option>
              <option value="8">d8</option>
              <option value="10">d10</option>
              <option value="12">d12</option>
              <option value="20" selected>d20</option>
              <option value="100">d100</option>
            </select>
            <input type="number" id="diceModifier" value="0" min="-10" max="20" placeholder="+/-" style="width: 60px; padding: 8px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 4px;">
            <button class="test-btn" onclick="rollCustomDice()" style="margin: 0;">Roll</button>
          </div>
        </div>

        <div style="border-top: 1px solid var(--border-color); padding-top: 15px;">
          <strong style="display: block; margin-bottom: 8px;">Quick Actions</strong>
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <input type="number" id="damageAmount" value="10" min="1" max="999" placeholder="Damage" style="width: 80px; padding: 8px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 4px;">
            <button class="test-btn" onclick="takeDamage()" style="margin: 0;">üíî Damage</button>
            <button class="test-btn" onclick="heal()" style="margin: 0;">‚ù§Ô∏è Heal</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer: Canvas & Location -->
    <div style="margin-top: 20px; padding: 20px; background: var(--surface-color); border-radius: 12px; border: 2px solid var(--border-color);">
      <!-- Rest Buttons -->
      <div style="margin-bottom: 20px;">
        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">Rest & Recovery</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button onclick="shortRest()" style="padding: 12px; background: var(--accent-color); border: none; border-radius: 6px; color: white; font-size: 0.9rem; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
            ‚òÄÔ∏è Short Rest
          </button>
          <button onclick="longRest()" style="padding: 12px; background: var(--secondary-color, #6c757d); border: none; border-radius: 6px; color: white; font-size: 0.9rem; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
            üåô Long Rest
          </button>
        </div>
      </div>

      <!-- Character Portrait -->
      <div style="margin-bottom: 20px;">
        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">Character Portrait</div>
        <div id="footerPortraitContainer" onclick="togglePortraitFullsize()" style="width: 100%; max-width: 400px; aspect-ratio: 1; margin: 0 auto; border-radius: 12px; overflow: hidden; border: 3px solid var(--accent-color); background: var(--background-color); display: flex; align-items: center; justify-content: center; font-size: 8rem; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
          <div id="footerPortrait">üèπ</div>
        </div>
        <select id="portraitExpression" onchange="updatePortraitExpression()" style="width: 100%; max-width: 400px; margin: 10px auto 0; display: block; padding: 10px; background: var(--surface-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; cursor: pointer;">
          <option value="normal">Normal</option>
          <option value="happy">Happy</option>
          <option value="sad">Sad</option>
          <option value="angry">Angry</option>
          <option value="hurt">Hurt</option>
          <option value="injured">Injured</option>
          <option value="gravely-injured">Gravely Injured</option>
        </select>
      </div>

      <!-- Location Background -->
      <div style="margin-bottom: 20px;">
        <div id="canvasDisplay" onclick="toggleCanvasFullsize()" style="width: 100%; max-width: 400px; aspect-ratio: 1; margin: 0 auto; background: var(--background-color); border: 3px solid var(--border-color); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; transition: transform 0.2s; overflow: hidden;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
          Canvas preview (location background)
        </div>
      </div>

      <!-- Location -->
      <div>
        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">Location</div>
        <select id="locationSelect" onchange="changeLocation()" style="width: 100%; padding: 10px; background: var(--surface-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem; cursor: pointer;">
          <option value="forest">Moonlit Forest</option>
          <option value="tavern">The Drunken Dragon Tavern</option>
          <option value="dungeon">Ancient Dungeon</option>
          <option value="castle">Royal Castle</option>
          <option value="town">Town Square</option>
          <option value="mountains">Mountain Pass</option>
          <option value="ruins">Ancient Ruins</option>
          <option value="temple">Sacred Temple</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Portrait Fullsize Overlay -->
  <div id="portraitFullsizeOverlay" onclick="togglePortraitFullsize()" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; align-items: center; justify-content: center; cursor: pointer;">
    <div style="width: 90vmin; height: 90vmin; max-width: 600px; max-height: 600px; border-radius: 20px; overflow: hidden; border: 5px solid var(--accent-color); background: var(--background-color); display: flex; align-items: center; justify-content: center; font-size: 20rem;">
      <div id="fullsizePortrait">üèπ</div>
    </div>
  </div>

  <!-- Canvas Fullsize Overlay -->
  <div id="canvasFullsizeOverlay" onclick="toggleCanvasFullsize()" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; align-items: center; justify-content: center; cursor: pointer;">
    <div id="fullsizeCanvas" style="width: 90vmin; height: 90vmin; max-width: 800px; max-height: 800px; border-radius: 20px; overflow: hidden; border: 5px solid var(--border-color); background: var(--background-color); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 1.2rem;">
      Canvas preview (location background)
    </div>
  </div>

  <!-- Dice Roll Overlay -->
  <div class="dice-overlay" id="diceOverlay">
    <div class="dice-result" id="diceResult">
      <div class="dice-icon" id="diceIcon">üé≤</div>
      <div class="dice-type" id="diceType">Attack Roll</div>
      <div class="dice-value" id="diceValue">18</div>
      <div class="dice-breakdown" id="diceBreakdown"></div>
    </div>
  </div>

  <script>
    // Location Data
    const locations = [
      { id: 'tavern', name: 'The Drunken Dragon Tavern', image: 'https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800&q=80' },
      { id: 'forest', name: 'Moonlit Forest', image: 'https://images.unsplash.com/photo-1511497584788-876760111969?w=800&q=80' },
      { id: 'dungeon', name: 'Ancient Dungeon', image: 'https://images.unsplash.com/photo-1518105779142-d975f22f1b0a?w=800&q=80' },
      { id: 'castle', name: 'Royal Castle', image: 'https://images.unsplash.com/photo-1549048430-7f0e636b069e?w=800&q=80' },
      { id: 'town', name: 'Town Square', image: 'https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=800&q=80' },
      { id: 'mountains', name: 'Mountain Pass', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80' },
      { id: 'ruins', name: 'Ancient Ruins', image: 'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=800&q=80' },
      { id: 'temple', name: 'Sacred Temple', image: 'https://images.unsplash.com/photo-1512699355324-f07e3106dae5?w=800&q=80' }
    ];

    // Character Data with Skills
    const characters = [
      {
        id: 'aelindra',
        name: 'Aelindra Moonwhisper',
        emoji: 'üèπ',
        class: 'Ranger',
        subclass: 'Hunter',
        race: 'Half-Elf',
        alignment: 'Neutral Good',
        classType: 'halfcaster', // melee, halfcaster, or caster
        level: 8,
        hp: { current: 58, max: 68 },
        ac: 16,
        food: { current: 70, max: 100 }, // Hunger/satiety level
        stats: { str: 12, dex: 18, con: 14, int: 13, wis: 16, cha: 10 },
        // portrait: 'https://i.imgur.com/yXEiYQ7.png', // Placeholder - using emoji instead
        location: 'forest',
        attacks: {
          melee: { name: 'Shortsword', damage: '1d6+4', toHit: 7 },
          ranged: { name: 'Longbow +1', damage: '1d8+5', toHit: 8 }
        },
        inventory: [
          { id: 'longbow', name: 'Longbow +1', type: 'weapon', equipped: true, attuned: true },
          { id: 'cloak', name: 'Cloak of Elvenkind', type: 'armor', equipped: true, attuned: true },
          { id: 'arrows', name: 'Arrows', type: 'ammunition', quantity: 40 },
          { id: 'leather_armor', name: 'Leather Armor', type: 'armor', equipped: true },
          { id: 'healing_potion', name: 'Potion of Healing', type: 'consumable', quantity: 3 },
          { id: 'rope', name: 'Rope (50 ft)', type: 'gear', quantity: 1 },
          { id: 'rations', name: 'Rations', type: 'consumable', quantity: 7 }
        ],
        skills: {
          // Format: [ability, proficiency] where proficiency: 0=none, 1=proficient, 2=expertise
          acrobatics: ['dex', 1],
          animalHandling: ['wis', 1],
          arcana: ['int', 0],
          athletics: ['str', 0],
          deception: ['cha', 0],
          history: ['int', 0],
          insight: ['wis', 0],
          intimidation: ['cha', 0],
          investigation: ['int', 1],
          medicine: ['wis', 0],
          nature: ['int', 0],
          perception: ['wis', 1],
          performance: ['cha', 0],
          persuasion: ['cha', 0],
          religion: ['int', 0],
          sleightOfHand: ['dex', 0],
          stealth: ['dex', 2], // Expertise
          survival: ['wis', 2]  // Expertise
        },
        abilities: [
          { id: 'multiattack', name: 'Multiattack', icon: '‚öîÔ∏è', damage: '2d8+4', description: 'Make two attacks' },
          { id: 'arrow_volley', name: 'Arrow Volley', icon: 'üèπ', damage: '3d8', description: 'Rain arrows on area' }
        ],
        spells: {
          0: [
            { id: 'fire_bolt', name: 'Fire Bolt', icon: 'üî•', damage: '1d10', description: 'Hurl a mote of fire at a creature or object.', school: 'Evocation', castingTime: '1 action', range: '120 feet', components: 'V, S', duration: 'Instantaneous', attackRoll: true }
          ],
          1: [
            { id: 'hunters_mark', name: "Hunter's Mark", prepared: true, icon: 'üéØ', damage: '1d6', description: 'Mark a target for extra damage. When you hit with a weapon attack, add 1d6 extra damage.', school: 'Divination', castingTime: '1 bonus action', range: '90 feet', components: 'V', duration: '1 hour', concentration: true },
            { id: 'cure_wounds', name: 'Cure Wounds', prepared: true, icon: '‚ù§Ô∏è', damage: '1d8+3', description: 'Touch a creature to restore hit points.', school: 'Evocation', castingTime: '1 action', range: 'Touch', components: 'V, S', duration: 'Instantaneous' },
            { id: 'goodberry', name: 'Goodberry', prepared: false, icon: 'ü´ê', damage: null, description: 'Create 10 berries that heal 1 HP each and provide nourishment.', school: 'Transmutation', castingTime: '1 action', range: 'Touch', components: 'V, S, M', duration: '24 hours' }
          ],
          2: [
            { id: 'pass_without_trace', name: 'Pass Without Trace', prepared: true, icon: 'üëª', damage: null, description: 'Creatures you choose within 30 feet gain +10 to Stealth checks.', school: 'Abjuration', castingTime: '1 action', range: '30 feet', components: 'V, S, M', duration: '1 hour', concentration: true },
            { id: 'spike_growth', name: 'Spike Growth', prepared: false, icon: 'üåø', damage: '2d4', description: 'Ground in a 20-foot radius becomes difficult terrain covered with spikes. Creatures take 2d4 damage per 5 feet moved.', school: 'Transmutation', castingTime: '1 action', range: '150 feet', components: 'V, S, M', duration: '10 minutes', concentration: true, save: 'Dexterity' }
          ]
        },
        states: {
          default: { mood: 'calm', greeting: 'You find me studying tracks in the forest. The creatures here have been acting strangely...' },
          battle: { mood: 'focused', greeting: 'Enemy sighted! Ready your weapons!' },
          injured: { mood: 'pained', greeting: '*winces* I\'ve seen better days...' },
          angry: { mood: 'furious', greeting: 'Those poachers will pay for what they\'ve done!' },
          triumphant: { mood: 'joyful', greeting: 'We did it! The forest is safe once more!' }
        }
      },
      {
        id: 'theron',
        name: 'Theron Brightshield',
        emoji: 'üõ°Ô∏è',
        class: 'Paladin',
        subclass: 'Oath of Vengeance',
        race: 'Human',
        alignment: 'Lawful Good',
        classType: 'halfcaster',
        level: 10,
        hp: { current: 88, max: 104 },
        ac: 18,
        food: { current: 85, max: 100 },
        stats: { str: 18, dex: 10, con: 16, int: 10, wis: 14, cha: 16 },
        // portrait: 'https://i.imgur.com/8KfPqXJ.png', // Placeholder - using emoji instead
        location: 'temple',
        attacks: {
          melee: { name: 'Longsword of Justice', damage: '1d8+5', toHit: 9 },
          ranged: { name: 'Javelin', damage: '1d6+4', toHit: 8 }
        },
        inventory: [
          { id: 'longsword', name: 'Longsword of Justice', type: 'weapon', equipped: true, attuned: true },
          { id: 'shield', name: 'Shield +1', type: 'armor', equipped: true, attuned: true },
          { id: 'amulet', name: 'Amulet of Health', type: 'gear', equipped: true, attuned: true },
          { id: 'plate_armor', name: 'Plate Armor', type: 'armor', equipped: true },
          { id: 'holy_symbol', name: 'Holy Symbol', type: 'gear', equipped: true },
          { id: 'healing_potion', name: 'Potion of Greater Healing', type: 'consumable', quantity: 2 },
          { id: 'oil_of_sharpness', name: 'Oil of Sharpness', type: 'consumable', quantity: 1 }
        ],
        skills: {
          acrobatics: ['dex', 0],
          animalHandling: ['wis', 0],
          arcana: ['int', 0],
          athletics: ['str', 1],
          deception: ['cha', 0],
          history: ['int', 0],
          insight: ['wis', 1],
          intimidation: ['cha', 1],
          investigation: ['int', 0],
          medicine: ['wis', 1],
          nature: ['int', 0],
          perception: ['wis', 0],
          performance: ['cha', 0],
          persuasion: ['cha', 1],
          religion: ['int', 1],
          sleightOfHand: ['dex', 0],
          stealth: ['dex', 0],
          survival: ['wis', 0]
        },
        abilities: [
          { id: 'divine_smite', name: 'Divine Smite', icon: '‚ö°', damage: '4d8', description: 'Channel divine energy into your strike' },
          { id: 'lay_on_hands', name: 'Lay on Hands', icon: '‚ú®', damage: '50', description: 'Heal with divine touch' },
          { id: 'shield_bash', name: 'Shield Bash', icon: 'üõ°Ô∏è', damage: '1d8+4', description: 'Bash with your shield' },
          { id: 'aura_courage', name: 'Aura of Courage', icon: 'üí™', damage: null, description: 'Grant allies immunity to fear' }
        ],
        spells: {
          0: [
            { id: 'sacred_flame', name: 'Sacred Flame', icon: 'üî•', damage: '1d8', description: 'Flame-like radiance descends on a creature.', school: 'Evocation', castingTime: '1 action', range: '60 feet', components: 'V, S', duration: 'Instantaneous', save: 'Dexterity' }
          ],
          1: [
            { id: 'bless', name: 'Bless', prepared: true, icon: '‚ú®', damage: null, description: 'Up to 3 creatures add 1d4 to attack rolls and saving throws.', school: 'Enchantment', castingTime: '1 action', range: '30 feet', components: 'V, S, M', duration: '1 minute', concentration: true },
            { id: 'cure_wounds', name: 'Cure Wounds', prepared: true, icon: '‚ù§Ô∏è', damage: '1d8+3', description: 'Touch a creature to restore hit points.', school: 'Evocation', castingTime: '1 action', range: 'Touch', components: 'V, S', duration: 'Instantaneous' },
            { id: 'shield_of_faith', name: 'Shield of Faith', prepared: true, icon: 'üõ°Ô∏è', damage: null, description: 'A creature gains +2 to AC.', school: 'Abjuration', castingTime: '1 bonus action', range: '60 feet', components: 'V, S, M', duration: '10 minutes', concentration: true }
          ],
          2: [
            { id: 'aid', name: 'Aid', prepared: true, icon: 'üí™', damage: null, description: 'Increase max HP of up to 3 creatures by 5.', school: 'Abjuration', castingTime: '1 action', range: '30 feet', components: 'V, S, M', duration: '8 hours' },
            { id: 'lesser_restoration', name: 'Lesser Restoration', prepared: false, icon: 'ü©π', damage: null, description: 'End one disease or condition affecting a creature.', school: 'Abjuration', castingTime: '1 action', range: 'Touch', components: 'V, S', duration: 'Instantaneous' }
          ],
          3: [
            { id: 'aura_of_vitality', name: 'Aura of Vitality', prepared: true, icon: '‚ù§Ô∏è‚Äçüî•', damage: '2d6', description: 'Healing energy radiates from you. Use bonus action to heal a creature 2d6 HP.', school: 'Evocation', castingTime: '1 action', range: 'Self (30-foot radius)', components: 'V', duration: '1 minute', concentration: true },
            { id: 'revivify', name: 'Revivify', prepared: false, icon: '‚ö∞Ô∏è', damage: null, description: 'Return a creature to life that died within the last minute.', school: 'Necromancy', castingTime: '1 action', range: 'Touch', components: 'V, S, M (diamonds worth 300gp)', duration: 'Instantaneous' }
          ]
        },
        states: {
          default: { mood: 'noble', greeting: 'Greetings, friend. How may I serve justice this day?' },
          battle: { mood: 'righteous', greeting: 'By the light, evil shall not prevail!' },
          injured: { mood: 'determined', greeting: 'A mere scratch. I will not fall!' },
          angry: { mood: 'wrathful', greeting: 'You dare commit such atrocities?!' },
          triumphant: { mood: 'blessed', greeting: 'The light has guided us to victory!' }
        }
      },
      {
        id: 'zara',
        name: 'Zara Infernalis',
        emoji: 'üîÆ',
        class: 'Wizard',
        subclass: 'School of Evocation',
        race: 'Tiefling',
        alignment: 'Chaotic Neutral',
        classType: 'caster',
        level: 9,
        hp: { current: 42, max: 54 },
        ac: 13,
        food: { current: 45, max: 100 },
        stats: { str: 8, dex: 14, con: 13, int: 20, wis: 12, cha: 11 },
        // portrait: 'https://i.imgur.com/mBvN2dK.png', // Placeholder - using emoji instead
        location: 'ruins',
        attacks: {
          melee: { name: 'Quarterstaff', damage: '1d6-1', toHit: 1 },
          ranged: null // Wizards typically don't use ranged weapons
        },
        inventory: [
          { id: 'staff', name: 'Staff of Power', type: 'weapon', equipped: true },
          { id: 'robes', name: 'Robes of the Archmagi', type: 'armor', equipped: true },
          { id: 'component_pouch', name: 'Component Pouch', type: 'gear', equipped: true },
          { id: 'spellbook', name: 'Spellbook', type: 'gear', equipped: true },
          { id: 'scroll_fireball', name: 'Scroll of Fireball', type: 'consumable', quantity: 1 },
          { id: 'scroll_counterspell', name: 'Scroll of Counterspell', type: 'consumable', quantity: 2 }
        ],
        skills: {
          acrobatics: ['dex', 0],
          animalHandling: ['wis', 0],
          arcana: ['int', 2], // Expertise
          athletics: ['str', 0],
          deception: ['cha', 0],
          history: ['int', 1],
          insight: ['wis', 0],
          intimidation: ['cha', 0],
          investigation: ['int', 1],
          medicine: ['wis', 0],
          nature: ['int', 1],
          perception: ['wis', 0],
          performance: ['cha', 0],
          persuasion: ['cha', 0],
          religion: ['int', 1],
          sleightOfHand: ['dex', 0],
          stealth: ['dex', 0],
          survival: ['wis', 0]
        },
        abilities: [],
        spells: {
          0: [
            { id: 'fire_bolt', name: 'Fire Bolt', prepared: true, icon: 'üî•', damage: '2d10', description: 'Ranged fire attack cantrip' },
            { id: 'mage_hand', name: 'Mage Hand', prepared: true, icon: '‚úã', damage: null, description: 'Telekinetic manipulation' },
            { id: 'prestidigitation', name: 'Prestidigitation', prepared: true, icon: '‚ú®', damage: null, description: 'Minor magical trick' }
          ],
          1: [
            { id: 'magic_missile', name: 'Magic Missile', prepared: true, icon: '‚ú®', damage: '3d4+3', description: 'Unerring magical darts' },
            { id: 'shield', name: 'Shield', prepared: true, icon: 'üõ°Ô∏è', damage: null, description: '+5 AC until your next turn' },
            { id: 'detect_magic', name: 'Detect Magic', prepared: false, icon: 'üîÆ', damage: null, description: 'Sense magical auras' }
          ],
          2: [
            { id: 'misty_step', name: 'Misty Step', prepared: true, icon: 'üí®', damage: null, description: 'Teleport 30 feet' },
            { id: 'scorching_ray', name: 'Scorching Ray', prepared: false, icon: 'üî•', damage: '2d6', description: 'Three rays of fire' }
          ],
          3: [
            { id: 'fireball', name: 'Fireball', prepared: true, icon: 'üî•', damage: '8d6', description: 'Devastating explosion of flame' },
            { id: 'counterspell', name: 'Counterspell', prepared: true, icon: 'üö´', damage: null, description: 'Negate enemy spells' },
            { id: 'lightning_bolt', name: 'Lightning Bolt', prepared: false, icon: '‚ö°', damage: '8d6', description: 'Line of electrical energy' }
          ],
          4: [
            { id: 'polymorph', name: 'Polymorph', prepared: true, icon: 'üê∏', damage: null, description: 'Transform target into beast' },
            { id: 'wall_of_fire', name: 'Wall of Fire', prepared: false, icon: 'üî•', damage: '5d8', description: 'Create wall of flames' }
          ],
          5: [
            { id: 'cone_of_cold', name: 'Cone of Cold', prepared: true, icon: '‚ùÑÔ∏è', damage: '8d8', description: 'Blast of frigid air' },
            { id: 'wall_of_force', name: 'Wall of Force', prepared: false, icon: 'üõ°Ô∏è', damage: null, description: 'Invisible wall' }
          ]
        },
        states: {
          default: { mood: 'curious', greeting: 'Fascinating... the magical energies here are quite unusual.' },
          battle: { mood: 'calculating', greeting: 'Let me show you the true power of the arcane!' },
          injured: { mood: 'weakened', greeting: 'My concentration... slipping...' },
          angry: { mood: 'volatile', greeting: 'You\'ve made a grave mistake interrupting my research!' },
          triumphant: { mood: 'smug', greeting: 'As I predicted, victory was inevitable.' }
        }
      },
      {
        id: 'kael',
        name: 'Kael Quickfingers',
        emoji: 'üó°Ô∏è',
        class: 'Rogue',
        subclass: 'Arcane Trickster',
        race: 'Halfling',
        alignment: 'Chaotic Good',
        classType: 'melee',
        level: 7,
        hp: { current: 38, max: 45 },
        ac: 15,
        food: { current: 60, max: 100 },
        stats: { str: 10, dex: 20, con: 12, int: 14, wis: 13, cha: 14 },
        // portrait: 'https://i.imgur.com/RkH7Wd0.png', // Placeholder - using emoji instead
        location: 'tavern',
        attacks: {
          melee: { name: 'Rapier +1', damage: '1d8+6', toHit: 9 },
          ranged: { name: 'Dagger (Thrown)', damage: '1d4+5', toHit: 9 }
        },
        inventory: [
          { id: 'rapier', name: 'Rapier +1', type: 'weapon', equipped: true },
          { id: 'dagger', name: 'Dagger', type: 'weapon', equipped: true, quantity: 3 },
          { id: 'leather_armor', name: 'Studded Leather Armor', type: 'armor', equipped: true },
          { id: 'thieves_tools', name: "Thieves' Tools", type: 'gear', equipped: true },
          { id: 'healing_potion', name: 'Potion of Healing', type: 'consumable', quantity: 2 },
          { id: 'poison', name: 'Vial of Poison', type: 'consumable', quantity: 3 },
          { id: 'grappling_hook', name: 'Grappling Hook', type: 'gear', quantity: 1 }
        ],
        skills: {
          acrobatics: ['dex', 2], // Expertise
          animalHandling: ['wis', 0],
          arcana: ['int', 0],
          athletics: ['str', 0],
          deception: ['cha', 1],
          history: ['int', 0],
          insight: ['wis', 0],
          intimidation: ['cha', 0],
          investigation: ['int', 1],
          medicine: ['wis', 0],
          nature: ['int', 0],
          perception: ['wis', 1],
          performance: ['cha', 0],
          persuasion: ['cha', 1],
          religion: ['int', 0],
          sleightOfHand: ['dex', 2], // Expertise
          stealth: ['dex', 2], // Expertise
          survival: ['wis', 0]
        },
        abilities: [
          { id: 'sneak_attack', name: 'Sneak Attack', icon: 'üó°Ô∏è', damage: '4d6', description: 'Strike from the shadows' },
          { id: 'cunning_action', name: 'Cunning Action', icon: 'üí®', damage: null, description: 'Bonus action dash/disengage/hide' },
          { id: 'evasion', name: 'Evasion', icon: 'ü§∏', damage: null, description: 'Dodge area effects' },
          { id: 'thieves_tools', name: "Thieves' Tools", icon: 'üîì', damage: null, description: 'Pick locks and disable traps' }
        ],
        spells: {
          0: [
            { id: 'mage_hand', name: 'Mage Hand', icon: '‚úã', damage: null, description: 'Invisible spectral hand for manipulation', school: 'Conjuration', castingTime: '1 action', range: '30 feet', components: 'V, S', duration: '1 minute' },
            { id: 'minor_illusion', name: 'Minor Illusion', icon: 'üëª', damage: null, description: 'Create sound or image illusion', school: 'Illusion', castingTime: '1 action', range: '30 feet', components: 'S, M', duration: '1 minute' }
          ],
          1: [
            { id: 'disguise_self', name: 'Disguise Self', prepared: true, icon: 'üé≠', damage: null, description: 'Change your appearance', school: 'Illusion', castingTime: '1 action', range: 'Self', components: 'V, S', duration: '1 hour' },
            { id: 'charm_person', name: 'Charm Person', prepared: true, icon: 'üíñ', damage: null, description: 'Make humanoid friendly', school: 'Enchantment', castingTime: '1 action', range: '30 feet', components: 'V, S', duration: '1 hour', save: 'Wisdom' }
          ]
        },
        states: {
          default: { mood: 'sly', greeting: '*leaning casually* Well, well, what brings you to this part of town?' },
          battle: { mood: 'focused', greeting: 'Time to disappear... *fades into shadows*' },
          injured: { mood: 'grimacing', greeting: '*clutching side* Not my best day...' },
          angry: { mood: 'vengeful', greeting: 'You\'ll regret double-crossing me!' },
          triumphant: { mood: 'cocky', greeting: '*twirling dagger* Too easy. What\'s next?' }
        }
      }
    ];


    // Common D&D Abilities Database
    const abilityDatabase = {
      barbarian: [
        { id: 'rage', name: 'Rage', icon: 'üò°', damage: null, description: 'Gain advantage on STR checks, +2 damage, resistance to physical damage' },
        { id: 'reckless_attack', name: 'Reckless Attack', icon: 'üí•', damage: null, description: 'Gain advantage on attack rolls, enemies have advantage against you' },
        { id: 'danger_sense', name: 'Danger Sense', icon: '‚ö†Ô∏è', damage: null, description: 'Advantage on DEX saves against effects you can see' }
      ],
      bard: [
        { id: 'bardic_inspiration', name: 'Bardic Inspiration', icon: 'üéµ', damage: '1d6', description: 'Grant ally inspiration die to add to ability check, attack, or save' },
        { id: 'jack_of_all_trades', name: 'Jack of All Trades', icon: 'üé≠', damage: null, description: 'Add half proficiency to any ability check you make' },
        { id: 'cutting_words', name: 'Cutting Words', icon: 'üó£Ô∏è', damage: '1d6', description: 'Subtract inspiration die from enemy attack or ability check' }
      ],
      cleric: [
        { id: 'channel_divinity', name: 'Channel Divinity', icon: '‚úùÔ∏è', damage: null, description: 'Use divine energy for various effects based on domain' },
        { id: 'turn_undead', name: 'Turn Undead', icon: 'üëª', damage: null, description: 'Force undead to flee if they fail WIS save' },
        { id: 'divine_intervention', name: 'Divine Intervention', icon: 'üôè', damage: null, description: 'Ask deity for direct intervention' }
      ],
      druid: [
        { id: 'wild_shape', name: 'Wild Shape', icon: 'üê∫', damage: null, description: 'Transform into beast you have seen' },
        { id: 'natural_recovery', name: 'Natural Recovery', icon: 'üåø', damage: null, description: 'Recover spell slots during short rest' },
        { id: 'beast_spells', name: 'Beast Spells', icon: 'ü¶Ö', damage: null, description: 'Cast spells while in Wild Shape' }
      ],
      fighter: [
        { id: 'action_surge', name: 'Action Surge', icon: '‚ö°', damage: null, description: 'Take additional action on your turn' },
        { id: 'second_wind', name: 'Second Wind', icon: 'üí®', damage: '1d10+10', description: 'Regain hit points as bonus action' },
        { id: 'extra_attack', name: 'Extra Attack', icon: '‚öîÔ∏è', damage: null, description: 'Attack twice when you take Attack action' },
        { id: 'indomitable', name: 'Indomitable', icon: 'üõ°Ô∏è', damage: null, description: 'Reroll failed saving throw' }
      ],
      monk: [
        { id: 'flurry_of_blows', name: 'Flurry of Blows', icon: 'üëä', damage: '2d6', description: 'Make two unarmed strikes as bonus action' },
        { id: 'patient_defense', name: 'Patient Defense', icon: 'ü•ã', damage: null, description: 'Dodge as bonus action' },
        { id: 'step_of_the_wind', name: 'Step of the Wind', icon: 'üí®', damage: null, description: 'Dash or Disengage as bonus action, jump distance doubled' },
        { id: 'stunning_strike', name: 'Stunning Strike', icon: '‚≠ê', damage: null, description: 'Target must succeed CON save or be stunned' },
        { id: 'deflect_missiles', name: 'Deflect Missiles', icon: 'üõ°Ô∏è', damage: '1d10+20', description: 'Reduce damage from ranged attacks' },
        { id: 'slow_fall', name: 'Slow Fall', icon: 'ü™Ç', damage: null, description: 'Reduce falling damage by 5x monk level' },
        { id: 'ki_empowered_strikes', name: 'Ki-Empowered Strikes', icon: '‚ú®', damage: null, description: 'Unarmed strikes count as magical' }
      ],
      paladin: [
        { id: 'lay_on_hands', name: 'Lay on Hands', icon: 'üôå', damage: null, description: 'Heal hit points or cure disease/poison' },
        { id: 'divine_smite', name: 'Divine Smite', icon: '‚ö°', damage: '2d8', description: 'Expend spell slot to deal extra radiant damage' },
        { id: 'divine_sense', name: 'Divine Sense', icon: 'üëÅÔ∏è', damage: null, description: 'Detect celestials, fiends, undead nearby' },
        { id: 'aura_of_protection', name: 'Aura of Protection', icon: 'üõ°Ô∏è', damage: null, description: 'You and allies within 10ft get bonus to saves' }
      ],
      ranger: [
        { id: 'favored_enemy', name: 'Favored Enemy', icon: 'üéØ', damage: null, description: 'Advantage on tracking and INT checks about chosen foe' },
        { id: 'natural_explorer', name: 'Natural Explorer', icon: 'üó∫Ô∏è', damage: null, description: 'Expertise in navigation and tracking in favored terrain' },
        { id: 'primeval_awareness', name: 'Primeval Awareness', icon: 'üëÅÔ∏è', damage: null, description: 'Sense presence of certain creature types' },
        { id: 'colossus_slayer', name: 'Colossus Slayer', icon: '‚öîÔ∏è', damage: '1d8', description: 'Deal extra damage to injured enemies once per turn' }
      ],
      rogue: [
        { id: 'sneak_attack', name: 'Sneak Attack', icon: 'üó°Ô∏è', damage: '10d6', description: 'Deal extra damage when you have advantage' },
        { id: 'cunning_action', name: 'Cunning Action', icon: 'üí®', damage: null, description: 'Dash, Disengage, or Hide as bonus action' },
        { id: 'evasion', name: 'Evasion', icon: 'ü§∏', damage: null, description: 'Take no damage on successful DEX save, half on failure' },
        { id: 'uncanny_dodge', name: 'Uncanny Dodge', icon: 'üõ°Ô∏è', damage: null, description: 'Halve damage from one attack as reaction' }
      ],
      sorcerer: [
        { id: 'metamagic', name: 'Metamagic', icon: 'üîÆ', damage: null, description: 'Modify spells with sorcery points' },
        { id: 'twinned_spell', name: 'Twinned Spell', icon: 'üë•', damage: null, description: 'Target second creature with single-target spell' },
        { id: 'quickened_spell', name: 'Quickened Spell', icon: '‚ö°', damage: null, description: 'Cast spell as bonus action' }
      ],
      warlock: [
        { id: 'eldritch_blast', name: 'Eldritch Blast', icon: 'üí•', damage: '4d10', description: 'Warlock signature cantrip attack' },
        { id: 'agonizing_blast', name: 'Agonizing Blast', icon: 'üòà', damage: null, description: 'Add CHA modifier to Eldritch Blast damage' },
        { id: 'hex', name: 'Hex', icon: 'üéØ', damage: '1d6', description: 'Curse target to deal extra necrotic damage' },
        { id: 'eldritch_invocations', name: 'Eldritch Invocations', icon: 'üëÅÔ∏è', damage: null, description: 'Special warlock abilities granted by patron' }
      ],
      wizard: [
        { id: 'arcane_recovery', name: 'Arcane Recovery', icon: 'üîÑ', damage: null, description: 'Recover spell slots during short rest' },
        { id: 'spell_mastery', name: 'Spell Mastery', icon: 'üìñ', damage: null, description: 'Cast certain spells at will' },
        { id: 'signature_spells', name: 'Signature Spells', icon: '‚úçÔ∏è', damage: null, description: 'Always have two 3rd level spells prepared' }
      ]
    };

    // 5e Spell Progression Tables (spells known/in spellbook by level)
    const spellsKnownProgression = {
      // Full casters - Known spells
      bard: [0, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 15, 16, 18, 19, 20, 22, 22, 22],
      sorcerer: [0, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 12, 13, 13, 14, 14, 15, 15, 15, 15],
      warlock: [0, 2, 3, 4, 5, 6, 7, 8, 9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15],
      // Half casters - Known spells
      ranger: [0, 0, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11],
      // Prepared casters - these numbers represent spellbook size for wizards
      wizard: [0, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44],
      // Prepared casters (Cleric, Druid, Paladin) have access to full class list
      // They can prepare: spellcasting_mod + level spells
    };

    // Cantrips known progression
    const cantripsKnownProgression = {
      bard: [0, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4],
      cleric: [0, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5],
      druid: [0, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4],
      sorcerer: [0, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6],
      warlock: [0, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4],
      wizard: [0, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5]
    };


    // Subclass-themed spell suggestions
    const subclassSpells = {
      // Wizard subclasses
      'School of Evocation': {
        cantrips: ['fire_bolt', 'ray_of_frost'],
        1: ['burning_hands', 'magic_missile', 'thunderwave'],
        2: ['scorching_ray', 'shatter'],
        3: ['fireball', 'lightning_bolt'],
        4: ['ice_storm', 'wall_of_fire'],
        5: ['cone_of_cold']
      },
      'School of Abjuration': {
        cantrips: ['mage_hand', 'light'],
        1: ['shield', 'mage_armor', 'alarm'],
        2: ['arcane_lock', 'mirror_image'],
        3: ['counterspell', 'dispel_magic'],
        4: ['banishment', 'dimension_door'],
        5: ['wall_of_force']
      },
      // Cleric domains
      'Life Domain': {
        cantrips: ['sacred_flame', 'guidance', 'light'],
        1: ['cure_wounds', 'bless', 'healing_word'],
        2: ['prayer_of_healing', 'lesser_restoration', 'spiritual_weapon'],
        3: ['mass_healing_word', 'revivify', 'beacon_of_hope'],
        4: ['death_ward', 'guardian_of_faith'],
        5: ['mass_cure_wounds', 'raise_dead']
      },
      'Light Domain': {
        cantrips: ['sacred_flame', 'light', 'guidance'],
        1: ['burning_hands', 'faerie_fire', 'cure_wounds'],
        2: ['scorching_ray', 'flaming_sphere'],
        3: ['fireball', 'daylight'],
        4: ['wall_of_fire', 'guardian_of_faith'],
        5: ['flame_strike']
      },
      // Sorcerer bloodlines
      'Draconic Bloodline': {
        cantrips: ['fire_bolt', 'mage_hand', 'prestidigitation'],
        1: ['burning_hands', 'shield', 'mage_armor'],
        2: ['scorching_ray', 'dragon_breath'],
        3: ['fireball', 'fly', 'fear'],
        4: ['wall_of_fire', 'polymorph'],
        5: ['cone_of_cold', 'dominate_person']
      },
      // Warlock patrons
      'The Fiend': {
        cantrips: ['eldritch_blast', 'mage_hand'],
        1: ['burning_hands', 'command', 'hex'],
        2: ['scorching_ray', 'suggestion'],
        3: ['fireball', 'vampiric_touch'],
        4: ['wall_of_fire', 'dimension_door'],
        5: ['flame_strike']
      },
      // Druid circles
      'Circle of the Moon': {
        cantrips: ['guidance', 'produce_flame', 'shillelagh'],
        1: ['cure_wounds', 'entangle', 'goodberry'],
        2: ['moonbeam', 'pass_without_trace', 'healing_spirit'],
        3: ['call_lightning', 'conjure_animals'],
        4: ['polymorph', 'giant_insect'],
        5: ['mass_cure_wounds']
      },
      // Bard colleges
      'College of Lore': {
        cantrips: ['vicious_mockery', 'mage_hand', 'minor_illusion'],
        1: ['cure_wounds', 'healing_word', 'detect_magic', 'identify'],
        2: ['invisibility', 'suggestion', 'heat_metal'],
        3: ['counterspell', 'hypnotic_pattern'],
        4: ['polymorph', 'dimension_door'],
        5: ['mass_cure_wounds', 'dominate_person']
      }
    };

    // Spell definitions with more complete data
    const spellDefinitions = {
      // Cantrips
      fire_bolt: { name: 'Fire Bolt', icon: 'üî•', damage: '1d10', school: 'Evocation', description: 'Hurl a mote of fire at a creature', castingTime: '1 action', range: '120 feet', components: 'V, S', duration: 'Instantaneous', attackRoll: true },
      ray_of_frost: { name: 'Ray of Frost', icon: '‚ùÑÔ∏è', damage: '1d8', school: 'Evocation', description: 'Frigid beam of blue-white light', castingTime: '1 action', range: '60 feet', components: 'V, S', duration: 'Instantaneous', attackRoll: true },
      sacred_flame: { name: 'Sacred Flame', icon: '‚ú®', damage: '1d8', school: 'Evocation', description: 'Flame-like radiance descends', castingTime: '1 action', range: '60 feet', components: 'V, S', duration: 'Instantaneous', save: 'Dexterity' },
      guidance: { name: 'Guidance', icon: 'üôè', damage: null, school: 'Divination', description: 'Touch creature to add d4 to ability check', castingTime: '1 action', range: 'Touch', components: 'V, S', duration: '1 minute', concentration: true },
      mage_hand: { name: 'Mage Hand', icon: '‚úã', damage: null, school: 'Conjuration', description: 'Spectral floating hand', castingTime: '1 action', range: '30 feet', components: 'V, S', duration: '1 minute' },
      eldritch_blast: { name: 'Eldritch Blast', icon: 'üí•', damage: '1d10', school: 'Evocation', description: 'Crackling beam of energy', castingTime: '1 action', range: '120 feet', components: 'V, S', duration: 'Instantaneous', attackRoll: true },
      light: { name: 'Light', icon: 'üí°', damage: null, school: 'Evocation', description: 'Object sheds bright light', castingTime: '1 action', range: 'Touch', components: 'V, M', duration: '1 hour' },
      vicious_mockery: { name: 'Vicious Mockery', icon: 'üó£Ô∏è', damage: '1d4', school: 'Enchantment', description: 'Unleash string of insults', castingTime: '1 action', range: '60 feet', components: 'V', duration: 'Instantaneous', save: 'Wisdom' },
      produce_flame: { name: 'Produce Flame', icon: 'üî•', damage: '1d8', school: 'Conjuration', description: 'Flickering flame in palm', castingTime: '1 action', range: 'Self', components: 'V, S', duration: '10 minutes', attackRoll: true },
      prestidigitation: { name: 'Prestidigitation', icon: '‚ú®', damage: null, school: 'Transmutation', description: 'Minor magical trick', castingTime: '1 action', range: '10 feet', components: 'V, S', duration: '1 hour' },
      minor_illusion: { name: 'Minor Illusion', icon: 'üëª', damage: null, school: 'Illusion', description: 'Create sound or image', castingTime: '1 action', range: '30 feet', components: 'S, M', duration: '1 minute' },
      shillelagh: { name: 'Shillelagh', icon: 'ü™µ', damage: '1d8', school: 'Transmutation', description: 'Imbue club with nature magic', castingTime: '1 bonus action', range: 'Touch', components: 'V, S, M', duration: '1 minute' },

      // Level 1
      burning_hands: { name: 'Burning Hands', icon: 'üî•', damage: '3d6', school: 'Evocation', description: 'Thin sheet of flames', castingTime: '1 action', range: 'Self (15-foot cone)', components: 'V, S', duration: 'Instantaneous', save: 'Dexterity' },
      magic_missile: { name: 'Magic Missile', icon: '‚ú®', damage: '3d4+3', school: 'Evocation', description: 'Three darts of magical force', castingTime: '1 action', range: '120 feet', components: 'V, S', duration: 'Instantaneous' },
      shield: { name: 'Shield', icon: 'üõ°Ô∏è', damage: null, school: 'Abjuration', description: '+5 AC until your next turn', castingTime: '1 reaction', range: 'Self', components: 'V, S', duration: '1 round' },
      cure_wounds: { name: 'Cure Wounds', icon: '‚ù§Ô∏è', damage: '1d8+3', school: 'Evocation', description: 'Heal creature you touch', castingTime: '1 action', range: 'Touch', components: 'V, S', duration: 'Instantaneous' },
      bless: { name: 'Bless', icon: '‚ú®', damage: null, school: 'Enchantment', description: 'Add d4 to attacks and saves', castingTime: '1 action', range: '30 feet', components: 'V, S, M', duration: '1 minute', concentration: true },
      healing_word: { name: 'Healing Word', icon: 'üíö', damage: '1d4+3', school: 'Evocation', description: 'Heal with a word', castingTime: '1 bonus action', range: '60 feet', components: 'V', duration: 'Instantaneous' },
      thunderwave: { name: 'Thunderwave', icon: '‚ö°', damage: '2d8', school: 'Evocation', description: 'Wave of thunderous force', castingTime: '1 action', range: 'Self (15-foot cube)', components: 'V, S', duration: 'Instantaneous', save: 'Constitution' },
      mage_armor: { name: 'Mage Armor', icon: 'üõ°Ô∏è', damage: null, school: 'Abjuration', description: 'Base AC becomes 13 + DEX', castingTime: '1 action', range: 'Touch', components: 'V, S, M', duration: '8 hours' },
      hex: { name: 'Hex', icon: 'üéØ', damage: '1d6', school: 'Enchantment', description: 'Curse target for extra damage', castingTime: '1 bonus action', range: '90 feet', components: 'V, S, M', duration: '1 hour', concentration: true },
      entangle: { name: 'Entangle', icon: 'üåø', damage: null, school: 'Conjuration', description: 'Grasping weeds and vines', castingTime: '1 action', range: '90 feet', components: 'V, S', duration: '1 minute', concentration: true, save: 'Strength' },
      goodberry: { name: 'Goodberry', icon: 'ü´ê', damage: null, school: 'Transmutation', description: '10 berries that heal 1 HP each', castingTime: '1 action', range: 'Touch', components: 'V, S, M', duration: '24 hours' },
      detect_magic: { name: 'Detect Magic', icon: 'üîÆ', damage: null, school: 'Divination', description: 'Sense presence of magic', castingTime: '1 action', range: 'Self', components: 'V, S', duration: '10 minutes', concentration: true },

      // Level 2
      scorching_ray: { name: 'Scorching Ray', icon: 'üî•', damage: '2d6', school: 'Evocation', description: 'Three rays of fire', castingTime: '1 action', range: '120 feet', components: 'V, S', duration: 'Instantaneous', attackRoll: true },
      shatter: { name: 'Shatter', icon: 'üí•', damage: '3d8', school: 'Evocation', description: 'Sudden loud ringing noise', castingTime: '1 action', range: '60 feet', components: 'V, S, M', duration: 'Instantaneous', save: 'Constitution' },
      spiritual_weapon: { name: 'Spiritual Weapon', icon: '‚öîÔ∏è', damage: '1d8+3', school: 'Evocation', description: 'Floating spectral weapon', castingTime: '1 bonus action', range: '60 feet', components: 'V, S', duration: '1 minute' },
      moonbeam: { name: 'Moonbeam', icon: 'üåô', damage: '2d10', school: 'Evocation', description: 'Column of silvery light', castingTime: '1 action', range: '120 feet', components: 'V, S, M', duration: '1 minute', concentration: true, save: 'Constitution' },
      prayer_of_healing: { name: 'Prayer of Healing', icon: 'üôè', damage: '2d8+3', school: 'Evocation', description: 'Heal up to 6 creatures', castingTime: '10 minutes', range: '30 feet', components: 'V', duration: 'Instantaneous' },

      // Level 3
      fireball: { name: 'Fireball', icon: 'üî•', damage: '8d6', school: 'Evocation', description: 'Streak of flame explodes', castingTime: '1 action', range: '150 feet', components: 'V, S, M', duration: 'Instantaneous', save: 'Dexterity' },
      lightning_bolt: { name: 'Lightning Bolt', icon: '‚ö°', damage: '8d6', school: 'Evocation', description: 'Stroke of lightning', castingTime: '1 action', range: 'Self (100-foot line)', components: 'V, S, M', duration: 'Instantaneous', save: 'Dexterity' },
      counterspell: { name: 'Counterspell', icon: 'üö´', damage: null, school: 'Abjuration', description: 'Interrupt creature casting spell', castingTime: '1 reaction', range: '60 feet', components: 'S', duration: 'Instantaneous' },
      dispel_magic: { name: 'Dispel Magic', icon: '‚úã', damage: null, school: 'Abjuration', description: 'End spells on target', castingTime: '1 action', range: '120 feet', components: 'V, S', duration: 'Instantaneous' },
      revivify: { name: 'Revivify', icon: 'üí´', damage: null, school: 'Necromancy', description: 'Return creature to life', castingTime: '1 action', range: 'Touch', components: 'V, S, M', duration: 'Instantaneous' },
      mass_healing_word: { name: 'Mass Healing Word', icon: 'üíö', damage: '1d4+3', school: 'Evocation', description: 'Heal up to 6 creatures', castingTime: '1 bonus action', range: '60 feet', components: 'V', duration: 'Instantaneous' },
      call_lightning: { name: 'Call Lightning', icon: '‚ö°', damage: '3d10', school: 'Conjuration', description: 'Storm cloud rains lightning', castingTime: '1 action', range: '120 feet', components: 'V, S', duration: '10 minutes', concentration: true, save: 'Dexterity' },
      hypnotic_pattern: { name: 'Hypnotic Pattern', icon: 'üåÄ', damage: null, school: 'Illusion', description: 'Twisting pattern of colors', castingTime: '1 action', range: '120 feet', components: 'S, M', duration: '1 minute', concentration: true, save: 'Wisdom' },
      fly: { name: 'Fly', icon: 'ü¶Ö', damage: null, school: 'Transmutation', description: 'Grant flying speed', castingTime: '1 action', range: 'Touch', components: 'V, S, M', duration: '10 minutes', concentration: true },

      // Level 4-5
      polymorph: { name: 'Polymorph', icon: 'üê∏', damage: null, school: 'Transmutation', description: 'Transform into beast', castingTime: '1 action', range: '60 feet', components: 'V, S, M', duration: '1 hour', concentration: true, save: 'Wisdom' },
      wall_of_fire: { name: 'Wall of Fire', icon: 'üî•', damage: '5d8', school: 'Evocation', description: 'Wall of flames', castingTime: '1 action', range: '120 feet', components: 'V, S, M', duration: '1 minute', concentration: true, save: 'Dexterity' },
      cone_of_cold: { name: 'Cone of Cold', icon: '‚ùÑÔ∏è', damage: '8d8', school: 'Evocation', description: 'Blast of cold air', castingTime: '1 action', range: 'Self (60-foot cone)', components: 'V, S, M', duration: 'Instantaneous', save: 'Constitution' },
      mass_cure_wounds: { name: 'Mass Cure Wounds', icon: '‚ù§Ô∏è', damage: '3d8+3', school: 'Evocation', description: 'Heal up to 6 creatures', castingTime: '1 action', range: '60 feet', components: 'V, S', duration: 'Instantaneous' },
      flame_strike: { name: 'Flame Strike', icon: 'üî•', damage: '8d6', school: 'Evocation', description: 'Column of divine fire', castingTime: '1 action', range: '60 feet', components: 'V, S, M', duration: 'Instantaneous', save: 'Dexterity' }
    };

    let currentCharacter = characters[0];
    let selectedCantrip = null;
    // Spell modal state
    let currentModalSpell = null;
    let currentModalSpellLevel = null;
    // Spell picker state
    let allSpellsFromAPI = [];
    let filteredSpells = [];
    let currentLevelFilter = 'all';
    let currentClassFilter = 'all';
    let currentChatMode = 'conversation';
    let currentState = 'default';
    let turnNumber = 1;

    // Initialize
    console.log('=== INITIALIZING PAGE ===');
    console.log('Total characters:', characters.length);
    console.log('Current character:', currentCharacter.name);
    console.log('Current character has spells:', !!currentCharacter.spells);
    updateCharacterDisplay();
    populateCharacterMenu();
    updateSpellsTab();
    updateAbilitiesTab();
    console.log('=== INITIALIZATION COMPLETE ===');

    function populateCharacterMenu() {
      const list = document.getElementById('characterList');
      console.log('=== POPULATING CHARACTER MENU ===');
      console.log('Characters array length:', characters.length);
      console.log('Characters:', characters.map(c => c.name));

      if (!list) {
        console.error('ERROR: characterList element not found!');
        return;
      }

      console.log('characterList element found');

      const html = characters.map((char, index) => `
        <div class="character-item ${index === 0 ? 'active' : ''}" onclick="selectCharacterFromMenu(${index})">
          <div class="character-item-header">
            <div class="character-item-emoji">${char.emoji}</div>
            <div class="character-item-info">
              <div class="character-item-name">${char.name}</div>
              <div class="character-item-class">${char.class} ${char.level}</div>
            </div>
          </div>
          <div class="character-item-stats">
            <span>HP: ${char.hp.current}/${char.hp.max}</span>
            <span>AC: ${char.ac}</span>
          </div>
        </div>
      `).join('');

      console.log('Generated HTML length:', html.length);
      console.log('First 200 chars:', html.substring(0, 200));
      list.innerHTML = html;

      // Debug: Check if innerHTML was actually set
      console.log('After setting innerHTML, list.innerHTML length:', list.innerHTML.length);
      console.log('list element:', list);
      console.log('list children count:', list.children.length);
      console.log('Character menu populated successfully');
      console.log('=================================');
    }

    function toggleMenu() {
      const menu = document.getElementById('characterMenu');
      const overlay = document.getElementById('menuOverlay');
      menu.classList.toggle('open');
      overlay.classList.toggle('show');
    }

    function closeMenu() {
      const menu = document.getElementById('characterMenu');
      const overlay = document.getElementById('menuOverlay');
      menu.classList.remove('open');
      overlay.classList.remove('show');
    }

    function selectCharacterFromMenu(index) {
      // Validate index
      if (index < 0 || index >= characters.length) {
        console.error('Invalid character index:', index);
        return;
      }

      console.log('Switching to character:', characters[index].name);

      // Update current character
      currentCharacter = characters[index];
      currentState = 'default';
      turnNumber = 1;

      // Update all displays
      updateCharacterDisplay();
      updateMessages();

      // IMPORTANT: Update spells and abilities tabs
      updateSpellsTab();
      updateAbilitiesTab();

      console.log('Character switched successfully');

      // Update menu active state
      document.querySelectorAll('.character-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
      });

      // Update the character menu to show current HP, etc.
      populateCharacterMenu();

      closeMenu();
    }

    function updateCharacterDisplay() {
      // Update header (portrait and name)
      document.getElementById('currentCharName').textContent = currentCharacter.name;
      document.getElementById('charAlignment').textContent = currentCharacter.alignment || 'Neutral';
      document.getElementById('charLevel').textContent = currentCharacter.level;
      document.getElementById('charRace').textContent = currentCharacter.race || 'Human';
      document.getElementById('charClass').textContent = currentCharacter.class;
      document.getElementById('characterNameHeader').textContent = currentCharacter.name;

      // Update portraits
      document.getElementById('headerPortrait').textContent = currentCharacter.emoji;
      document.getElementById('footerPortrait').textContent = currentCharacter.emoji;
      document.getElementById('fullsizePortrait').textContent = currentCharacter.emoji;

      // Update stats
      const stats = currentCharacter.stats;
      ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(stat => {
        const value = stats[stat];
        const modifier = Math.floor((value - 10) / 2);
        document.getElementById(stat + 'Value').textContent = value;
        document.getElementById(stat + 'Mod').textContent = (modifier >= 0 ? '+' : '') + modifier;
      });

      // Update HP (stats tab - may not exist if removed)
      const hpPercent = (currentCharacter.hp.current / currentCharacter.hp.max) * 100;
      const hpFillEl = document.getElementById('hpFill');
      const hpTextEl = document.getElementById('hpText');
      const hpCurrentEditEl = document.getElementById('hpCurrentEdit');
      const hpMaxEditEl = document.getElementById('hpMaxEdit');

      if (hpFillEl) hpFillEl.style.width = hpPercent + '%';
      if (hpTextEl) hpTextEl.textContent = `${currentCharacter.hp.current} / ${currentCharacter.hp.max}`;
      if (hpCurrentEditEl) hpCurrentEditEl.textContent = currentCharacter.hp.current;
      if (hpMaxEditEl) hpMaxEditEl.textContent = currentCharacter.hp.max;

      // Update Header HP Bar
      const headerHpFill = document.getElementById('headerHpFill');
      const headerHpText = document.getElementById('headerHpText');
      headerHpFill.style.width = hpPercent + '%';
      headerHpText.textContent = `${currentCharacter.hp.current}/${currentCharacter.hp.max}`;

      // Update HP bar color based on percentage
      headerHpFill.classList.remove('high', 'medium');
      if (hpPercent > 60) {
        headerHpFill.classList.add('high');
      } else if (hpPercent > 25) {
        headerHpFill.classList.add('medium');
      }

      // Update Battle HP Bar
      const battleHpFill = document.getElementById('battleHpFill');
      const battleHpText = document.getElementById('battleHpText');
      if (battleHpFill && battleHpText) {
        battleHpFill.style.width = hpPercent + '%';
        battleHpFill.classList.remove('high', 'medium', 'low');
        if (hpPercent > 66) battleHpFill.classList.add('high');
        else if (hpPercent > 33) battleHpFill.classList.add('medium');
        else battleHpFill.classList.add('low');
        battleHpText.textContent = `${currentCharacter.hp.current} / ${currentCharacter.hp.max}`;
      }


      // Update AC
      document.getElementById('acValue').textContent = currentCharacter.ac;
      document.getElementById('headerAc').textContent = `AC ${currentCharacter.ac}`;

      // Update Initiative
      const dexMod = Math.floor((stats.dex - 10) / 2);
      document.getElementById('initValue').textContent = (dexMod >= 0 ? '+' : '') + dexMod;

      // Update location selector
      document.getElementById('locationSelect').value = currentCharacter.location;

      // Update abilities
      updateAbilities();

      // Update skills
      updateSkills();

      // Update turn tracker
      document.getElementById('turnNumber').textContent = turnNumber;

      // Auto-select first cantrip for battle mode (only for cantrip classes)
      const cantripClasses = ['bard', 'cleric', 'druid', 'sorcerer', 'warlock', 'wizard'];
      const charClass = currentCharacter.class.toLowerCase();

      if (cantripClasses.includes(charClass)) {
        if (currentCharacter.spells && currentCharacter.spells['0'] && currentCharacter.spells['0'].length > 0) {
          selectedCantrip = currentCharacter.spells['0'][0];
          updateCantripButton();
        } else {
          selectedCantrip = null;
          updateCantripButton();
        }
      } else {
        // Non-cantrip class - hide button
        selectedCantrip = null;
        updateCantripButton();
      }

      // Update tab visibility based on class
      updateTabVisibility();
    }

    function updateAbilities() {
      const abilitiesGrid = document.getElementById('abilitiesGrid');
      if (!abilitiesGrid) return; // Element doesn't exist in current view

      let html = '';

      // Show attacks first (melee/ranged)
      if (currentCharacter.attacks) {
        html += '<div style="margin-bottom: 20px;"><strong style="color: var(--text-primary);">‚öîÔ∏è Attacks</strong></div>';

        if (currentCharacter.attacks.melee) {
          const attack = currentCharacter.attacks.melee;
          html += `
            <div class="ability-card" onclick="rollWeaponAttack('melee')">
              <div class="ability-header">
                <div class="ability-icon">‚öîÔ∏è</div>
                <div class="ability-info">
                  <div class="ability-name">${attack.name} (Melee)</div>
                  <div class="ability-damage">${attack.damage} | +${attack.toHit} to hit</div>
                </div>
              </div>
              <div class="ability-description">Make a melee attack with your ${attack.name}</div>
            </div>
          `;
        }

        if (currentCharacter.attacks.ranged) {
          const attack = currentCharacter.attacks.ranged;
          html += `
            <div class="ability-card" onclick="rollWeaponAttack('ranged')">
              <div class="ability-header">
                <div class="ability-icon">üèπ</div>
                <div class="ability-info">
                  <div class="ability-name">${attack.name} (Ranged)</div>
                  <div class="ability-damage">${attack.damage} | +${attack.toHit} to hit</div>
                </div>
              </div>
              <div class="ability-description">Make a ranged attack with your ${attack.name}</div>
            </div>
          `;
        }
      }

      // Show abilities (for all classes)
      if (currentCharacter.abilities && currentCharacter.abilities.length > 0) {
        html += '<div style="margin: 20px 0;"><strong style="color: var(--text-primary);">Abilities</strong></div>';
        currentCharacter.abilities.forEach(ability => {
          html += `
            <div class="ability-card" onclick="useAbility('${ability.id}')">
              <div class="ability-header">
                <div class="ability-icon">${ability.icon}</div>
                <div class="ability-info">
                  <div class="ability-name">${ability.name}</div>
                  ${ability.damage ? `<div class="ability-damage">${ability.damage}</div>` : ''}
                </div>
              </div>
              <div class="ability-description">${ability.description}</div>
            </div>
          `;
        });
      }

      // Show spells (for casters and halfcasters)
      if (currentCharacter.spells && (currentCharacter.classType === 'caster' || currentCharacter.classType === 'halfcaster')) {
        html += '<div style="margin: 20px 0;"><strong style="color: var(--text-primary);">Spells</strong></div>';

        Object.keys(currentCharacter.spells).sort((a, b) => parseInt(a) - parseInt(b)).forEach(level => {
          const levelName = level === '0' ? 'Cantrips' : `Level ${level}`;
          html += `<div class="spell-level-section">
            <div class="spell-level-header">${levelName}</div>`;

          currentCharacter.spells[level].forEach(spell => {
            html += `
              <div class="spell-card ${spell.prepared ? 'prepared' : ''}" onclick="toggleSpellPrepared('${spell.id}', ${level})">
                <div class="spell-header">
                  <div class="spell-icon">${spell.icon}</div>
                  <div class="spell-info">
                    <div class="spell-name">${spell.name}</div>
                    ${spell.damage ? `<div class="spell-damage">${spell.damage}</div>` : ''}
                  </div>
                  ${spell.prepared ? '<div class="prepared-indicator">Prepared</div>' : ''}
                </div>
                <div class="spell-description">${spell.description}</div>
              </div>
            `;
          });

          html += '</div>';
        });
      }

      abilitiesGrid.innerHTML = html;
    }

    // New function to update the Abilities tab in the stats section
    function updateAbilitiesTab() {
      const abilitiesContent = document.getElementById('abilitiesContent');
      let html = '';

      // Show abilities only
      if (currentCharacter.abilities && currentCharacter.abilities.length > 0) {
        currentCharacter.abilities.forEach(ability => {
          const isDefault = ability.isDefault || false;
          html += `
            <div class="ability-card" style="position: relative; cursor: pointer;" onclick="useAbility('${ability.id}')">
              <div class="ability-header">
                <div class="ability-icon">${ability.icon}</div>
                <div class="ability-info">
                  <div class="ability-name">${ability.name}</div>
                  ${ability.damage ? `<div class="ability-damage">üí• ${ability.damage}</div>` : ''}
                </div>
              </div>
              <div class="ability-description">${ability.description}</div>
            </div>
          `;
        });
      } else {
        html = '<div style="color: var(--text-secondary); padding: 20px; text-align: center;">No abilities available.</div>';
      }

      abilitiesContent.innerHTML = html;
    }

    function updateSpellsTab() {
      const spellsContent = document.getElementById('spellsContent');

      // Check if element exists (tab might not be active)
      if (!spellsContent) return;

      let html = '';

      // Check if character has spells
      if (!currentCharacter.spells || Object.keys(currentCharacter.spells).length === 0) {
        spellsContent.innerHTML = '<div style="color: var(--text-secondary); padding: 20px; text-align: center;">No spells available for this character.</div>';
        updateSpellSlotsDisplay();
        return;
      }

      // Update spell slots display
      updateSpellSlotsDisplay();

      // Debug: log spells
      console.log('=== SPELL DEBUG ===');
      console.log('Character:', currentCharacter.name);
      console.log('Has spells object:', !!currentCharacter.spells);
      console.log('Spell keys:', Object.keys(currentCharacter.spells || {}));
      console.log('Spells:', currentCharacter.spells);
      console.log('===================');

      // Show spells by level - MINIMAL CARD VIEW
      Object.keys(currentCharacter.spells).sort((a, b) => parseInt(a) - parseInt(b)).forEach(level => {
        const levelName = level === '0' ? 'Cantrips' : `Level ${level}`;
        html += `<div class="spell-level-section">
          <div class="spell-level-header">${levelName}</div>`;

        currentCharacter.spells[level].forEach(spell => {
          const isCantrip = level === '0';
          const isPrepared = isCantrip || spell.prepared; // Cantrips are always "prepared"
          const isSelected = selectedCantrip && selectedCantrip.id === spell.id;

          html += `
            <div class="spell-card ${isPrepared ? 'prepared' : ''}" onclick="openSpellDetail('${spell.id}', ${level})">
              <span class="spell-icon">${spell.icon}</span>
              <span class="spell-name">${spell.name}${isSelected ? ' (Selected)' : ''}</span>
              ${isPrepared ? '<span class="spell-check">‚úì</span>' : ''}
            
              ${currentCharacter.castingType === 'known' && level !== '0' ?
                `<button onclick="event.stopPropagation(); deleteSpell('${spell.id}', ${level})"
                        style="position: absolute; top: 5px; right: 5px; background: var(--background-color); border: 2px solid var(--border-color); border-radius: 4px; padding: 3px 8px; font-size: 0.75rem; cursor: pointer; color: var(--text-secondary);"
                        title="Remove spell">
                  ‚úï
                </button>` : ''}</div>
          `;
        });

        html += '</div>';
      });

      spellsContent.innerHTML = html;
    }

    // Update spell slots display with progress bars
    function updateSpellSlotsDisplay() {
      // Update casting type info
      const castingInfoEl = document.getElementById('castingTypeInfo');
      if (castingInfoEl && currentCharacter.castingType) {
        const castingDescriptions = {
          'prepared': 'üìö Prepared Caster: You can prepare spells each day. Toggle ‚úì to prepare/unprepare.',
          'known': 'üìñ Known Caster: You know a limited number of spells permanently. Click ‚úï to forget a spell.'
        };
        castingInfoEl.innerHTML = `<div style="color: var(--text-secondary);">${castingDescriptions[currentCharacter.castingType] || ''}</div>`;
      }


      const spellSlotsDisplay = document.getElementById('spellSlotsDisplay');

      // Check if element exists (tab might not be active)
      if (!spellSlotsDisplay) return;

      if (!currentCharacter.spells || Object.keys(currentCharacter.spells).length === 0) {
        spellSlotsDisplay.innerHTML = '<div style="color: var(--text-secondary); padding: 15px; text-align: center;">No spell slots available</div>';
        return;
      }

      // Initialize spell slots tracking if not present
      if (!currentCharacter.spellSlots) {
        currentCharacter.spellSlots = {};
        const maxSpellLevel = Math.max(...Object.keys(currentCharacter.spells).map(l => parseInt(l)).filter(l => l > 0));
        for (let level = 1; level <= maxSpellLevel; level++) {
          const maxSlots = getSpellSlots(currentCharacter.level, currentCharacter.classType, level);
          currentCharacter.spellSlots[level] = { current: maxSlots, max: maxSlots };
        }
      }

      // Count prepared spells
      let preparedCount = 0;
      let maxPrepared = Math.floor(currentCharacter.level / 2) + Math.floor((currentCharacter.stats.wis - 10) / 2);
      if (currentCharacter.classType === 'caster') {
        maxPrepared = currentCharacter.level + Math.floor((currentCharacter.stats.int - 10) / 2);
      }
      maxPrepared = Math.max(1, maxPrepared);

      Object.keys(currentCharacter.spells).forEach(level => {
        if (level !== '0') {
          preparedCount += currentCharacter.spells[level].filter(s => s.prepared).length;
        }
      });

      let html = `
        <div class="slots-header">
          <span class="slots-title">Spell Slots</span>
          <span class="prepared-count">Prep: ${preparedCount}/${maxPrepared}</span>
        </div>
        <div class="slots-grid">
      `;

      // Show cantrip row if character has cantrips
      if (currentCharacter.spells['0'] && currentCharacter.spells['0'].length > 0) {
        html += `
          <div class="slot-row">
            <span class="slot-label">Cantrips:</span>
            <div class="slot-bar">
              <div class="slot-fill" style="width: 100%; background: linear-gradient(90deg, var(--accent-color), var(--accent-color-bright));"></div>
              <div class="slot-text">‚àû Unlimited</div>
            </div>
          </div>
        `;
      }

      // Show spell slot progress bars
      const spellLevels = Object.keys(currentCharacter.spellSlots).sort((a, b) => parseInt(a) - parseInt(b));
      spellLevels.forEach(level => {
        const slot = currentCharacter.spellSlots[level];
        const percentage = (slot.current / slot.max) * 100;
        const levelSuffix = level === '1' ? 'st' : level === '2' ? 'nd' : level === '3' ? 'rd' : 'th';

        html += `
          <div class="slot-row">
            <span class="slot-label">${level}${levelSuffix}:</span>
            <div class="slot-bar">
              <div class="slot-fill" style="width: ${percentage}%"></div>
              <div class="slot-text">${slot.current}/${slot.max}</div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      spellSlotsDisplay.innerHTML = html;
    }

    // Helper function to get spell slots by level and class type
    function getSpellSlots(characterLevel, classType, spellLevel) {
      // Simplified spell slot calculation (D&D 5e)
      const halfcasterLevel = Math.floor(characterLevel / 2);
      const effectiveLevel = classType === 'halfcaster' ? halfcasterLevel : characterLevel;

      const slotTable = {
        1: [2, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4],
        2: [0, 0, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
        3: [0, 0, 0, 0, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
        4: [0, 0, 0, 0, 0, 0, 1, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
        5: [0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3]
      };

      if (spellLevel > 5 || effectiveLevel < 1) return 0;
      return slotTable[spellLevel]?.[effectiveLevel - 1] || 0;
    }

    // Modal state



    // Open spell detail modal
    function openSpellDetail(spellId, level) {
      const spell = currentCharacter.spells[level]?.find(s => s.id === spellId);
      if (!spell) return;

      currentModalSpell = spell;
      currentModalSpellLevel = level;

      // Update modal content
      document.getElementById('modalSpellIcon').textContent = spell.icon || '‚ú®';
      document.getElementById('modalSpellName').textContent = spell.name;

      const isCantrip = level === '0';
      const levelText = isCantrip ? 'Cantrip' : `Level ${level} Spell`;
      const school = spell.school || 'Evocation';
      document.getElementById('modalSpellLevel').textContent = `${levelText} ‚Ä¢ ${school}`;

      // Build stats grid
      const statsGrid = document.getElementById('modalSpellStats');
      const castingTime = spell.castingTime || '1 action';
      const range = spell.range || '60 feet';
      const components = spell.components || 'V, S';
      const duration = spell.duration || 'Instantaneous';
      const concentration = spell.concentration ? ' (Concentration)' : '';

      statsGrid.innerHTML = `
        <div class="spell-stat">
          <div class="spell-stat-label">Casting Time</div>
          <div class="spell-stat-value">${castingTime}</div>
        </div>
        <div class="spell-stat">
          <div class="spell-stat-label">Range</div>
          <div class="spell-stat-value">${range}</div>
        </div>
        <div class="spell-stat">
          <div class="spell-stat-label">Components</div>
          <div class="spell-stat-value">${components}</div>
        </div>
        <div class="spell-stat">
          <div class="spell-stat-label">Duration</div>
          <div class="spell-stat-value">${duration}${concentration}</div>
        </div>
      `;

      // Add damage/save info if applicable
      if (spell.damage || spell.save) {
        const damageHtml = spell.damage ? `
          <div class="spell-stat">
            <div class="spell-stat-label">Damage</div>
            <div class="spell-stat-value" style="color: var(--battle-color);">${spell.damage}</div>
          </div>
        ` : '';

        const saveHtml = spell.save ? `
          <div class="spell-stat">
            <div class="spell-stat-label">Save</div>
            <div class="spell-stat-value">${spell.save} DC ${currentCharacter.computed?.spellSaveDC || 15}</div>
          </div>
        ` : '';

        statsGrid.innerHTML += damageHtml + saveHtml;
      }

      // Description
      document.getElementById('modalSpellDescription').textContent = spell.description || 'No description available.';

      // Update buttons
      const castBtn = document.getElementById('modalCastBtn');
      const prepareBtn = document.getElementById('modalPrepareBtn');

      // Cast button
      if (isCantrip) {
        castBtn.textContent = '‚ú® Cast (‚àû Unlimited)';
        castBtn.disabled = false;
      } else {
        const slotsAvailable = currentCharacter.spellSlots?.[level]?.current > 0;
        castBtn.textContent = `‚ú® Cast (${currentCharacter.spellSlots?.[level]?.current || 0} slots)`;
        castBtn.disabled = !slotsAvailable || !spell.prepared;
      }

      // Prepare button
      if (isCantrip) {
        prepareBtn.style.display = 'none';
      } else {
        prepareBtn.style.display = 'block';
        prepareBtn.textContent = spell.prepared ? '‚úì Prepared' : 'Prepare';
        prepareBtn.classList.toggle('prepared', spell.prepared);
      }

      // Show modal
      document.getElementById('spellModalOverlay').classList.add('show');
    }

    function closeSpellModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('spellModalOverlay').classList.remove('show');
      currentModalSpell = null;
      currentModalSpellLevel = null;
    }

    function castSpellFromModal() {
      if (!currentModalSpell) return;

      const spell = currentModalSpell;
      const level = currentModalSpellLevel;
      const isCantrip = level === '0';

      // Cantrips don't need spell slots
      if (!isCantrip) {
        // Check if spell slot available
        if (!currentCharacter.spellSlots?.[level] || currentCharacter.spellSlots[level].current <= 0) {
          alert(`No ${level}${getOrdinalSuffix(level)} level spell slots available!`);
          return;
        }

        // Check if spell is prepared
        if (!spell.prepared) {
          alert(`${spell.name} is not prepared!`);
          return;
        }

        // Use spell slot
        currentCharacter.spellSlots[level].current--;
        updateSpellSlotsDisplay();
      }

      // Roll spell (if applicable)
      let resultText = `‚ú® ${spell.name}`;

      if (spell.attackRoll || spell.damage) {
        // Attack spell
        if (spell.attackRoll) {
          const d20 = Math.floor(Math.random() * 20) + 1;
          const spellAttackBonus = currentCharacter.computed?.spellAttackBonus || 7;
          const total = d20 + spellAttackBonus;
          const isCrit = d20 === 20;
          const isFail = d20 === 1;

          resultText += ` | Attack: ${total} (d20: ${d20}+${spellAttackBonus})`;
          if (isCrit) resultText += ' **CRITICAL HIT!**';
          if (isFail) resultText += ' (Critical Miss)';
        }

        // Damage (always show if spell has damage, even without attack roll)
        if (spell.damage) {
          const damageMatch = spell.damage.match(/(\d+)d(\d+)([+-]\d+)?/);
          if (damageMatch) {
            const numDice = parseInt(damageMatch[1]);
            const diceType = parseInt(damageMatch[2]);
            const modifier = damageMatch[3] ? parseInt(damageMatch[3]) : 0;

            let damageTotal = 0;
            let rolls = [];
            for (let i = 0; i < numDice; i++) {
              const roll = Math.floor(Math.random() * diceType) + 1;
              rolls.push(roll);
              damageTotal += roll;
            }
            damageTotal += modifier;

            resultText += ` | Damage: ${damageTotal} (${spell.damage}) [${rolls.join(', ')}]`;
          }
        }
      } else if (spell.save) {
        // Save spell
        const saveDC = currentCharacter.computed?.spellSaveDC || 15;
        resultText += ` | ${spell.save} DC ${saveDC}`;
      }

      // Add to battle log
      addBattleLog(`${spell.icon || '‚ú®'} ${resultText}`);

      // Show in modal feedback
      if (!isCantrip) {
        alert(`Cast ${spell.name}! (${currentCharacter.spellSlots[level].current} ${level}${getOrdinalSuffix(level)} level slots remaining)`);
      } else {
        alert(`Cast ${spell.name}!`);
      }

      // Update displays
      updateSpellsTab();
      updateSpellSlotsDisplay();

      // Close modal
      closeSpellModal();
    }

    function getOrdinalSuffix(num) {
      const j = num % 10;
      const k = num % 100;
      if (j == 1 && k != 11) return 'st';
      if (j == 2 && k != 12) return 'nd';
      if (j == 3 && k != 13) return 'rd';
      return 'th';
    }

    function togglePrepareFromModal() {
      if (!currentModalSpell || currentModalSpellLevel === '0') return;

      const spell = currentModalSpell;
      spell.prepared = !spell.prepared;

      // Update modal button
      const prepareBtn = document.getElementById('modalPrepareBtn');
      prepareBtn.textContent = spell.prepared ? '‚úì Prepared' : 'Prepare';
      prepareBtn.classList.toggle('prepared', spell.prepared);

      // Update cast button availability
      const castBtn = document.getElementById('modalCastBtn');
      const slotsAvailable = currentCharacter.spellSlots?.[currentModalSpellLevel]?.current > 0;
      castBtn.disabled = !slotsAvailable || !spell.prepared;

      // Update spell list
      updateSpellsTab();
      updateSpellSlotsDisplay();
    }





    // Spell picker modal for adding spells from D&D 5e API
    async function openSpellPicker() {
      // Show modal
      document.getElementById('spellPickerOverlay').classList.add('show');

      // Fetch spells if not already loaded
      if (allSpellsFromAPI.length === 0) {
        await fetchSpellsFromAPI();
      } else {
        // Re-render with existing data
        renderPickerSpells(allSpellsFromAPI);
      }
    }

    function closeSpellPicker(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('spellPickerOverlay').classList.remove('show');
      // Reset filters
      document.getElementById('spellPickerSearch').value = '';
      document.getElementById('spellClassFilter').value = 'all';
      currentClassFilter = 'all';
      currentLevelFilter = 'all';
      document.querySelectorAll('.spell-picker-filter').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.level === 'all');
      });
    }
    // Open spell detail from picker (for spells not in character list yet)
    function openSpellPickerDetail(spellIndex) {
      const spell = allSpellsFromAPI.find(s => s.index === spellIndex);
      if (!spell) return;

      // Map to character spell format for modal
      const mappedSpell = mapAPISpellToCharacterSpell(spell);
      currentModalSpell = mappedSpell;
      currentModalSpellLevel = spell.level.toString();

      // Update modal content
      document.getElementById('modalSpellIcon').textContent = mappedSpell.icon || '‚ú®';
      document.getElementById('modalSpellName').textContent = mappedSpell.name;

      const isCantrip = spell.level === 0;
      const levelText = isCantrip ? 'Cantrip' : `Level ${spell.level} Spell`;
      const school = mappedSpell.school || 'Evocation';
      document.getElementById('modalSpellLevel').textContent = `${levelText} ‚Ä¢ ${school}`;

      // Build stats grid
      const statsGrid = document.getElementById('modalSpellStats');
      statsGrid.innerHTML = `
        <div class="spell-stat">
          <div class="spell-stat-label">Casting Time</div>
          <div class="spell-stat-value">${mappedSpell.castingTime}</div>
        </div>
        <div class="spell-stat">
          <div class="spell-stat-label">Range</div>
          <div class="spell-stat-value">${mappedSpell.range}</div>
        </div>
        <div class="spell-stat">
          <div class="spell-stat-label">Components</div>
          <div class="spell-stat-value">${mappedSpell.components}</div>
        </div>
        <div class="spell-stat">
          <div class="spell-stat-label">Duration</div>
          <div class="spell-stat-value">${mappedSpell.duration}${mappedSpell.concentration ? ' (Concentration)' : ''}</div>
        </div>
      `;

      // Add damage/save info if applicable
      if (mappedSpell.damage || mappedSpell.save) {
        const damageHtml = mappedSpell.damage ? `
          <div class="spell-stat">
            <div class="spell-stat-label">Damage</div>
            <div class="spell-stat-value" style="color: var(--battle-color);">${mappedSpell.damage}</div>
          </div>
        ` : '';

        const saveHtml = mappedSpell.save ? `
          <div class="spell-stat">
            <div class="spell-stat-label">Save</div>
            <div class="spell-stat-value">${mappedSpell.save} DC ${currentCharacter.computed?.spellSaveDC || 15}</div>
          </div>
        ` : '';

        statsGrid.innerHTML += damageHtml + saveHtml;
      }

      // Description
      document.getElementById('modalSpellDescription').textContent = mappedSpell.description || 'No description available.';

      // Hide cast/prepare buttons since spell is not in character list yet
      document.getElementById('modalCastBtn').style.display = 'none';
      document.getElementById('modalPrepareBtn').style.display = 'none';

      // Show modal
      document.getElementById('spellModalOverlay').classList.add('show');
    }


    async function fetchSpellsFromAPI() {
      const body = document.getElementById('spellPickerBody');
      body.innerHTML = '<div class="spell-picker-loading">üîÆ Loading spells from local database...</div>';

      try {
        // Fetch spell list from local file
        const response = await fetch('spells-srd.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const spells = await response.json();

        // Map to our format (SRD format is different from D&D 5e API)
        allSpellsFromAPI = spells.map(spell => ({
          index: spell.name.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, ''),
          name: spell.name,
          level: spell.level === 'cantrip' ? 0 : parseInt(spell.level),
          school: { name: spell.school.charAt(0).toUpperCase() + spell.school.slice(1) },
          desc: [spell.description],
          casting_time: spell.casting_time,
          range: spell.range,
          components: spell.components.raw || 'V, S',
          duration: spell.duration,
          concentration: spell.duration.toLowerCase().includes('concentration'),
          // Try to extract damage from description
          damage: extractDamageFromDescription(spell.description),
          dc: extractSaveFromDescription(spell.description),
          classes: spell.classes || []
        }));

        addBattleLog(`üìö Loaded ${allSpellsFromAPI.length} spells from local database!`);
        renderPickerSpells(allSpellsFromAPI);
      } catch (error) {
        console.warn('Could not load spells-srd.json, using embedded fallback spells:', error);

        // Fallback: Use embedded essential spells (works without web server)
        const fallbackSpells = [{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"You hurl a bubble of acid. Choose one creature within range, or choose two creatures within range that are within 5 feet of each other. A target must succeed on a Dexterity saving throw or take 1d6 acid damage.\n\nThis spell's damage increases by 1d6 when you reach 5th level (2d6), 11th level (3d6), and 17th level (4d6).","duration":"Instantaneous","level":"cantrip","name":"Acid Splash","range":"60 feet","ritual":false,"school":"conjuration","tags":["sorcerer","wizard","cantrip"],"type":"Conjuration cantrip"},{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"As you hold your hands with thumbs touching and fingers spread, a thin sheet of flames shoots forth from your outstretched fingertips. Each creature in a 15-foot cone must make a Dexterity saving throw. A creature takes 3d6 fire damage on a failed save, or half as much damage on a successful one.\n\nThe fire ignites any flammable objects in the area that aren\u2019t being worn or carried.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 2nd level or higher, the damage increases by 1d6 for each slot level above 1st.","level":"1","name":"Burning Hands","range":"Self (15-foot cone)","ritual":false,"school":"evocation","tags":["sorcerer","wizard","level1"],"type":"1st-level evocation"},{"casting_time":"1 action","classes":["bard","druid","sorcerer","warlock","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"You attempt to charm a humanoid you can see within range. It must make a Wisdom saving throw, and does so with advantage if you or your companions are fighting it. If it fails the saving throw, it is charmed by you until the spell ends or until you or your companions do anything harmful to it. The charmed creature regards you as a friendly acquaintance. When the spell ends, the creature knows it was charmed by you.","duration":"1 hour","higher_levels":"When you cast this spell using a spell slot of 2nd level or higher, you can target one additional creature for each slot level above 1st. The creatures must be within 30 feet of each other when you target them.","level":"1","name":"Charm Person","range":"30 feet","ritual":false,"school":"enchantment","tags":["bard","druid","sorcerer","warlock","wizard","level1"],"type":"1st-level enchantment"},{"casting_time":"1 action","classes":["bard","cleric","druid","paladin","ranger"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"A creature you touch regains a number of hit points equal to 1d8 + your spellcasting ability modifier. This spell has no effect on undead or constructs.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 2nd level or higher, the healing increases by 1d8 for each slot level above 1st.","level":"1","name":"Cure Wounds","range":"Touch","ritual":false,"school":"evocation","tags":["bard","cleric","druid","paladin","ranger","level1"],"type":"1st-level evocation"},{"casting_time":"1 action","classes":["bard","cleric","druid","paladin","ranger","sorcerer","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"For the duration, you sense the presence of magic within 30 feet of you. If you sense magic in this way, you can use your action to see a faint aura around any visible creature or object in the area that bears magic, and you learn its school of magic, if any.\n\nThe spell can penetrate most barriers, but it is blocked by 1 foot of stone, 1 inch of common metal, a thin sheet of lead, or 3 feet of wood or dirt.","duration":"Concentration, up to 10 minutes","level":"1","name":"Detect Magic","range":"Self","ritual":true,"school":"divination","tags":["bard","cleric","druid","paladin","ranger","sorcerer","wizard","level1"],"type":"1st-level divination (Ritual)"},{"casting_time":"1 action","classes":["warlock"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"A beam of crackling energy streaks toward a creature within range. Make a ranged spell attack against the target. On a hit, the target takes 1d10 force damage.\nThe spell creates more than one beam when you reach higher levels: two beams at 5th level, three beams at 11th level, and four beams at 17th level. You can direct the beams at the same target or at different ones. Make a separate attack roll for each beam.","duration":"Instantaneous","level":"cantrip","name":"Eldritch Blast","range":"120 feet","ritual":false,"school":"evocation","tags":["warlock","cantrip"],"type":"Evocation cantrip"},{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"You hurl a mote of fire at a creature or object within range. Make a ranged spell attack against the target. On a hit, the target takes 1d10 fire damage. A flammable object hit by this spell ignites if it isn't being worn or carried. This spell\u2019s damage increases by 1d10 when you reach 5th level (2d10), 11th level (3d10), and 17th level (4d10).","duration":"Instantaneous","level":"cantrip","name":"Fire Bolt","range":"120 feet","ritual":false,"school":"evocation","tags":["sorcerer","wizard","cantrip"],"type":"Evocation cantrip"},{"casting_time":"1 action","classes":["cleric","druid"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"You touch one willing creature. Once before the spell ends, the target can roll a d4 and add the number rolled to one ability check of its choice. It can roll the die before or after making the ability check. The spell then ends.","duration":"Concentration, up to 1 minute","level":"cantrip","name":"Guidance","range":"Touch","ritual":false,"school":"divination","tags":["cleric","druid","cantrip"],"type":"Divination cantrip"},{"casting_time":"1 bonus action","classes":["bard","cleric","druid"],"components":{"material":false,"raw":"V","somatic":false,"verbal":true},"description":"A creature of your choice that you can see within range regains hit points equal to 1d4 + your spellcasting ability modifier. This spell has no effect on undead or constructs.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 2nd level or higher, the healing increases by 1d4 for each slot level above 1st.","level":"1","name":"Healing Word","range":"60 feet","ritual":false,"school":"evocation","tags":["bard","cleric","druid","level1"],"type":"1st-level evocation"},{"casting_time":"1 action","classes":["bard","cleric","sorcerer","wizard"],"components":{"material":true,"materials_needed":["a firefly or phosphorescent moss"],"raw":"V, M (a firefly or phosphorescent moss)","somatic":false,"verbal":true},"description":"You touch one object that is no larger than 10 feet in any dimension. Until the spell ends, the object sheds bright light in a 20-foot radius and dim light for an additional 20 feet. The light can be colored as you like. Completely covering the object with something opaque blocks the light. The spell ends if you cast it again or dismiss it as an action.\n\nIf you target an object held or worn by a hostile creature, that creature must succeed on a Dexterity saving throw to avoid the spell.","duration":"1 hour","level":"cantrip","name":"Light","range":"Touch","ritual":false,"school":"evocation","tags":["bard","cleric","sorcerer","wizard","cantrip"],"type":"Evocation cantrip"},{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":true,"materials_needed":["a piece of cured leather"],"raw":"V, S, M (a piece of cured leather)","somatic":true,"verbal":true},"description":"You touch a willing creature who isn\u2019t wearing armor, and a protective magical force surrounds it until the spell ends. The target\u2019s base AC becomes 13 + its Dexterity modifier. The spell ends if the target dons armor or if you dismiss the spell as an action.","duration":"8 hours","level":"1","name":"Mage Armor","range":"Touch","ritual":false,"school":"abjuration","tags":["sorcerer","wizard","level1"],"type":"1st-level abjuration"},{"casting_time":"1 action","classes":["bard","sorcerer","warlock","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"A spectral, floating hand appears at a point you choose within range. The hand lasts for the duration or until you dismiss it as an action. The hand vanishes if it is ever more than 30 feet away from you or if you cast this spell again.\n\nYou can use your action to control the hand. You can use the hand to manipulate an object, open an unlocked door or container, stow or retrieve an item from an open container, or pour the contents out of a vial. You can move the hand up to 30 feet each time you use it.\n\nThe hand can\u2019t attack, activate magic items, or carry more than 10 pounds.","duration":"1 minute","level":"cantrip","name":"Mage Hand","range":"30 feet","ritual":false,"school":"conjuration","tags":["bard","sorcerer","warlock","wizard","cantrip"],"type":"Conjuration cantrip"},{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"You create three glowing darts of magical force. Each dart hits a creature of your choice that you can see within range. A dart deals 1d4 + 1 force damage to its target. The darts all strike simultaneously, and you can direct them to hit one creature or several.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 2nd level or higher, the spell creates one more dart for each slot level above 1st.","level":"1","name":"Magic Missile","range":"120 feet","ritual":false,"school":"evocation","tags":["sorcerer","wizard","level1"],"type":"1st-level evocation"},{"casting_time":"1 action","classes":["bard","sorcerer","warlock","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"This spell is a minor magical trick that novice spellcasters use for practice. You create one of the following magical effects within range:\n\n* You create an instantaneous, harmless sensory effect, such as a shower of sparks, a puff of wind, faint musical notes, or an odd odor.\n\n* You instantaneously light or snuff out a candle, a torch, or a small campfire.\n\n* You instantaneously clean or soil an object no larger than 1 cubic foot.\n\n* You chill, warm, or flavor up to 1 cubic foot of nonliving material for 1 hour.\n\n* You make a color, a small mark, or a symbol appear on an object or a surface for 1 hour.\n\n* You create a nonmagical trinket or an illusory image that can fit in your hand and that lasts until the end of your next turn.\n\nIf you cast this spell multiple times, you can have up to three of its non-instantaneous effects active at a time, and you can dismiss such an effect as an action.","duration":"Up to 1 hour","level":"cantrip","name":"Prestidigitation","range":"10 feet","ritual":false,"school":"transmutation","tags":["bard","sorcerer","warlock","wizard","cantrip"],"type":"Transmutation cantrip"},{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"A frigid beam of blue-white light streaks toward a creature within range. Make a ranged spell attack against the target. On a hit, it takes 1d8 cold damage, and its speed is reduced by 10 feet until the start of your next turn.\n\nThe spell\u2019s damage increases by 1d8 when you reach 5th level (2d8), 11th level (3d8), and 17th level (4d8).","duration":"Instantaneous","level":"cantrip","name":"Ray of Frost","range":"60 feet","ritual":false,"school":"evocation","tags":["sorcerer","wizard","cantrip"],"type":"Evocation cantrip"},{"casting_time":"1 action","classes":["cleric"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"Flame-like radiance descends on a creature that you can see within range. The target must succeed on a Dexterity saving throw or take 1d8 radiant damage. The target gains no benefit from cover for this saving throw.\n\nThe spell\u2019s damage increases by 1d8 when you reach 5th level (2d8), 11th level (3d8), and 17th level (4d8).","duration":"Instantaneous","level":"cantrip","name":"Sacred Flame","range":"60 feet","ritual":false,"school":"evocation","tags":["cleric","cantrip"],"type":"Evocation cantrip"},{"casting_time":"1 reaction, which you take when you are hit by an attack or targeted by the magic missile spell","classes":["sorcerer","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"An invisible barrier of magical force appears and protects you. Until the start of your next turn, you have a +5 bonus to AC, including against the triggering attack, and you take no damage from magic missile.","duration":"1 round","level":"1","name":"Shield","range":"Self","ritual":false,"school":"abjuration","tags":["sorcerer","wizard","level1"],"type":"1st-level abjuration"},{"casting_time":"1 action","classes":["bard","sorcerer","wizard"],"components":{"material":true,"materials_needed":["a pinch of fine sand, rose petals, or a cricket"],"raw":"V, S, M (a pinch of fine sand, rose petals, or a cricket)","somatic":true,"verbal":true},"description":"This spell sends creatures into a magical slumber. Roll 5d8; the total is how many hit points of creatures this spell can affect. Creatures within 20 feet of a point you choose within range are affected in ascending order of their current hit points (ignoring unconscious creatures).\n\nStarting with the creature that has the lowest current hit points, each creature affected by this spell falls unconscious until the spell ends, the sleeper takes damage, or someone uses an action to shake or slap the sleeper awake. Subtract each creature\u2019s hit points from the total before moving on to the creature with the next lowest hit points. A creature\u2019s hit points must be equal to or less than the remaining total for that creature to be affected.\n\nUndead and creatures immune to being charmed aren\u2019t affected by this spell.","duration":"1 minute","higher_levels":"When you cast this spell using a spell slot of 2nd level or higher, roll an additional 2d8 for each slot level above 1st.","level":"1","name":"Sleep","range":"90 feet","ritual":false,"school":"enchantment","tags":["bard","sorcerer","wizard","level1"],"type":"1st-level enchantment"},{"casting_time":"1 action","classes":["cleric"],"components":{"material":false,"raw":"V","somatic":false,"verbal":true},"description":"You manifest a minor wonder, a sign of supernatural power, within range.  You create one of the following magial effects within range:\n\n* Your voice booms up to three times as loud as normal for 1 minute.\n\n* You cause flames to flicker, brighten, dim, or change color for 1 minute.\n\n* You cause harmless tremors in the ground for 1 minute.\n\n* You create an instantaneous sound that originates from a point of your choice within range, such as a rumble of thunder, the cry of a raven, or ominous whispers.\n\n* You instantaneously cause an unlocked door or window to fly open or slam shut.\n\n* You alter the appearance of your eyes for 1 minute.\n\nIf you cast this spell multiple times, you can have up to three of its 1-minute effects active at a time, and you can dismiss such an effect as an action.","duration":"Up to 1 minute","level":"cantrip","name":"Thaumaturgy","range":"30 feet","ritual":false,"school":"transmutation","tags":["cleric","cantrip"],"type":"Transmutation cantrip"},{"casting_time":"1 action","classes":["bard","druid","sorcerer","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"A wave of thunderous force sweeps out from you. Each creature in a 15-foot cube originating from you must make a Constitution saving throw. On a failed save, a creature takes 2d8 thunder damage and is pushed 10 feet away from you. On a successful save, the creature takes half as much damage and isn\u2019t pushed. In addition, unsecured objects that are completely within the area of effect are automatically pushed 10 feet away from you by the spell\u2019s effect, and the spell emits a thunderous boom audible out to 300 feet.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 2nd level or higher, the damage increases by 1d8 for each slot level above 1st.","level":"1","name":"Thunderwave","range":"Self (15-foot cube)","ritual":false,"school":"evocation","tags":["bard","druid","sorcerer","wizard","level1"],"type":"1st-level evocation"},{"casting_time":"1 action","classes":["bard","cleric","druid","sorcerer","warlock","wizard"],"components":{"material":true,"materials_needed":["a small, straight piece of iron"],"raw":"V, S, M (a small, straight piece of iron)","somatic":true,"verbal":true},"description":"Choose a humanoid that you can see within range. The target must succeed on a Wisdom saving throw or be paralyzed for the duration. At the end of each of its turns, the target can make another Wisdom saving throw. On a success, the spell ends on the target.","duration":"Concentration, up to 1 minute","higher_levels":"When you cast this spell using a spell slot of 3rd level or higher, you can target one additional humanoid for each slot level above 2nd. The humanoids must be within 30 feet of each other when you target them.","level":"2","name":"Hold Person","range":"60 feet","ritual":true,"school":"enchantment","tags":["bard","cleric","druid","sorcerer","warlock","wizard","level2"],"type":"2nd-level enchantment (ritual)"},{"casting_time":"1 action","classes":["bard","cleric","druid","paladin","ranger"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"You touch a creature and can end either one disease or one condition afflicting it. The condition can be blinded, deafened, paralyzed, or poisoned.","duration":"Instantaneous","level":"2","name":"Lesser Restoration","range":"Touch","ritual":false,"school":"abjuration","tags":["bard","cleric","druid","paladin","ranger","level2"],"type":"2nd-level abjuration"},{"casting_time":"10 minutes","classes":["cleric"],"components":{"material":false,"raw":"V","somatic":false,"verbal":true},"description":"Up to six creatures of your choice that you can see within range each regain hit points equal to 2d8 + your spellcasting ability modifier. This spell has no effect on undead or constructs.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 3rd level or higher, the healing increases by 1d8 for each slot level above 2nd.","level":"2","name":"Prayer of Healing","range":"30 feet","ritual":false,"school":"evocation","tags":["cleric","level2"],"type":"2nd-level evocation"},{"casting_time":"1 bonus action","classes":["cleric"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"You create a floating, spectral weapon within range that lasts for the duration or until you cast this spell again. When you cast the spell, you can make a melee spell attack against a creature within 5 feet of the weapon. On a hit, the target takes force damage equal to 1d8 + your spellcasting ability modifier.\n\nAs a bonus action on your turn, you can move the weapon up to 20 feet and repeat the attack against a creature within 5 feet of it. The weapon can take whatever form you choose. Clerics of deities who are associated with a particular weapon (as St. Cuthbert is known for his mace and Thor for his hammer) make this spell\u2019s effect resemble that weapon.","duration":"1 minute","higher_levels":"When you cast this spell using a spell slot of 3rd level or higher, the damage increases by 1d8 for every two slot levels above 2nd.","level":"2","name":"Spiritual Weapon","range":"60 feet","ritual":false,"school":"evocation","tags":["cleric","level2"],"type":"2nd-level evocation"},{"casting_time":"1 action","classes":["cleric","paladin","sorcerer","warlock","wizard"],"components":{"material":true,"materials_needed":["an item distasteful to the target"],"raw":"V, S, M (an item distasteful to the target)","somatic":true,"verbal":true},"description":"You attempt to send one creature that you can see within range to another plane of existence. The target must succeed on a Charisma saving throw or be banished.\n\nIf the target is native to the plane of existance you're on, you banish the target to a harmless demiplane. While there, the target is incapacitated. The target remains there until the spell ends, at which point the target reappears in the space it left or in the nearest unoccupied space if that space is occupied.\n\nIf the target is native to a different plane of existance than the one you're on, the target is banished with a faint popping noise, returning to its home plane. If the spell ends before 1 minute has passed, the target reappears in the space it left or in the nearest unoccupied space if that space is occupied. Otherwise, the target doesn't return.","duration":"Concentration, up to 1 minute","higher_levels":"When you cast this spell using a spell slot of 5th level or higher, you can target one additional creature for each slot level above 4th.","level":"4","name":"Banishment","range":"60 feet","ritual":false,"school":"abjuration","tags":["cleric","paladin","sorcerer","warlock","wizard","level4"],"type":"4th-level abjuration"},{"casting_time":"1 action","classes":["druid","ranger"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"You summon fey spirits that take the form of beasts and appear in unoccupied spaces that you can see whithin range.  Choose one of the following options for what appears:\n\n* One beast of challenge rating 2 or lower\n\n* Two beasts of challenge rating 1 or lower\n\n* Four beasts of challenge rating 1/2 or lower\n\n* Eight beasts of challenge rating 1/4 or lower\n\nEach beast is also considered fey, and it disappears when it drops to 0 hit points or when the spell ends.\n\nThe summoned creatures are friendly to you and your companions. Roll initiative for the summoned creatures as a group, which has its own turns. They obey any verbal commands that you issue to them (no action required by you). If you don\u2019t issue any commands to them, they defend themselves from hostile creatures, but otherwise take no actions.\n\nThe DM has the creatures\u2019 statistics.","duration":"Concentration, up to 1 hour","higher_levels":"When you cast this spell using certain higher-level spell slots, you choose one of the summoning options above, and more creatures appear: twice as many with a 5th-level slot, three times as many with a 7th-level","level":"3","name":"Conjure Animals","range":"60 feet","ritual":false,"school":"conjuration","tags":["druid","ranger","level3"],"type":"3rd-level conjuration"},{"casting_time":"1 reaction, which you take when you see a creature within 60 feet of you casting a spell.","classes":["sorcerer","warlock","wizard"],"components":{"material":false,"raw":"S","somatic":true,"verbal":false},"description":"You attempt to interrupt a creature in the process of casting a spell. If the creature is casting a spell of 3rd level or lower, its spell fails and has no effect. If it is casting a spell of 4th level or higher, make an ability check using your spellcasting ability. The DC equals 10 + the spell\u2019s level. On a success, the creature\u2019s spell fails and has no effect.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 4th level or higher, the interrupted spell has no effect if its level is less than or equal to the level of the spell slot you used.","level":"3","name":"Counterspell","range":"60 feet","ritual":false,"school":"abjuration","tags":["sorcerer","warlock","wizard","level3"],"type":"3rd-level abjuration"},{"casting_time":"1 action","classes":["bard","cleric","druid","paladin","sorcerer","warlock","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"Choose one creature, object, or magical effect within range. Any spell of 3rd level or lower on the target ends. For each spell of 4th level or higher on the target, make an ability check using your spellcasting ability. The DC equals 10 + the spell\u2019s level. On a successful check, the spell ends.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 4th level or higher, you automatically end the effects of a spell on the target if the spell\u2019s level is equal to or less than the level of the spell slot you used.","level":"3","name":"Dispel Magic","range":"120 feet","ritual":false,"school":"abjuration","tags":["bard","cleric","druid","paladin","sorcerer","warlock","wizard","level3"],"type":"3rd-level abjuration"},{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":true,"materials_needed":["a tiny ball of bat guano and sulfur"],"raw":"V, S, M (a tiny ball of bat guano and sulfur)","somatic":true,"verbal":true},"description":"A bright streak flashes from your pointing finger to a point you choose within range and then blossoms with a low roar into an explosion of flame. Each creature in a 20-foot-radius sphere centered on that point must make a Dexterity saving throw. A target takes 8d6 fire damage on a failed save, or half as much damage on a successful one.\n\nThe fire spreads around corners. It ignites flammable objects in the area that aren't being worn or carried.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 4th level or higher, the damage increases by 1d6 for each slot level above 3rd.","level":"3","name":"Fireball","range":"150 feet","ritual":false,"school":"evocation","tags":["sorcerer","wizard","level3"],"type":"3rd-level evocation"},{"casting_time":"1 action","classes":["sorcerer","warlock","wizard"],"components":{"material":true,"materials_needed":["a wing feather from any bird"],"raw":"V, S, M (a wing feather from any bird)","somatic":true,"verbal":true},"description":"You touch a willing creature. The target gains a flying speed of 60 feet for the duration. When the spell ends, the target falls if it is still aloft, unless it can stop the fall.","duration":"Concentration, up to 10 minutes","higher_levels":"When you cast this spell using a spell slot of 4th level or higher, you can target one additional creature for each slot level above 3rd.","level":"3","name":"Fly","range":"Touch","ritual":false,"school":"transmutation","tags":["sorcerer","warlock","wizard","level3"],"type":"3rd-level transmutation"},{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":true,"materials_needed":["a shaving of licorice root"],"raw":"V, S, M (a shaving of licorice root)","somatic":true,"verbal":true},"description":"Choose a willing creature that you can see within range. Until the spell ends, the target\u2019s speed is doubled, it gains a +2 bonus to AC, it has advantage on Dexterity saving throws, and it gains an additional action on each of its turns. That action can be used only to take the Attack (one weapon attack only), Dash, Disengage, Hide, or Use an Object action.\n\nWhen the spell ends, the target can\u2019t move or take actions until after its next turn, as a wave of lethargy sweeps over it.","duration":"Concentration, up to 1 minute","level":"3","name":"Haste","range":"30 feet","ritual":false,"school":"transmutation","tags":["sorcerer","wizard","level3"],"type":"3rd-level transmutation"},{"casting_time":"1 bonus action","classes":["cleric"],"components":{"material":false,"raw":"V","somatic":false,"verbal":true},"description":"As you call out words of restoration, up to six creatures of your choice that you can see within range regain hit points equal to 1d4 + your spellcasting ability modifier. This spell has no effect on undead or constructs.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 4th level or higher, the healing increases by 1d4 for each slot level above 3rd.","level":"3","name":"Mass Healing Word","range":"60 feet","ritual":false,"school":"evocation","tags":["cleric","level3"],"type":"3rd-level evocation"},{"casting_time":"1 action","classes":["cleric","paladin"],"components":{"material":true,"materials_needed":["diamonds worth 300 gp, which the spell consumes"],"raw":"V, S, M (diamonds worth 300 gp, which the spell consumes)","somatic":true,"verbal":true},"description":"You touch a creature that has died within the last minute. That creature returns to life with 1 hit point. This spell can\u2019t return to life a creature that has died of old age, nor can it restore any missing body parts.","duration":"Instantaneous","level":"3","name":"Revivify","range":"Touch","ritual":false,"school":"conjuration","tags":["cleric","paladin","level3"],"type":"3rd-level conjuration"},{"casting_time":"1 action","classes":["cleric"],"components":{"material":true,"materials_needed":["a holy symbol"],"raw":"V, S, M (a holy symbol)","somatic":true,"verbal":true},"description":"You call forth spirits to protect you. They flit around you to a distance of 15 feet for the duration. If you are good or neutral, their spectral form appears angelic or fey (your choice). If you are evil, they appear fiendish.\n\nWhen you cast this spell, you can designate any number of creatures you can see to be unaffected by it. An affected creature\u2019s speed is halved in the area, and when the creature enters the area for the first time on a turn or starts its turn there, it must make a Wisdom saving throw. On a failed save, the creature takes 3d8 radiant damage (if you are good or neutral) or 3d8 necrotic damage (if you are evil). On a successful save, the creature takes half as much damage.","duration":"Concentration, up to 10 minutes","higher_levels":"When you cast this spell using a spell slot of 4th level or higher, the damage increases by 1d8 for each slot level above 3rd.","level":"3","name":"Spirit Guardians","range":"Self (15-foot radius)","ritual":false,"school":"conjuration","tags":["cleric","level3"],"type":"3rd-level conjuration"},{"casting_time":"1 action","classes":["bard","sorcerer","warlock","wizard"],"components":{"material":true,"materials_needed":["an eyelash encased in gum arabic"],"raw":"V, S, M (an eyelash encased in gum arabic)","somatic":true,"verbal":true},"description":"A creature you touch becomes invisible until the spell ends. Anything the target is wearing or carrying is invisible as long as it is on the target's person. The spell ends for a target that attacks or casts a spell.","duration":"Concentration, up to 1 hour","higher_levels":"When you cast this spell using a spell slot of 3rd level or higher, you can target one additional creature for each slot level above 2nd.","level":"2","name":"Invisibility","range":"Touch","ritual":false,"school":"illusion","tags":["bard","sorcerer","warlock","wizard","level2"],"type":"2nd-level illusion"},{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":true,"materials_needed":["a small crystal or a glass cone"],"raw":"V, S, M (a small crystal or a glass cone)","somatic":true,"verbal":true},"description":"A blast of cold air erupts from your hands. Each creature in a 60-foot cone must make a Constitution saving throw. A creature takes 8d8 cold damage on a failed save, or half as much damage on a successful one.\n\nA creature killed by this spell becomes a frozen statue until it thaws.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 6th level or higher, the damage increases by 1d8 for each slot level above 5th.","level":"5","name":"Cone of Cold","range":"Self (60-foot cone)","ritual":false,"school":"evocation","tags":["sorcerer","wizard","level5"],"type":"5th-level evocation"},{"casting_time":"1 action","classes":["cleric"],"components":{"material":true,"materials_needed":["pinch of sulfur"],"raw":"V, S, M (pinch of sulfur)","somatic":true,"verbal":true},"description":"A vertical column of divine fire roars down from the heavens in a location you specify. Each creature in a 10-foot radius, 40-foot-high cylinder centered on a point within range must make a Dexterity saving throw. A creature takes 4d6 fire damage and 4d6 radiant damage on a failed save, or half as much damage on a successful one.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 6th level or higher, the fire damage or the radiant damage (your choice) inceases by 1d6 for each slot level above 5th.","level":"5","name":"Flame Strike","range":"60 feet","ritual":false,"school":"evocation","tags":["cleric","level5"],"type":"5th-level evocation"},{"casting_time":"1 action","classes":["sorcerer","wizard","bard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"You or a creature you touch becomes invisible until the spell ends. Anything the target is wearing or carrying is invisible as long as it is on the target\u2019s person.","duration":"Concentration, up to 1 minute","level":"4","name":"Greater Invisibility","range":"Touch","ritual":false,"school":"illusion","tags":["sorcerer","wizard","bard","level4"],"type":"4th-level illusion"},{"casting_time":"1 action","classes":["druid","sorcerer","wizard"],"components":{"material":true,"materials_needed":["a pinch of dust and a few drops of water"],"raw":"V, S, M (a pinch of dust and a few drops of water)","somatic":true,"verbal":true},"description":"A hail of rock-hard ice pounds to the ground in a 20-foot-radius, 40-foot-high cylinder centered on a point within range. Each creature in the cylinder must make a Dexterity saving throw. A creature takes 2d8 bludgeoning damage and 4d6 cold damage on a failed save, or half as much damage on a successful one.\n\nHailstones turn the storm\u2019s area of effect into difficult terrain until the end of your next turn.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 5th level or higher, the bludgeoning damage increases by 1d8 for each slot level above 4th.","level":"4","name":"Ice Storm","range":"300 feet","ritual":false,"school":"evocation","tags":["druid","sorcerer","wizard","level4"],"type":"4th-level evocation"},{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":true,"materials_needed":["a bit of fur and a rod of amber, crystal, or glass"],"raw":"V, S, M (a bit of fur and a rod of amber, crystal, or glass)","somatic":true,"verbal":true},"description":"A stroke of lightning forming a line 100 feet long and 5 feet wide blasts out from you in a direction you choose. Each creature in the line must make a Dexterity saving throw. A creature takes 8d6 lightning damage on a failed save, or half as much damage on a successful one.\n\nThe lightning ignites flammable objects in the area that aren't being worn or carried.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 4th level or higher, the damage increases by 1d6 for each slot level above 3rd.","level":"3","name":"Lightning Bolt","range":"Self (100-foot line)","ritual":false,"school":"evocation","tags":["sorcerer","wizard","level3"],"type":"3rd-level evocation"},{"casting_time":"1 action","classes":["bard","cleric","druid"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"A wave of healing energy washes out from a point of your choice within range. Choose up to six creatures in a 30-foot-radius sphere centered on that point. Each target regains hit points equal to 3d8 + your spellcasting ability modifier. This spell has no effect on undead or constructs.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 6th level or higher, the healing increases by 1d8 for each slot level above 5th.","level":"5","name":"Mass Cure Wounds","range":"60 feet","ritual":false,"school":"conjuration","tags":["bard","cleric","druid","level5"],"type":"5th-level conjuration"},{"casting_time":"1 action","classes":["sorcerer","warlock","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"Three illusory duplicates of yourself appear in your space. Until the spell ends, the duplicates move with you and mimic your actions, shifting position so it's impossible to track which image is real. You can use your action to dismiss the illusory duplicates.\n\nEach time a creature targets you with an attack during the spell's duration, roll a d20 to determine whether the attack instead targets one of your duplicates.\n\nlf you have three duplicates, you must roll a 6 or higher to change the attack's target to a duplicate. With two duplicates, you must roll an 8 or higher. With one duplicate, you must roll an 11 or higher.\n\nA duplicate's AC equals 10 + your Dexterity modifier. If an attack hits a duplicate, the duplicate is destroyed. A duplicate can be destroyed only by an attack that hits it. It ignores all other damage and effects. The spell ends when all three duplicates are destroyed.\n\nA creature is unaffected by this spell if it can't see, if it relies on senses other than sight, such as blindsight, or if it can perceive illusions as false, as with truesight.","duration":"1 minute","level":"2","name":"Mirror Image","range":"Self","ritual":false,"school":"illusion","tags":["sorcerer","warlock","wizard","level2"],"type":"2nd-level illusion"},{"casting_time":"1 bonus action","classes":["sorcerer","warlock","wizard"],"components":{"material":false,"raw":"V","somatic":false,"verbal":true},"description":"Briefly surrounded by silvery mist, you teleport up to 30 feet to an unoccupied space that you can see.","duration":"Instantaneous","level":"2","name":"Misty Step","range":"Self","ritual":false,"school":"conjuration","tags":["sorcerer","warlock","wizard","level2"],"type":"2nd-level conjuration"},{"casting_time":"1 action","classes":["bard","druid","sorcerer","wizard"],"components":{"material":true,"materials_needed":["a caterpillar cocoon"],"raw":"V, S, M (a caterpillar cocoon)","somatic":true,"verbal":true},"description":"This spell transforms a creature that you can see within range into a new form. An unwilling creature must make a Wisdom saving throw to avoid the effect. A shapechanger automatically succeeds on this saving throw.\n\nThe transformation lasts for the duration, or until the target drops to 0 hit points or dies. The new form can be any beast whose challenge rating is equal to or less than the target's (or the target's level, if it doesn\u2019t have a challenge rating). The target's game statistics, including mental ability scores, are replaced by the statistics of the chosen beast. It retains its alignment and personality.\n\nThe target assumes the hit points of its new form. When it reverts to its normal form, the creature returns to the number of hit points it had before it transformed. If it reverts as a result of dropping to 0 hit points, any excess damage carries over to its normal form.\n\nAs long as the excess damage doesn't reduce the creature's normal form to 0 hit points, it isn't knocked unconscious.\n\nThe creature is limited in the actions it can perform by the nature of its new form, and it can't speak, cast spells, or take any other action that requires hands or speech.\n\nThe target's gear melds into the new form. The creature can't activate, use, wield, or otherwise benefit from any of its equipment.","duration":"Concentration, up to 1 hour","level":"4","name":"Polymorph","range":"60 feet","ritual":false,"school":"transmutation","tags":["bard","druid","sorcerer","wizard","level4"],"type":"4th-level transmutation"},{"casting_time":"1 hour","classes":["cleric","paladin","bard"],"components":{"material":true,"materials_needed":["a diamond worth at least 500 gp, which the spell consumes"],"raw":"V, S, M (a diamond worth at least 500 gp, which the spell consumes)","somatic":true,"verbal":true},"description":"You return a dead creature you touch to life, provided that it has been dead no longer than 10 days. If the creature's soul is both willing and at liberty to rejoin the body, the creature returns to life with 1 hit point.\n\nThis spell also neutralizes any poisons and cures nonmagical diseases that affected the creature at the time it died. This spell doesn't, however, remove magical diseases, curses, or similar effects; if these aren't first removed prior to casting the spell, they take effect when the creature returns to life. The spell can\u2019t return an undead creature to life.\n\nThis spell closes all mortal wounds, but it doesn't restore missing body parts. If the creature is lacking body parts or organs integral for its survival\u2014its head, for instance\u2014the spell automatically fails.\n\nComing back from the dead is an ordeal. The target takes a \u22124 penalty to all attack rolls, saving throws, and ability checks. Every time the target finishes a long rest, the penalty is reduced by 1 until it disappears.","duration":"Instantaneous","level":"5","name":"Raise Dead","range":"Touch","ritual":false,"school":"necromancy","tags":["cleric","paladin","bard","level5"],"type":"5th-level necromancy"},{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":false,"raw":"V, S","somatic":true,"verbal":true},"description":"You create three rays of fire and hurl them at targets within range. You can hurl them at one target or several.\n\nMake a ranged spell attack for each ray. On a hit, the target takes 2d6 fire damage.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 3rd level or higher, you create one additional ray for each slot level above 2nd.","level":"2","name":"Scorching Ray","range":"120 feet","ritual":false,"school":"evocation","tags":["sorcerer","wizard","level2"],"type":"2nd-level evocation"},{"casting_time":"1 action","classes":["bard","sorcerer","warlock","wizard"],"components":{"material":true,"materials_needed":["a chip of mica"],"raw":"V, S, M (a chip of mica)","somatic":true,"verbal":true},"description":"A sudden loud ringing noise, painfully intense, erupts from a point of your choice within range. Each creature in a lO-foot-radius sphere centered on that point must make a Constitution saving throw. A creature takes 3d8 thunder damage on a failed save, or half as much damage on a successful one. A creature made of inorganic material such as stone, crystal, or metal has disadvantage on this saving throw.\n\nA nonmagical object that isn't being worn or carried also takes the damage if it's in the spell's area.","duration":"Instantaneous","higher_levels":"When you cast this spell using a spell slot of 3rd levei or higher, the damage increases by ld8 for each slot level above 2nd.","level":"2","name":"Shatter","range":"60 feet","ritual":false,"school":"evocation","tags":["bard","sorcerer","warlock","wizard","level2"],"type":"2nd-level evocation"},{"casting_time":"1 minute","classes":["bard","sorcerer","wizard"],"components":{"material":true,"materials_needed":["rare chalks and inks infused with precious gems with 50 gp, which the spell consumes"],"raw":"V, M (rare chalks and inks infused with precious gems with 50 gp, which the spell consumes)","somatic":false,"verbal":true},"description":"As you cast the spell, you draw a 10-foot-diameter circle on the ground inscribed with sigils that link your location to a permanent teleportation circle of your choice, whose sigil sequence you know and that is on the same plane of existence as you. A shimmering portal opens within the circle you drew and remains open until the end of your next turn. Any creature that enters the portal instantly appears within 5 feet of the destination circle or in the nearest unoccupied space if that space is occupied.\n\nMany major temples, guilds, and other important places have permanent teleportation circles inscribed somewhere within their confines. Each such circle includes a unique sigil sequence\u2014-a string of magical runes arranged in a particular pattern. When you first gain the ability to cast this spell, you learn the sigil sequences for two destinations on the Material Plane, determined by the DM. You can learn additional sigil sequences during your adventures. You can commit a new sigil sequence to memory after studying it for 1 minute.\n\nYou can create a permanent teleportation circle by casting this spell in the same location every day for one year. You need not use the circle to teleport when you cast the spell in this way.","duration":"1 round","level":"5","name":"Teleportation Circle","range":"10 feet","ritual":false,"school":"conjuration","tags":["bard","sorcerer","wizard","level5"],"type":"5th-level conjuration"},{"casting_time":"1 action","classes":["druid","sorcerer","wizard"],"components":{"material":true,"materials_needed":["a small piece of phosphorus"],"raw":"V, S, M (a small piece of phosphorus)","somatic":true,"verbal":true},"description":"You create a wall of fire on a solid surface within range. You can make the wall up to 60 feet long, 20 feet high, and 1 foot thick, or a ringed wall up to 20 feet in diameter, 20 feet high, and 1 foot thick. The wall is opaque and lasts for the duration.\n\nWhen the wall appears, each creature within its area must make a Dexterity saving throw. On a failed save, a creature takes 5d8 fire damage, or half as much damage on a successful save.\n\nOne side of the wall, selected by you when you cast this spell, deals 5d8 fire damage to each creature that ends its turn within 10 feet of that side or inside the wall. A creature takes the same damage when it enters the wall for the first time on a turn or ends its turn there. The other side of the wall deals no damage.","duration":"Concentration, up to 1 minute","higher_levels":"When you cast this spell using a spell slot of 5th level or higher, the damage increases by 1d8 for each slot level above 4th.","level":"4","name":"Wall of Fire","range":"120 feet","ritual":false,"school":"evocation","tags":["druid","sorcerer","wizard","level4"],"type":"4th-level evocation"},{"casting_time":"1 action","classes":["sorcerer","wizard"],"components":{"material":true,"materials_needed":["a bit of spiderweb"],"raw":"V, S, M (a bit of spiderweb)","somatic":true,"verbal":true},"description":"You conjure a mass of thick, sticky webbing at a point of your choice within range. The webs fill a 20-foot cube from that point for the duration. The webs are difficult terrain and lightly obscure their area.\n\nIf the webs aren't anchored between two solid masses (such as walls or trees) or layered across a floor, wall, or ceiling, the conjured web collapses on itself, and the spell ends at the start of your next turn. Webs layered over a flat surface have a depth of 5 feet.\n\nEach creature that starts its turn in the webs or that enters them during its turn must make a Dexterity saving throw. On a failed save, the creature is restrained as long as it remains in the webs or until it breaks free.\n\nA creature restrained by the webs can use its action to make a Strength cheek against your spell save DC. If it suceeeds, it is no longer restrained.\n\nThe webs are flammable. Any 5-foot cube of webs exposed to fire burns away in 1 round, dealing 2d4 fire damage to any creature that starts its turn in the fire.","duration":"Concentration, up to 1 hour","level":"2","name":"Web","range":"60 feet","ritual":false,"school":"conjuration","tags":["sorcerer","wizard","level2"],"type":"2nd-level conjuration"}];

        // Map to our format
        allSpellsFromAPI = fallbackSpells.map(spell => ({
          index: spell.name.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, ''),
          name: spell.name,
          level: spell.level === 'cantrip' ? 0 : parseInt(spell.level),
          school: { name: spell.school },
          desc: [spell.description],
          casting_time: spell.casting_time,
          range: spell.range,
          components: spell.components.raw,
          duration: spell.duration,
          concentration: spell.duration.includes('Concentration'),
          ritual: spell.ritual,
          classes: spell.classes || []
        }));

        filteredSpells = allSpellsFromAPI;
        renderPickerSpells(filteredSpells);

        // Show info message
        const infoMsg = `<div style="background: #ff9800; color: white; padding: 10px; margin-bottom: 10px; border-radius: 6px; font-size: 0.9rem;">
          ‚ÑπÔ∏è Using embedded spell database (${allSpellsFromAPI.length} spells).
          For full spell list, run: <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">python3 -m http.server 8000</code>
        </div>`;
        body.insertAdjacentHTML('afterbegin', infoMsg);
        return;
      }
    }

    function extractDamageFromDescription(description) {
      // Simple regex to extract damage dice (e.g., "1d6", "2d8")
      const damageMatch = description.match(/(\d+d\d+(?:\s*\+\s*\d+)?)/);
      return damageMatch ? damageMatch[1] : null;
    }

    function extractSaveFromDescription(description) {
      // Extract save type (Dexterity, Constitution, etc.)
      const saveMatch = description.match(/(Strength|Dexterity|Constitution|Intelligence|Wisdom|Charisma)\s+saving\s+throw/i);
      if (saveMatch) {
        return { dc_type: { name: saveMatch[1] } };
      }
      return null;
    }

    function renderPickerSpells(spells) {
      const body = document.getElementById('spellPickerBody');

      if (spells.length === 0) {
        body.innerHTML = '<div class="spell-picker-empty">No spells found matching your search.</div>';
        return;
      }

      let html = '<div class="spell-picker-list">';

      spells.forEach(spell => {
        const levelText = spell.level === 0 ? 'Cantrip' : `Level ${spell.level}`;
        const school = spell.school?.name || 'Unknown';
        const alreadyHas = hasSpell(spell.index);

        html += `
          <div class="spell-picker-item" style="cursor: pointer;" onclick="openSpellPickerDetail('${spell.index}')">
            <div class="spell-picker-item-info">
              <div class="spell-picker-item-name">${spell.name}</div>
              <div class="spell-picker-item-meta">${levelText} ‚Ä¢ ${school}</div>
            </div>
            <button class="spell-picker-item-add"
                    onclick="event.stopPropagation(); addSpellToCharacter('${spell.index}')"
                    ${alreadyHas ? 'disabled' : ''}>
              ${alreadyHas ? '‚úì Added' : '+ Add'}
            </button>
          </div>
        `;
      });

      html += '</div>';
      body.innerHTML = html;
    }

    function filterByLevel(level) {
      currentLevelFilter = level;

      // Update active button
      document.querySelectorAll('.spell-picker-filter').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.level === level);
      });

      filterPickerSpells();
    }

    function filterByClass(classFilter) {
      currentClassFilter = classFilter;
      filterPickerSpells();
    }

        function filterPickerSpells() {
      const searchTerm = document.getElementById('spellPickerSearch').value.toLowerCase();

      filteredSpells = allSpellsFromAPI.filter(spell => {
        const matchesSearch = spell.name.toLowerCase().includes(searchTerm) ||
                            (spell.school?.name || '').toLowerCase().includes(searchTerm);
        const matchesLevel = currentLevelFilter === 'all' || spell.level === parseInt(currentLevelFilter);
        const matchesClass = currentClassFilter === 'all' ||
                            (spell.classes && Array.isArray(spell.classes) &&
                             spell.classes.some(c => typeof c === 'string' && c.toLowerCase() === currentClassFilter));

        return matchesSearch && matchesLevel && matchesClass;
      });

            renderPickerSpells(filteredSpells);
    }

    function hasSpell(spellIndex) {
      // Check if character already has this spell
      if (!currentCharacter.spells) return false;

      for (const level in currentCharacter.spells) {
        if (currentCharacter.spells[level].some(s => s.id === spellIndex)) {
          return true;
        }
      }
      return false;
    }

    function addSpellToCharacter(spellIndex) {
      const apiSpell = allSpellsFromAPI.find(s => s.index === spellIndex);
      if (!apiSpell) return;

      // Check if already has spell
      if (hasSpell(spellIndex)) {
        addBattleLog(`‚ö†Ô∏è ${currentCharacter.name} already knows ${apiSpell.name}!`);
        return;
      }

      // Map API spell to our format
      const spell = mapAPISpellToCharacterSpell(apiSpell);
      const level = apiSpell.level.toString();

      // Initialize spell level array if needed
      if (!currentCharacter.spells[level]) {
        currentCharacter.spells[level] = [];
      }

      // Add spell to character
      currentCharacter.spells[level].push(spell);

      // Update UI
      addBattleLog(`üìñ ${currentCharacter.name} learned ${spell.name}!`);
      updateSpellsTab();

      // Re-render picker to update button states
      filterPickerSpells();
    }

    function mapAPISpellToCharacterSpell(apiSpell) {
      // Map spell format to our character spell format
      // Handle both local SRD format and API format
      const spell = {
        id: apiSpell.index,
        name: apiSpell.name,
        icon: getSpellIcon(apiSpell.school?.name, apiSpell.name),
        description: (apiSpell.desc || []).join(' '),
        school: apiSpell.school?.name || 'Evocation',
        castingTime: apiSpell.casting_time || '1 action',
        range: apiSpell.range || 'Self',
        // Components can be either string (from local) or array (from API)
        components: typeof apiSpell.components === 'string' ? apiSpell.components : (Array.isArray(apiSpell.components) ? apiSpell.components.join(', ') : 'V, S'),
        duration: apiSpell.duration || 'Instantaneous',
        concentration: apiSpell.concentration || false,
        prepared: false
      };

      // Add damage if present (from our mapping or from API)
      if (apiSpell.damage) {
        if (typeof apiSpell.damage === 'string') {
          spell.damage = apiSpell.damage;
        } else if (apiSpell.damage?.damage_at_character_level || apiSpell.damage?.damage_at_slot_level) {
          const damageData = apiSpell.damage.damage_at_character_level || apiSpell.damage.damage_at_slot_level;
          const firstLevel = Object.keys(damageData)[0];
          spell.damage = damageData[firstLevel];
        }
      }

      // Detect if spell requires attack roll
      // Check description for attack keywords or if it's explicitly marked
      const needsAttackRoll = apiSpell.attack_roll ||
                             (apiSpell.desc && apiSpell.desc.some(d =>
                               d.includes('ranged spell attack') ||
                               d.includes('melee spell attack') ||
                               d.includes('spell attack')
                             ));

      // If spell has damage and description suggests attack, mark it
      if (spell.damage && needsAttackRoll) {
        spell.attackRoll = true;
      }

      // Add save requirement if present
      if (apiSpell.dc) {
        spell.save = apiSpell.dc.dc_type?.name || 'DEX';
      }

      // Determine if it's an attack roll or save
      if (apiSpell.attack_type === 'ranged' || apiSpell.attack_type === 'melee') {
        spell.attackRoll = true;
      } else if (apiSpell.dc?.dc_type?.name) {
        spell.save = apiSpell.dc.dc_type.name;
      }

      return spell;
    }

    function getSpellIcon(school, name) {
      // Map spell schools to appropriate icons
      const schoolIcons = {
        'Abjuration': 'üõ°Ô∏è',
        'Conjuration': 'üåÄ',
        'Divination': 'üîÆ',
        'Enchantment': '‚ú®',
        'Evocation': 'üî•',
        'Illusion': 'üëÅÔ∏è',
        'Necromancy': 'üíÄ',
        'Transmutation': 'üîÑ'
      };

      // Special cases based on spell name
      const nameLower = name.toLowerCase();
      if (nameLower.includes('fire') || nameLower.includes('flame')) return 'üî•';
      if (nameLower.includes('ice') || nameLower.includes('frost') || nameLower.includes('cold')) return '‚ùÑÔ∏è';
      if (nameLower.includes('light') || nameLower.includes('sacred')) return '‚ú®';
      if (nameLower.includes('heal') || nameLower.includes('cure')) return '‚ù§Ô∏è';
      if (nameLower.includes('shield') || nameLower.includes('armor')) return 'üõ°Ô∏è';
      if (nameLower.includes('lightning') || nameLower.includes('thunder')) return '‚ö°';
      if (nameLower.includes('poison')) return '‚ò†Ô∏è';
      if (nameLower.includes('magic missile')) return 'üí´';
      if (nameLower.includes('arrow') || nameLower.includes('bolt')) return 'üèπ';

      return schoolIcons[school] || '‚ú®';
    }

    function updateSkills() {
      const profBonus = 2 + Math.floor((currentCharacter.level - 1) / 4);

      Object.entries(currentCharacter.skills).forEach(([skillName, [ability, proficiency]]) => {
        const abilityMod = Math.floor((currentCharacter.stats[ability] - 10) / 2);
        const profMod = proficiency * profBonus;
        const total = abilityMod + profMod;

        const skillId = 'skill-' + skillName.toLowerCase().replace(/\s+/g, '');
        const element = document.getElementById(skillId);
        if (element) {
          element.textContent = (total >= 0 ? '+' : '') + total;
        }
      });
    }

    function switchChatMode(mode) {
      currentChatMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Show/hide appropriate sections
      document.getElementById('conversationMode').style.display = mode === 'conversation' ? 'block' : 'none';
      document.getElementById('battleMode').style.display = mode === 'battle' ? 'block' : 'none';
    }

    function switchStatTab(tab) {
      // Remove active class from all tab buttons
      document.querySelectorAll('.stat-tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Show/hide appropriate tabs
      document.getElementById('statsTab').style.display = tab === 'stats' ? 'block' : 'none';
      document.getElementById('skillsTab').style.display = tab === 'skills' ? 'block' : 'none';
      document.getElementById('abilitiesTab').style.display = tab === 'abilities' ? 'block' : 'none';
      document.getElementById('spellsTab').style.display = tab === 'spells' ? 'block' : 'none';
      document.getElementById('inventoryTab').style.display = tab === 'inventory' ? 'block' : 'none';

      // Update content when switching tabs
      if (tab === 'inventory') {
        updateInventory();
      } else if (tab === 'abilities') {
        updateAbilitiesTab();
      } else if (tab === 'spells') {
        updateSpellsTab();
      }
    }

    // Hide/show Spells tab based on character class and subclass
    function updateTabVisibility() {
      const spellsTabBtn = document.getElementById('spellsTabBtn');
      if (!spellsTabBtn) return;

      // Classes that don't have spells
      const nonCasters = ['barbarian', 'monk'];
      const charClass = currentCharacter.class.toLowerCase();
      const subclass = currentCharacter.subclass || '';

      // 1/3 casters (Fighter Eldritch Knight, Rogue Arcane Trickster)
      const thirdCasterSubclasses = ['Eldritch Knight', 'Arcane Trickster'];
      const isThirdCaster = thirdCasterSubclasses.includes(subclass);

      // Hide spells tab only for pure martials (not including 1/3 casters)
      const shouldHideSpells = nonCasters.includes(charClass) ||
                               (charClass === 'fighter' && !isThirdCaster) ||
                               (charClass === 'rogue' && !isThirdCaster);

      if (shouldHideSpells) {
        spellsTabBtn.style.display = 'none';
        // If currently on spells tab, switch to stats
        if (document.getElementById('spellsTab').style.display === 'block') {
          switchStatTab('stats');
          document.querySelector('.stat-tab-btn[onclick*="stats"]').classList.add('active');
        }
      } else {
        spellsTabBtn.style.display = '';
      }
    }

    function changeCharacterState() {
      currentState = document.getElementById('characterState').value;
      updateMessages();
    }

    function updateCharacterState() {
      const state = document.getElementById('characterStateStats').value;
      console.log('Character state changed to:', state);
      // This can be used to apply state-based modifiers or effects
      // For now, just log the state change
    }

    function updateMessages() {
      const stateConfig = currentCharacter.states?.[currentState];
      if (stateConfig && stateConfig.greeting) {
        document.getElementById('greetingMessage').textContent = stateConfig.greeting;
      } else {
        // Fallback if state doesn't exist
        console.warn(`State '${currentState}' not found for character ${currentCharacter.name}`);
        document.getElementById('greetingMessage').textContent = `${currentCharacter.name} is ready for adventure.`;
      }
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (!message) return;

      const messagesArea = document.getElementById('messagesArea');

      // Add player message
      messagesArea.innerHTML += `
        <div class="message player">
          <div class="message-avatar">üë§</div>
          <div class="message-content">
            <div class="message-text">${message}</div>
          </div>
        </div>
      `;

      input.value = '';

      // Simulate character response
      setTimeout(() => {
        const responses = [
          "That's an interesting point. Tell me more.",
          "I understand your concern. Let me think about this...",
          "Fascinating. I hadn't considered that perspective.",
          "We should proceed carefully. What do you suggest?",
          "Your wisdom is valuable. Together we can solve this."
        ];
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];

        messagesArea.innerHTML += `
          <div class="message">
            <div class="message-avatar">${currentCharacter.emoji}</div>
            <div class="message-content">
              <div class="message-header">${currentCharacter.name}</div>
              <div class="message-text">${randomResponse}</div>
            </div>
          </div>
        `;

        messagesArea.scrollTop = messagesArea.scrollHeight;
      }, 800);

      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function addBattleLog(message) {
      // If in conversation mode, don't add to battle log
      if (currentChatMode === 'conversation') return;

      const battleLog = document.getElementById('battleLog');
      if (!battleLog) return;

      // Clear placeholder if this is the first entry
      if (battleLog.innerHTML.includes('Battle actions and rolls will appear here')) {
        battleLog.innerHTML = '';
      }

      const timestamp = new Date().toLocaleTimeString();
      battleLog.innerHTML += `
        <div style="margin-bottom: 10px; padding: 8px; background: var(--surface-color); border-left: 3px solid var(--accent-color); border-radius: 4px;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">${timestamp}</div>
          <div style="color: var(--text-primary);">${message}</div>
        </div>
      `;
      battleLog.scrollTop = battleLog.scrollHeight;
    }

    function rollAttack() {
      // Legacy function - redirect to melee attack
      rollMeleeAttack();
    }

    function rollMeleeAttack() {
      const strMod = Math.floor((currentCharacter.stats.str - 10) / 2);
      const roll = Math.floor(Math.random() * 20) + 1;
      const total = roll + strMod;
      const breakdown = `1d20${strMod >= 0 ? '+' : ''}${strMod}`;

      showDiceRoll('Melee Attack', 'd20', roll, total, breakdown, roll === 20 ? 'success' : (roll === 1 ? 'fail' : null));
      addBattleLog(`‚öîÔ∏è ${currentCharacter.name} rolled Melee Attack: ${total} (${breakdown})`);

      // Roll damage if hit (not on nat 1)
      if (roll !== 1) {
        setTimeout(() => {
          const damageRoll = Math.floor(Math.random() * 8) + 1 + strMod;
          addBattleLog(`üí• Damage: ${damageRoll} (1d8${strMod >= 0 ? '+' : ''}${strMod})`);
        }, 500);
      }
    }

    function rollRangedAttack() {
      const dexMod = Math.floor((currentCharacter.stats.dex - 10) / 2);
      const roll = Math.floor(Math.random() * 20) + 1;
      const total = roll + dexMod;
      const breakdown = `1d20${dexMod >= 0 ? '+' : ''}${dexMod}`;

      showDiceRoll('Ranged Attack', 'd20', roll, total, breakdown, roll === 20 ? 'success' : (roll === 1 ? 'fail' : null));
      addBattleLog(`üèπ ${currentCharacter.name} rolled Ranged Attack: ${total} (${breakdown})`);

      // Roll damage if hit (not on nat 1)
      if (roll !== 1) {
        setTimeout(() => {
          const damageRoll = Math.floor(Math.random() * 8) + 1 + dexMod;
          addBattleLog(`üí• Damage: ${damageRoll} (1d8${dexMod >= 0 ? '+' : ''}${dexMod})`);
        }, 500);
      }
    }

    function rollDice(type, dice, modifier = 0) {
      const sides = parseInt(dice.substring(1));
      const roll = Math.floor(Math.random() * sides) + 1;

      // Apply temporary modifiers
      let tempMod = 0;
      if (tempModifiers.length > 0) {
        tempMod = tempModifiers.reduce((sum, mod) => sum + mod.value, 0);
      }

      const totalModifier = modifier + tempMod;
      const total = roll + totalModifier;

      let breakdown = `1${dice}`;
      if (modifier !== 0) {
        breakdown += `${modifier >= 0 ? '+' : ''}${modifier}`;
      }
      if (tempMod !== 0) {
        breakdown += ` [Temp: ${tempMod >= 0 ? '+' : ''}${tempMod}]`;
      }

      const isCritical = sides === 20 && (roll === 20 || roll === 1);

      showDiceRoll(type, dice, roll, total, breakdown, roll === 20 ? 'success' : (roll === 1 ? 'fail' : null));

      // Add to battle log
      if (currentChatMode === 'battle') {
        addBattleLog(`${currentCharacter.name} rolled ${type}: ${total} (${breakdown})`);
      }
    }

    function showDiceRoll(type, diceType, baseRoll, total, breakdown, critical) {
      const overlay = document.getElementById('diceOverlay');
      const result = document.getElementById('diceResult');
      const icon = document.getElementById('diceIcon');
      const typeEl = document.getElementById('diceType');
      const valueEl = document.getElementById('diceValue');
      const breakdownEl = document.getElementById('diceBreakdown');

      icon.textContent = 'üé≤';
      typeEl.textContent = type;
      valueEl.textContent = total;
      breakdownEl.textContent = breakdown;

      // Apply critical styling
      result.className = 'dice-result';
      if (critical === 'success') {
        result.classList.add('critical-success');
      } else if (critical === 'fail') {
        result.classList.add('critical-fail');
      }

      overlay.classList.add('show');

      setTimeout(() => {
        overlay.classList.remove('show');
      }, 2800);
    }

    function rollSkill(skillName, ability) {
      const skillKey = skillName.toLowerCase().replace(/\s+/g, '');
      const [, proficiency] = currentCharacter.skills[skillKey] || [ability, 0];

      const abilityMod = Math.floor((currentCharacter.stats[ability] - 10) / 2);
      const profBonus = 2 + Math.floor((currentCharacter.level - 1) / 4);
      const modifier = abilityMod + (proficiency * profBonus);

      const roll = Math.floor(Math.random() * 20) + 1;
      const total = roll + modifier;
      const breakdown = `1d20${modifier >= 0 ? '+' : ''}${modifier}`;

      // Get emoji from the clicked button if available
      const skillEmojiMap = {
        'Arcana': '‚ú®', 'History': 'üìú', 'Investigation': 'üîç', 'Nature': 'üåø', 'Religion': '‚õ™',
        'Animal Handling': 'üê∫', 'Insight': 'üí≠', 'Medicine': '‚öïÔ∏è', 'Perception': 'üëÅÔ∏è', 'Survival': 'üèïÔ∏è',
        'Deception': 'üé≠', 'Intimidation': 'üò†', 'Performance': 'üé™', 'Persuasion': 'ü§ù',
        'Acrobatics': 'ü§∏', 'Sleight of Hand': 'üëã', 'Stealth': 'ü•∑',
        'Athletics': 'üí™'
      };
      const displayEmoji = skillEmojiMap[skillName] || 'üé≤';

      showDiceRoll(skillName, 'd20', roll, total, breakdown, roll === 20 ? 'success' : (roll === 1 ? 'fail' : null));

      // Always add to battle log
      addBattleLog(`${displayEmoji} ${currentCharacter.name} rolled ${skillName}: ${total} (${breakdown})`);
    }

    function rollRandomDice() {
      const types = ['Attack Roll', 'Saving Throw', 'Ability Check', 'Damage Roll'];
      const type = types[Math.floor(Math.random() * types.length)];
      const modifier = Math.floor(Math.random() * 6);
      rollDice(type, 'd20', modifier);
    }

    function useAbility(abilityId) {
      const ability = currentCharacter.abilities.find(a => a.id === abilityId);
      if (!ability) return;

      // Add to battle log
      addBattleLog(`${currentCharacter.name} uses ${ability.icon} ${ability.name}!`);

      // Roll dice if ability has damage
      if (ability.damage) {
        setTimeout(() => {
          // Parse damage (e.g., "4d6", "2d8+4")
          const match = ability.damage.match(/(\d+)d(\d+)([+-]\d+)?/);
          if (match) {
            const count = parseInt(match[1]);
            const sides = parseInt(match[2]);
            const modifier = match[3] ? parseInt(match[3]) : 0;

            let total = modifier;
            for (let i = 0; i < count; i++) {
              total += Math.floor(Math.random() * sides) + 1;
            }

            const breakdown = `${count}d${sides}${modifier >= 0 && modifier !== 0 ? '+' : ''}${modifier !== 0 ? modifier : ''}`;
            showDiceRoll(ability.name, `d${sides}`, 0, total, breakdown, null);

            addBattleLog(`Damage: ${total} (${breakdown})`);
          }
        }, 500);
      }
    }

    function quickAction(action) {
      const messages = {
        dash: `${currentCharacter.name} dashes forward!`,
        dodge: `${currentCharacter.name} takes the Dodge action.`,
        help: `${currentCharacter.name} helps an ally!`
      };

      addBattleLog(messages[action] || 'Action performed!');
    }

    function castDefaultSpell() {
      // Find the default spell
      let defaultSpell = null;
      let spellLevel = null;

      if (currentCharacter.spells) {
        Object.keys(currentCharacter.spells).forEach(level => {
          currentCharacter.spells[level].forEach(spell => {
            if (spell.isDefault && spell.prepared) {
              defaultSpell = spell;
              spellLevel = level;
            }
          });
        });
      }

      if (!defaultSpell) {
        addBattleLog('‚ö†Ô∏è No default spell set! Go to the Abilities tab to set a default prepared spell.');
        return;
      }

      // Cast the spell
      const spellName = defaultSpell.name;
      const spellIcon = defaultSpell.icon || '‚ú®';

      addBattleLog(`${spellIcon} ${currentCharacter.name} casts ${spellName}!`);

      if (defaultSpell.damage) {
        // If spell has damage, roll it
        setTimeout(() => {
          const damageRoll = defaultSpell.damage.match(/(\d+)d(\d+)/);
          if (damageRoll) {
            const count = parseInt(damageRoll[1]);
            const sides = parseInt(damageRoll[2]);
            let total = 0;
            const rolls = [];

            for (let i = 0; i < count; i++) {
              const roll = Math.floor(Math.random() * sides) + 1;
              rolls.push(roll);
              total += roll;
            }

            addBattleLog(`üí• Spell Damage: ${total} (${rolls.join(' + ')})`);
          }
        }, 300);
      }
    }



    function updateCantripButton() {
      const cantripBtn = document.querySelector('.action-btn[onclick="castCantrip()"]');
      if (!cantripBtn) return;

      // Classes that get cantrips
      const cantripClasses = ['bard', 'cleric', 'druid', 'sorcerer', 'warlock', 'wizard'];
      const charClass = currentCharacter.class.toLowerCase();

      // Hide button for classes without cantrips
      if (!cantripClasses.includes(charClass)) {
        cantripBtn.style.display = 'none';
        return;
      }

      // Show button for cantrip classes
      cantripBtn.style.display = '';

      if (selectedCantrip) {
        cantripBtn.textContent = `${selectedCantrip.icon || '‚ú®'} ${selectedCantrip.name}`;
      } else {
        cantripBtn.textContent = '‚ú® Cantrip';
      }
    }
    function selectCantripForBattle(spellId) {
      const cantrip = currentCharacter.spells['0']?.find(s => s.id === spellId);
      if (cantrip) {
        selectedCantrip = cantrip;
        updateCantripButton();
        addBattleLog(`‚ú® Equipped ${cantrip.name} for battle!`);
        updateSpellsTab(); // Refresh to show selection
      }
    }


        function castCantrip() {
      if (!selectedCantrip) {
        addBattleLog('‚ö†Ô∏è No cantrip selected! Go to the Abilities tab and click on a cantrip to select it.');
        return;
      }

      const spellName = selectedCantrip.name;
      const spellIcon = selectedCantrip.icon || '‚ú®';
      const spellSaveDC = currentCharacter.computed?.spellSaveDC || (8 + 2 + Math.floor((currentCharacter.stats.wis - 10) / 2));

      addBattleLog(`${spellIcon} ${currentCharacter.name} casts ${spellName}!`);

      // Check if it's an attack spell or save spell
      if (selectedCantrip.attackRoll) {
        // Attack spell - roll to hit
        const intMod = Math.floor((currentCharacter.stats.int - 10) / 2);
        const profBonus = 2 + Math.floor((currentCharacter.level - 1) / 4);
        const spellAttack = intMod + profBonus;
        const roll = Math.floor(Math.random() * 20) + 1;
        const total = roll + spellAttack;

        addBattleLog(`üéØ Spell Attack: ${total} (1d20+${spellAttack})`);

        if (roll !== 1) {
          setTimeout(() => {
            if (selectedCantrip.damage) {
              const damageRoll = selectedCantrip.damage.match(/(\d+)d(\d+)/);
              if (damageRoll) {
                const count = parseInt(damageRoll[1]);
                const sides = parseInt(damageRoll[2]);
                let total = 0;
                const rolls = [];

                for (let i = 0; i < count; i++) {
                  const r = Math.floor(Math.random() * sides) + 1;
                  rolls.push(r);
                  total += r;
                }

                addBattleLog(`üí• Spell Damage: ${total} (${rolls.join(' + ')})`);
              }
            }
          }, 300);
        }
      } else {
        // Save spell - show DC
        addBattleLog(`üõ°Ô∏è Target must make a saving throw (DC ${spellSaveDC})`);

        if (selectedCantrip.damage) {
          setTimeout(() => {
            const damageRoll = selectedCantrip.damage.match(/(\d+)d(\d+)/);
            if (damageRoll) {
              const count = parseInt(damageRoll[1]);
              const sides = parseInt(damageRoll[2]);
              let total = 0;
              const rolls = [];

              for (let i = 0; i < count; i++) {
                const r = Math.floor(Math.random() * sides) + 1;
                rolls.push(r);
                total += r;
              }

              addBattleLog(`üí• Spell Damage on failed save: ${total} (${rolls.join(' + ')})`);
            }
          }, 300);
        }
      }
    }

    function selectCantrip(spellId, level) {
      // Find and set the selected cantrip
      if (currentCharacter.spells && currentCharacter.spells[level]) {
        const cantrip = currentCharacter.spells[level].find(s => s.id === spellId);
        if (cantrip) {
          selectedCantrip = cantrip;
          addBattleLog(`‚ú® Selected cantrip: ${cantrip.name}`);
          updateAbilitiesTab(); // Refresh the abilities tab to show selection
        }
      }
    }

    function updatePortraitExpression() {
      const expression = document.getElementById('portraitExpression').value;
      console.log('Portrait expression changed to:', expression);
      // This would trigger an API call to generate new portrait with the expression
      // For now, just log it
    }

    function togglePortraitFullsize() {
      const overlay = document.getElementById('portraitFullsizeOverlay');
      const fullsizePortrait = document.getElementById('fullsizePortrait');
      const footerPortrait = document.getElementById('footerPortrait');

      if (overlay.style.display === 'none' || overlay.style.display === '') {
        // Show fullsize
        fullsizePortrait.textContent = footerPortrait.textContent;
        overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent scrolling
      } else {
        // Hide fullsize
        overlay.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
      }
    }

    function toggleCanvasFullsize() {
      const overlay = document.getElementById('canvasFullsizeOverlay');
      const fullsizeCanvas = document.getElementById('fullsizeCanvas');
      const canvasDisplay = document.getElementById('canvasDisplay');

      if (overlay.style.display === 'none' || overlay.style.display === '') {
        // Show fullsize - copy background and content
        fullsizeCanvas.style.background = canvasDisplay.style.background || getComputedStyle(canvasDisplay).background;
        fullsizeCanvas.textContent = canvasDisplay.textContent;
        overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent scrolling
      } else {
        // Hide fullsize
        overlay.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
      }
    }

    function nextTurn() {
      turnNumber++;
      document.getElementById('turnNumber').textContent = turnNumber;
      addBattleLog(`--- Turn ${turnNumber} ---`);
    }

    function rollInitiative() {
      const dexMod = Math.floor((currentCharacter.stats.dex - 10) / 2);
      const d20 = Math.floor(Math.random() * 20) + 1;
      const total = d20 + dexMod;

      const modText = dexMod >= 0 ? `+${dexMod}` : dexMod;
      let result = `üé≤ Initiative: ${total} (d20: ${d20} ${modText})`;

      if (d20 === 20) result += ' **CRITICAL!**';
      else if (d20 === 1) result += ' (Natural 1)';

      addBattleLog(result);
      showDiceRoll('Initiative', 'd20', d20, total, dexMod);
    }

    function shortRest() {
      // Short rest: Regain some HP (spend hit dice), recover some abilities
      const hitDiceHeal = Math.floor(Math.random() * 8) + 1 + Math.floor((currentCharacter.stats.con - 10) / 2);
      const healAmount = Math.min(hitDiceHeal, currentCharacter.hp.max - currentCharacter.hp.current);

      currentCharacter.hp.current += healAmount;

      // Warlocks regain all spell slots on short rest
      if (currentCharacter.class.toLowerCase() === 'warlock' && currentCharacter.spellSlots) {
        Object.keys(currentCharacter.spellSlots).forEach(level => {
          if (currentCharacter.spellSlots[level]) {
            currentCharacter.spellSlots[level].current = currentCharacter.spellSlots[level].max;
          }
        });
        addBattleLog(`üí´ ${currentCharacter.name} regained all spell slots!`);
      }

      // Fighters regain Action Surge, Monks regain Ki points, etc.
      addBattleLog(`‚òÄÔ∏è ${currentCharacter.name} took a short rest and regained ${healAmount} HP!`);
      addBattleLog(`‚ú® Some class features have been restored!`);

      updateCharacterDisplay();
      updateSpellsTab();

      alert(`Short Rest Complete!\n\n‚Ä¢ Regained ${healAmount} HP\n‚Ä¢ Some class features restored\n${currentCharacter.class === 'Warlock' ? '‚Ä¢ All spell slots restored!' : ''}`);
    }

    function longRest() {
      // Long rest: Fully heal HP, restore all spell slots, restore all abilities
      const healAmount = currentCharacter.hp.max - currentCharacter.hp.current;
      currentCharacter.hp.current = currentCharacter.hp.max;

      // Restore all spell slots
      if (currentCharacter.spellSlots) {
        Object.keys(currentCharacter.spellSlots).forEach(level => {
          if (currentCharacter.spellSlots[level]) {
            currentCharacter.spellSlots[level].current = currentCharacter.spellSlots[level].max;
          }
        });
      }

      // Clear temporary modifiers
      tempModifiers = [];
      updateTempModifiersList();

      addBattleLog(`üåô ${currentCharacter.name} took a long rest!`);
      addBattleLog(`‚ù§Ô∏è Fully healed! HP: ${currentCharacter.hp.current}/${currentCharacter.hp.max}`);
      addBattleLog(`‚ú® All spell slots and abilities restored!`);
      addBattleLog(`üßπ Temporary effects cleared!`);

      updateCharacterDisplay();
      updateSpellsTab();

      alert(`Long Rest Complete!\n\n‚Ä¢ Fully healed (${healAmount > 0 ? '+' + healAmount : '0'} HP)\n‚Ä¢ All spell slots restored\n‚Ä¢ All abilities restored\n‚Ä¢ Temporary effects cleared`);
    }

    function takeDamage() {
      const damageInput = document.getElementById('damageAmount');
      const damage = parseInt(damageInput.value) || 10;
      currentCharacter.hp.current = Math.max(0, currentCharacter.hp.current - damage);
      updateCharacterDisplay();
      showDiceRoll('Damage Taken', 'd20', 0, damage, `${damage} damage`, null);
      addBattleLog(`${currentCharacter.name} takes ${damage} damage!`);
    }

    function heal() {
      const healing = Math.floor(Math.random() * 20) + 10;
      currentCharacter.hp.current = Math.min(currentCharacter.hp.max, currentCharacter.hp.current + healing);
      updateCharacterDisplay();
      showDiceRoll('Healing', 'd20', 0, healing, `${healing} HP`, null);
      addBattleLog(`${currentCharacter.name} heals ${healing} HP!`);
    }

    function rollCustomDice() {
      const numDice = parseInt(document.getElementById('numDice').value) || 1;
      const diceType = parseInt(document.getElementById('diceTypeSelect').value) || 20;
      const modifier = parseInt(document.getElementById('diceModifier').value) || 0;

      let total = 0;
      let rolls = [];
      for (let i = 0; i < numDice; i++) {
        const roll = Math.floor(Math.random() * diceType) + 1;
        rolls.push(roll);
        total += roll;
      }

      const finalTotal = total + modifier;
      const breakdown = `${numDice}d${diceType}${modifier !== 0 ? (modifier >= 0 ? '+' : '') + modifier : ''}`;
      const isCritical = diceType === 20 && numDice === 1 && (rolls[0] === 20 || rolls[0] === 1);

      showDiceRoll('Custom Roll', `d${diceType}`, rolls[0] || total, finalTotal, breakdown,
        isCritical ? (rolls[0] === 20 ? 'success' : 'fail') : null);

      if (currentChatMode === 'battle') {
        addBattleLog(`${currentCharacter.name} rolled ${breakdown}: ${finalTotal}`);
      }
    }


    function useAbility(abilityId) {
      const ability = currentCharacter.abilities.find(a => a.id === abilityId);
      if (!ability) return;

      // Parse damage string (e.g., "2d8+4" or "1d6")
      let attackRoll = null;
      let damageRolls = [];
      let damageTotal = 0;

      if (ability.damage) {
        // Roll attack (d20 + modifier, assume +7 for now)
        const attackD20 = Math.floor(Math.random() * 20) + 1;
        const attackMod = 7;
        attackRoll = attackD20 + attackMod;

        // Parse damage (e.g., "2d8+4")
        const damageMatch = ability.damage.match(/(\d+)d(\d+)([+-]\d+)?/);
        if (damageMatch) {
          const numDice = parseInt(damageMatch[1]);
          const diceType = parseInt(damageMatch[2]);
          const modifier = damageMatch[3] ? parseInt(damageMatch[3]) : 0;

          for (let i = 0; i < numDice; i++) {
            const roll = Math.floor(Math.random() * diceType) + 1;
            damageRolls.push(roll);
            damageTotal += roll;
          }
          damageTotal += modifier;

          // Show dice overlay for attack
          showDiceRoll(
            ability.name,
            'd20',
            attackD20,
            attackRoll,
            `Attack: 1d20+${attackMod}`,
            attackD20 === 20 ? 'success' : (attackD20 === 1 ? 'fail' : null)
          );

          // Add to battle log
          const critText = attackD20 === 20 ? ' **CRITICAL HIT!**' : (attackD20 === 1 ? ' (Critical Miss)' : '');
          const damageText = ` | Damage: ${damageTotal} (${ability.damage}) [${damageRolls.join(', ')}]`;
          addBattleLog(`${ability.icon} ${ability.name}: Attack ${attackRoll}${critText}${damageText}`);
        }
      } else {
        // Non-damage ability
        addBattleLog(`${ability.icon} ${ability.name} - ${ability.description}`);
      }
    }


    function editBattleHP() {
      const current = currentCharacter.hp.current;
      const max = currentCharacter.hp.max;

      const newCurrent = prompt(`Edit Current HP (max: ${max}):`, current);
      if (newCurrent === null) return; // Cancelled

      const newCurrentNum = parseInt(newCurrent);
      if (isNaN(newCurrentNum) || newCurrentNum < 0) {
        alert('Please enter a valid number');
        return;
      }

      // Update HP
      currentCharacter.hp.current = Math.min(newCurrentNum, max);
      updateCharacterDisplay();
      addBattleLog(`${currentCharacter.name}'s HP updated to ${currentCharacter.hp.current}/${max}`);
    }

    function changeLocation() {
      const newLocation = document.getElementById('locationSelect').value;
      currentCharacter.location = newLocation;

      const locationName = locations.find(l => l.id === newLocation)?.name || newLocation;

      // Update canvas display in footer
      const canvasDisplay = document.getElementById('canvasDisplay');
      if (canvasDisplay) {
        canvasDisplay.textContent = `Canvas preview: ${locationName}`;
      }

      addBattleLog(`${currentCharacter.name} moved to ${locationName}`);
    }

    let statsLocked = false;
    let tempModifiers = [];

    function addTempModifier() {
      const nameInput = document.getElementById('tempModName');
      const valueInput = document.getElementById('tempModValue');
      const name = nameInput.value.trim();
      const value = parseInt(valueInput.value);

      if (!name || isNaN(value)) {
        return;
      }

      tempModifiers.push({ name, value });
      updateTempModifiersList();

      // Clear inputs
      nameInput.value = '';
      valueInput.value = '';
    }

    function removeTempModifier(index) {
      tempModifiers.splice(index, 1);
      updateTempModifiersList();
    }

    function updateTempModifiersList() {
      const list = document.getElementById('tempModifiersList');
      if (tempModifiers.length === 0) {
        list.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.85rem; padding: 10px; text-align: center;">No temporary modifiers</div>';
        return;
      }

      let html = '';
      tempModifiers.forEach((mod, index) => {
        const sign = mod.value >= 0 ? '+' : '';
        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--surface-color); border-radius: 6px; margin-bottom: 6px;">
            <span style="color: var(--text-primary);">${mod.name}</span>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: ${mod.value >= 0 ? '#4caf50' : '#f44336'}; font-weight: 600;">${sign}${mod.value}</span>
              <button onclick="removeTempModifier(${index})" style="padding: 4px 8px; background: var(--battle-color); border: none; border-radius: 4px; color: white; font-size: 0.8rem; cursor: pointer;">Remove</button>
            </div>
          </div>
        `;
      });
      list.innerHTML = html;
    }

    function toggleStatsLock() {
      statsLocked = !statsLocked;
      const lockText = document.getElementById('lockText');
      const allStats = document.querySelectorAll('.stat-readonly');

      if (statsLocked) {
        lockText.textContent = 'Edit';

        // Remove onclick handlers and titles
        allStats.forEach(el => {
          el.onclick = null;
          el.title = '';
          el.style.cursor = 'default';
        });
      } else {
        lockText.textContent = 'Lock';

        // Add onclick handlers and titles
        allStats.forEach(el => {
          if (el.classList.contains('stat-value') || el.id.includes('Value') || el.id === 'acValue' || el.id.includes('hpCurrentEdit') || el.id.includes('hpMaxEdit')) {
            const statName = el.dataset.stat || (el.id.includes('hpCurrent') ? 'hpCurrent' : el.id.includes('hpMax') ? 'hpMax' : 'unknown');
            if (statName !== 'unknown') {
              el.onclick = function() { editStat(statName, this); };
              el.title = 'Click to edit';
              el.style.cursor = 'pointer';
            }
          }
        });
      }
    }

    function editStat(statName, element) {
      const currentValue = element.textContent;
      const input = document.createElement('input');
      input.type = 'number';
      input.value = parseInt(currentValue);
      input.style.width = '60px';
      input.style.padding = '4px';
      input.style.background = 'var(--background-color)';
      input.style.color = 'var(--text-primary)';
      input.style.border = '2px solid var(--accent-color)';
      input.style.borderRadius = '4px';
      input.style.textAlign = 'center';
      input.style.fontSize = element.style.fontSize || '1rem';

      input.onblur = function() {
        const newValue = parseInt(input.value);
        if (!isNaN(newValue) && newValue >= 0) {
          // Update character data
          if (statName === 'hpCurrent') {
            currentCharacter.hp.current = Math.min(newValue, currentCharacter.hp.max);
          } else if (statName === 'hpMax') {
            currentCharacter.hp.max = newValue;
            currentCharacter.hp.current = Math.min(currentCharacter.hp.current, newValue);
          } else if (statName === 'ac') {
            currentCharacter.ac = newValue;
          } else if (['str', 'dex', 'con', 'int', 'wis', 'cha'].includes(statName)) {
            currentCharacter.stats[statName] = newValue;
          }
          // Remove input first before updating display
          if (input.parentNode === element) {
            input.remove();
          }
          updateCharacterDisplay();
        } else {
          element.textContent = currentValue;
          if (input.parentNode === element) {
            input.remove();
          }
        }
      };

      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          input.blur();
        } else if (e.key === 'Escape') {
          element.textContent = currentValue;
          element.style.display = '';
          input.remove();
        }
      };

      element.textContent = '';
      element.appendChild(input);
      input.focus();
      input.select();
    }

    function editHeaderHP() {
      if (statsLocked) return;

      const element = document.getElementById('headerHpText');
      const currentText = element.textContent; // e.g., "85/85"
      const [currentHP, maxHP] = currentText.split('/').map(v => parseInt(v.trim()));

      // Create input for current HP
      const input = document.createElement('input');
      input.type = 'number';
      input.value = currentHP;
      input.style.width = '50px';
      input.style.padding = '2px';
      input.style.background = 'var(--background-color)';
      input.style.color = 'var(--text-primary)';
      input.style.border = '2px solid var(--accent-color)';
      input.style.borderRadius = '4px';
      input.style.textAlign = 'center';
      input.style.fontSize = '0.75rem';
      input.style.fontWeight = '700';

      input.onblur = function() {
        const newValue = parseInt(input.value);
        if (!isNaN(newValue) && newValue >= 0) {
          currentCharacter.hp.current = Math.min(newValue, currentCharacter.hp.max);
          updateCharacterDisplay();
        } else {
          element.textContent = currentText;
        }
      };

      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          input.blur();
        } else if (e.key === 'Escape') {
          element.textContent = currentText;
          updateCharacterDisplay();
        }
      };

      element.textContent = '';
      element.appendChild(input);
      input.focus();
      input.select();
    }

    function editModifier(statName, element) {
      const currentValue = element.textContent.replace(/[+\-]/g, '');
      const input = document.createElement('input');
      input.type = 'number';
      input.value = parseInt(currentValue);
      input.style.width = '50px';
      input.style.padding = '4px';
      input.style.background = 'var(--background-color)';
      input.style.color = 'var(--text-primary)';
      input.style.border = '2px solid var(--accent-color)';
      input.style.borderRadius = '4px';
      input.style.textAlign = 'center';
      input.style.fontSize = '0.9rem';

      input.onblur = function() {
        const newModifier = parseInt(input.value);
        if (!isNaN(newModifier) && newModifier >= -5 && newModifier <= 10) {
          // Back-calculate ability score from modifier
          // modifier = floor((score - 10) / 2)
          // score = (modifier * 2) + 10
          const newScore = (newModifier * 2) + 10;
          currentCharacter.stats[statName] = newScore;
          // Remove input first before updating display
          if (input.parentNode === element) {
            input.remove();
          }
          updateCharacterDisplay();
        } else {
          element.textContent = currentValue;
          if (input.parentNode === element) {
            input.remove();
          }
        }
      };

      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          input.blur();
        } else if (e.key === 'Escape') {
          element.textContent = (parseInt(currentValue) >= 0 ? '+' : '') + currentValue;
          element.style.display = '';
          input.remove();
        }
      };

      element.textContent = '';
      element.appendChild(input);
      input.focus();
      input.select();
    }

    function toggleSpellPrepared(spellId, level) {
      const spell = currentCharacter.spells[level].find(s => s.id === spellId);
      if (spell) {
        spell.prepared = !spell.prepared;
        updateAbilities();
        updateAbilitiesTab();
      }
    }

    function setDefaultAbility(abilityId) {
      // Clear any existing defaults
      currentCharacter.abilities.forEach(a => a.isDefault = false);

      // Set the new default
      const ability = currentCharacter.abilities.find(a => a.id === abilityId);
      if (ability) {
        ability.isDefault = true;
        updateAbilitiesTab();
      }
    }

    function setDefaultSpell(spellId, level) {
      // Clear any existing defaults across all spell levels
      Object.keys(currentCharacter.spells).forEach(lvl => {
        currentCharacter.spells[lvl].forEach(s => s.isDefault = false);
      });

      // Set the new default
      const spell = currentCharacter.spells[level].find(s => s.id === spellId);
      if (spell && spell.prepared) {
        spell.isDefault = true;
        updateAbilitiesTab();
      }
    }

    function updateInventory() {
      const inventoryGrid = document.getElementById('inventoryGrid');
      if (!currentCharacter.inventory) {
        inventoryGrid.innerHTML = '<p style="color: var(--text-secondary); padding: 20px;">No items in inventory.</p>';
        return;
      }

      let html = '';

      // Group inventory by type with custom order
      const grouped = {};
      currentCharacter.inventory.forEach(item => {
        if (!grouped[item.type]) grouped[item.type] = [];
        grouped[item.type].push(item);
      });

      // Custom sort order: weapons, armor, consumables, ammunition, gear (magic items)
      const typeOrder = ['weapon', 'armor', 'consumable', 'ammunition', 'gear'];
      const sortedTypes = typeOrder.filter(type => grouped[type]);

      sortedTypes.forEach(type => {
        const typeName = type.charAt(0).toUpperCase() + type.slice(1) + (type !== 'gear' ? 's' : '');
        html += `<div class="inventory-category">
          <div class="inventory-category-title">${typeName}</div>`;

        grouped[type].forEach(item => {
          const equippedIcon = item.equipped ? '‚ö° ' : '';
          const attunedIcon = item.attuned ? '‚ú® ' : '';
          const isConsumable = item.type === 'consumable' && item.quantity > 0;
          const clickHandler = isConsumable ? `onclick="consumeItem('${item.id}')" style="cursor: pointer;"` : '';

          html += `
            <div class="inventory-item ${item.equipped ? 'equipped' : ''} ${isConsumable ? 'consumable-item' : ''}" ${clickHandler}>
              <div class="inventory-item-info">
                <div class="inventory-item-name">${attunedIcon}${equippedIcon}${item.name}</div>
                <div class="inventory-item-type">${item.type}${isConsumable ? ' (click to use)' : ''}</div>
              </div>
              ${item.quantity ? `<div class="inventory-item-quantity">√ó${item.quantity}</div>` : ''}
              ${item.equipped ? '<div class="equipped-badge">Equipped</div>' : ''}
            </div>
          `;
        });

        html += '</div>';
      });

      // Attuned Magical Items Section (max 3 slots) - at bottom
      const attunedItems = currentCharacter.inventory.filter(item => item.attuned);
      html += `<div style="margin-top: 25px; padding: 15px; background: rgba(74, 144, 226, 0.1); border: 2px solid var(--accent-color); border-radius: 8px;">
        <div style="font-size: 0.9rem; color: var(--accent-color); text-transform: uppercase; margin-bottom: 12px; font-weight: 600; letter-spacing: 1px;">Attuned Magical Items (${attunedItems.length}/3)</div>
        <div style="display: grid; gap: 8px;">`;

      for (let i = 0; i < 3; i++) {
        const item = attunedItems[i];
        if (item) {
          html += `
            <div class="inventory-item equipped">
              <div class="inventory-item-info">
                <div class="inventory-item-name">‚ú® ${item.name}</div>
                <div class="inventory-item-type">${item.type}</div>
              </div>
              <div class="equipped-badge">Attuned</div>
            </div>
          `;
        } else {
          html += `
            <div style="padding: 15px; background: rgba(255,255,255,0.05); border: 2px dashed var(--border-color); border-radius: 8px; text-align: center; color: var(--text-secondary); font-size: 0.85rem;">
              Empty Attunement Slot
            </div>
          `;
        }
      }

      html += '</div></div>';

      inventoryGrid.innerHTML = html;
    }

    // Auto-add class-appropriate items to inventory
    function updateInventory_autoAdd() {
      if (!currentCharacter.inventory) {
        currentCharacter.inventory = [];
      }

      const charClass = currentCharacter.class.toLowerCase();
      const level = currentCharacter.level;

      // Get current item IDs to avoid duplicates
      const currentItemIds = currentCharacter.inventory.map(item => item.id);

      // Class-appropriate item database
      const classItems = {
        barbarian: [
          { id: 'greataxe', name: 'Greataxe', type: 'weapon', equipped: false },
          { id: 'handaxe', name: 'Handaxe (x2)', type: 'weapon', equipped: false, quantity: 2 },
          { id: 'hide_armor', name: 'Hide Armor', type: 'armor', equipped: false },
          { id: 'explorers_pack', name: "Explorer's Pack", type: 'gear', equipped: false },
          { id: 'javelin', name: 'Javelin (x4)', type: 'weapon', equipped: false, quantity: 4 }
        ],
        fighter: [
          { id: 'longsword', name: 'Longsword', type: 'weapon', equipped: false },
          { id: 'shield', name: 'Shield', type: 'armor', equipped: false },
          { id: 'chain_mail', name: 'Chain Mail', type: 'armor', equipped: false },
          { id: 'crossbow_light', name: 'Light Crossbow', type: 'weapon', equipped: false },
          { id: 'crossbow_bolts', name: 'Crossbow Bolts (x20)', type: 'ammunition', equipped: false, quantity: 20 }
        ],
        monk: [
          { id: 'shortsword', name: 'Shortsword', type: 'weapon', equipped: false },
          { id: 'dart', name: 'Dart (x10)', type: 'weapon', equipped: false, quantity: 10 },
          { id: 'explorers_pack', name: "Explorer's Pack", type: 'gear', equipped: false }
        ],
        rogue: [
          { id: 'rapier', name: 'Rapier', type: 'weapon', equipped: false },
          { id: 'shortbow', name: 'Shortbow', type: 'weapon', equipped: false },
          { id: 'arrows', name: 'Arrows (x20)', type: 'ammunition', equipped: false, quantity: 20 },
          { id: 'leather_armor', name: 'Leather Armor', type: 'armor', equipped: false },
          { id: 'thieves_tools', name: "Thieves' Tools", type: 'gear', equipped: false },
          { id: 'burglars_pack', name: "Burglar's Pack", type: 'gear', equipped: false }
        ],
        paladin: [
          { id: 'longsword', name: 'Longsword', type: 'weapon', equipped: false },
          { id: 'shield', name: 'Shield', type: 'armor', equipped: false },
          { id: 'chain_mail', name: 'Chain Mail', type: 'armor', equipped: false },
          { id: 'javelin', name: 'Javelin (x5)', type: 'weapon', equipped: false, quantity: 5 },
          { id: 'holy_symbol', name: 'Holy Symbol', type: 'gear', equipped: false },
          { id: 'priests_pack', name: "Priest's Pack", type: 'gear', equipped: false }
        ],
        ranger: [
          { id: 'longbow', name: 'Longbow', type: 'weapon', equipped: false },
          { id: 'arrows', name: 'Arrows (x20)', type: 'ammunition', equipped: false, quantity: 20 },
          { id: 'shortsword', name: 'Shortsword (x2)', type: 'weapon', equipped: false, quantity: 2 },
          { id: 'scale_mail', name: 'Scale Mail', type: 'armor', equipped: false },
          { id: 'explorers_pack', name: "Explorer's Pack", type: 'gear', equipped: false }
        ],
        bard: [
          { id: 'rapier', name: 'Rapier', type: 'weapon', equipped: false },
          { id: 'lute', name: 'Lute', type: 'gear', equipped: false },
          { id: 'leather_armor', name: 'Leather Armor', type: 'armor', equipped: false },
          { id: 'dagger', name: 'Dagger', type: 'weapon', equipped: false },
          { id: 'entertainers_pack', name: "Entertainer's Pack", type: 'gear', equipped: false }
        ],
        cleric: [
          { id: 'mace', name: 'Mace', type: 'weapon', equipped: false },
          { id: 'shield', name: 'Shield', type: 'armor', equipped: false },
          { id: 'scale_mail', name: 'Scale Mail', type: 'armor', equipped: false },
          { id: 'holy_symbol', name: 'Holy Symbol', type: 'gear', equipped: false },
          { id: 'priests_pack', name: "Priest's Pack", type: 'gear', equipped: false }
        ],
        druid: [
          { id: 'scimitar', name: 'Scimitar', type: 'weapon', equipped: false },
          { id: 'shield', name: 'Wooden Shield', type: 'armor', equipped: false },
          { id: 'leather_armor', name: 'Leather Armor', type: 'armor', equipped: false },
          { id: 'druidic_focus', name: 'Druidic Focus', type: 'gear', equipped: false },
          { id: 'explorers_pack', name: "Explorer's Pack", type: 'gear', equipped: false }
        ],
        sorcerer: [
          { id: 'light_crossbow', name: 'Light Crossbow', type: 'weapon', equipped: false },
          { id: 'crossbow_bolts', name: 'Crossbow Bolts (x20)', type: 'ammunition', equipped: false, quantity: 20 },
          { id: 'arcane_focus', name: 'Arcane Focus', type: 'gear', equipped: false },
          { id: 'dagger', name: 'Dagger (x2)', type: 'weapon', equipped: false, quantity: 2 },
          { id: 'explorers_pack', name: "Explorer's Pack", type: 'gear', equipped: false }
        ],
        warlock: [
          { id: 'light_crossbow', name: 'Light Crossbow', type: 'weapon', equipped: false },
          { id: 'crossbow_bolts', name: 'Crossbow Bolts (x20)', type: 'ammunition', equipped: false, quantity: 20 },
          { id: 'arcane_focus', name: 'Arcane Focus', type: 'gear', equipped: false },
          { id: 'leather_armor', name: 'Leather Armor', type: 'armor', equipped: false },
          { id: 'dagger', name: 'Dagger (x2)', type: 'weapon', equipped: false, quantity: 2 }
        ],
        wizard: [
          { id: 'quarterstaff', name: 'Quarterstaff', type: 'weapon', equipped: false },
          { id: 'arcane_focus', name: 'Arcane Focus', type: 'gear', equipped: false },
          { id: 'spellbook', name: 'Spellbook', type: 'gear', equipped: false },
          { id: 'scholars_pack', name: "Scholar's Pack", type: 'gear', equipped: false },
          { id: 'component_pouch', name: 'Component Pouch', type: 'gear', equipped: false }
        ]
      };

      // Common items all classes can use
      const commonItems = [
        { id: 'healing_potion', name: 'Potion of Healing', type: 'consumable', quantity: 3 },
        { id: 'greater_healing_potion', name: 'Potion of Greater Healing', type: 'consumable', quantity: 1 },
        { id: 'rope', name: 'Rope (50ft)', type: 'gear', equipped: false },
        { id: 'rations', name: 'Rations (10 days)', type: 'consumable', quantity: 10 },
        { id: 'torch', name: 'Torch (x10)', type: 'gear', equipped: false, quantity: 10 },
        { id: 'bedroll', name: 'Bedroll', type: 'gear', equipped: false },
        { id: 'tinderbox', name: 'Tinderbox', type: 'gear', equipped: false }
      ];

      // High level items (level 10+)
      const highLevelItems = [
        { id: 'potion_superior_healing', name: 'Potion of Superior Healing', type: 'consumable', quantity: 2 },
        { id: 'antitoxin', name: 'Antitoxin', type: 'consumable', quantity: 2 },
        { id: 'climbers_kit', name: "Climber's Kit", type: 'gear', equipped: false }
      ];

      let itemsAdded = 0;

      // Add class-specific items
      const classItemList = classItems[charClass] || [];
      classItemList.forEach(item => {
        if (!currentItemIds.includes(item.id)) {
          currentCharacter.inventory.push(item);
          currentItemIds.push(item.id);
          itemsAdded++;
        }
      });

      // Add 3-4 common items
      const commonToAdd = commonItems.slice(0, 4);
      commonToAdd.forEach(item => {
        if (!currentItemIds.includes(item.id)) {
          currentCharacter.inventory.push(item);
          currentItemIds.push(item.id);
          itemsAdded++;
        }
      });

      // Add high level items if level 10+
      if (level >= 10) {
        highLevelItems.forEach(item => {
          if (!currentItemIds.includes(item.id)) {
            currentCharacter.inventory.push(item);
            currentItemIds.push(item.id);
            itemsAdded++;
          }
        });
      }

      if (itemsAdded > 0) {
        updateInventory();
        addBattleLog(`üéí ${currentCharacter.name} acquired ${itemsAdded} new item${itemsAdded > 1 ? 's' : ''}!`);
        alert(`‚ú® Added ${itemsAdded} new item${itemsAdded > 1 ? 's' : ''} to inventory!`);
      } else {
        alert('üéí No new items available! You already have all available items, or customize your inventory manually.');
      }
    }

    // Auto-update canvas based on HP percentage
    function getCharacterState() {
      const hpPercent = (currentCharacter.hp.current / currentCharacter.hp.max) * 100;

      if (hpPercent <= 0) return 'dead';
      if (hpPercent <= 25) return 'critical'; // Severely injured
      if (hpPercent <= 50) return 'injured';  // Moderately injured
      if (hpPercent <= 75) return 'wounded';  // Lightly injured
      return 'default';
    }

    function consumeItem(itemId) {
      const item = currentCharacter.inventory?.find(i => i.id === itemId);
      if (!item || item.type !== 'consumable' || !item.quantity || item.quantity <= 0) {
        return;
      }

      // Consume 1 of the item
      item.quantity--;

      // Apply effects based on item type
      let effect = '';
      if (item.name.toLowerCase().includes('healing')) {
        // Healing potion
        let healing = 7; // 2d4+2 average for regular potion
        if (item.name.toLowerCase().includes('greater')) {
          healing = 20; // 4d4+4 average for greater
        } else if (item.name.toLowerCase().includes('superior')) {
          healing = 28; // 8d4+8 average for superior
        }

        currentCharacter.hp.current = Math.min(currentCharacter.hp.max, currentCharacter.hp.current + healing);
        effect = `restored ${healing} HP`;
      } else if (item.name.toLowerCase().includes('ration')) {
        // Food ration
        const foodRestored = 30;
        if (currentCharacter.food) {
          currentCharacter.food.current = Math.min(currentCharacter.food.max, currentCharacter.food.current + foodRestored);
          effect = `restored ${foodRestored} satiety`;
        }
      } else {
        // Generic consumable
        effect = `used ${item.name}`;
      }

      updateCharacterDisplay();
      addBattleLog(`${currentCharacter.name} consumed ${item.name} and ${effect}!`);

      // Remove item if quantity reaches 0
      if (item.quantity === 0) {
        const index = currentCharacter.inventory.indexOf(item);
        if (index > -1) currentCharacter.inventory.splice(index, 1);
        addBattleLog(`‚ö†Ô∏è Out of ${item.name}!`);
      }
    }

    function toggleDicePopup() {
      const popup = document.getElementById('dicePopup');
      popup.classList.toggle('show');

      // Update combat buttons when popup is opened
      if (popup.classList.contains('show')) {
        updateDicePopupButtons();
      }
    }

    function updateDicePopupButtons() {
      const attackButtonsDiv = document.getElementById('attackButtons');
      const spellButtonsDiv = document.getElementById('spellButtons');

      if (!attackButtonsDiv || !spellButtonsDiv) return;

      let attackHtml = '';
      let spellHtml = '';

      // Add attack buttons (melee/ranged)
      if (currentCharacter.attacks) {
        if (currentCharacter.attacks.melee) {
          attackHtml += `<button class="test-btn" onclick="rollWeaponAttack('melee'); toggleDicePopup();" style="margin: 0; flex: 1; min-width: 120px;">‚öîÔ∏è ${currentCharacter.attacks.melee.name}</button>`;
        }
        if (currentCharacter.attacks.ranged) {
          attackHtml += `<button class="test-btn" onclick="rollWeaponAttack('ranged'); toggleDicePopup();" style="margin: 0; flex: 1; min-width: 120px;">üèπ ${currentCharacter.attacks.ranged.name}</button>`;
        }
      }

      // Add spell buttons (from prepared spells)
      if (currentCharacter.spells) {
        const preparedSpells = [];
        Object.keys(currentCharacter.spells).forEach(level => {
          if (Array.isArray(currentCharacter.spells[level])) {
            currentCharacter.spells[level].forEach(spell => {
              if (spell.prepared) {
                preparedSpells.push({ ...spell, level: parseInt(level) });
              }
            });
          }
        });

        // Show up to 4 prepared spells
        preparedSpells.slice(0, 4).forEach(spell => {
          spellHtml += `<button class="test-btn" onclick="rollSpellAttack('${spell.id}', ${spell.level}); toggleDicePopup();" style="margin: 0; flex: 1; min-width: 120px;">${spell.icon} ${spell.name}</button>`;
        });
      }

      attackButtonsDiv.innerHTML = attackHtml;
      spellButtonsDiv.innerHTML = spellHtml;

      // Hide combat rolls section if no attacks or spells
      const combatSection = document.getElementById('combatRollsSection');
      if (combatSection) {
        combatSection.style.display = (attackHtml || spellHtml) ? 'block' : 'none';
      }
    }

    function rollWeaponAttack(type) {
      const attack = type === 'melee' ? currentCharacter.attacks.melee : currentCharacter.attacks.ranged;
      if (!attack) return;

      // Roll attack (d20 + toHit)
      const attackRoll = Math.floor(Math.random() * 20) + 1;
      const attackTotal = attackRoll + attack.toHit;
      const attackBreakdown = `1d20+${attack.toHit}`;

      showDiceRoll(`${attack.name} Attack`, 'd20', attackRoll, attackTotal, attackBreakdown,
        attackRoll === 20 ? 'success' : (attackRoll === 1 ? 'fail' : null));

      addBattleLog(`${currentCharacter.name} attacks with ${attack.name}: ${attackTotal} to hit`);

      // If hit, prompt for damage roll or auto-roll
      if (attackRoll >= 10) { // Simplified - assume hits on 10+
        setTimeout(() => {
          // Parse damage (e.g., "1d8+4")
          const match = attack.damage.match(/(\d+)d(\d+)([\+\-]\d+)?/);
          if (match) {
            const numDice = parseInt(match[1]);
            const diceSize = parseInt(match[2]);
            const modifier = match[3] ? parseInt(match[3]) : 0;

            let damageTotal = 0;
            for (let i = 0; i < numDice; i++) {
              damageTotal += Math.floor(Math.random() * diceSize) + 1;
            }
            damageTotal += modifier;

            showDiceRoll(`${attack.name} Damage`, `d${diceSize}`, damageTotal - modifier, damageTotal, attack.damage, null);
            addBattleLog(`${attack.name} deals ${damageTotal} damage!`);
          }
        }, 1000);
      }
    }

    function rollSpellAttack(spellId, level) {
      // Find the spell
      let spell = null;
      if (currentCharacter.spells && currentCharacter.spells[level]) {
        spell = currentCharacter.spells[level].find(s => s.id === spellId);
      }

      if (!spell) return;

      // Calculate spell attack modifier (using primary stat)
      const statMod = currentCharacter.classType === 'caster'
        ? Math.floor((currentCharacter.stats.int - 10) / 2)
        : Math.floor((currentCharacter.stats.wis - 10) / 2);
      const profBonus = Math.ceil(currentCharacter.level / 4) + 1; // Proficiency bonus
      const spellAttackMod = statMod + profBonus;

      // Roll spell attack if it has damage
      if (spell.damage) {
        const attackRoll = Math.floor(Math.random() * 20) + 1;
        const attackTotal = attackRoll + spellAttackMod;
        const attackBreakdown = `1d20+${spellAttackMod}`;

        showDiceRoll(`${spell.name} Attack`, 'd20', attackRoll, attackTotal, attackBreakdown,
          attackRoll === 20 ? 'success' : (attackRoll === 1 ? 'fail' : null));

        addBattleLog(`${currentCharacter.name} casts ${spell.name}: ${attackTotal} to hit`);

        // Roll damage on hit
        if (attackRoll >= 10) {
          setTimeout(() => {
            const match = spell.damage.match(/(\d+)d(\d+)/);
            if (match) {
              const numDice = parseInt(match[1]);
              const diceSize = parseInt(match[2]);

              let damageTotal = 0;
              for (let i = 0; i < numDice; i++) {
                damageTotal += Math.floor(Math.random() * diceSize) + 1;
              }

              showDiceRoll(`${spell.name} Damage`, `d${diceSize}`, damageTotal, damageTotal, spell.damage, null);
              addBattleLog(`${spell.name} deals ${damageTotal} damage!`);
            }
          }, 1000);
        }
      } else {
        // Non-damage spell (utility/buff)
        addBattleLog(`${currentCharacter.name} casts ${spell.name}!`);
        showDiceRoll(spell.name, spell.icon, '‚ú®', '‚ú®', 'Cast successfully', 'success');
      }
    }

    // Character Creator Functions
    function openCharacterCreator() {
      document.getElementById('characterCreatorOverlay').classList.add('show');
      // Reset form
      document.getElementById('newCharName').value = '';
      document.getElementById('newCharClass').value = 'fighter';
      document.getElementById('newCharRace').value = 'human';
      document.getElementById('newCharLevel').value = '1';
    }

    function closeCharacterCreator(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('characterCreatorOverlay').classList.remove('show');
    }

    function showComingSoon() {
      alert('üìÇ Coming Soon!\n\nLoad Existing Character will allow you to import characters from saved files. This feature requires Node.js integration and will be available in a future update.');
    }

    function createNewCharacter() {
      const name = document.getElementById('newCharName').value.trim();
      const charClass = document.getElementById('newCharClass').value;
      const race = document.getElementById('newCharRace').value;
      const level = parseInt(document.getElementById('newCharLevel').value);

      if (!name) {
        alert('Please enter a character name!');
        return;
      }

      // Generate character emoji based on class
      const classEmojis = {
        barbarian: '‚öîÔ∏è', bard: 'üéµ', cleric: '‚úùÔ∏è', druid: 'üåø',
        fighter: 'üó°Ô∏è', monk: 'ü•ã', paladin: 'üõ°Ô∏è', ranger: 'üèπ',
        rogue: 'üó°Ô∏è', sorcerer: 'üîÆ', warlock: 'üëÅÔ∏è', wizard: 'üßô'
      };

      // Determine class type for spells
      const classTypes = {
        barbarian: 'melee', fighter: 'melee', monk: 'melee', rogue: 'melee',
        bard: 'caster', cleric: 'caster', druid: 'caster', sorcerer: 'caster', warlock: 'caster', wizard: 'caster',
        paladin: 'halfcaster', ranger: 'halfcaster'
      };

      // Generate basic stats (standard array)
      const stats = { str: 15, dex: 14, con: 13, int: 12, wis: 10, cha: 8 };

      // Create new character object
      const newChar = {
        id: name.toLowerCase().replace(/\s+/g, '_'),
        name: name,
        emoji: classEmojis[charClass] || 'üé≠',
        class: charClass.charAt(0).toUpperCase() + charClass.slice(1),
        subclass: level >= 3 && document.getElementById('newCharSubclass').value !== 'none' ? document.getElementById('newCharSubclass').value : 'Choose at level 3',
        race: race.charAt(0).toUpperCase() + race.slice(1),
        alignment: 'Neutral Good',
        classType: classTypes[charClass] || 'melee',
        level: level,
        hp: { current: 10 + level * 6, max: 10 + level * 6 },
        ac: 12,
        food: { current: 100, max: 100 },
        stats: stats,
        location: 'tavern',
        attacks: {
          melee: { name: 'Weapon', damage: '1d8+2', toHit: 4 },
          ranged: { name: 'Ranged Weapon', damage: '1d6+2', toHit: 4 }
        },
        inventory: [
          { id: 'weapon', name: 'Starting Weapon', type: 'weapon', equipped: true },
          { id: 'armor', name: 'Leather Armor', type: 'armor', equipped: true },
          { id: 'healing_potion', name: 'Potion of Healing', type: 'consumable', quantity: 2 }
        ],
        skills: {
          acrobatics: ['dex', 0], animalHandling: ['wis', 0], arcana: ['int', 0],
          athletics: ['str', 1], deception: ['cha', 0], history: ['int', 0],
          insight: ['wis', 0], intimidation: ['cha', 0], investigation: ['int', 0],
          medicine: ['wis', 0], nature: ['int', 0], perception: ['wis', 1],
          performance: ['cha', 0], persuasion: ['cha', 0], religion: ['int', 0],
          sleightOfHand: ['dex', 0], stealth: ['dex', 0], survival: ['wis', 0]
        },
        abilities: [
          { id: 'basic_attack', name: 'Basic Attack', icon: '‚öîÔ∏è', damage: '1d8+2', description: 'Standard weapon attack' }
        ],
        spells: {},
        states: {
          default: { mood: 'determined', greeting: `I am ${name}, ready for adventure!` },
          battle: { mood: 'focused', greeting: 'Let\'s do this!' },
          injured: { mood: 'pained', greeting: 'I\'ve taken some damage...' },
          triumphant: { mood: 'joyful', greeting: 'Victory is ours!' }
        }
      };

      // Add to characters array
      
      // Auto-populate spells and abilities based on class and level
      autoPopulateSpells(newChar);
      autoPopulateAbilities(newChar);

      characters.push(newChar);

      // Switch to new character
      currentCharacter = newChar;
      const newIndex = characters.length - 1;

      // Update displays
      updateCharacterDisplay();
      populateCharacterMenu();
      updateSpellsTab();
      updateAbilitiesTab();

      // Close modals
      closeCharacterCreator();
      closeMenu();

      // Notify user
      addBattleLog(`üé≠ ${name} has joined the party!`);
      alert(`‚ú® ${name} created successfully!\n\nClass: ${newChar.class}\nRace: ${newChar.race}\nLevel: ${level}`);
    }


    // Ability Picker Functions
    function openAbilityPicker() {
      document.getElementById('abilityPickerOverlay').classList.add('show');
      // Auto-select current character's class
      const classFilter = document.getElementById('abilityClassFilter');
      classFilter.value = currentCharacter.class.toLowerCase();
      filterAbilities();
    }

    function closeAbilityPicker(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('abilityPickerOverlay').classList.remove('show');
      document.getElementById('abilityPickerSearch').value = '';
      document.getElementById('abilityClassFilter').value = 'all';
    }

    function filterAbilities() {
      const searchTerm = document.getElementById('abilityPickerSearch').value.toLowerCase();
      const classFilter = document.getElementById('abilityClassFilter').value;
      const body = document.getElementById('abilityPickerBody');

      if (classFilter === 'all') {
        body.innerHTML = '<div class="spell-picker-empty" style="padding: 40px; text-align: center; color: var(--text-secondary);">Select a class to view abilities</div>';
        return;
      }

      const abilities = abilityDatabase[classFilter] || [];
      const filtered = abilities.filter(ability =>
        ability.name.toLowerCase().includes(searchTerm) ||
        ability.description.toLowerCase().includes(searchTerm)
      );

      if (filtered.length === 0) {
        body.innerHTML = '<div class="spell-picker-empty" style="padding: 40px; text-align: center; color: var(--text-secondary);">No abilities found</div>';
        return;
      }

      let html = '<div class="spell-picker-list">';
      filtered.forEach(ability => {
        const alreadyHas = currentCharacter.abilities?.some(a => a.id === ability.id);
        html += `
          <div class="spell-picker-item">
            <div class="spell-picker-item-info">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <span style="font-size: 1.5rem;">${ability.icon}</span>
                <div>
                  <div class="spell-picker-item-name">${ability.name}</div>
                  ${ability.damage ? `<div style="color: var(--battle-color); font-size: 0.85rem; font-weight: 600;">${ability.damage}</div>` : ''}
                </div>
              </div>
              <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px;">${ability.description}</div>
            </div>
            <button class="spell-picker-item-add"
                    onclick="addAbilityToCharacter('${ability.id}', '${classFilter}')"
                    ${alreadyHas ? 'disabled' : ''}>
              ${alreadyHas ? '‚úì Added' : '+ Add'}
            </button>
          </div>
        `;
      });
      html += '</div>';
      body.innerHTML = html;
    }

    function addAbilityToCharacter(abilityId, classFilter) {
      const ability = abilityDatabase[classFilter]?.find(a => a.id === abilityId);
      if (!ability) return;

      // Check if already has ability
      if (currentCharacter.abilities?.some(a => a.id === ability.id)) {
        alert('You already have this ability!');
        return;
      }

      // Initialize abilities array if needed
      if (!currentCharacter.abilities) {
        currentCharacter.abilities = [];
      }

      // Add ability
      currentCharacter.abilities.push({
        id: ability.id,
        name: ability.name,
        icon: ability.icon,
        damage: ability.damage,
        description: ability.description
      });

      // Update display
      updateAbilitiesTab();
      addBattleLog(`‚öîÔ∏è ${currentCharacter.name} learned ${ability.name}!`);

      // Refresh picker to update button states
      filterAbilities();
    }

    // Custom Ability Creator Functions
    function openCustomAbilityCreator() {
      document.getElementById('customAbilityOverlay').classList.add('show');
      // Clear form
      document.getElementById('customAbilityName').value = '';
      document.getElementById('customAbilityIcon').value = '‚öîÔ∏è';
      document.getElementById('customAbilityDamage').value = '';
      document.getElementById('customAbilityDesc').value = '';
    }

    function closeCustomAbilityCreator(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('customAbilityOverlay').classList.remove('show');
    }

    function addCustomAbility() {
      const name = document.getElementById('customAbilityName').value.trim();
      const icon = document.getElementById('customAbilityIcon').value.trim() || '‚öîÔ∏è';
      const damage = document.getElementById('customAbilityDamage').value.trim() || null;
      const description = document.getElementById('customAbilityDesc').value.trim();

      if (!name) {
        alert('Please enter an ability name!');
        return;
      }

      if (!description) {
        alert('Please enter a description!');
        return;
      }

      // Generate unique ID
      const id = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

      // Check if already has ability with this ID
      if (currentCharacter.abilities?.some(a => a.id === id)) {
        alert('You already have an ability with this name!');
        return;
      }

      // Initialize abilities array if needed
      if (!currentCharacter.abilities) {
        currentCharacter.abilities = [];
      }

      // Add custom ability
      currentCharacter.abilities.push({
        id: id,
        name: name,
        icon: icon,
        damage: damage,
        description: description
      });

      // Update display
      updateAbilitiesTab();
      addBattleLog(`‚ú® ${currentCharacter.name} created custom ability: ${name}!`);

      // Close modals
      closeCustomAbilityCreator();
      closeAbilityPicker();

      alert(`‚ú® ${name} added successfully!`);
    }


    // Saving Throw Roll Function
    function rollSavingThrow(stat) {
      const statNames = {
        str: 'Strength',
        dex: 'Dexterity',
        con: 'Constitution',
        int: 'Intelligence',
        wis: 'Wisdom',
        cha: 'Charisma'
      };

      const statValue = currentCharacter.stats[stat];
      const modifier = Math.floor((statValue - 10) / 2);
      const d20 = Math.floor(Math.random() * 20) + 1;
      const total = d20 + modifier;

      const statName = statNames[stat];
      const modifierText = modifier >= 0 ? `+${modifier}` : modifier;

      let result = `üé≤ ${statName} Save: ${total}`;
      result += ` (d20: ${d20} ${modifierText})`;

      if (d20 === 20) {
        result += ' **CRITICAL SUCCESS!**';
      } else if (d20 === 1) {
        result += ' (Critical Failure)';
      }

      addBattleLog(result);

      // Show dice roll animation
      showDiceRoll(`${statName} Save`, 'd20', d20, total, modifier);
    }


    // Subclass options by class
    const subclassOptions = {
      barbarian: ['Path of the Berserker', 'Path of the Totem Warrior', 'Path of the Zealot'],
      bard: ['College of Lore', 'College of Valor', 'College of Glamour'],
      cleric: ['Life Domain', 'Light Domain', 'War Domain', 'Trickery Domain'],
      druid: ['Circle of the Land', 'Circle of the Moon', 'Circle of Dreams'],
      fighter: ['Champion', 'Battle Master', 'Eldritch Knight'],
      monk: ['Way of the Open Hand', 'Way of Shadow', 'Way of the Four Elements'],
      paladin: ['Oath of Devotion', 'Oath of Vengeance', 'Oath of the Ancients'],
      ranger: ['Hunter', 'Beast Master', 'Gloom Stalker'],
      rogue: ['Thief', 'Assassin', 'Arcane Trickster'],
      sorcerer: ['Draconic Bloodline', 'Wild Magic', 'Divine Soul'],
      warlock: ['The Fiend', 'The Archfey', 'The Great Old One'],
      wizard: ['School of Evocation', 'School of Abjuration', 'School of Divination']
    };

    function updateSubclassOptions() {
      const classSelect = document.getElementById('newCharClass');
      const subclassSelect = document.getElementById('newCharSubclass');
      const selectedClass = classSelect.value;

      const subclasses = subclassOptions[selectedClass] || [];

      let html = '<option value="none">Choose subclass...</option>';
      subclasses.forEach(subclass => {
        html += `<option value="${subclass}">${subclass}</option>`;
      });

      subclassSelect.innerHTML = html;

      // Also update visibility based on level
      updateSubclassVisibility();
    }

    function updateSubclassVisibility() {
      const levelInput = document.getElementById('newCharLevel');
      const subclassWrapper = document.getElementById('subclassWrapper');
      const level = parseInt(levelInput.value) || 1;

      // Show subclass field only if level is 3 or higher
      if (level >= 3) {
        subclassWrapper.style.display = 'block';
      } else {
        subclassWrapper.style.display = 'none';
      }
    }

    // Auto-populate spells based on class and level
    function autoPopulateSpells(character) {
      const spellcasters = ['bard', 'cleric', 'druid', 'sorcerer', 'warlock', 'wizard'];
      const halfcasters = ['paladin', 'ranger'];
      const charClass = character.class.toLowerCase();
      const subclass = character.subclass || '';

      // 1/3 casters (Fighter Eldritch Knight, Rogue Arcane Trickster)
      const thirdCasterSubclasses = ['Eldritch Knight', 'Arcane Trickster'];
      const isThirdCaster = thirdCasterSubclasses.includes(subclass);

      if (!spellcasters.includes(charClass) && !halfcasters.includes(charClass) && !isThirdCaster) {
        return; // No spells for non-casters
      }

      // Determine casting type
      const preparedCasters = ['cleric', 'druid', 'paladin'];
      const knownCasters = ['bard', 'sorcerer', 'warlock', 'ranger'];

      character.castingType = preparedCasters.includes(charClass) ? 'prepared' : 'known';

      // Initialize spells object
      character.spells = {};

      const level = character.level;

      // Get subclass-themed spells if available
      let subclassSpellList = subclassSpells[subclass] || null;

      // Fallback: Use generic class-based spells if subclass not found
      const classDefaultSpells = {
        wizard: {
          cantrips: ['fire_bolt', 'mage_hand'],
          1: ['magic_missile', 'shield', 'detect_magic'],
          2: ['misty_step', 'scorching_ray'],
          3: ['fireball', 'counterspell'],
          4: ['greater_invisibility', 'ice_storm'],
          5: ['cone_of_cold', 'wall_of_force']
        },
        cleric: {
          cantrips: ['sacred_flame', 'guidance', 'light'],
          1: ['cure_wounds', 'bless', 'healing_word'],
          2: ['prayer_of_healing', 'spiritual_weapon'],
          3: ['mass_healing_word', 'spirit_guardians'],
          4: ['death_ward', 'guardian_of_faith'],
          5: ['mass_cure_wounds', 'flame_strike']
        },
        druid: {
          cantrips: ['produce_flame', 'shillelagh'],
          1: ['cure_wounds', 'entangle', 'goodberry'],
          2: ['moonbeam', 'pass_without_trace'],
          3: ['call_lightning', 'conjure_animals'],
          4: ['ice_storm', 'polymorph'],
          5: ['cone_of_cold', 'tree_stride']
        },
        sorcerer: {
          cantrips: ['fire_bolt', 'mage_hand'],
          1: ['magic_missile', 'shield'],
          2: ['misty_step', 'scorching_ray'],
          3: ['fireball', 'counterspell'],
          4: ['greater_invisibility', 'ice_storm'],
          5: ['cone_of_cold']
        },
        warlock: {
          cantrips: ['eldritch_blast', 'mage_hand'],
          1: ['hex', 'armor_of_agathys'],
          2: ['misty_step', 'hold_person'],
          3: ['counterspell', 'hunger_of_hadar'],
          4: ['dimension_door', 'banishment'],
          5: ['cone_of_cold', 'hold_monster']
        },
        bard: {
          cantrips: ['vicious_mockery', 'mage_hand'],
          1: ['cure_wounds', 'healing_word'],
          2: ['misty_step', 'hold_person'],
          3: ['counterspell', 'mass_healing_word'],
          4: ['greater_invisibility', 'dimension_door'],
          5: ['mass_cure_wounds', 'hold_monster']
        },
        paladin: {
          1: ['cure_wounds', 'shield_of_faith'],
          2: ['prayer_of_healing', 'aid'],
          3: ['revivify', 'mass_healing_word'],
          4: ['death_ward', 'aura_of_purity'],
          5: ['mass_cure_wounds']
        },
        ranger: {
          1: ['cure_wounds', 'hunters_mark'],
          2: ['pass_without_trace', 'spike_growth'],
          3: ['conjure_animals', 'lightning_arrow'],
          4: ['conjure_woodland_beings', 'freedom_of_movement'],
          5: ['swift_quiver', 'tree_stride']
        }
      };

      // If no subclass spells, use class defaults
      if (!subclassSpellList) {
        subclassSpellList = classDefaultSpells[charClass] || null;
      }

      // Add cantrips - use 5e progression
      let cantripCount = 0;
      if (cantripsKnownProgression[charClass]) {
        cantripCount = cantripsKnownProgression[charClass][level] || 0;
      } else if (spellcasters.includes(charClass)) {
        cantripCount = Math.min(4, 2 + Math.floor(level / 4));
      } else if (isThirdCaster && level >= 3) {
        // 1/3 casters get cantrips starting at level 3
        cantripCount = level >= 10 ? 3 : 2;
      }

      if (cantripCount > 0) {
        character.spells['0'] = [];

        if (subclassSpellList && subclassSpellList.cantrips) {
          // Add subclass-themed cantrips
          subclassSpellList.cantrips.slice(0, cantripCount).forEach(cantripId => {
            const spellDef = spellDefinitions[cantripId];
            if (spellDef) {
              character.spells['0'].push({
                id: cantripId,
                name: spellDef.name,
                icon: spellDef.icon,
                damage: spellDef.damage,
                description: spellDef.description,
                school: spellDef.school,
                castingTime: spellDef.castingTime,
                range: spellDef.range,
                components: spellDef.components,
                duration: spellDef.duration,
                concentration: spellDef.concentration,
                attackRoll: spellDef.attackRoll,
                save: spellDef.save
              });
            }
          });
        }
      }

      // Calculate max spell level based on class and character level
      let maxSpellLevel;
      if (isThirdCaster) {
        // 1/3 casters: start at level 3, max 4th level spells
        if (level < 3) return; // No spells yet
        maxSpellLevel = Math.min(4, Math.floor(level / 3));
      } else if (halfcasters.includes(charClass)) {
        // Half casters: start at level 2, max 5th level spells
        if (level < 2) return; // No spells yet
        maxSpellLevel = Math.min(5, Math.ceil(level / 4));
      } else {
        // Full casters: start at level 1, max 9th level spells
        maxSpellLevel = Math.min(9, Math.ceil(level / 2));
      }

      // Calculate total spells to distribute
      let totalSpellsToAdd = 0;
      const totalSpellsKnown = spellsKnownProgression[charClass] ? spellsKnownProgression[charClass][level] || 0 : 0;

      if (charClass === 'wizard') {
        // Wizards: Use spellbook size from progression
        totalSpellsToAdd = totalSpellsKnown;
      } else if (knownCasters.includes(charClass)) {
        // Known casters: Use known spells progression
        totalSpellsToAdd = totalSpellsKnown;
      } else if (preparedCasters.includes(charClass)) {
        // Prepared casters: Give them more spell options (they prepare from class list)
        totalSpellsToAdd = maxSpellLevel * 4; // ~4 spells per level
      } else if (isThirdCaster) {
        // 1/3 casters use their own progression
        // Level 3: 3 spells, Level 4-6: 4, Level 7: 5, etc.
        totalSpellsToAdd = Math.min(13, Math.floor((level - 3) / 2) + 3);
      }

      // Distribute spells across available spell levels
      for (let spellLevel = 1; spellLevel <= maxSpellLevel; spellLevel++) {
        character.spells[spellLevel.toString()] = [];

        // Calculate how many spells to add for this level
        let spellsToAdd;
        if (spellLevel === 1) {
          // Add more 1st level spells
          spellsToAdd = Math.ceil(totalSpellsToAdd / maxSpellLevel) + 1;
        } else {
          // Distribute remaining evenly
          spellsToAdd = Math.floor(totalSpellsToAdd / maxSpellLevel);
        }

        // Add subclass-themed spells
        if (subclassSpellList && subclassSpellList[spellLevel]) {
          const spellIds = subclassSpellList[spellLevel].slice(0, spellsToAdd);

          spellIds.forEach(spellId => {
            const spellDef = spellDefinitions[spellId];
            if (spellDef) {
              character.spells[spellLevel.toString()].push({
                id: spellId,
                name: spellDef.name,
                icon: spellDef.icon,
                damage: spellDef.damage,
                description: spellDef.description,
                school: spellDef.school,
                castingTime: spellDef.castingTime,
                range: spellDef.range,
                components: spellDef.components,
                duration: spellDef.duration,
                concentration: spellDef.concentration,
                attackRoll: spellDef.attackRoll,
                save: spellDef.save,
                prepared: preparedCasters.includes(charClass) ? true : false // Prepared casters auto-prepare
              });
            }
          });
        }
      }
    }

    // Auto-populate abilities based on class, subclass, and level
    function autoPopulateAbilities(character) {
      const charClass = character.class.toLowerCase();

      // Initialize abilities array
      if (!character.abilities) {
        character.abilities = [];
      }

      // Get abilities from database for this class
      const classAbilities = abilityDatabase[charClass] || [];

      // Add core abilities based on level
      const level = character.level;

      // Calculate how many abilities to give based on level
      // Low level: 1-2 abilities, Mid level: 3-4, High level: all available
      let abilitiesToAdd;
      if (level <= 2) {
        abilitiesToAdd = 1; // Just core ability
      } else if (level <= 4) {
        abilitiesToAdd = 2; // Core + one more
      } else if (level <= 10) {
        abilitiesToAdd = Math.min(4, classAbilities.length);
      } else {
        abilitiesToAdd = classAbilities.length; // All abilities
      }

      // Add abilities
      classAbilities.slice(0, abilitiesToAdd).forEach(ability => {
        character.abilities.push({
          id: ability.id,
          name: ability.name,
          icon: ability.icon,
          damage: ability.damage,
          description: ability.description
        });
      });

      // Add Extra Attack for fighters/paladins/rangers at level 5+
      if (level >= 5 && ['fighter', 'paladin', 'ranger'].includes(charClass)) {
        if (!character.abilities.some(a => a.id === 'extra_attack')) {
          character.abilities.push({
            id: 'extra_attack',
            name: 'Extra Attack',
            icon: '‚öîÔ∏è',
            damage: null,
            description: 'Attack twice when you take the Attack action'
          });
        }
      }
    }


    // Delete spell function (for known casters)
    function deleteSpell(spellId, level) {
      if (!currentCharacter.spells || !currentCharacter.spells[level]) return;

      // Check if this is a known caster (can delete spells)
      const knownCasters = ['bard', 'sorcerer', 'warlock', 'ranger'];
      const charClass = currentCharacter.class.toLowerCase();

      if (!knownCasters.includes(charClass)) {
        alert('This character uses prepared spells. Use the prepare/unprepare system instead!');
        return;
      }

      // Confirm deletion
      const spell = currentCharacter.spells[level].find(s => s.id === spellId);
      if (!spell) return;

      if (!confirm(`Remove ${spell.name} from known spells?\n\nYou can add it back from the spell picker.`)) {
        return;
      }

      // Remove spell
      currentCharacter.spells[level] = currentCharacter.spells[level].filter(s => s.id !== spellId);

      // Update display
      updateSpellsTab();
      addBattleLog(`üìñ ${currentCharacter.name} forgot ${spell.name}`);
    }

    // Auto-add more spells from the database
    function updateSpells() {
      const spellcasters = ['bard', 'cleric', 'druid', 'sorcerer', 'warlock', 'wizard'];
      const halfcasters = ['paladin', 'ranger'];
      const charClass = currentCharacter.class.toLowerCase();
      const subclass = currentCharacter.subclass || '';

      // 1/3 casters (Fighter Eldritch Knight, Rogue Arcane Trickster)
      const thirdCasterSubclasses = ['Eldritch Knight', 'Arcane Trickster'];
      const isThirdCaster = thirdCasterSubclasses.includes(subclass);

      if (!spellcasters.includes(charClass) && !halfcasters.includes(charClass) && !isThirdCaster) {
        alert('‚ö†Ô∏è This character is not a spellcaster!');
        return;
      }

      if (!currentCharacter.spells) {
        currentCharacter.spells = {};
      }

      // Expanded spell database with more variety
      const expandedSpellDatabase = {
        0: ['fire_bolt', 'ray_of_frost', 'shocking_grasp', 'chill_touch', 'poison_spray', 'mage_hand', 'prestidigitation', 'minor_illusion', 'sacred_flame', 'guidance', 'light', 'thaumaturgy', 'vicious_mockery', 'eldritch_blast', 'blade_ward', 'true_strike', 'produce_flame', 'shillelagh', 'thorn_whip'],
        1: ['magic_missile', 'shield', 'detect_magic', 'burning_hands', 'thunderwave', 'cure_wounds', 'bless', 'healing_word', 'hex', 'armor_of_agathys', 'entangle', 'goodberry', 'hunters_mark', 'shield_of_faith', 'inflict_wounds', 'sanctuary'],
        2: ['scorching_ray', 'shatter', 'misty_step', 'hold_person', 'prayer_of_healing', 'lesser_restoration', 'spiritual_weapon', 'moonbeam', 'pass_without_trace', 'spike_growth', 'aid', 'silence', 'locate_object'],
        3: ['fireball', 'lightning_bolt', 'counterspell', 'mass_healing_word', 'revivify', 'beacon_of_hope', 'call_lightning', 'conjure_animals', 'lightning_arrow', 'spirit_guardians', 'dispel_magic', 'hunger_of_hadar'],
        4: ['ice_storm', 'wall_of_fire', 'greater_invisibility', 'death_ward', 'guardian_of_faith', 'polymorph', 'conjure_woodland_beings', 'freedom_of_movement', 'dimension_door', 'banishment', 'aura_of_purity'],
        5: ['cone_of_cold', 'wall_of_force', 'mass_cure_wounds', 'raise_dead', 'flame_strike', 'tree_stride', 'swift_quiver', 'hold_monster', 'cloudkill', 'scrying']
      };

      let spellsAdded = 0;
      const preparedCasters = ['cleric', 'druid', 'paladin'];
      const level = currentCharacter.level;
      const maxSpellLevel = halfcasters.includes(charClass) ? Math.min(5, Math.ceil(level / 4)) : Math.min(9, Math.ceil(level / 2));

      // For each spell level the character has access to
      for (let spellLevel = 0; spellLevel <= maxSpellLevel; spellLevel++) {
        const levelKey = spellLevel.toString();

        // Initialize if needed
        if (!currentCharacter.spells[levelKey]) {
          currentCharacter.spells[levelKey] = [];
        }

        // Get current spell IDs to avoid duplicates
        const currentSpellIds = currentCharacter.spells[levelKey].map(s => s.id);

        // Get available spells for this level
        const availableSpells = expandedSpellDatabase[spellLevel] || [];

        // Filter out spells already known
        const newSpells = availableSpells.filter(spellId => !currentSpellIds.includes(spellId));

        // Add 2-3 new spells per level
        const spellsToAdd = spellLevel === 0 ? 2 : Math.min(3, newSpells.length);

        for (let i = 0; i < spellsToAdd && i < newSpells.length; i++) {
          const spellId = newSpells[i];
          const spellDef = spellDefinitions[spellId];

          if (spellDef) {
            currentCharacter.spells[levelKey].push({
              id: spellId,
              name: spellDef.name,
              icon: spellDef.icon,
              damage: spellDef.damage,
              description: spellDef.description,
              school: spellDef.school,
              castingTime: spellDef.castingTime,
              range: spellDef.range,
              components: spellDef.components,
              duration: spellDef.duration,
              concentration: spellDef.concentration,
              attackRoll: spellDef.attackRoll,
              save: spellDef.save,
              prepared: preparedCasters.includes(charClass) ? true : false
            });
            spellsAdded++;
          }
        }
      }

      if (spellsAdded > 0) {
        updateSpellsTab();
        alert(`‚ú® Added ${spellsAdded} new spell${spellsAdded > 1 ? 's' : ''} to your spellbook!`);
      } else {
        alert('üìñ No new spells available! You already know all available spells for your level, or use the Spell Picker to add custom spells.');
      }
    }

    // Auto-add more abilities from expanded database
    function addMoreAbilities() {
      if (!currentCharacter.abilities) {
        currentCharacter.abilities = [];
      }

      const charClass = currentCharacter.class.toLowerCase();
      const level = currentCharacter.level;

      // Expanded ability database with more options
      const expandedAbilityDatabase = {
        barbarian: [
          { id: 'rage', name: 'Rage', icon: 'üò°', damage: null, description: 'Gain advantage on STR checks, +2 damage, resistance to physical damage' },
          { id: 'reckless_attack', name: 'Reckless Attack', icon: 'üí•', damage: null, description: 'Gain advantage on melee attacks, enemies have advantage against you' },
          { id: 'danger_sense', name: 'Danger Sense', icon: '‚ö†Ô∏è', damage: null, description: 'Advantage on DEX saves against visible effects' },
          { id: 'feral_instinct', name: 'Feral Instinct', icon: 'üê∫', damage: null, description: 'Advantage on initiative, cannot be surprised while raging' },
          { id: 'brutal_critical', name: 'Brutal Critical', icon: 'üíÄ', damage: null, description: 'Roll additional weapon damage dice on critical hits' },
          { id: 'relentless_rage', name: 'Relentless Rage', icon: '‚ù§Ô∏è', damage: null, description: 'If you drop to 0 HP while raging, make a DC 10 CON save to drop to 1 HP instead' },
          { id: 'persistent_rage', name: 'Persistent Rage', icon: 'üî•', damage: null, description: 'Your rage only ends early if you fall unconscious or choose to end it' }
        ],
        fighter: [
          { id: 'second_wind', name: 'Second Wind', icon: 'üí®', damage: null, description: 'Regain 1d10 + fighter level HP as bonus action' },
          { id: 'action_surge', name: 'Action Surge', icon: '‚ö°', damage: null, description: 'Take one additional action on your turn' },
          { id: 'extra_attack', name: 'Extra Attack', icon: '‚öîÔ∏è', damage: null, description: 'Attack twice when you take the Attack action' },
          { id: 'indomitable', name: 'Indomitable', icon: 'üõ°Ô∏è', damage: null, description: 'Reroll a failed saving throw' },
          { id: 'improved_critical', name: 'Improved Critical', icon: 'üéØ', damage: null, description: 'Critical hits on rolls of 19-20' },
          { id: 'remarkable_athlete', name: 'Remarkable Athlete', icon: 'üèÉ', damage: null, description: 'Add half proficiency to STR/DEX/CON checks without proficiency' }
        ],
        monk: [
          { id: 'martial_arts', name: 'Martial Arts', icon: 'ü•ã', damage: '1d6', description: 'Unarmed strikes use martial arts die, bonus action unarmed strike' },
          { id: 'ki', name: 'Ki Points', icon: '‚ú®', damage: null, description: 'Spend ki points to fuel special abilities' },
          { id: 'flurry_of_blows', name: 'Flurry of Blows', icon: 'üëä', damage: '2d6', description: 'Spend 1 ki to make two unarmed strikes as bonus action' },
          { id: 'patient_defense', name: 'Patient Defense', icon: 'üõ°Ô∏è', damage: null, description: 'Spend 1 ki to Dodge as bonus action' },
          { id: 'step_of_wind', name: 'Step of the Wind', icon: 'üí®', damage: null, description: 'Spend 1 ki to Disengage/Dash as bonus action, double jump distance' },
          { id: 'stunning_strike', name: 'Stunning Strike', icon: '‚≠ê', damage: null, description: 'Spend 1 ki, target must succeed CON save or be stunned' },
          { id: 'deflect_missiles', name: 'Deflect Missiles', icon: 'üéØ', damage: null, description: 'Reduce ranged attack damage, catch and throw back projectiles' },
          { id: 'slow_fall', name: 'Slow Fall', icon: 'ü™Ç', damage: null, description: 'Reduce falling damage by 5x monk level' },
          { id: 'evasion', name: 'Evasion', icon: '‚ö°', damage: null, description: 'Take no damage on successful DEX save, half on failure' },
          { id: 'stillness_of_mind', name: 'Stillness of Mind', icon: 'üßò', damage: null, description: 'End one charmed or frightened effect as action' }
        ],
        rogue: [
          { id: 'sneak_attack', name: 'Sneak Attack', icon: 'üó°Ô∏è', damage: '6d6', description: 'Deal extra damage when you have advantage or ally is nearby' },
          { id: 'cunning_action', name: 'Cunning Action', icon: '‚ö°', damage: null, description: 'Dash, Disengage, or Hide as bonus action' },
          { id: 'evasion', name: 'Evasion', icon: 'üí®', damage: null, description: 'Take no damage on successful DEX save, half on failure' },
          { id: 'uncanny_dodge', name: 'Uncanny Dodge', icon: 'üõ°Ô∏è', damage: null, description: 'Halve damage from one attack as reaction' },
          { id: 'reliable_talent', name: 'Reliable Talent', icon: 'üéØ', damage: null, description: 'Treat rolls of 9 or lower as 10 for proficient skills' },
          { id: 'blindsense', name: 'Blindsense', icon: 'üëÅÔ∏è', damage: null, description: 'Detect hidden/invisible creatures within 10ft' },
          { id: 'slippery_mind', name: 'Slippery Mind', icon: 'üß†', damage: null, description: 'Proficiency in WIS saves' }
        ],
        paladin: [
          { id: 'divine_sense', name: 'Divine Sense', icon: '‚ú®', damage: null, description: 'Detect celestials, fiends, and undead within 60ft' },
          { id: 'lay_on_hands', name: 'Lay on Hands', icon: 'ü§≤', damage: null, description: 'Heal 5x paladin level HP per day' },
          { id: 'divine_smite', name: 'Divine Smite', icon: '‚öîÔ∏è', damage: '2d8', description: 'Expend spell slot to deal extra radiant damage' },
          { id: 'extra_attack', name: 'Extra Attack', icon: '‚öîÔ∏è', damage: null, description: 'Attack twice when you take the Attack action' },
          { id: 'aura_of_protection', name: 'Aura of Protection', icon: 'üõ°Ô∏è', damage: null, description: 'You and allies within 10ft add CHA mod to saves' },
          { id: 'aura_of_courage', name: 'Aura of Courage', icon: 'üí™', damage: null, description: 'You and allies within 10ft immune to frightened' },
          { id: 'cleansing_touch', name: 'Cleansing Touch', icon: '‚úã', damage: null, description: 'End one spell on yourself or ally (CHA mod times per day)' }
        ],
        ranger: [
          { id: 'favored_enemy', name: 'Favored Enemy', icon: 'üéØ', damage: null, description: 'Advantage on tracking and INT checks for chosen enemy type' },
          { id: 'natural_explorer', name: 'Natural Explorer', icon: 'üå≤', damage: null, description: 'Benefits in favored terrain: ignore difficult terrain, advantage on initiative' },
          { id: 'hunters_mark', name: "Hunter's Mark", icon: 'üèπ', damage: '1d6', description: 'Mark target for 1 hour, deal extra damage and track easily' },
          { id: 'extra_attack', name: 'Extra Attack', icon: '‚öîÔ∏è', damage: null, description: 'Attack twice when you take the Attack action' },
          { id: 'land_stride', name: "Land's Stride", icon: 'üèÉ', damage: null, description: 'Move through nonmagical difficult terrain without penalty' },
          { id: 'hide_in_plain_sight', name: 'Hide in Plain Sight', icon: 'üåø', damage: null, description: 'Camouflage yourself, +10 to Stealth checks' },
          { id: 'vanish', name: 'Vanish', icon: 'üí®', damage: null, description: 'Hide as bonus action, cannot be tracked except by magic' }
        ],
        bard: [
          { id: 'bardic_inspiration', name: 'Bardic Inspiration', icon: 'üéµ', damage: '1d8', description: 'Grant ally inspiration die to add to ability checks, attacks, or saves' },
          { id: 'jack_of_all_trades', name: 'Jack of All Trades', icon: 'üé≠', damage: null, description: 'Add half proficiency to ability checks without proficiency' },
          { id: 'song_of_rest', name: 'Song of Rest', icon: 'üé∂', damage: '1d8', description: 'Allies regain extra HP during short rest' },
          { id: 'expertise', name: 'Expertise', icon: '‚≠ê', damage: null, description: 'Double proficiency bonus for two skills' },
          { id: 'font_of_inspiration', name: 'Font of Inspiration', icon: '‚ú®', damage: null, description: 'Regain bardic inspiration on short rest' },
          { id: 'countercharm', name: 'Countercharm', icon: 'üé∫', damage: null, description: 'Grant advantage vs frightened/charmed to allies within 30ft' }
        ],
        cleric: [
          { id: 'channel_divinity', name: 'Channel Divinity', icon: '‚úùÔ∏è', damage: null, description: 'Channel divine energy for powerful effects' },
          { id: 'turn_undead', name: 'Turn Undead', icon: 'üíÄ', damage: null, description: 'Force undead to flee for 1 minute (WIS save)' },
          { id: 'destroy_undead', name: 'Destroy Undead', icon: '‚ò†Ô∏è', damage: null, description: 'Instantly destroy low CR undead when turned' },
          { id: 'divine_intervention', name: 'Divine Intervention', icon: 'üôè', damage: null, description: 'Ask deity for aid (10% chance + cleric level)' },
          { id: 'blessed_healer', name: 'Blessed Healer', icon: 'üíö', damage: null, description: 'Heal yourself when you heal others (2 + spell level HP)' }
        ],
        druid: [
          { id: 'wild_shape', name: 'Wild Shape', icon: 'üêª', damage: null, description: 'Transform into beast with CR up to 1/3 druid level' },
          { id: 'natural_recovery', name: 'Natural Recovery', icon: 'üåø', damage: null, description: 'Recover spell slots during short rest (total level = half druid level)' },
          { id: 'beast_spells', name: 'Beast Spells', icon: '‚ú®', damage: null, description: 'Cast spells while in Wild Shape' },
          { id: 'timeless_body', name: 'Timeless Body', icon: '‚è≥', damage: null, description: 'Age 1 year for every 10 years, cannot be aged magically' },
          { id: 'archdruid', name: 'Archdruid', icon: 'üå≥', damage: null, description: 'Use Wild Shape unlimited times' }
        ],
        sorcerer: [
          { id: 'sorcery_points', name: 'Sorcery Points', icon: '‚ú®', damage: null, description: 'Fuel metamagic and create spell slots' },
          { id: 'metamagic', name: 'Metamagic', icon: 'üîÆ', damage: null, description: 'Modify spells: Quicken, Twin, Empower, Subtle' },
          { id: 'font_of_magic', name: 'Font of Magic', icon: 'üí´', damage: null, description: 'Convert sorcery points to/from spell slots' },
          { id: 'sorcerous_restoration', name: 'Sorcerous Restoration', icon: 'üîÑ', damage: null, description: 'Regain 4 sorcery points on short rest' }
        ],
        warlock: [
          { id: 'eldritch_invocations', name: 'Eldritch Invocations', icon: 'üëÅÔ∏è', damage: null, description: 'Learn magical abilities granted by patron' },
          { id: 'pact_magic', name: 'Pact Magic', icon: 'üìú', damage: null, description: 'Spell slots recharge on short rest' },
          { id: 'agonizing_blast', name: 'Agonizing Blast', icon: 'üí•', damage: '+5', description: 'Add CHA modifier to Eldritch Blast damage' },
          { id: 'devils_sight', name: "Devil's Sight", icon: 'üëÅÔ∏è', damage: null, description: 'See normally in darkness (magical or nonmagical) to 120ft' },
          { id: 'mystic_arcanum', name: 'Mystic Arcanum', icon: 'üìñ', damage: null, description: 'Learn 6th-9th level spells, cast once per long rest' }
        ],
        wizard: [
          { id: 'arcane_recovery', name: 'Arcane Recovery', icon: 'üîÑ', damage: null, description: 'Recover spell slots during short rest (total level = half wizard level)' },
          { id: 'spell_mastery', name: 'Spell Mastery', icon: 'üìö', damage: null, description: 'Cast one 1st and one 2nd level spell at will' },
          { id: 'signature_spells', name: 'Signature Spells', icon: '‚úçÔ∏è', damage: null, description: 'Always have two 3rd level spells prepared' },
          { id: 'sculpt_spells', name: 'Sculpt Spells', icon: 'üé®', damage: null, description: 'Allies auto-succeed saves against your evocation spells' },
          { id: 'potent_cantrip', name: 'Potent Cantrip', icon: 'üí´', damage: null, description: 'Targets take half damage on cantrip save success' }
        ]
      };

      // Get current ability IDs to avoid duplicates
      const currentAbilityIds = currentCharacter.abilities.map(a => a.id);

      // Get expanded abilities for this class
      const classAbilities = expandedAbilityDatabase[charClass] || [];

      // Filter out already known abilities
      const newAbilities = classAbilities.filter(ability => !currentAbilityIds.includes(ability.id));

      let abilitiesAdded = 0;

      // Add 3-5 new abilities
      const abilitiesToAdd = Math.min(5, newAbilities.length);

      for (let i = 0; i < abilitiesToAdd; i++) {
        const ability = newAbilities[i];
        currentCharacter.abilities.push({
          id: ability.id,
          name: ability.name,
          icon: ability.icon,
          damage: ability.damage,
          description: ability.description
        });
        abilitiesAdded++;
      }

      if (abilitiesAdded > 0) {
        updateAbilitiesTab();
        alert(`‚ú® Added ${abilitiesAdded} new ${abilitiesAdded > 1 ? 'abilities' : 'ability'}!`);
      } else {
        alert('‚öîÔ∏è No new abilities available! You already know all available abilities for your class, or use the Ability Picker to add custom abilities.');
      }
    }

  </script>

  <!-- Spell Detail Modal -->
  <div class="spell-modal-overlay" id="spellModalOverlay" onclick="closeSpellModal(event)">
    <div class="spell-modal" onclick="event.stopPropagation()">
      <div class="spell-modal-header">
        <div class="spell-modal-icon" id="modalSpellIcon">‚ú®</div>
        <div class="spell-modal-title">
          <div class="spell-modal-name" id="modalSpellName">Spell Name</div>
          <div class="spell-modal-level" id="modalSpellLevel">Level 1 Evocation</div>
        </div>
        <button class="spell-modal-close" onclick="closeSpellModal()">‚úï</button>
      </div>
      <div class="spell-modal-body">
        <div class="spell-stats-grid" id="modalSpellStats">
          <!-- Stats will be populated dynamically -->
        </div>
        <div class="spell-description" id="modalSpellDescription">
          Spell description will appear here...
        </div>
        <div class="spell-modal-actions">
          <button class="spell-btn-cast" id="modalCastBtn" onclick="castSpellFromModal()">
            ‚ú® Cast Spell
          </button>
          <button class="spell-btn-prepare" id="modalPrepareBtn" onclick="togglePrepareFromModal()">
            Prepare
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Spell Picker Modal -->
  <div class="spell-picker-overlay" id="spellPickerOverlay" onclick="closeSpellPicker(event)">
    <div class="spell-picker-modal" onclick="event.stopPropagation()">
      <div class="spell-picker-header">
        <div class="spell-picker-title">üìö Add Spell from D&D 5e SRD</div>
        <button class="spell-modal-close" onclick="closeSpellPicker()" style="position: absolute; top: 15px; right: 15px;">‚úï</button>

        <div class="spell-picker-search">
          <input type="text" id="spellPickerSearch" placeholder="Search spells..." oninput="filterPickerSpells()">
        </div>

        <div class="spell-picker-filters">
          <button class="spell-picker-filter active" data-level="all" onclick="filterByLevel('all')">All Levels</button>
          <button class="spell-picker-filter" data-level="0" onclick="filterByLevel('0')">Cantrips</button>
          <button class="spell-picker-filter" data-level="1" onclick="filterByLevel('1')">1st</button>
          <button class="spell-picker-filter" data-level="2" onclick="filterByLevel('2')">2nd</button>
          <button class="spell-picker-filter" data-level="3" onclick="filterByLevel('3')">3rd</button>
          <button class="spell-picker-filter" data-level="4" onclick="filterByLevel('4')">4th</button>
          <button class="spell-picker-filter" data-level="5" onclick="filterByLevel('5')">5th</button>
          <button class="spell-picker-filter" data-level="6" onclick="filterByLevel('6')">6th</button>
          <button class="spell-picker-filter" data-level="7" onclick="filterByLevel('7')">7th</button>
          <button class="spell-picker-filter" data-level="8" onclick="filterByLevel('8')">8th</button>
          <button class="spell-picker-filter" data-level="9" onclick="filterByLevel('9')">9th</button>
        </div>
        <div style="padding: 10px 15px 0 15px;">
          <select id="spellClassFilter" onchange="filterByClass(this.value)" style="width: 100%; padding: 8px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.9rem;">
            <option value="all">All Classes</option>
            <option value="bard">Bard</option>
            <option value="cleric">Cleric</option>
            <option value="druid">Druid</option>
            <option value="paladin">Paladin</option>
            <option value="ranger">Ranger</option>
            <option value="sorcerer">Sorcerer</option>
            <option value="warlock">Warlock</option>
            <option value="wizard">Wizard</option>
          </select>
        </div>

      </div>

      <div class="spell-picker-body" id="spellPickerBody">
        <div class="spell-picker-loading">
          üîÆ Loading spells from local database...
        </div>
      </div>
    </div>
  </div>

  <!-- Character Creator Modal -->
  <div class="spell-modal-overlay" id="characterCreatorOverlay" onclick="closeCharacterCreator(event)" style="z-index: 11000;">
    <div class="spell-modal" onclick="event.stopPropagation()" style="max-width: 600px;">
      <div class="spell-modal-header">
        <div class="spell-modal-icon">üé≠</div>
        <div class="spell-modal-title">
          <div class="spell-modal-name">Create New Character</div>
          <div class="spell-modal-level">Build your D&D adventurer</div>
        </div>
        <button class="spell-modal-close" onclick="closeCharacterCreator()">‚úï</button>
      </div>

      <div class="spell-modal-body" style="padding: 20px;">
        <div style="display: flex; flex-direction: column; gap: 15px;">

          <!-- Name Input -->
          <div>
            <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 5px;">Character Name</label>
            <input type="text" id="newCharName" placeholder="Enter character name" style="width: 100%; padding: 10px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem;">
          </div>

          <!-- Class Dropdown -->
          <div>
            <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 5px;">Class</label>
            <select id="newCharClass" onchange="updateSubclassOptions()" style="width: 100%; padding: 10px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem;">
              <option value="barbarian">Barbarian</option>
              <option value="bard">Bard</option>
              <option value="cleric">Cleric</option>
              <option value="druid">Druid</option>
              <option value="fighter">Fighter</option>
              <option value="monk">Monk</option>
              <option value="paladin">Paladin</option>
              <option value="ranger">Ranger</option>
              <option value="rogue">Rogue</option>
              <option value="sorcerer">Sorcerer</option>
              <option value="warlock">Warlock</option>
              <option value="wizard">Wizard</option>
            </select>
          </div>

          <!-- Race Dropdown -->
          <div>
            <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 5px;">Race</label>
            <select id="newCharRace" style="width: 100%; padding: 10px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem;">
              <option value="human">Human</option>
              <option value="elf">Elf</option>
              <option value="dwarf">Dwarf</option>
              <option value="halfling">Halfling</option>
              <option value="dragonborn">Dragonborn</option>
              <option value="gnome">Gnome</option>
              <option value="half-elf">Half-Elf</option>
              <option value="half-orc">Half-Orc</option>
              <option value="tiefling">Tiefling</option>
            </select>
          </div>
          <!-- Subclass Dropdown -->
          <div id="subclassWrapper" style="display: none;">
            <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 5px;">Subclass</label>
            <select id="newCharSubclass" style="width: 100%; padding: 10px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem;">
              <option value="none">Choose subclass...</option>
            </select>
          </div>


          <!-- Level Input -->
          <div>
            <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 5px;">Starting Level</label>
            <input type="number" id="newCharLevel" value="1" min="1" max="20" oninput="updateSubclassVisibility()" style="width: 100%; padding: 10px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem;">
          </div>

          <!-- Create Button -->
          <button onclick="createNewCharacter()" style="width: 100%; padding: 12px; background: var(--accent-color); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 1.1rem; margin-top: 10px;">
            ‚ú® Create Character
          </button>

          <!-- Load Existing Button -->
          <button onclick="showComingSoon()" style="width: 100%; padding: 10px; background: var(--surface-color); border: 2px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); font-weight: 500; cursor: pointer; font-size: 0.95rem;">
            üìÇ Load Existing Character
          </button>

        </div>
      </div>
    </div>
  </div>


  <!-- Ability Picker Modal -->
  <div class="spell-picker-overlay" id="abilityPickerOverlay" onclick="closeAbilityPicker(event)">
    <div class="spell-picker-modal" onclick="event.stopPropagation()">
      <div class="spell-picker-header">
        <div class="spell-picker-title">‚öîÔ∏è Add Ability</div>
        <button class="spell-modal-close" onclick="closeAbilityPicker()" style="position: absolute; top: 15px; right: 15px;">‚úï</button>

        <div class="spell-picker-search">
          <input type="text" id="abilityPickerSearch" placeholder="Search abilities..." oninput="filterAbilities()">
        </div>

        <div style="padding: 10px 15px 0 15px;">
          <select id="abilityClassFilter" onchange="filterAbilities()" style="width: 100%; padding: 8px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.9rem;">
            <option value="all">All Classes</option>
            <option value="barbarian">Barbarian</option>
            <option value="bard">Bard</option>
            <option value="cleric">Cleric</option>
            <option value="druid">Druid</option>
            <option value="fighter">Fighter</option>
            <option value="monk">Monk</option>
            <option value="paladin">Paladin</option>
            <option value="ranger">Ranger</option>
            <option value="rogue">Rogue</option>
            <option value="sorcerer">Sorcerer</option>
            <option value="warlock">Warlock</option>
            <option value="wizard">Wizard</option>
          </select>
        </div>
      </div>

      <div class="spell-picker-body" id="abilityPickerBody">
        <div class="spell-picker-loading">
          ‚öîÔ∏è Select a class to see abilities...
        </div>
      </div>

      <div style="padding: 15px; border-top: 2px solid var(--border-color);">
        <button onclick="openCustomAbilityCreator()" style="width: 100%; padding: 12px; background: var(--surface-color); border: 2px solid var(--accent-color); border-radius: 6px; color: var(--accent-color); font-weight: 600; cursor: pointer; font-size: 1rem;">
          ‚ú® Create Custom Ability
        </button>
      </div>
    </div>
  </div>

  <!-- Custom Ability Creator Modal -->
  <div class="spell-modal-overlay" id="customAbilityOverlay" onclick="closeCustomAbilityCreator(event)" style="z-index: 10200;">
    <div class="spell-modal" onclick="event.stopPropagation()" style="max-width: 500px;">
      <div class="spell-modal-header">
        <div class="spell-modal-icon">‚ú®</div>
        <div class="spell-modal-title">
          <div class="spell-modal-name">Create Custom Ability</div>
          <div class="spell-modal-level">Design your own ability</div>
        </div>
        <button class="spell-modal-close" onclick="closeCustomAbilityCreator()">‚úï</button>
      </div>

      <div class="spell-modal-body" style="padding: 20px;">
        <div style="display: flex; flex-direction: column; gap: 15px;">
          <div>
            <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 5px;">Ability Name</label>
            <input type="text" id="customAbilityName" placeholder="e.g., Power Strike" style="width: 100%; padding: 10px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem;">
          </div>

          <div>
            <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 5px;">Icon (emoji)</label>
            <input type="text" id="customAbilityIcon" placeholder="‚öîÔ∏è" maxlength="2" style="width: 100%; padding: 10px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem;">
          </div>

          <div>
            <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 5px;">Damage (optional)</label>
            <input type="text" id="customAbilityDamage" placeholder="e.g., 2d6+4" style="width: 100%; padding: 10px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem;">
          </div>

          <div>
            <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 5px;">Description</label>
            <textarea id="customAbilityDesc" placeholder="Describe what this ability does..." rows="4" style="width: 100%; padding: 10px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem; resize: vertical;"></textarea>
          </div>

          <button onclick="addCustomAbility()" style="width: 100%; padding: 12px; background: var(--accent-color); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 1.1rem; margin-top: 10px;">
            ‚ú® Add Ability
          </button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
