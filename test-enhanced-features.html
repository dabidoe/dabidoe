<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Features Test - Character Foundry</title>
  <style>
    :root {
      --surface-color: #1a1a1a;
      --background-color: #0f0f0f;
      --border-color: #333;
      --accent-color: #4a90e2;
      --accent-hover: #357abd;
      --text-primary: #fff;
      --text-secondary: #888;
      --hover-color: #252525;
      --battle-color: #e74c3c;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--background-color);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
    }

    .test-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header with Hamburger */
    .test-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 40px;
      padding: 20px 30px;
      background: var(--surface-color);
      border-radius: 12px;
      border: 2px solid var(--border-color);
      position: relative;
    }

    .hamburger-btn {
      width: 50px;
      height: 50px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.2s ease;
    }

    .hamburger-btn:hover {
      border-color: var(--accent-color);
      background: var(--hover-color);
    }

    .hamburger-btn span {
      width: 25px;
      height: 3px;
      background: var(--text-primary);
      border-radius: 2px;
      transition: all 0.2s ease;
    }

    .header-content {
      flex: 1;
      text-align: center;
    }

    .header-content h1 {
      font-size: 2rem;
      margin-bottom: 5px;
      color: var(--accent-color);
    }

    .current-character {
      font-size: 1.2rem;
      color: var(--text-secondary);
    }

    .current-character-emoji {
      font-size: 1.5rem;
      margin-right: 8px;
    }

    /* Character Menu Overlay */
    .character-menu {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100vh;
      background: var(--surface-color);
      border-right: 2px solid var(--border-color);
      z-index: 9999;
      transition: left 0.3s ease;
      overflow-y: auto;
      box-shadow: 2px 0 20px rgba(0, 0, 0, 0.5);
    }

    .character-menu.open {
      left: 0;
    }

    .menu-header {
      padding: 20px;
      background: var(--background-color);
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .menu-header h3 {
      color: var(--accent-color);
    }

    .close-menu-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 1.2rem;
    }

    .character-list {
      padding: 10px;
    }

    .character-item {
      padding: 15px;
      margin-bottom: 10px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .character-item:hover {
      border-color: var(--accent-color);
      transform: translateX(5px);
    }

    .character-item.active {
      background: var(--accent-color);
      border-color: var(--accent-color);
    }

    .character-item-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .character-item-emoji {
      font-size: 2rem;
    }

    .character-item-info {
      flex: 1;
    }

    .character-item-name {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 3px;
    }

    .character-item-class {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .character-item.active .character-item-class {
      color: rgba(255, 255, 255, 0.8);
    }

    .character-item-stats {
      display: flex;
      gap: 15px;
      font-size: 0.85rem;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }

    .character-item.active .character-item-stats {
      border-top-color: rgba(255, 255, 255, 0.3);
    }

    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9998;
      display: none;
    }

    .menu-overlay.show {
      display: block;
    }

    .demo-layout {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .demo-section {
      background: var(--surface-color);
      border-radius: 12px;
      padding: 20px;
      border: 2px solid var(--border-color);
    }

    .demo-section h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: var(--accent-color);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
    }

    /* Image Tabs */
    .image-tabs-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
    }

    .tab-button {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }

    .tab-button:hover {
      background: var(--hover-color);
      color: var(--text-primary);
    }

    .tab-button.active {
      background: var(--accent-color);
      color: white;
    }

    .image-display {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      background: var(--background-color);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .image-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
    }

    .placeholder-emoji {
      font-size: 4rem;
      margin-bottom: 10px;
      opacity: 0.3;
    }

    .portrait-types {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .portrait-type-btn {
      padding: 8px 16px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.85rem;
    }

    .portrait-type-btn:hover {
      border-color: var(--accent-color);
    }

    .portrait-type-btn.active {
      background: var(--accent-color);
      border-color: var(--accent-color);
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-block {
      padding: 15px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      text-align: center;
    }

    .stat-name {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--text-primary);
    }

    .stat-modifier {
      font-size: 0.9rem;
      color: var(--accent-color);
      font-weight: 700;
    }

    .hp-display {
      margin-bottom: 15px;
      padding: 15px;
      background: var(--background-color);
      border-radius: 8px;
    }

    .hp-bar {
      position: relative;
      height: 30px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 15px;
      border: 2px solid var(--border-color);
      overflow: hidden;
      margin-top: 10px;
    }

    .hp-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, #e74c3c, #c0392b);
      transition: width 0.3s ease;
    }

    .hp-text {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: white;
      font-weight: bold;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    }

    /* Chat Modes */
    .chat-modes {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
    }

    .mode-btn {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .mode-btn:hover {
      background: var(--hover-color);
      color: var(--text-primary);
    }

    .mode-btn.active {
      background: var(--accent-color);
      color: white;
    }

    /* Turn Tracker */
    .turn-tracker {
      margin-bottom: 15px;
      padding: 12px;
      background: var(--background-color);
      border: 2px solid var(--battle-color);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .turn-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .turn-number {
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--battle-color);
    }

    .turn-controls button {
      padding: 8px 16px;
      background: var(--battle-color);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .turn-controls button:hover {
      opacity: 0.8;
    }

    /* State Selector */
    .state-selector {
      margin-bottom: 15px;
      padding: 12px;
      background: var(--background-color);
      border-radius: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .state-selector select {
      flex: 1;
      padding: 8px;
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    /* Messages */
    .messages-area {
      height: 350px;
      overflow-y: auto;
      padding: 15px;
      background: var(--background-color);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .message {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.player {
      flex-direction: row-reverse;
    }

    .message.system {
      justify-content: center;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .message.system .message-avatar {
      background: var(--battle-color);
    }

    .message-content {
      flex: 1;
      padding: 12px;
      background: var(--surface-color);
      border-radius: 12px;
      max-width: 70%;
    }

    .message.player .message-content {
      background: var(--accent-color);
    }

    .message.system .message-content {
      background: rgba(231, 76, 60, 0.2);
      border: 2px solid var(--battle-color);
      max-width: 90%;
      text-align: center;
    }

    .message-header {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--accent-color);
    }

    .message.player .message-header {
      color: rgba(255, 255, 255, 0.9);
    }

    .message-text {
      line-height: 1.5;
    }

    /* Battle Actions */
    .battle-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .action-btn {
      padding: 12px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .action-btn:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
    }

    /* Abilities */
    .abilities-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .ability-card {
      padding: 15px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ability-card:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
    }

    .ability-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .ability-icon {
      font-size: 2rem;
    }

    .ability-info {
      flex: 1;
    }

    .ability-name {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .ability-damage {
      font-size: 0.85rem;
      color: var(--accent-color);
      font-weight: 700;
    }

    .ability-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* Skills Grid */
    .skills-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    .skill-btn {
      padding: 12px 8px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .skill-btn:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .skill-emoji {
      font-size: 1.8rem;
      display: block;
      margin-bottom: 5px;
    }

    .skill-name {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .skill-modifier {
      font-size: 0.7rem;
      color: var(--accent-color);
      font-weight: 700;
    }

    .skills-section {
      margin-bottom: 20px;
    }

    .skills-section h3 {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    /* Dice Overlay */
    .dice-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      display: none;
    }

    .dice-overlay.show {
      display: block;
      animation: diceEnter 0.5s ease-out;
    }

    @keyframes diceEnter {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5) rotate(-180deg);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
      }
    }

    .dice-result {
      padding: 30px 40px;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(26, 26, 26, 0.95));
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), 0 0 20px rgba(74, 144, 226, 0.3);
      text-align: center;
      backdrop-filter: blur(10px);
      min-width: 200px;
    }

    .dice-icon {
      font-size: 3rem;
      margin-bottom: 10px;
      animation: diceRoll 0.5s ease-out;
    }

    @keyframes diceRoll {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(90deg); }
      50% { transform: rotate(180deg); }
      75% { transform: rotate(270deg); }
    }

    .dice-type {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    .dice-value {
      font-size: 3.5rem;
      font-weight: 900;
      text-shadow: 0 2px 10px currentColor;
      animation: resultPulse 0.5s ease-out;
      line-height: 1;
      margin-bottom: 8px;
    }

    .dice-breakdown {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-family: 'Courier New', monospace;
      margin-top: 8px;
    }

    @keyframes resultPulse {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }

    .dice-result.critical-success {
      border-color: #2ecc71;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(46, 204, 113, 0.6);
    }

    .dice-result.critical-success .dice-value {
      color: #2ecc71;
    }

    .dice-result.critical-fail {
      border-color: #e74c3c;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(231, 76, 60, 0.6);
      animation: criticalFailShake 0.5s ease-out;
    }

    .dice-result.critical-fail .dice-value {
      color: #e74c3c;
    }

    @keyframes criticalFailShake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* Test Controls */
    .test-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }

    .test-btn {
      padding: 15px 25px;
      background: var(--accent-color);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .test-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    @media (max-width: 1200px) {
      .demo-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .battle-actions {
        grid-template-columns: repeat(2, 1fr);
      }

      .skills-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .test-controls {
        bottom: 10px;
        right: 10px;
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="test-container">
    <!-- Header with Hamburger -->
    <div class="test-header">
      <button class="hamburger-btn" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <div class="header-content">
        <h1>üéÆ Character Foundry</h1>
        <div class="current-character">
          <span class="current-character-emoji" id="currentCharEmoji">üèπ</span>
          <span id="currentCharName">Aelindra Moonwhisper</span>
        </div>
      </div>

      <div style="width: 50px;"></div> <!-- Spacer for symmetry -->
    </div>

    <!-- Character Menu -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
    <div class="character-menu" id="characterMenu">
      <div class="menu-header">
        <h3>Characters</h3>
        <button class="close-menu-btn" onclick="closeMenu()">‚úï</button>
      </div>
      <div class="character-list" id="characterList">
        <!-- Will be populated by JS -->
      </div>
    </div>

    <!-- Demo Layout -->
    <div class="demo-layout">
      <!-- Left Column -->
      <div>
        <!-- Image Tabs -->
        <div class="demo-section">
          <h2>üì∏ Multi-Image System</h2>

          <div class="image-tabs-nav">
            <button class="tab-button active" onclick="switchImageTab('portrait')">Portrait</button>
            <button class="tab-button" onclick="switchImageTab('battle')">Battle</button>
            <button class="tab-button" onclick="switchImageTab('canvas')">Canvas</button>
          </div>

          <div id="imageDisplay" class="image-display">
            <div class="image-placeholder">
              <div class="placeholder-emoji" id="characterEmoji">üèπ</div>
              <p>AI-Generated Portrait</p>
              <small style="color: var(--text-secondary);">Standard portrait type</small>
            </div>
          </div>

          <div class="portrait-types">
            <button class="portrait-type-btn active" onclick="switchPortraitType('standard')">Standard</button>
            <button class="portrait-type-btn" onclick="switchPortraitType('battle')">Battle</button>
            <button class="portrait-type-btn" onclick="switchPortraitType('injured')">Injured</button>
            <button class="portrait-type-btn" onclick="switchPortraitType('triumphant')">Triumphant</button>
          </div>
        </div>

        <!-- Stats -->
        <div class="demo-section">
          <h2>üìä Character Stats</h2>

          <div class="hp-display">
            <strong>Hit Points</strong>
            <div class="hp-bar">
              <div class="hp-fill" id="hpFill" style="width: 85%"></div>
              <div class="hp-text" id="hpText">58 / 68</div>
            </div>
          </div>

          <div class="stats-grid">
            <div class="stat-block">
              <div class="stat-name">STR</div>
              <div class="stat-value" id="strValue">12</div>
              <div class="stat-modifier" id="strMod">+1</div>
            </div>
            <div class="stat-block">
              <div class="stat-name">DEX</div>
              <div class="stat-value" id="dexValue">18</div>
              <div class="stat-modifier" id="dexMod">+4</div>
            </div>
            <div class="stat-block">
              <div class="stat-name">CON</div>
              <div class="stat-value" id="conValue">14</div>
              <div class="stat-modifier" id="conMod">+2</div>
            </div>
            <div class="stat-block">
              <div class="stat-name">INT</div>
              <div class="stat-value" id="intValue">13</div>
              <div class="stat-modifier" id="intMod">+1</div>
            </div>
            <div class="stat-block">
              <div class="stat-name">WIS</div>
              <div class="stat-value" id="wisValue">16</div>
              <div class="stat-modifier" id="wisMod">+3</div>
            </div>
            <div class="stat-block">
              <div class="stat-name">CHA</div>
              <div class="stat-value" id="chaValue">10</div>
              <div class="stat-modifier" id="chaMod">+0</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
            <div style="padding: 10px; background: var(--background-color); border-radius: 6px; text-align: center;">
              <div style="font-size: 0.8rem; color: var(--text-secondary);">AC</div>
              <div style="font-size: 1.5rem; font-weight: 900;" id="acValue">16</div>
            </div>
            <div style="padding: 10px; background: var(--background-color); border-radius: 6px; text-align: center;">
              <div style="font-size: 0.8rem; color: var(--text-secondary);">Initiative</div>
              <div style="font-size: 1.5rem; font-weight: 900; color: var(--accent-color);" id="initValue">+4</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div>
        <!-- Chat Interface -->
        <div class="demo-section">
          <h2>üí¨ Enhanced Chat Interface</h2>

          <div class="chat-modes">
            <button class="mode-btn active" onclick="switchChatMode('conversation')">üí¨ Conversation</button>
            <button class="mode-btn" onclick="switchChatMode('battle')">‚öîÔ∏è Battle</button>
            <button class="mode-btn" onclick="switchChatMode('skills')">üéØ Skills</button>
          </div>

          <!-- Conversation Mode -->
          <div id="conversationMode">
            <div class="state-selector">
              <label style="color: var(--text-secondary); font-weight: 600;">State:</label>
              <select id="characterState" onchange="changeCharacterState()">
                <option value="default">Default (Calm)</option>
                <option value="battle">Battle (Focused)</option>
                <option value="injured">Injured (Pained)</option>
                <option value="angry">Angry (Furious)</option>
                <option value="triumphant">Triumphant (Joyful)</option>
              </select>
            </div>

            <div class="messages-area" id="messagesArea">
              <div class="message">
                <div class="message-avatar">üèπ</div>
                <div class="message-content">
                  <div class="message-header" id="characterNameHeader">Aelindra</div>
                  <div class="message-text" id="greetingMessage">
                    You find me studying tracks in the forest. The creatures here have been acting strangely...
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 10px;">
              <input
                type="text"
                id="messageInput"
                placeholder="Type a message..."
                style="flex: 1; padding: 12px; background: var(--background-color); border: 2px solid var(--border-color); border-radius: 8px; color: var(--text-primary);"
                onkeypress="if(event.key === 'Enter') sendMessage()"
              >
              <button class="test-btn" onclick="sendMessage()">Send</button>
            </div>
          </div>

          <!-- Battle Mode -->
          <div id="battleMode" style="display: none;">
            <div class="turn-tracker">
              <div class="turn-info">
                <div>
                  <strong style="color: var(--text-secondary); font-size: 0.85rem;">Turn</strong>
                  <div class="turn-number" id="turnNumber">1</div>
                </div>
                <div style="border-left: 2px solid var(--border-color); padding-left: 15px; margin-left: 15px;">
                  <div style="font-size: 0.75rem; color: var(--text-secondary);">Current</div>
                  <div style="font-weight: 600; color: var(--text-primary);" id="currentTurn">Your Turn</div>
                </div>
              </div>
              <div class="turn-controls">
                <button onclick="nextTurn()">Next Turn ‚û§</button>
              </div>
            </div>

            <div style="margin-bottom: 15px;">
              <strong style="color: var(--text-primary);">Quick Actions</strong>
            </div>

            <div class="battle-actions">
              <button class="action-btn" onclick="rollAttack()">‚öîÔ∏è Attack</button>
              <button class="action-btn" onclick="rollDice('Initiative', 'd20')">üé≤ Initiative</button>
              <button class="action-btn" onclick="rollDice('Save', 'd20')">üõ°Ô∏è Save</button>
              <button class="action-btn" onclick="quickAction('dash')">üèÉ Dash</button>
              <button class="action-btn" onclick="quickAction('dodge')">üí® Dodge</button>
              <button class="action-btn" onclick="quickAction('help')">ü§ù Help</button>
            </div>

            <div style="margin: 20px 0;">
              <strong style="color: var(--text-primary);">Abilities</strong>
            </div>

            <div class="abilities-grid" id="abilitiesGrid">
              <!-- Will be populated dynamically -->
            </div>
          </div>

          <!-- Skills Mode -->
          <div id="skillsMode" style="display: none;">
            <div style="padding: 15px; background: var(--background-color); border-radius: 8px; margin-bottom: 15px;">
              <strong style="color: var(--text-primary); margin-bottom: 10px; display: block;">D&D 5e Skill Checks</strong>
              <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                Click any skill to roll a check. Modifiers are automatically calculated based on your character's stats and proficiencies.
              </p>
            </div>

            <div class="skills-section">
              <h3>üß† Intelligence Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Arcana', 'int')">
                  <span class="skill-emoji">üîÆ</span>
                  <div class="skill-name">Arcana</div>
                  <div class="skill-modifier" id="skill-arcana">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('History', 'int')">
                  <span class="skill-emoji">üìú</span>
                  <div class="skill-name">History</div>
                  <div class="skill-modifier" id="skill-history">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Investigation', 'int')">
                  <span class="skill-emoji">üîç</span>
                  <div class="skill-name">Investigation</div>
                  <div class="skill-modifier" id="skill-investigation">+4</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Nature', 'int')">
                  <span class="skill-emoji">üåø</span>
                  <div class="skill-name">Nature</div>
                  <div class="skill-modifier" id="skill-nature">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Religion', 'int')">
                  <span class="skill-emoji">‚õ™</span>
                  <div class="skill-name">Religion</div>
                  <div class="skill-modifier" id="skill-religion">+1</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üëÅÔ∏è Wisdom Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Animal Handling', 'wis')">
                  <span class="skill-emoji">üê∫</span>
                  <div class="skill-name">Animal Handling</div>
                  <div class="skill-modifier" id="skill-animal">+6</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Insight', 'wis')">
                  <span class="skill-emoji">üí≠</span>
                  <div class="skill-name">Insight</div>
                  <div class="skill-modifier" id="skill-insight">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Medicine', 'wis')">
                  <span class="skill-emoji">‚öïÔ∏è</span>
                  <div class="skill-name">Medicine</div>
                  <div class="skill-modifier" id="skill-medicine">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Perception', 'wis')">
                  <span class="skill-emoji">üëÅÔ∏è</span>
                  <div class="skill-name">Perception</div>
                  <div class="skill-modifier" id="skill-perception">+6</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Survival', 'wis')">
                  <span class="skill-emoji">üèïÔ∏è</span>
                  <div class="skill-name">Survival</div>
                  <div class="skill-modifier" id="skill-survival">+9</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>‚ú® Charisma Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Deception', 'cha')">
                  <span class="skill-emoji">üé≠</span>
                  <div class="skill-name">Deception</div>
                  <div class="skill-modifier" id="skill-deception">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Intimidation', 'cha')">
                  <span class="skill-emoji">üò†</span>
                  <div class="skill-name">Intimidation</div>
                  <div class="skill-modifier" id="skill-intimidation">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Performance', 'cha')">
                  <span class="skill-emoji">üé™</span>
                  <div class="skill-name">Performance</div>
                  <div class="skill-modifier" id="skill-performance">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Persuasion', 'cha')">
                  <span class="skill-emoji">ü§ù</span>
                  <div class="skill-name">Persuasion</div>
                  <div class="skill-modifier" id="skill-persuasion">+0</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>ü§∏ Dexterity Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Acrobatics', 'dex')">
                  <span class="skill-emoji">ü§∏</span>
                  <div class="skill-name">Acrobatics</div>
                  <div class="skill-modifier" id="skill-acrobatics">+7</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Sleight of Hand', 'dex')">
                  <span class="skill-emoji">üÉè</span>
                  <div class="skill-name">Sleight of Hand</div>
                  <div class="skill-modifier" id="skill-sleight">+4</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Stealth', 'dex')">
                  <span class="skill-emoji">ü•∑</span>
                  <div class="skill-name">Stealth</div>
                  <div class="skill-modifier" id="skill-stealth">+10</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üí™ Strength Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Athletics', 'str')">
                  <span class="skill-emoji">üí™</span>
                  <div class="skill-name">Athletics</div>
                  <div class="skill-modifier" id="skill-athletics">+1</div>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Test Controls -->
    <div class="test-controls">
      <button class="test-btn" onclick="rollRandomDice()">üé≤ Random Roll</button>
      <button class="test-btn" onclick="takeDamage()">üíî Damage</button>
      <button class="test-btn" onclick="heal()">‚ù§Ô∏è Heal</button>
    </div>
  </div>

  <!-- Dice Roll Overlay -->
  <div class="dice-overlay" id="diceOverlay">
    <div class="dice-result" id="diceResult">
      <div class="dice-icon" id="diceIcon">üé≤</div>
      <div class="dice-type" id="diceType">Attack Roll</div>
      <div class="dice-value" id="diceValue">18</div>
      <div class="dice-breakdown" id="diceBreakdown"></div>
    </div>
  </div>

  <script>
    // Character Data with Skills
    const characters = [
      {
        id: 'aelindra',
        name: 'Aelindra Moonwhisper',
        emoji: 'üèπ',
        class: 'Ranger',
        level: 8,
        hp: { current: 58, max: 68 },
        ac: 16,
        stats: { str: 12, dex: 18, con: 14, int: 13, wis: 16, cha: 10 },
        skills: {
          // Format: [ability, proficiency] where proficiency: 0=none, 1=proficient, 2=expertise
          acrobatics: ['dex', 1],
          animalHandling: ['wis', 1],
          arcana: ['int', 0],
          athletics: ['str', 0],
          deception: ['cha', 0],
          history: ['int', 0],
          insight: ['wis', 0],
          intimidation: ['cha', 0],
          investigation: ['int', 1],
          medicine: ['wis', 0],
          nature: ['int', 0],
          perception: ['wis', 1],
          performance: ['cha', 0],
          persuasion: ['cha', 0],
          religion: ['int', 0],
          sleightOfHand: ['dex', 0],
          stealth: ['dex', 2], // Expertise
          survival: ['wis', 2]  // Expertise
        },
        abilities: [
          { id: 'hunters_mark', name: "Hunter's Mark", icon: 'üéØ', damage: '1d6', description: 'Mark a target for extra damage' },
          { id: 'multiattack', name: 'Multiattack', icon: '‚öîÔ∏è', damage: '2d8+4', description: 'Make two attacks' },
          { id: 'cure_wounds', name: 'Cure Wounds', icon: '‚ù§Ô∏è', damage: '1d8+3', description: 'Heal an ally' },
          { id: 'arrow_volley', name: 'Arrow Volley', icon: 'üèπ', damage: '3d8', description: 'Rain arrows on area' }
        ],
        states: {
          default: { mood: 'calm', greeting: 'You find me studying tracks in the forest. The creatures here have been acting strangely...' },
          battle: { mood: 'focused', greeting: 'Enemy sighted! Ready your weapons!' },
          injured: { mood: 'pained', greeting: '*winces* I\'ve seen better days...' },
          angry: { mood: 'furious', greeting: 'Those poachers will pay for what they\'ve done!' },
          triumphant: { mood: 'joyful', greeting: 'We did it! The forest is safe once more!' }
        }
      },
      {
        id: 'theron',
        name: 'Theron Brightshield',
        emoji: 'üõ°Ô∏è',
        class: 'Paladin',
        level: 10,
        hp: { current: 88, max: 104 },
        ac: 18,
        stats: { str: 18, dex: 10, con: 16, int: 10, wis: 14, cha: 16 },
        skills: {
          acrobatics: ['dex', 0],
          animalHandling: ['wis', 0],
          arcana: ['int', 0],
          athletics: ['str', 1],
          deception: ['cha', 0],
          history: ['int', 0],
          insight: ['wis', 1],
          intimidation: ['cha', 1],
          investigation: ['int', 0],
          medicine: ['wis', 1],
          nature: ['int', 0],
          perception: ['wis', 0],
          performance: ['cha', 0],
          persuasion: ['cha', 1],
          religion: ['int', 1],
          sleightOfHand: ['dex', 0],
          stealth: ['dex', 0],
          survival: ['wis', 0]
        },
        abilities: [
          { id: 'divine_smite', name: 'Divine Smite', icon: '‚ö°', damage: '4d8', description: 'Channel divine energy into your strike' },
          { id: 'lay_on_hands', name: 'Lay on Hands', icon: '‚ú®', damage: '50', description: 'Heal with divine touch' },
          { id: 'shield_bash', name: 'Shield Bash', icon: 'üõ°Ô∏è', damage: '1d8+4', description: 'Bash with your shield' },
          { id: 'aura_courage', name: 'Aura of Courage', icon: 'üí™', damage: null, description: 'Grant allies immunity to fear' }
        ],
        states: {
          default: { mood: 'noble', greeting: 'Greetings, friend. How may I serve justice this day?' },
          battle: { mood: 'righteous', greeting: 'By the light, evil shall not prevail!' },
          injured: { mood: 'determined', greeting: 'A mere scratch. I will not fall!' },
          angry: { mood: 'wrathful', greeting: 'You dare commit such atrocities?!' },
          triumphant: { mood: 'blessed', greeting: 'The light has guided us to victory!' }
        }
      },
      {
        id: 'zara',
        name: 'Zara Infernalis',
        emoji: 'üîÆ',
        class: 'Wizard',
        level: 9,
        hp: { current: 42, max: 54 },
        ac: 13,
        stats: { str: 8, dex: 14, con: 13, int: 20, wis: 12, cha: 11 },
        skills: {
          acrobatics: ['dex', 0],
          animalHandling: ['wis', 0],
          arcana: ['int', 2], // Expertise
          athletics: ['str', 0],
          deception: ['cha', 0],
          history: ['int', 1],
          insight: ['wis', 0],
          intimidation: ['cha', 0],
          investigation: ['int', 1],
          medicine: ['wis', 0],
          nature: ['int', 1],
          perception: ['wis', 0],
          performance: ['cha', 0],
          persuasion: ['cha', 0],
          religion: ['int', 1],
          sleightOfHand: ['dex', 0],
          stealth: ['dex', 0],
          survival: ['wis', 0]
        },
        abilities: [
          { id: 'fireball', name: 'Fireball', icon: 'üî•', damage: '8d6', description: 'Devastating explosion of flame' },
          { id: 'counterspell', name: 'Counterspell', icon: 'üö´', damage: null, description: 'Negate enemy spells' },
          { id: 'magic_missile', name: 'Magic Missile', icon: '‚ú®', damage: '3d4+3', description: 'Unerring magical darts' },
          { id: 'lightning_bolt', name: 'Lightning Bolt', icon: '‚ö°', damage: '8d6', description: 'Line of electrical energy' }
        ],
        states: {
          default: { mood: 'curious', greeting: 'Fascinating... the magical energies here are quite unusual.' },
          battle: { mood: 'calculating', greeting: 'Let me show you the true power of the arcane!' },
          injured: { mood: 'weakened', greeting: 'My concentration... slipping...' },
          angry: { mood: 'volatile', greeting: 'You\'ve made a grave mistake interrupting my research!' },
          triumphant: { mood: 'smug', greeting: 'As I predicted, victory was inevitable.' }
        }
      },
      {
        id: 'kael',
        name: 'Kael Quickfingers',
        emoji: 'üó°Ô∏è',
        class: 'Rogue',
        level: 7,
        hp: { current: 38, max: 45 },
        ac: 15,
        stats: { str: 10, dex: 20, con: 12, int: 14, wis: 13, cha: 14 },
        skills: {
          acrobatics: ['dex', 2], // Expertise
          animalHandling: ['wis', 0],
          arcana: ['int', 0],
          athletics: ['str', 0],
          deception: ['cha', 1],
          history: ['int', 0],
          insight: ['wis', 0],
          intimidation: ['cha', 0],
          investigation: ['int', 1],
          medicine: ['wis', 0],
          nature: ['int', 0],
          perception: ['wis', 1],
          performance: ['cha', 0],
          persuasion: ['cha', 1],
          religion: ['int', 0],
          sleightOfHand: ['dex', 2], // Expertise
          stealth: ['dex', 2], // Expertise
          survival: ['wis', 0]
        },
        abilities: [
          { id: 'sneak_attack', name: 'Sneak Attack', icon: 'üó°Ô∏è', damage: '4d6', description: 'Strike from the shadows' },
          { id: 'cunning_action', name: 'Cunning Action', icon: 'üí®', damage: null, description: 'Bonus action dash/disengage/hide' },
          { id: 'evasion', name: 'Evasion', icon: 'ü§∏', damage: null, description: 'Dodge area effects' },
          { id: 'thieves_tools', name: "Thieves' Tools", icon: 'üîì', damage: null, description: 'Pick locks and disable traps' }
        ],
        states: {
          default: { mood: 'sly', greeting: '*leaning casually* Well, well, what brings you to this part of town?' },
          battle: { mood: 'focused', greeting: 'Time to disappear... *fades into shadows*' },
          injured: { mood: 'grimacing', greeting: '*clutching side* Not my best day...' },
          angry: { mood: 'vengeful', greeting: 'You\'ll regret double-crossing me!' },
          triumphant: { mood: 'cocky', greeting: '*twirling dagger* Too easy. What\'s next?' }
        }
      }
    ];

    let currentCharacter = characters[0];
    let currentImageTab = 'portrait';
    let currentPortraitType = 'standard';
    let currentChatMode = 'conversation';
    let currentState = 'default';
    let turnNumber = 1;

    // Initialize
    updateCharacterDisplay();
    populateCharacterMenu();

    function populateCharacterMenu() {
      const list = document.getElementById('characterList');
      list.innerHTML = characters.map((char, index) => `
        <div class="character-item ${index === 0 ? 'active' : ''}" onclick="selectCharacterFromMenu(${index})">
          <div class="character-item-header">
            <div class="character-item-emoji">${char.emoji}</div>
            <div class="character-item-info">
              <div class="character-item-name">${char.name}</div>
              <div class="character-item-class">${char.class} ${char.level}</div>
            </div>
          </div>
          <div class="character-item-stats">
            <span>HP: ${char.hp.current}/${char.hp.max}</span>
            <span>AC: ${char.ac}</span>
          </div>
        </div>
      `).join('');
    }

    function toggleMenu() {
      const menu = document.getElementById('characterMenu');
      const overlay = document.getElementById('menuOverlay');
      menu.classList.toggle('open');
      overlay.classList.toggle('show');
    }

    function closeMenu() {
      const menu = document.getElementById('characterMenu');
      const overlay = document.getElementById('menuOverlay');
      menu.classList.remove('open');
      overlay.classList.remove('show');
    }

    function selectCharacterFromMenu(index) {
      // Update menu active state
      document.querySelectorAll('.character-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
      });

      currentCharacter = characters[index];
      currentState = 'default';
      turnNumber = 1;
      updateCharacterDisplay();
      updateMessages();
      closeMenu();
    }

    function updateCharacterDisplay() {
      // Update header
      document.getElementById('currentCharEmoji').textContent = currentCharacter.emoji;
      document.getElementById('currentCharName').textContent = currentCharacter.name;
      document.getElementById('characterEmoji').textContent = currentCharacter.emoji;
      document.getElementById('characterNameHeader').textContent = currentCharacter.name;

      // Update stats
      const stats = currentCharacter.stats;
      ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(stat => {
        const value = stats[stat];
        const modifier = Math.floor((value - 10) / 2);
        document.getElementById(stat + 'Value').textContent = value;
        document.getElementById(stat + 'Mod').textContent = (modifier >= 0 ? '+' : '') + modifier;
      });

      // Update HP
      const hpPercent = (currentCharacter.hp.current / currentCharacter.hp.max) * 100;
      document.getElementById('hpFill').style.width = hpPercent + '%';
      document.getElementById('hpText').textContent = `${currentCharacter.hp.current} / ${currentCharacter.hp.max}`;

      // Update AC
      document.getElementById('acValue').textContent = currentCharacter.ac;

      // Update Initiative
      const dexMod = Math.floor((stats.dex - 10) / 2);
      document.getElementById('initValue').textContent = (dexMod >= 0 ? '+' : '') + dexMod;

      // Update abilities
      updateAbilities();

      // Update skills
      updateSkills();

      // Update turn tracker
      document.getElementById('turnNumber').textContent = turnNumber;
    }

    function updateAbilities() {
      const abilitiesGrid = document.getElementById('abilitiesGrid');
      let html = '';

      currentCharacter.abilities.forEach(ability => {
        html += `
          <div class="ability-card" onclick="useAbility('${ability.id}')">
            <div class="ability-header">
              <div class="ability-icon">${ability.icon}</div>
              <div class="ability-info">
                <div class="ability-name">${ability.name}</div>
                ${ability.damage ? `<div class="ability-damage">${ability.damage}</div>` : ''}
              </div>
            </div>
            <div class="ability-description">${ability.description}</div>
          </div>
        `;
      });

      abilitiesGrid.innerHTML = html;
    }

    function updateSkills() {
      const profBonus = 2 + Math.floor((currentCharacter.level - 1) / 4);

      Object.entries(currentCharacter.skills).forEach(([skillName, [ability, proficiency]]) => {
        const abilityMod = Math.floor((currentCharacter.stats[ability] - 10) / 2);
        const profMod = proficiency * profBonus;
        const total = abilityMod + profMod;

        const skillId = 'skill-' + skillName.toLowerCase().replace(/\s+/g, '');
        const element = document.getElementById(skillId);
        if (element) {
          element.textContent = (total >= 0 ? '+' : '') + total;
        }
      });
    }

    function switchImageTab(tab) {
      currentImageTab = tab;
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      const placeholder = document.querySelector('.image-placeholder p');
      if (tab === 'portrait') {
        placeholder.textContent = 'AI-Generated Portrait';
      } else if (tab === 'battle') {
        placeholder.textContent = 'Battle Pose';
      } else if (tab === 'canvas') {
        placeholder.textContent = 'Scene/Environment';
      }
    }

    function switchPortraitType(type) {
      currentPortraitType = type;
      document.querySelectorAll('.portrait-type-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      const subtitle = document.querySelector('.image-placeholder small');
      subtitle.textContent = type + ' portrait type';
    }

    function switchChatMode(mode) {
      currentChatMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Show/hide appropriate sections
      document.getElementById('conversationMode').style.display = mode === 'conversation' ? 'block' : 'none';
      document.getElementById('battleMode').style.display = mode === 'battle' ? 'block' : 'none';
      document.getElementById('skillsMode').style.display = mode === 'skills' ? 'block' : 'none';
    }

    function changeCharacterState() {
      currentState = document.getElementById('characterState').value;
      updateMessages();
    }

    function updateMessages() {
      const stateConfig = currentCharacter.states[currentState];
      document.getElementById('greetingMessage').textContent = stateConfig.greeting;
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (!message) return;

      const messagesArea = document.getElementById('messagesArea');

      // Add player message
      messagesArea.innerHTML += `
        <div class="message player">
          <div class="message-avatar">üë§</div>
          <div class="message-content">
            <div class="message-text">${message}</div>
          </div>
        </div>
      `;

      input.value = '';

      // Simulate character response
      setTimeout(() => {
        const responses = [
          "That's an interesting point. Tell me more.",
          "I understand your concern. Let me think about this...",
          "Fascinating. I hadn't considered that perspective.",
          "We should proceed carefully. What do you suggest?",
          "Your wisdom is valuable. Together we can solve this."
        ];
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];

        messagesArea.innerHTML += `
          <div class="message">
            <div class="message-avatar">${currentCharacter.emoji}</div>
            <div class="message-content">
              <div class="message-header">${currentCharacter.name}</div>
              <div class="message-text">${randomResponse}</div>
            </div>
          </div>
        `;

        messagesArea.scrollTop = messagesArea.scrollHeight;
      }, 800);

      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function addBattleLog(message) {
      // If in conversation mode, don't add to messages
      if (currentChatMode === 'conversation') return;

      const messagesArea = document.getElementById('messagesArea');
      messagesArea.innerHTML += `
        <div class="message system">
          <div class="message-avatar">‚öîÔ∏è</div>
          <div class="message-content">
            <div class="message-text">${message}</div>
          </div>
        </div>
      `;
      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function rollAttack() {
      // Auto-switch to battle mode
      if (currentChatMode !== 'battle') {
        switchChatMode('battle');
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.mode-btn')[1].classList.add('active'); // Battle tab
        document.getElementById('conversationMode').style.display = 'none';
        document.getElementById('battleMode').style.display = 'block';
        document.getElementById('skillsMode').style.display = 'none';
      }

      rollDice('Attack', 'd20', Math.floor((currentCharacter.stats.dex - 10) / 2));
    }

    function rollDice(type, dice, modifier = 0) {
      const sides = parseInt(dice.substring(1));
      const roll = Math.floor(Math.random() * sides) + 1;
      const total = roll + modifier;
      const breakdown = modifier !== 0 ? `1${dice}${modifier >= 0 ? '+' : ''}${modifier}` : `1${dice}`;
      const isCritical = sides === 20 && (roll === 20 || roll === 1);

      showDiceRoll(type, dice, roll, total, breakdown, roll === 20 ? 'success' : (roll === 1 ? 'fail' : null));

      // Add to battle log
      if (currentChatMode === 'battle') {
        addBattleLog(`${currentCharacter.name} rolled ${type}: ${total} (${breakdown})`);
      }
    }

    function showDiceRoll(type, diceType, baseRoll, total, breakdown, critical) {
      const overlay = document.getElementById('diceOverlay');
      const result = document.getElementById('diceResult');
      const icon = document.getElementById('diceIcon');
      const typeEl = document.getElementById('diceType');
      const valueEl = document.getElementById('diceValue');
      const breakdownEl = document.getElementById('diceBreakdown');

      icon.textContent = 'üé≤';
      typeEl.textContent = type;
      valueEl.textContent = total;
      breakdownEl.textContent = breakdown;

      // Apply critical styling
      result.className = 'dice-result';
      if (critical === 'success') {
        result.classList.add('critical-success');
      } else if (critical === 'fail') {
        result.classList.add('critical-fail');
      }

      overlay.classList.add('show');

      setTimeout(() => {
        overlay.classList.remove('show');
      }, 2800);
    }

    function rollSkill(skillName, ability) {
      const skillKey = skillName.toLowerCase().replace(/\s+/g, '');
      const [, proficiency] = currentCharacter.skills[skillKey] || [ability, 0];

      const abilityMod = Math.floor((currentCharacter.stats[ability] - 10) / 2);
      const profBonus = 2 + Math.floor((currentCharacter.level - 1) / 4);
      const modifier = abilityMod + (proficiency * profBonus);

      const roll = Math.floor(Math.random() * 20) + 1;
      const total = roll + modifier;
      const breakdown = `1d20${modifier >= 0 ? '+' : ''}${modifier}`;

      showDiceRoll(skillName, 'd20', roll, total, breakdown, roll === 20 ? 'success' : (roll === 1 ? 'fail' : null));

      // Add to battle log if in battle
      if (currentChatMode === 'battle') {
        addBattleLog(`${currentCharacter.name} rolled ${skillName}: ${total}`);
      }
    }

    function rollRandomDice() {
      const types = ['Attack Roll', 'Saving Throw', 'Ability Check', 'Damage Roll'];
      const type = types[Math.floor(Math.random() * types.length)];
      const modifier = Math.floor(Math.random() * 6);
      rollDice(type, 'd20', modifier);
    }

    function useAbility(abilityId) {
      const ability = currentCharacter.abilities.find(a => a.id === abilityId);
      if (!ability) return;

      // Add to battle log
      addBattleLog(`${currentCharacter.name} uses ${ability.icon} ${ability.name}!`);

      // Roll dice if ability has damage
      if (ability.damage) {
        setTimeout(() => {
          // Parse damage (e.g., "4d6", "2d8+4")
          const match = ability.damage.match(/(\d+)d(\d+)([+-]\d+)?/);
          if (match) {
            const count = parseInt(match[1]);
            const sides = parseInt(match[2]);
            const modifier = match[3] ? parseInt(match[3]) : 0;

            let total = modifier;
            for (let i = 0; i < count; i++) {
              total += Math.floor(Math.random() * sides) + 1;
            }

            const breakdown = `${count}d${sides}${modifier >= 0 && modifier !== 0 ? '+' : ''}${modifier !== 0 ? modifier : ''}`;
            showDiceRoll(ability.name, `d${sides}`, 0, total, breakdown, null);

            addBattleLog(`Damage: ${total} (${breakdown})`);
          }
        }, 500);
      }
    }

    function quickAction(action) {
      const messages = {
        dash: `${currentCharacter.name} dashes forward!`,
        dodge: `${currentCharacter.name} takes the Dodge action.`,
        help: `${currentCharacter.name} helps an ally!`
      };

      addBattleLog(messages[action] || 'Action performed!');
    }

    function nextTurn() {
      turnNumber++;
      document.getElementById('turnNumber').textContent = turnNumber;
      addBattleLog(`--- Turn ${turnNumber} ---`);
    }

    function takeDamage() {
      const damage = Math.floor(Math.random() * 15) + 5;
      currentCharacter.hp.current = Math.max(0, currentCharacter.hp.current - damage);
      updateCharacterDisplay();
      showDiceRoll('Damage Taken', 'd20', 0, damage, `${damage} damage`, null);
      addBattleLog(`${currentCharacter.name} takes ${damage} damage!`);
    }

    function heal() {
      const healing = Math.floor(Math.random() * 20) + 10;
      currentCharacter.hp.current = Math.min(currentCharacter.hp.max, currentCharacter.hp.current + healing);
      updateCharacterDisplay();
      showDiceRoll('Healing', 'd20', 0, healing, `${healing} HP`, null);
      addBattleLog(`${currentCharacter.name} heals ${healing} HP!`);
    }
  </script>
</body>
</html>
