<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Features Test - Character Foundry</title>
  <style>
    :root {
      --surface-color: #1a1a1a;
      --background-color: #0f0f0f;
      --border-color: #333;
      --accent-color: #4a90e2;
      --accent-hover: #357abd;
      --text-primary: #fff;
      --text-secondary: #888;
      --hover-color: #252525;
      --battle-color: #e74c3c;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--background-color);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
    }

    .test-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header with Hamburger */
    .test-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 40px;
      padding: 20px 30px;
      background: var(--surface-color);
      border-radius: 12px;
      border: 2px solid var(--border-color);
      position: relative;
    }

    .hamburger-btn {
      width: 40px;
      height: 40px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .hamburger-btn:hover {
      border-color: var(--accent-color);
      background: var(--hover-color);
    }

    .hamburger-btn span {
      width: 20px;
      height: 2.5px;
      background: var(--text-primary);
      border-radius: 2px;
      transition: all 0.2s ease;
    }

    .header-content {
      flex: 1;
      text-align: center;
    }

    .header-center {
      flex: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* Header HP Bar */
    .header-hp-bar {
      width: 120px;
      margin-top: 8px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
      height: 24px;
    }

    .header-hp-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
      transition: width 0.3s ease;
      position: absolute;
      top: 0;
      left: 0;
    }

    .header-hp-fill.high {
      background: linear-gradient(90deg, #27ae60 0%, #229954 100%);
    }

    .header-hp-fill.medium {
      background: linear-gradient(90deg, #f39c12 0%, #d68910 100%);
    }

    .header-hp-text {
      position: relative;
      z-index: 2;
      font-size: 0.75rem;
      font-weight: 700;
      text-align: center;
      line-height: 24px;
      color: var(--text-primary);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      cursor: pointer;
    }

    .header-hp-text:hover {
      color: var(--accent-color);
    }

    .header-ac {
      margin-top: 4px;
      font-size: 0.7rem;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .header-ac:hover {
      color: var(--accent-color);
    }

    .header-content h1 {
      font-size: 2rem;
      margin-bottom: 5px;
      color: var(--accent-color);
    }

    .current-character {
      font-size: 1.2rem;
      color: var(--text-secondary);
    }

    .current-character-emoji {
      font-size: 1.5rem;
      margin-right: 8px;
    }

    /* Character Menu Overlay */
    .character-menu {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100vh;
      background: var(--surface-color);
      border-right: 2px solid var(--border-color);
      z-index: 9999;
      transition: left 0.3s ease;
      overflow-y: auto;
      box-shadow: 2px 0 20px rgba(0, 0, 0, 0.5);
    }

    .character-menu.open {
      left: 0;
    }

    .menu-header {
      padding: 20px;
      background: var(--background-color);
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .menu-header h3 {
      color: var(--accent-color);
    }

    .close-menu-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 1.2rem;
    }

    .character-list {
      padding: 10px;
    }

    .character-item {
      padding: 15px;
      margin-bottom: 10px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .character-item:hover {
      border-color: var(--accent-color);
      transform: translateX(5px);
    }

    .character-item.active {
      background: var(--accent-color);
      border-color: var(--accent-color);
    }

    .character-item-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .character-item-emoji {
      font-size: 2rem;
    }

    .character-item-info {
      flex: 1;
    }

    .character-item-name {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 3px;
    }

    .character-item-class {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .character-item.active .character-item-class {
      color: rgba(255, 255, 255, 0.8);
    }

    .character-item-stats {
      display: flex;
      gap: 15px;
      font-size: 0.85rem;
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }

    .character-item.active .character-item-stats {
      border-top-color: rgba(255, 255, 255, 0.3);
    }

    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9998;
      display: none;
    }

    .menu-overlay.show {
      display: block;
    }

    .demo-layout {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .demo-section {
      background: var(--surface-color);
      border-radius: 12px;
      padding: 20px;
      border: 2px solid var(--border-color);
    }

    .demo-section h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: var(--accent-color);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
    }

    /* Image Tabs */
    .image-tabs-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
    }

    .tab-button {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }

    .tab-button:hover {
      background: var(--hover-color);
      color: var(--text-primary);
    }

    .tab-button.active {
      background: var(--accent-color);
      color: white;
    }

    .image-display {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      background: var(--background-color);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .image-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
    }

    .placeholder-emoji {
      font-size: 4rem;
      margin-bottom: 10px;
      opacity: 0.3;
    }

    .portrait-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .canvas-display {
      position: relative;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
    }

    .character-overlay {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid var(--accent-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
      overflow: hidden;
      background: var(--background-color);
    }

    .character-overlay img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .location-name {
      position: absolute;
      top: 15px;
      left: 15px;
      padding: 8px 16px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 20px;
      font-size: 0.9rem;
      color: white;
      backdrop-filter: blur(10px);
    }

    .editable-stat {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .editable-stat:hover {
      background: var(--hover-color);
      outline: 1px solid var(--accent-color);
    }

    /* Portrait Types - Removed for cleaner mobile UI */
    .portrait-types {
      display: none;
    }

    .portrait-type-btn {
      display: none;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-block {
      padding: 15px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      text-align: center;
    }

    .stat-name {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--text-primary);
    }

    .stat-modifier {
      font-size: 0.9rem;
      color: var(--accent-color);
      font-weight: 700;
    }

    .hp-display {
      margin-bottom: 15px;
      padding: 15px;
      background: var(--background-color);
      border-radius: 8px;
    }

    .hp-bar {
      position: relative;
      height: 30px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 15px;
      border: 2px solid var(--border-color);
      overflow: hidden;
      margin-top: 10px;
    }

    .hp-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, #e74c3c, #c0392b);
      transition: width 0.3s ease;
    }

    .hp-text {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: white;
      font-weight: bold;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    }

    /* Chat Modes */
    .chat-modes {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
    }

    .mode-btn {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .mode-btn:hover {
      background: var(--hover-color);
      color: var(--text-primary);
    }

    .mode-btn.active {
      background: var(--accent-color);
      color: white;
    }

    /* Stat Tabs */
    .stat-tab-btn {
      flex: 1;
      padding: 10px 15px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s ease;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .stat-tab-btn:hover {
      background: var(--hover-color);
      color: var(--text-primary);
    }

    .stat-tab-btn.active {
      background: var(--accent-color);
      color: white;
    }

    /* Turn Tracker */
    .turn-tracker {
      margin-bottom: 15px;
      padding: 12px;
      background: var(--background-color);
      border: 2px solid var(--battle-color);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .turn-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .turn-number {
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--battle-color);
    }

    .turn-controls button {
      padding: 8px 16px;
      background: var(--battle-color);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .turn-controls button:hover {
      opacity: 0.8;
    }

    /* State Selector */
    .state-selector {
      margin-bottom: 15px;
      padding: 12px;
      background: var(--background-color);
      border-radius: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .state-selector select {
      flex: 1;
      padding: 8px;
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    /* Messages */
    .messages-area {
      height: 350px;
      overflow-y: auto;
      padding: 15px;
      background: var(--background-color);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .message {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.player {
      flex-direction: row-reverse;
    }

    .message.system {
      justify-content: center;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .message.system .message-avatar {
      background: var(--battle-color);
    }

    .message-content {
      flex: 1;
      padding: 12px;
      background: var(--surface-color);
      border-radius: 12px;
      max-width: 70%;
    }

    .message.player .message-content {
      background: var(--accent-color);
    }

    .message.system .message-content {
      background: rgba(231, 76, 60, 0.2);
      border: 2px solid var(--battle-color);
      max-width: 90%;
      text-align: center;
    }

    .message-header {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--accent-color);
    }

    .message.player .message-header {
      color: rgba(255, 255, 255, 0.9);
    }

    .message-text {
      line-height: 1.5;
    }

    /* Battle Actions */
    .battle-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .action-btn {
      padding: 12px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .action-btn:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
    }

    /* Abilities */
    .abilities-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .ability-card {
      padding: 15px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ability-card:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
    }

    .ability-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .ability-icon {
      font-size: 2rem;
    }

    .ability-info {
      flex: 1;
    }

    .ability-name {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .ability-damage {
      font-size: 0.85rem;
      color: var(--accent-color);
      font-weight: 700;
    }

    .ability-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* Skills Grid */
    .skills-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    .skill-btn {
      padding: 12px 8px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .skill-btn:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .skill-emoji {
      font-size: 1.8rem;
      display: block;
      margin-bottom: 5px;
    }

    .skill-name {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .skill-modifier {
      font-size: 0.7rem;
      color: var(--accent-color);
      font-weight: 700;
    }

    .skills-section {
      margin-bottom: 20px;
    }

    .skills-section h3 {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    /* Spells */
    .spell-level-section {
      margin-bottom: 20px;
    }

    .spell-level-header {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .spell-card {
      padding: 12px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .spell-card.prepared {
      opacity: 1;
      border-color: var(--accent-color);
    }

    .spell-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    .spell-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .spell-icon {
      font-size: 1.5rem;
    }

    .spell-info {
      flex: 1;
    }

    .spell-name {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .spell-damage {
      font-size: 0.75rem;
      color: var(--battle-color);
      font-weight: 700;
    }

    .spell-description {
      font-size: 0.8rem;
      color: var(--text-secondary);
      line-height: 1.3;
    }

    .prepared-indicator {
      padding: 3px 8px;
      background: var(--accent-color);
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      color: white;
    }

    /* Inventory */
    .inventory-category {
      margin-bottom: 20px;
    }

    .inventory-category-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    .inventory-item {
      padding: 12px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
    }

    .inventory-item.equipped {
      border-color: var(--accent-color);
      background: rgba(74, 144, 226, 0.1);
    }

    .inventory-item:hover {
      border-color: var(--accent-color);
      transform: translateY(-1px);
    }

    .inventory-item.consumable-item:hover {
      background: rgba(46, 204, 113, 0.1);
      border-color: #2ecc71;
      cursor: pointer;
    }

    .inventory-item.consumable-item:active {
      transform: scale(0.98);
    }

    .inventory-item-info {
      flex: 1;
    }

    .inventory-item-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .inventory-item-type {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: capitalize;
    }

    .inventory-item-quantity {
      padding: 4px 10px;
      background: var(--surface-color);
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .equipped-badge {
      padding: 3px 8px;
      background: var(--accent-color);
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      color: white;
    }

    /* Dice Overlay */
    .dice-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      display: none;
    }

    .dice-overlay.show {
      display: block;
      animation: diceEnter 0.5s ease-out;
    }

    @keyframes diceEnter {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5) rotate(-180deg);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
      }
    }

    .dice-result {
      padding: 30px 40px;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(26, 26, 26, 0.95));
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), 0 0 20px rgba(74, 144, 226, 0.3);
      text-align: center;
      backdrop-filter: blur(10px);
      min-width: 200px;
    }

    .dice-icon {
      font-size: 3rem;
      margin-bottom: 10px;
      animation: diceRoll 0.5s ease-out;
    }

    @keyframes diceRoll {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(90deg); }
      50% { transform: rotate(180deg); }
      75% { transform: rotate(270deg); }
    }

    .dice-type {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    .dice-value {
      font-size: 3.5rem;
      font-weight: 900;
      text-shadow: 0 2px 10px currentColor;
      animation: resultPulse 0.5s ease-out;
      line-height: 1;
      margin-bottom: 8px;
    }

    .dice-breakdown {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-family: 'Courier New', monospace;
      margin-top: 8px;
    }

    @keyframes resultPulse {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }

    .dice-result.critical-success {
      border-color: #2ecc71;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(46, 204, 113, 0.6);
    }

    .dice-result.critical-success .dice-value {
      color: #2ecc71;
    }

    .dice-result.critical-fail {
      border-color: #e74c3c;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(231, 76, 60, 0.6);
      animation: criticalFailShake 0.5s ease-out;
    }

    .dice-result.critical-fail .dice-value {
      color: #e74c3c;
    }

    @keyframes criticalFailShake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* Floating Action Button */
    .fab-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 65px;
      height: 65px;
      background: var(--accent-color);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      transition: all 0.3s ease;
      z-index: 999;
    }

    .fab-btn:hover {
      background: var(--accent-hover);
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    }

    .fab-btn:active {
      transform: scale(0.95);
    }

    /* Dice Popup */
    .dice-popup {
      position: fixed;
      bottom: 110px;
      right: 30px;
      width: 350px;
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 998;
      display: none;
      animation: popupSlideIn 0.3s ease-out;
    }

    .dice-popup.show {
      display: block;
    }

    @keyframes popupSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dice-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 2px solid var(--border-color);
    }

    .dice-popup-header h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .close-popup-btn {
      width: 30px;
      height: 30px;
      background: var(--background-color);
      border: 2px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .close-popup-btn:hover {
      border-color: var(--accent-color);
      background: var(--hover-color);
    }

    .dice-popup-content {
      padding: 20px;
    }

    .test-btn {
      padding: 10px 20px;
      background: var(--accent-color);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    .test-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }

    @media (max-width: 1200px) {
      .demo-layout {
        display: flex;
        flex-direction: column;
      }

      /* Mobile order: Chat (1), Stats (2) */
      .section-chat { order: 1; }
      .section-stats { order: 2; }
    }

    @media (max-width: 768px) {
      /* Shrink portrait images for mobile */
      .image-display {
        aspect-ratio: auto;
        height: 200px;
        max-height: 200px;
      }

      .image-placeholder {
        height: 200px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .battle-actions {
        grid-template-columns: repeat(2, 1fr);
      }

      .skills-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .test-controls {
        bottom: 10px;
        right: 10px;
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="test-container">
    <!-- Header with Hamburger -->
    <div class="test-header">
      <!-- Portrait Upper Left with HP Bar -->
      <div style="display: flex; flex-direction: column; align-items: center; flex-shrink: 0;">
        <div class="header-portrait" style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid var(--accent-color);">
          <div id="headerPortrait" style="width: 100%; height: 100%; background: var(--background-color); display: flex; align-items: center; justify-content: center; font-size: 3.5rem;">
            üèπ
          </div>
        </div>

        <!-- HP Bar beneath portrait -->
        <div class="header-hp-bar">
          <div id="headerHpFill" class="header-hp-fill high" style="width: 100%;"></div>
          <div id="headerHpText" class="header-hp-text stat-readonly" data-stat="hpCurrent" onclick="!statsLocked && editHeaderHP()">85/85</div>
        </div>

        <!-- AC beneath HP bar -->
        <div id="headerAc" class="header-ac stat-readonly" data-stat="ac" onclick="!statsLocked && editStat('ac', this)">AC 16</div>
      </div>

      <div class="header-center" style="flex: 1; margin-left: 20px;">
        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 3px;">Character Foundry</div>
        <h2 style="font-size: 1.5rem; margin: 0; color: var(--text-primary);">
          <span id="currentCharName">Aelindra Moonwhisper</span>
        </h2>
        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;" id="characterDetails">
          <span id="charAlignment">Neutral Good</span> ‚Ä¢
          Level <span id="charLevel">8</span>
          <span id="charRace">Half-Elf</span>
          <span id="charClass">Ranger</span>
        </div>
      </div>

      <!-- Hamburger Upper Right -->
      <button class="hamburger-btn" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <!-- Character Menu -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
    <div class="character-menu" id="characterMenu">
      <div class="menu-header">
        <h3>Characters</h3>
        <button class="close-menu-btn" onclick="closeMenu()">‚úï</button>
      </div>
      <div class="character-list" id="characterList">
        <!-- Will be populated by JS -->
      </div>
    </div>

    <!-- Demo Layout -->
    <div class="demo-layout">
      <!-- Stats/Skills/Inventory Tabbed Container -->
      <div class="section-stats" data-order="3">
        <div class="demo-section">
          <!-- Tabs -->
          <div class="stat-tabs" style="display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid var(--border-color);">
            <button class="stat-tab-btn active" onclick="switchStatTab('stats')" id="statsTabBtn">Stats</button>
            <button class="stat-tab-btn" onclick="switchStatTab('skills')" id="skillsTabBtn">Skills</button>
            <button class="stat-tab-btn" onclick="switchStatTab('abilities')" id="abilitiesTabBtn">Abilities</button>
            <button class="stat-tab-btn" onclick="switchStatTab('inventory')" id="inventoryTabBtn">Inventory</button>
          </div>

          <!-- Stats Tab -->
          <div id="statsTab">
            <!-- Portrait Section -->
            <div style="margin-bottom: 20px;">
              <div style="width: 200px; height: 200px; margin: 0 auto; border-radius: 12px; overflow: hidden; border: 3px solid var(--accent-color); background: var(--background-color); display: flex; align-items: center; justify-content: center; font-size: 4rem;">
                <div id="statsPortrait">üèπ</div>
              </div>
              <select id="portraitExpression" onchange="updatePortraitExpression()" style="width: 200px; margin: 10px auto 0; display: block; padding: 8px; background: var(--surface-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                <option value="normal">Normal</option>
                <option value="happy">Happy</option>
                <option value="sad">Sad</option>
                <option value="angry">Angry</option>
                <option value="hurt">Hurt</option>
                <option value="injured">Injured</option>
                <option value="gravely-injured">Gravely Injured</option>
              </select>
            </div>

            <div class="hp-display">
              <strong>Hit Points</strong>
              <div class="hp-bar">
                <div class="hp-fill" id="hpFill" style="width: 85%"></div>
                <div class="hp-text" id="hpText">58 / 68</div>
              </div>
              <div style="margin-top: 10px; display: flex; gap: 10px; font-size: 0.85rem; color: var(--text-secondary);">
                <span>Current: <span class="stat-readonly" id="hpCurrentEdit">58</span></span>
                <span>Max: <span class="stat-readonly" id="hpMaxEdit">68</span></span>
              </div>
            </div>

            <div class="stats-grid">
              <div class="stat-block">
                <div class="stat-name">STR</div>
                <div class="stat-value stat-readonly" id="strValue" data-stat="str">12</div>
                <div class="stat-modifier stat-readonly" id="strMod">+1</div>
              </div>
              <div class="stat-block">
                <div class="stat-name">DEX</div>
                <div class="stat-value stat-readonly" id="dexValue" data-stat="dex">18</div>
                <div class="stat-modifier stat-readonly" id="dexMod">+4</div>
              </div>
              <div class="stat-block">
                <div class="stat-name">CON</div>
                <div class="stat-value stat-readonly" id="conValue" data-stat="con">14</div>
                <div class="stat-modifier stat-readonly" id="conMod">+2</div>
              </div>
              <div class="stat-block">
                <div class="stat-name">INT</div>
                <div class="stat-value stat-readonly" id="intValue" data-stat="int">13</div>
                <div class="stat-modifier stat-readonly" id="intMod">+1</div>
              </div>
              <div class="stat-block">
                <div class="stat-name">WIS</div>
                <div class="stat-value stat-readonly" id="wisValue" data-stat="wis">16</div>
                <div class="stat-modifier stat-readonly" id="wisMod">+3</div>
              </div>
              <div class="stat-block">
                <div class="stat-name">CHA</div>
                <div class="stat-value stat-readonly" id="chaValue" data-stat="cha">10</div>
                <div class="stat-modifier stat-readonly" id="chaMod">+0</div>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
              <div style="padding: 10px; background: var(--background-color); border-radius: 6px; text-align: center;">
                <div style="font-size: 0.8rem; color: var(--text-secondary);">AC</div>
                <div class="stat-readonly" style="font-size: 1.5rem; font-weight: 900;" id="acValue" data-stat="ac">16</div>
              </div>
              <div style="padding: 10px; background: var(--background-color); border-radius: 6px; text-align: center;">
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Initiative</div>
                <div style="font-size: 1.5rem; font-weight: 900; color: var(--accent-color);" id="initValue">+4</div>
              </div>
            </div>

            <div style="margin-top: 15px; padding: 10px; background: var(--background-color); border-radius: 6px;">
              <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">State</div>
              <select id="characterStateStats" onchange="updateCharacterState()" style="width: 100%; padding: 8px; background: var(--surface-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; cursor: pointer;">
                <option value="normal">Normal</option>
                <option value="paralyzed">Paralyzed</option>
                <option value="poisoned">Poisoned</option>
                <option value="prone">Prone</option>
                <option value="unconscious">Unconscious</option>
              </select>
            </div>

            <div style="margin-top: 15px; padding: 10px; background: var(--background-color); border-radius: 6px;">
              <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">Temporary Modifiers</div>
              <div style="display: grid; grid-template-columns: 1fr 60px; gap: 8px; margin-bottom: 8px;">
                <input type="text" id="tempModName" placeholder="Modifier name (e.g., Bless)" style="padding: 8px; background: var(--surface-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.9rem;">
                <input type="number" id="tempModValue" placeholder="+/-" style="padding: 8px; background: var(--surface-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; text-align: center;">
              </div>
              <button onclick="addTempModifier()" style="width: 100%; padding: 8px; background: var(--accent-color); border: none; border-radius: 6px; color: white; font-size: 0.9rem; cursor: pointer;">Add Modifier</button>
              <div id="tempModifiersList" style="margin-top: 10px;">
                <!-- Temporary modifiers will appear here -->
              </div>
            </div>

            <!-- Edit Button (lower right corner) -->
            <div style="text-align: right; margin-top: 15px;">
              <button id="statsLockBtn" onclick="toggleStatsLock()" style="padding: 6px 12px; background: var(--background-color); border: 2px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; cursor: pointer;">
                <span id="lockText">Edit</span>
              </button>
            </div>
          </div>

          <!-- Skills Tab -->
          <div id="skillsTab" style="display: none;">
            <div class="skills-section">
              <h3>üß† Intelligence Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Arcana', 'int')">
                  <span class="skill-emoji">‚ú®</span>
                  <div class="skill-name">Arcana</div>
                  <div class="skill-modifier" id="skill-arcana">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('History', 'int')">
                  <span class="skill-emoji">üìú</span>
                  <div class="skill-name">History</div>
                  <div class="skill-modifier" id="skill-history">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Investigation', 'int')">
                  <span class="skill-emoji">üîç</span>
                  <div class="skill-name">Investigation</div>
                  <div class="skill-modifier" id="skill-investigation">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Nature', 'int')">
                  <span class="skill-emoji">üåø</span>
                  <div class="skill-name">Nature</div>
                  <div class="skill-modifier" id="skill-nature">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Religion', 'int')">
                  <span class="skill-emoji">‚õ™</span>
                  <div class="skill-name">Religion</div>
                  <div class="skill-modifier" id="skill-religion">+1</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üßò Wisdom Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Animal Handling', 'wis')">
                  <span class="skill-emoji">üê¥</span>
                  <div class="skill-name">Animal Handling</div>
                  <div class="skill-modifier" id="skill-animalhandling">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Insight', 'wis')">
                  <span class="skill-emoji">üëÅÔ∏è</span>
                  <div class="skill-name">Insight</div>
                  <div class="skill-modifier" id="skill-insight">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Medicine', 'wis')">
                  <span class="skill-emoji">‚öïÔ∏è</span>
                  <div class="skill-name">Medicine</div>
                  <div class="skill-modifier" id="skill-medicine">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Perception', 'wis')">
                  <span class="skill-emoji">üëÄ</span>
                  <div class="skill-name">Perception</div>
                  <div class="skill-modifier" id="skill-perception">+7</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Survival', 'wis')">
                  <span class="skill-emoji">üèïÔ∏è</span>
                  <div class="skill-name">Survival</div>
                  <div class="skill-modifier" id="skill-survival">+7</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üòä Charisma Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Deception', 'cha')">
                  <span class="skill-emoji">üé≠</span>
                  <div class="skill-name">Deception</div>
                  <div class="skill-modifier" id="skill-deception">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Intimidation', 'cha')">
                  <span class="skill-emoji">üò†</span>
                  <div class="skill-name">Intimidation</div>
                  <div class="skill-modifier" id="skill-intimidation">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Performance', 'cha')">
                  <span class="skill-emoji">üé™</span>
                  <div class="skill-name">Performance</div>
                  <div class="skill-modifier" id="skill-performance">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Persuasion', 'cha')">
                  <span class="skill-emoji">ü§ù</span>
                  <div class="skill-name">Persuasion</div>
                  <div class="skill-modifier" id="skill-persuasion">+0</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>ü§∏ Dexterity Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Acrobatics', 'dex')">
                  <span class="skill-emoji">ü§∏</span>
                  <div class="skill-name">Acrobatics</div>
                  <div class="skill-modifier" id="skill-acrobatics">+7</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Sleight of Hand', 'dex')">
                  <span class="skill-emoji">üëã</span>
                  <div class="skill-name">Sleight of Hand</div>
                  <div class="skill-modifier" id="skill-sleight">+4</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Stealth', 'dex')">
                  <span class="skill-emoji">ü•∑</span>
                  <div class="skill-name">Stealth</div>
                  <div class="skill-modifier" id="skill-stealth">+10</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üí™ Strength Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Athletics', 'str')">
                  <span class="skill-emoji">üí™</span>
                  <div class="skill-name">Athletics</div>
                  <div class="skill-modifier" id="skill-athletics">+1</div>
                </button>
              </div>
            </div>
          </div>

          <!-- Abilities Tab -->
          <div id="abilitiesTab" style="display: none;">
            <div style="margin-bottom: 15px;">
              <strong style="color: var(--text-primary);">Combat Abilities & Spells</strong>
            </div>
            <div id="abilitiesContent">
              <!-- Will be populated dynamically with abilities and spells -->
            </div>
          </div>

          <!-- Inventory Tab -->
          <div id="inventoryTab" style="display: none;">
            <div id="inventoryGrid">
              <!-- Will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Section -->
      <div class="section-chat" data-order="2">
        <div class="demo-section">
          <!-- Mode Selector (above chat) -->
          <div class="chat-modes" style="margin-bottom: 15px;">
            <button class="mode-btn active" onclick="switchChatMode('conversation')">Chat</button>
            <button class="mode-btn" onclick="switchChatMode('battle')">Battle</button>
          </div>

          <!-- Conversation Mode -->
          <div id="conversationMode">
            <div class="messages-area" id="messagesArea">
              <div class="message">
                <div class="message-avatar">üèπ</div>
                <div class="message-content">
                  <div class="message-header" id="characterNameHeader">Aelindra</div>
                  <div class="message-text" id="greetingMessage">
                    You find me studying tracks in the forest. The creatures here have been acting strangely...
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
              <input
                type="text"
                id="messageInput"
                placeholder="Type a message..."
                style="flex: 1; padding: 12px; background: var(--background-color); border: 2px solid var(--border-color); border-radius: 8px; color: var(--text-primary);"
                onkeypress="if(event.key === 'Enter') sendMessage()"
              >
              <button class="test-btn" onclick="sendMessage()">Send</button>
            </div>

            <!-- State Selector (below chat) -->
            <div style="padding-top: 15px; border-top: 1px solid var(--border-color);">
              <div class="state-selector">
                <label style="color: var(--text-secondary); font-weight: 600;">Mood:</label>
                <select id="characterState" onchange="changeCharacterState()">
                  <option value="default">Default (Calm)</option>
                  <option value="battle">Battle (Focused)</option>
                  <option value="injured">Injured (Pained)</option>
                  <option value="angry">Angry (Furious)</option>
                  <option value="triumphant">Triumphant (Joyful)</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Battle Mode -->
          <div id="battleMode" style="display: none;">
            <div class="turn-tracker">
              <div class="turn-info">
                <div>
                  <strong style="color: var(--text-secondary); font-size: 0.85rem;">Turn</strong>
                  <div class="turn-number" id="turnNumber">1</div>
                </div>
                <div style="border-left: 2px solid var(--border-color); padding-left: 15px; margin-left: 15px;">
                  <div style="font-size: 0.75rem; color: var(--text-secondary);">Current</div>
                  <div style="font-weight: 600; color: var(--text-primary);" id="currentTurn">Your Turn</div>
                </div>
              </div>
              <div class="turn-controls">
                <button onclick="nextTurn()">Next Turn ‚û§</button>
              </div>
            </div>

            <!-- Battle Log -->
            <div style="margin-bottom: 15px;">
              <strong style="color: var(--text-primary);">Battle Log</strong>
            </div>
            <div id="battleLog" style="min-height: 200px; max-height: 300px; overflow-y: auto; background: var(--background-color); border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
              <div style="color: var(--text-secondary); font-size: 0.9rem; text-align: center; padding: 20px;">
                Battle actions and rolls will appear here...
              </div>
            </div>

            <div style="margin-bottom: 15px;">
              <strong style="color: var(--text-primary);">Quick Actions</strong>
            </div>

            <div class="battle-actions">
              <button class="action-btn" onclick="rollMeleeAttack()">‚öîÔ∏è Melee Attack</button>
              <button class="action-btn" onclick="rollRangedAttack()">üèπ Ranged Attack</button>
              <button class="action-btn" onclick="castCantrip()">‚ú® Cantrip</button>
              <button class="action-btn" onclick="rollDice('Initiative', 'd20')">üé≤ Initiative</button>
              <button class="action-btn" onclick="rollDice('Save', 'd20')">üõ°Ô∏è Save</button>
              <button class="action-btn" onclick="quickAction('dash')">üèÉ Dash</button>
              <button class="action-btn" onclick="quickAction('dodge')">üí® Dodge</button>
              <button class="action-btn" onclick="quickAction('help')">ü§ù Help</button>
            </div>
          </div>

          <!-- Skills Mode -->
          <div id="skillsMode" style="display: none;">
            <div style="padding: 15px; background: var(--background-color); border-radius: 8px; margin-bottom: 15px;">
              <strong style="color: var(--text-primary); margin-bottom: 10px; display: block;">D&D 5e Skill Checks</strong>
              <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                Click any skill to roll a check. Modifiers are automatically calculated based on your character's stats and proficiencies.
              </p>
            </div>

            <div class="skills-section">
              <h3>üß† Intelligence Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Arcana', 'int')">
                  <span class="skill-emoji">üîÆ</span>
                  <div class="skill-name">Arcana</div>
                  <div class="skill-modifier" id="skill-arcana">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('History', 'int')">
                  <span class="skill-emoji">üìú</span>
                  <div class="skill-name">History</div>
                  <div class="skill-modifier" id="skill-history">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Investigation', 'int')">
                  <span class="skill-emoji">üîç</span>
                  <div class="skill-name">Investigation</div>
                  <div class="skill-modifier" id="skill-investigation">+4</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Nature', 'int')">
                  <span class="skill-emoji">üåø</span>
                  <div class="skill-name">Nature</div>
                  <div class="skill-modifier" id="skill-nature">+1</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Religion', 'int')">
                  <span class="skill-emoji">‚õ™</span>
                  <div class="skill-name">Religion</div>
                  <div class="skill-modifier" id="skill-religion">+1</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üëÅÔ∏è Wisdom Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Animal Handling', 'wis')">
                  <span class="skill-emoji">üê∫</span>
                  <div class="skill-name">Animal Handling</div>
                  <div class="skill-modifier" id="skill-animal">+6</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Insight', 'wis')">
                  <span class="skill-emoji">üí≠</span>
                  <div class="skill-name">Insight</div>
                  <div class="skill-modifier" id="skill-insight">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Medicine', 'wis')">
                  <span class="skill-emoji">‚öïÔ∏è</span>
                  <div class="skill-name">Medicine</div>
                  <div class="skill-modifier" id="skill-medicine">+3</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Perception', 'wis')">
                  <span class="skill-emoji">üëÅÔ∏è</span>
                  <div class="skill-name">Perception</div>
                  <div class="skill-modifier" id="skill-perception">+6</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Survival', 'wis')">
                  <span class="skill-emoji">üèïÔ∏è</span>
                  <div class="skill-name">Survival</div>
                  <div class="skill-modifier" id="skill-survival">+9</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>‚ú® Charisma Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Deception', 'cha')">
                  <span class="skill-emoji">üé≠</span>
                  <div class="skill-name">Deception</div>
                  <div class="skill-modifier" id="skill-deception">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Intimidation', 'cha')">
                  <span class="skill-emoji">üò†</span>
                  <div class="skill-name">Intimidation</div>
                  <div class="skill-modifier" id="skill-intimidation">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Performance', 'cha')">
                  <span class="skill-emoji">üé™</span>
                  <div class="skill-name">Performance</div>
                  <div class="skill-modifier" id="skill-performance">+0</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Persuasion', 'cha')">
                  <span class="skill-emoji">ü§ù</span>
                  <div class="skill-name">Persuasion</div>
                  <div class="skill-modifier" id="skill-persuasion">+0</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>ü§∏ Dexterity Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Acrobatics', 'dex')">
                  <span class="skill-emoji">ü§∏</span>
                  <div class="skill-name">Acrobatics</div>
                  <div class="skill-modifier" id="skill-acrobatics">+7</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Sleight of Hand', 'dex')">
                  <span class="skill-emoji">üëã</span>
                  <div class="skill-name">Sleight of Hand</div>
                  <div class="skill-modifier" id="skill-sleight">+4</div>
                </button>
                <button class="skill-btn" onclick="rollSkill('Stealth', 'dex')">
                  <span class="skill-emoji">ü•∑</span>
                  <div class="skill-name">Stealth</div>
                  <div class="skill-modifier" id="skill-stealth">+10</div>
                </button>
              </div>
            </div>

            <div class="skills-section">
              <h3>üí™ Strength Skills</h3>
              <div class="skills-grid">
                <button class="skill-btn" onclick="rollSkill('Athletics', 'str')">
                  <span class="skill-emoji">üí™</span>
                  <div class="skill-name">Athletics</div>
                  <div class="skill-modifier" id="skill-athletics">+1</div>
                </button>
              </div>
            </div>
          </div>

          <!-- Inventory Mode -->
          <div id="inventoryMode" style="display: none;">
            <div style="padding: 15px; background: var(--background-color); border-radius: 8px; margin-bottom: 15px;">
              <strong style="color: var(--text-primary); margin-bottom: 10px; display: block;">Character Inventory</strong>
              <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                Manage your equipment, weapons, and consumables. Click items to use or equip them.
              </p>
            </div>

            <div id="inventoryGrid">
              <!-- Will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab-btn" onclick="toggleDicePopup()" title="Dice & Quick Actions">
      üé≤
    </button>

    <!-- Dice Popup -->
    <div class="dice-popup" id="dicePopup">
      <div class="dice-popup-header">
        <h3>üé≤ Dice & Actions</h3>
        <button class="close-popup-btn" onclick="toggleDicePopup()">‚úï</button>
      </div>
      <div class="dice-popup-content">
        <div style="margin-bottom: 15px;" id="combatRollsSection">
          <strong style="display: block; margin-bottom: 8px;">Combat Rolls</strong>
          <div style="display: grid; gap: 8px;">
            <!-- Attack & Ranged buttons (populated dynamically) -->
            <div id="attackButtons" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
            <!-- Spell buttons (populated dynamically) -->
            <div id="spellButtons" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
          </div>
        </div>

        <div style="margin-bottom: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
          <strong style="display: block; margin-bottom: 8px;">Custom Dice Roll</strong>
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <input type="number" id="numDice" value="1" min="1" max="10" style="width: 50px; padding: 8px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 4px;">
            <select id="diceType" style="padding: 8px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 4px;">
              <option value="4">d4</option>
              <option value="6">d6</option>
              <option value="8">d8</option>
              <option value="10">d10</option>
              <option value="12">d12</option>
              <option value="20" selected>d20</option>
              <option value="100">d100</option>
            </select>
            <input type="number" id="diceModifier" value="0" min="-10" max="20" placeholder="+/-" style="width: 60px; padding: 8px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 4px;">
            <button class="test-btn" onclick="rollCustomDice()" style="margin: 0;">Roll</button>
          </div>
        </div>

        <div style="border-top: 1px solid var(--border-color); padding-top: 15px;">
          <strong style="display: block; margin-bottom: 8px;">Quick Actions</strong>
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <input type="number" id="damageAmount" value="10" min="1" max="999" placeholder="Damage" style="width: 80px; padding: 8px; background: var(--background-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 4px;">
            <button class="test-btn" onclick="takeDamage()" style="margin: 0;">üíî Damage</button>
            <button class="test-btn" onclick="heal()" style="margin: 0;">‚ù§Ô∏è Heal</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer: Canvas & Location -->
    <div style="margin-top: 20px; padding: 20px; background: var(--surface-color); border-radius: 12px; border: 2px solid var(--border-color);">
      <!-- Canvas -->
      <div style="margin-bottom: 20px;">
        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">üé® Canvas</div>
        <div id="canvasDisplay" style="width: 100%; height: 200px; background: var(--background-color); border: 2px solid var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
          Canvas preview (location background)
        </div>
      </div>

      <!-- Location -->
      <div>
        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">üìç Location</div>
        <select id="locationSelect" onchange="changeLocation()" style="width: 100%; padding: 10px; background: var(--surface-color); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem; cursor: pointer;">
          <option value="forest">Moonlit Forest</option>
          <option value="tavern">The Drunken Dragon Tavern</option>
          <option value="dungeon">Ancient Dungeon</option>
          <option value="castle">Royal Castle</option>
          <option value="town">Town Square</option>
          <option value="mountains">Mountain Pass</option>
          <option value="ruins">Ancient Ruins</option>
          <option value="temple">Sacred Temple</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Dice Roll Overlay -->
  <div class="dice-overlay" id="diceOverlay">
    <div class="dice-result" id="diceResult">
      <div class="dice-icon" id="diceIcon">üé≤</div>
      <div class="dice-type" id="diceType">Attack Roll</div>
      <div class="dice-value" id="diceValue">18</div>
      <div class="dice-breakdown" id="diceBreakdown"></div>
    </div>
  </div>

  <script>
    // Location Data
    const locations = [
      { id: 'tavern', name: 'The Drunken Dragon Tavern', image: 'https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800&q=80' },
      { id: 'forest', name: 'Moonlit Forest', image: 'https://images.unsplash.com/photo-1511497584788-876760111969?w=800&q=80' },
      { id: 'dungeon', name: 'Ancient Dungeon', image: 'https://images.unsplash.com/photo-1518105779142-d975f22f1b0a?w=800&q=80' },
      { id: 'castle', name: 'Royal Castle', image: 'https://images.unsplash.com/photo-1549048430-7f0e636b069e?w=800&q=80' },
      { id: 'town', name: 'Town Square', image: 'https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=800&q=80' },
      { id: 'mountains', name: 'Mountain Pass', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80' },
      { id: 'ruins', name: 'Ancient Ruins', image: 'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=800&q=80' },
      { id: 'temple', name: 'Sacred Temple', image: 'https://images.unsplash.com/photo-1512699355324-f07e3106dae5?w=800&q=80' }
    ];

    // Character Data with Skills
    const characters = [
      {
        id: 'aelindra',
        name: 'Aelindra Moonwhisper',
        emoji: 'üèπ',
        class: 'Ranger',
        subclass: 'Hunter',
        race: 'Half-Elf',
        alignment: 'Neutral Good',
        classType: 'halfcaster', // melee, halfcaster, or caster
        level: 8,
        hp: { current: 58, max: 68 },
        ac: 16,
        food: { current: 70, max: 100 }, // Hunger/satiety level
        stats: { str: 12, dex: 18, con: 14, int: 13, wis: 16, cha: 10 },
        // portrait: 'https://i.imgur.com/yXEiYQ7.png', // Placeholder - using emoji instead
        location: 'forest',
        attacks: {
          melee: { name: 'Shortsword', damage: '1d6+4', toHit: 7 },
          ranged: { name: 'Longbow +1', damage: '1d8+5', toHit: 8 }
        },
        inventory: [
          { id: 'longbow', name: 'Longbow +1', type: 'weapon', equipped: true, attuned: true },
          { id: 'cloak', name: 'Cloak of Elvenkind', type: 'armor', equipped: true, attuned: true },
          { id: 'arrows', name: 'Arrows', type: 'ammunition', quantity: 40 },
          { id: 'leather_armor', name: 'Leather Armor', type: 'armor', equipped: true },
          { id: 'healing_potion', name: 'Potion of Healing', type: 'consumable', quantity: 3 },
          { id: 'rope', name: 'Rope (50 ft)', type: 'gear', quantity: 1 },
          { id: 'rations', name: 'Rations', type: 'consumable', quantity: 7 }
        ],
        skills: {
          // Format: [ability, proficiency] where proficiency: 0=none, 1=proficient, 2=expertise
          acrobatics: ['dex', 1],
          animalHandling: ['wis', 1],
          arcana: ['int', 0],
          athletics: ['str', 0],
          deception: ['cha', 0],
          history: ['int', 0],
          insight: ['wis', 0],
          intimidation: ['cha', 0],
          investigation: ['int', 1],
          medicine: ['wis', 0],
          nature: ['int', 0],
          perception: ['wis', 1],
          performance: ['cha', 0],
          persuasion: ['cha', 0],
          religion: ['int', 0],
          sleightOfHand: ['dex', 0],
          stealth: ['dex', 2], // Expertise
          survival: ['wis', 2]  // Expertise
        },
        abilities: [
          { id: 'multiattack', name: 'Multiattack', icon: '‚öîÔ∏è', damage: '2d8+4', description: 'Make two attacks' },
          { id: 'arrow_volley', name: 'Arrow Volley', icon: 'üèπ', damage: '3d8', description: 'Rain arrows on area' }
        ],
        spells: {
          1: [
            { id: 'hunters_mark', name: "Hunter's Mark", prepared: true, icon: 'üéØ', damage: '1d6', description: 'Mark a target for extra damage' },
            { id: 'cure_wounds', name: 'Cure Wounds', prepared: true, icon: '‚ù§Ô∏è', damage: '1d8+3', description: 'Heal an ally' },
            { id: 'goodberry', name: 'Goodberry', prepared: false, icon: 'ü´ê', damage: null, description: 'Create 10 berries that heal 1 HP each' }
          ],
          2: [
            { id: 'pass_without_trace', name: 'Pass Without Trace', prepared: true, icon: 'üëª', damage: null, description: '+10 to Stealth for your party' },
            { id: 'spike_growth', name: 'Spike Growth', prepared: false, icon: 'üåø', damage: '2d4', description: 'Thorny ground damages enemies' }
          ]
        },
        states: {
          default: { mood: 'calm', greeting: 'You find me studying tracks in the forest. The creatures here have been acting strangely...' },
          battle: { mood: 'focused', greeting: 'Enemy sighted! Ready your weapons!' },
          injured: { mood: 'pained', greeting: '*winces* I\'ve seen better days...' },
          angry: { mood: 'furious', greeting: 'Those poachers will pay for what they\'ve done!' },
          triumphant: { mood: 'joyful', greeting: 'We did it! The forest is safe once more!' }
        }
      },
      {
        id: 'theron',
        name: 'Theron Brightshield',
        emoji: 'üõ°Ô∏è',
        class: 'Paladin',
        subclass: 'Oath of Vengeance',
        race: 'Human',
        alignment: 'Lawful Good',
        classType: 'halfcaster',
        level: 10,
        hp: { current: 88, max: 104 },
        ac: 18,
        food: { current: 85, max: 100 },
        stats: { str: 18, dex: 10, con: 16, int: 10, wis: 14, cha: 16 },
        // portrait: 'https://i.imgur.com/8KfPqXJ.png', // Placeholder - using emoji instead
        location: 'temple',
        attacks: {
          melee: { name: 'Longsword of Justice', damage: '1d8+5', toHit: 9 },
          ranged: { name: 'Javelin', damage: '1d6+4', toHit: 8 }
        },
        inventory: [
          { id: 'longsword', name: 'Longsword of Justice', type: 'weapon', equipped: true, attuned: true },
          { id: 'shield', name: 'Shield +1', type: 'armor', equipped: true, attuned: true },
          { id: 'amulet', name: 'Amulet of Health', type: 'gear', equipped: true, attuned: true },
          { id: 'plate_armor', name: 'Plate Armor', type: 'armor', equipped: true },
          { id: 'holy_symbol', name: 'Holy Symbol', type: 'gear', equipped: true },
          { id: 'healing_potion', name: 'Potion of Greater Healing', type: 'consumable', quantity: 2 },
          { id: 'oil_of_sharpness', name: 'Oil of Sharpness', type: 'consumable', quantity: 1 }
        ],
        skills: {
          acrobatics: ['dex', 0],
          animalHandling: ['wis', 0],
          arcana: ['int', 0],
          athletics: ['str', 1],
          deception: ['cha', 0],
          history: ['int', 0],
          insight: ['wis', 1],
          intimidation: ['cha', 1],
          investigation: ['int', 0],
          medicine: ['wis', 1],
          nature: ['int', 0],
          perception: ['wis', 0],
          performance: ['cha', 0],
          persuasion: ['cha', 1],
          religion: ['int', 1],
          sleightOfHand: ['dex', 0],
          stealth: ['dex', 0],
          survival: ['wis', 0]
        },
        abilities: [
          { id: 'divine_smite', name: 'Divine Smite', icon: '‚ö°', damage: '4d8', description: 'Channel divine energy into your strike' },
          { id: 'lay_on_hands', name: 'Lay on Hands', icon: '‚ú®', damage: '50', description: 'Heal with divine touch' },
          { id: 'shield_bash', name: 'Shield Bash', icon: 'üõ°Ô∏è', damage: '1d8+4', description: 'Bash with your shield' },
          { id: 'aura_courage', name: 'Aura of Courage', icon: 'üí™', damage: null, description: 'Grant allies immunity to fear' }
        ],
        spells: {
          1: [
            { id: 'bless', name: 'Bless', prepared: true, icon: '‚ú®', damage: null, description: '+1d4 to attack rolls and saves' },
            { id: 'cure_wounds', name: 'Cure Wounds', prepared: true, icon: '‚ù§Ô∏è', damage: '1d8+3', description: 'Heal an ally' },
            { id: 'shield_of_faith', name: 'Shield of Faith', prepared: true, icon: 'üõ°Ô∏è', damage: null, description: '+2 AC to target' }
          ],
          2: [
            { id: 'aid', name: 'Aid', prepared: true, icon: 'üí™', damage: null, description: '+5 max HP to 3 allies' },
            { id: 'lesser_restoration', name: 'Lesser Restoration', prepared: false, icon: 'ü©π', damage: null, description: 'End disease or condition' }
          ],
          3: [
            { id: 'aura_of_vitality', name: 'Aura of Vitality', prepared: true, icon: '‚ù§Ô∏è‚Äçüî•', damage: '2d6', description: 'Heal allies over time' },
            { id: 'revivify', name: 'Revivify', prepared: false, icon: '‚ö∞Ô∏è', damage: null, description: 'Bring back the dead' }
          ]
        },
        states: {
          default: { mood: 'noble', greeting: 'Greetings, friend. How may I serve justice this day?' },
          battle: { mood: 'righteous', greeting: 'By the light, evil shall not prevail!' },
          injured: { mood: 'determined', greeting: 'A mere scratch. I will not fall!' },
          angry: { mood: 'wrathful', greeting: 'You dare commit such atrocities?!' },
          triumphant: { mood: 'blessed', greeting: 'The light has guided us to victory!' }
        }
      },
      {
        id: 'zara',
        name: 'Zara Infernalis',
        emoji: 'üîÆ',
        class: 'Wizard',
        subclass: 'School of Evocation',
        race: 'Tiefling',
        alignment: 'Chaotic Neutral',
        classType: 'caster',
        level: 9,
        hp: { current: 42, max: 54 },
        ac: 13,
        food: { current: 45, max: 100 },
        stats: { str: 8, dex: 14, con: 13, int: 20, wis: 12, cha: 11 },
        // portrait: 'https://i.imgur.com/mBvN2dK.png', // Placeholder - using emoji instead
        location: 'ruins',
        attacks: {
          melee: { name: 'Quarterstaff', damage: '1d6-1', toHit: 1 },
          ranged: null // Wizards typically don't use ranged weapons
        },
        inventory: [
          { id: 'staff', name: 'Staff of Power', type: 'weapon', equipped: true },
          { id: 'robes', name: 'Robes of the Archmagi', type: 'armor', equipped: true },
          { id: 'component_pouch', name: 'Component Pouch', type: 'gear', equipped: true },
          { id: 'spellbook', name: 'Spellbook', type: 'gear', equipped: true },
          { id: 'scroll_fireball', name: 'Scroll of Fireball', type: 'consumable', quantity: 1 },
          { id: 'scroll_counterspell', name: 'Scroll of Counterspell', type: 'consumable', quantity: 2 }
        ],
        skills: {
          acrobatics: ['dex', 0],
          animalHandling: ['wis', 0],
          arcana: ['int', 2], // Expertise
          athletics: ['str', 0],
          deception: ['cha', 0],
          history: ['int', 1],
          insight: ['wis', 0],
          intimidation: ['cha', 0],
          investigation: ['int', 1],
          medicine: ['wis', 0],
          nature: ['int', 1],
          perception: ['wis', 0],
          performance: ['cha', 0],
          persuasion: ['cha', 0],
          religion: ['int', 1],
          sleightOfHand: ['dex', 0],
          stealth: ['dex', 0],
          survival: ['wis', 0]
        },
        abilities: [],
        spells: {
          0: [
            { id: 'fire_bolt', name: 'Fire Bolt', prepared: true, icon: 'üî•', damage: '2d10', description: 'Ranged fire attack cantrip' },
            { id: 'mage_hand', name: 'Mage Hand', prepared: true, icon: '‚úã', damage: null, description: 'Telekinetic manipulation' },
            { id: 'prestidigitation', name: 'Prestidigitation', prepared: true, icon: '‚ú®', damage: null, description: 'Minor magical trick' }
          ],
          1: [
            { id: 'magic_missile', name: 'Magic Missile', prepared: true, icon: '‚ú®', damage: '3d4+3', description: 'Unerring magical darts' },
            { id: 'shield', name: 'Shield', prepared: true, icon: 'üõ°Ô∏è', damage: null, description: '+5 AC until your next turn' },
            { id: 'detect_magic', name: 'Detect Magic', prepared: false, icon: 'üîÆ', damage: null, description: 'Sense magical auras' }
          ],
          2: [
            { id: 'misty_step', name: 'Misty Step', prepared: true, icon: 'üí®', damage: null, description: 'Teleport 30 feet' },
            { id: 'scorching_ray', name: 'Scorching Ray', prepared: false, icon: 'üî•', damage: '2d6', description: 'Three rays of fire' }
          ],
          3: [
            { id: 'fireball', name: 'Fireball', prepared: true, icon: 'üî•', damage: '8d6', description: 'Devastating explosion of flame' },
            { id: 'counterspell', name: 'Counterspell', prepared: true, icon: 'üö´', damage: null, description: 'Negate enemy spells' },
            { id: 'lightning_bolt', name: 'Lightning Bolt', prepared: false, icon: '‚ö°', damage: '8d6', description: 'Line of electrical energy' }
          ],
          4: [
            { id: 'polymorph', name: 'Polymorph', prepared: true, icon: 'üê∏', damage: null, description: 'Transform target into beast' },
            { id: 'wall_of_fire', name: 'Wall of Fire', prepared: false, icon: 'üî•', damage: '5d8', description: 'Create wall of flames' }
          ],
          5: [
            { id: 'cone_of_cold', name: 'Cone of Cold', prepared: true, icon: '‚ùÑÔ∏è', damage: '8d8', description: 'Blast of frigid air' },
            { id: 'wall_of_force', name: 'Wall of Force', prepared: false, icon: 'üõ°Ô∏è', damage: null, description: 'Invisible wall' }
          ]
        },
        states: {
          default: { mood: 'curious', greeting: 'Fascinating... the magical energies here are quite unusual.' },
          battle: { mood: 'calculating', greeting: 'Let me show you the true power of the arcane!' },
          injured: { mood: 'weakened', greeting: 'My concentration... slipping...' },
          angry: { mood: 'volatile', greeting: 'You\'ve made a grave mistake interrupting my research!' },
          triumphant: { mood: 'smug', greeting: 'As I predicted, victory was inevitable.' }
        }
      },
      {
        id: 'kael',
        name: 'Kael Quickfingers',
        emoji: 'üó°Ô∏è',
        class: 'Rogue',
        subclass: 'Arcane Trickster',
        race: 'Halfling',
        alignment: 'Chaotic Good',
        classType: 'melee',
        level: 7,
        hp: { current: 38, max: 45 },
        ac: 15,
        food: { current: 60, max: 100 },
        stats: { str: 10, dex: 20, con: 12, int: 14, wis: 13, cha: 14 },
        // portrait: 'https://i.imgur.com/RkH7Wd0.png', // Placeholder - using emoji instead
        location: 'tavern',
        attacks: {
          melee: { name: 'Rapier +1', damage: '1d8+6', toHit: 9 },
          ranged: { name: 'Dagger (Thrown)', damage: '1d4+5', toHit: 9 }
        },
        inventory: [
          { id: 'rapier', name: 'Rapier +1', type: 'weapon', equipped: true },
          { id: 'dagger', name: 'Dagger', type: 'weapon', equipped: true, quantity: 3 },
          { id: 'leather_armor', name: 'Studded Leather Armor', type: 'armor', equipped: true },
          { id: 'thieves_tools', name: "Thieves' Tools", type: 'gear', equipped: true },
          { id: 'healing_potion', name: 'Potion of Healing', type: 'consumable', quantity: 2 },
          { id: 'poison', name: 'Vial of Poison', type: 'consumable', quantity: 3 },
          { id: 'grappling_hook', name: 'Grappling Hook', type: 'gear', quantity: 1 }
        ],
        skills: {
          acrobatics: ['dex', 2], // Expertise
          animalHandling: ['wis', 0],
          arcana: ['int', 0],
          athletics: ['str', 0],
          deception: ['cha', 1],
          history: ['int', 0],
          insight: ['wis', 0],
          intimidation: ['cha', 0],
          investigation: ['int', 1],
          medicine: ['wis', 0],
          nature: ['int', 0],
          perception: ['wis', 1],
          performance: ['cha', 0],
          persuasion: ['cha', 1],
          religion: ['int', 0],
          sleightOfHand: ['dex', 2], // Expertise
          stealth: ['dex', 2], // Expertise
          survival: ['wis', 0]
        },
        abilities: [
          { id: 'sneak_attack', name: 'Sneak Attack', icon: 'üó°Ô∏è', damage: '4d6', description: 'Strike from the shadows' },
          { id: 'cunning_action', name: 'Cunning Action', icon: 'üí®', damage: null, description: 'Bonus action dash/disengage/hide' },
          { id: 'evasion', name: 'Evasion', icon: 'ü§∏', damage: null, description: 'Dodge area effects' },
          { id: 'thieves_tools', name: "Thieves' Tools", icon: 'üîì', damage: null, description: 'Pick locks and disable traps' }
        ],
        states: {
          default: { mood: 'sly', greeting: '*leaning casually* Well, well, what brings you to this part of town?' },
          battle: { mood: 'focused', greeting: 'Time to disappear... *fades into shadows*' },
          injured: { mood: 'grimacing', greeting: '*clutching side* Not my best day...' },
          angry: { mood: 'vengeful', greeting: 'You\'ll regret double-crossing me!' },
          triumphant: { mood: 'cocky', greeting: '*twirling dagger* Too easy. What\'s next?' }
        }
      }
    ];

    let currentCharacter = characters[0];
    let currentChatMode = 'conversation';
    let currentState = 'default';
    let turnNumber = 1;

    // Initialize
    updateCharacterDisplay();
    populateCharacterMenu();

    function populateCharacterMenu() {
      const list = document.getElementById('characterList');
      list.innerHTML = characters.map((char, index) => `
        <div class="character-item ${index === 0 ? 'active' : ''}" onclick="selectCharacterFromMenu(${index})">
          <div class="character-item-header">
            <div class="character-item-emoji">${char.emoji}</div>
            <div class="character-item-info">
              <div class="character-item-name">${char.name}</div>
              <div class="character-item-class">${char.class} ${char.level}</div>
            </div>
          </div>
          <div class="character-item-stats">
            <span>HP: ${char.hp.current}/${char.hp.max}</span>
            <span>AC: ${char.ac}</span>
          </div>
        </div>
      `).join('');
    }

    function toggleMenu() {
      const menu = document.getElementById('characterMenu');
      const overlay = document.getElementById('menuOverlay');
      menu.classList.toggle('open');
      overlay.classList.toggle('show');
    }

    function closeMenu() {
      const menu = document.getElementById('characterMenu');
      const overlay = document.getElementById('menuOverlay');
      menu.classList.remove('open');
      overlay.classList.remove('show');
    }

    function selectCharacterFromMenu(index) {
      // Validate index
      if (index < 0 || index >= characters.length) {
        console.error('Invalid character index:', index);
        return;
      }

      // Update current character
      currentCharacter = characters[index];
      currentState = 'default';
      turnNumber = 1;

      // Update all displays
      updateCharacterDisplay();
      updateMessages();

      // Update menu active state
      document.querySelectorAll('.character-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
      });

      // Update the character menu to show current HP, etc.
      populateCharacterMenu();

      closeMenu();
    }

    function updateCharacterDisplay() {
      // Update header (portrait and name)
      document.getElementById('currentCharName').textContent = currentCharacter.name;
      document.getElementById('charAlignment').textContent = currentCharacter.alignment || 'Neutral';
      document.getElementById('charLevel').textContent = currentCharacter.level;
      document.getElementById('charRace').textContent = currentCharacter.race || 'Human';
      document.getElementById('charClass').textContent = currentCharacter.class;
      document.getElementById('characterNameHeader').textContent = currentCharacter.name;

      // Update portraits
      document.getElementById('headerPortrait').textContent = currentCharacter.emoji;
      document.getElementById('statsPortrait').textContent = currentCharacter.emoji;

      // Update stats
      const stats = currentCharacter.stats;
      ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(stat => {
        const value = stats[stat];
        const modifier = Math.floor((value - 10) / 2);
        document.getElementById(stat + 'Value').textContent = value;
        document.getElementById(stat + 'Mod').textContent = (modifier >= 0 ? '+' : '') + modifier;
      });

      // Update HP
      const hpPercent = (currentCharacter.hp.current / currentCharacter.hp.max) * 100;
      document.getElementById('hpFill').style.width = hpPercent + '%';
      document.getElementById('hpText').textContent = `${currentCharacter.hp.current} / ${currentCharacter.hp.max}`;
      document.getElementById('hpCurrentEdit').textContent = currentCharacter.hp.current;
      document.getElementById('hpMaxEdit').textContent = currentCharacter.hp.max;

      // Update Header HP Bar
      const headerHpFill = document.getElementById('headerHpFill');
      const headerHpText = document.getElementById('headerHpText');
      headerHpFill.style.width = hpPercent + '%';
      headerHpText.textContent = `${currentCharacter.hp.current}/${currentCharacter.hp.max}`;

      // Update HP bar color based on percentage
      headerHpFill.classList.remove('high', 'medium');
      if (hpPercent > 60) {
        headerHpFill.classList.add('high');
      } else if (hpPercent > 25) {
        headerHpFill.classList.add('medium');
      }

      // Update AC
      document.getElementById('acValue').textContent = currentCharacter.ac;
      document.getElementById('headerAc').textContent = `AC ${currentCharacter.ac}`;

      // Update Initiative
      const dexMod = Math.floor((stats.dex - 10) / 2);
      document.getElementById('initValue').textContent = (dexMod >= 0 ? '+' : '') + dexMod;

      // Update location selector
      document.getElementById('locationSelect').value = currentCharacter.location;

      // Update abilities
      updateAbilities();

      // Update skills
      updateSkills();

      // Update turn tracker
      document.getElementById('turnNumber').textContent = turnNumber;
    }

    function updateAbilities() {
      const abilitiesGrid = document.getElementById('abilitiesGrid');
      let html = '';

      // Show attacks first (melee/ranged)
      if (currentCharacter.attacks) {
        html += '<div style="margin-bottom: 20px;"><strong style="color: var(--text-primary);">‚öîÔ∏è Attacks</strong></div>';

        if (currentCharacter.attacks.melee) {
          const attack = currentCharacter.attacks.melee;
          html += `
            <div class="ability-card" onclick="rollWeaponAttack('melee')">
              <div class="ability-header">
                <div class="ability-icon">‚öîÔ∏è</div>
                <div class="ability-info">
                  <div class="ability-name">${attack.name} (Melee)</div>
                  <div class="ability-damage">${attack.damage} | +${attack.toHit} to hit</div>
                </div>
              </div>
              <div class="ability-description">Make a melee attack with your ${attack.name}</div>
            </div>
          `;
        }

        if (currentCharacter.attacks.ranged) {
          const attack = currentCharacter.attacks.ranged;
          html += `
            <div class="ability-card" onclick="rollWeaponAttack('ranged')">
              <div class="ability-header">
                <div class="ability-icon">üèπ</div>
                <div class="ability-info">
                  <div class="ability-name">${attack.name} (Ranged)</div>
                  <div class="ability-damage">${attack.damage} | +${attack.toHit} to hit</div>
                </div>
              </div>
              <div class="ability-description">Make a ranged attack with your ${attack.name}</div>
            </div>
          `;
        }
      }

      // Show abilities (for all classes)
      if (currentCharacter.abilities && currentCharacter.abilities.length > 0) {
        html += '<div style="margin: 20px 0;"><strong style="color: var(--text-primary);">Abilities</strong></div>';
        currentCharacter.abilities.forEach(ability => {
          html += `
            <div class="ability-card" onclick="useAbility('${ability.id}')">
              <div class="ability-header">
                <div class="ability-icon">${ability.icon}</div>
                <div class="ability-info">
                  <div class="ability-name">${ability.name}</div>
                  ${ability.damage ? `<div class="ability-damage">${ability.damage}</div>` : ''}
                </div>
              </div>
              <div class="ability-description">${ability.description}</div>
            </div>
          `;
        });
      }

      // Show spells (for casters and halfcasters)
      if (currentCharacter.spells && (currentCharacter.classType === 'caster' || currentCharacter.classType === 'halfcaster')) {
        html += '<div style="margin: 20px 0;"><strong style="color: var(--text-primary);">Spells</strong></div>';

        Object.keys(currentCharacter.spells).sort((a, b) => parseInt(a) - parseInt(b)).forEach(level => {
          const levelName = level === '0' ? 'Cantrips' : `Level ${level}`;
          html += `<div class="spell-level-section">
            <div class="spell-level-header">${levelName}</div>`;

          currentCharacter.spells[level].forEach(spell => {
            html += `
              <div class="spell-card ${spell.prepared ? 'prepared' : ''}" onclick="toggleSpellPrepared('${spell.id}', ${level})">
                <div class="spell-header">
                  <div class="spell-icon">${spell.icon}</div>
                  <div class="spell-info">
                    <div class="spell-name">${spell.name}</div>
                    ${spell.damage ? `<div class="spell-damage">${spell.damage}</div>` : ''}
                  </div>
                  ${spell.prepared ? '<div class="prepared-indicator">Prepared</div>' : ''}
                </div>
                <div class="spell-description">${spell.description}</div>
              </div>
            `;
          });

          html += '</div>';
        });
      }

      abilitiesGrid.innerHTML = html;
    }

    // New function to update the Abilities tab in the stats section
    function updateAbilitiesTab() {
      const abilitiesContent = document.getElementById('abilitiesContent');
      let html = '';

      // Show abilities (for all classes)
      if (currentCharacter.abilities && currentCharacter.abilities.length > 0) {
        html += '<div style="margin-bottom: 20px;"><strong style="color: var(--text-primary);">‚öîÔ∏è Abilities</strong></div>';
        currentCharacter.abilities.forEach(ability => {
          const isDefault = ability.isDefault || false;
          html += `
            <div class="ability-card" style="position: relative;">
              <div class="ability-header">
                <div class="ability-icon">${ability.icon}</div>
                <div class="ability-info">
                  <div class="ability-name">${ability.name} ${isDefault ? '(Default)' : ''}</div>
                  ${ability.damage ? `<div class="ability-damage">${ability.damage}</div>` : ''}
                </div>
              </div>
              <div class="ability-description">${ability.description}</div>
              <button
                onclick="setDefaultAbility('${ability.id}')"
                style="position: absolute; top: 10px; right: 10px; padding: 4px 8px; background: var(--accent-color); border: none; border-radius: 4px; color: white; font-size: 0.7rem; cursor: pointer;"
              >
                ${isDefault ? 'Default ‚úì' : 'Set Default'}
              </button>
            </div>
          `;
        });
      }

      // Show spells (for casters and halfcasters)
      if (currentCharacter.spells && (currentCharacter.classType === 'caster' || currentCharacter.classType === 'halfcaster')) {
        html += '<div style="margin: 20px 0;"><strong style="color: var(--text-primary);">‚ú® Spells</strong></div>';
        html += '<div style="margin-bottom: 10px; font-size: 0.85rem; color: var(--text-secondary);">Click a spell to toggle preparation. Prepared spells are available in battle.</div>';

        Object.keys(currentCharacter.spells).sort((a, b) => parseInt(a) - parseInt(b)).forEach(level => {
          const levelName = level === '0' ? 'Cantrips' : `Level ${level}`;
          html += `<div class="spell-level-section">
            <div class="spell-level-header">${levelName}</div>`;

          currentCharacter.spells[level].forEach(spell => {
            const isDefault = spell.isDefault || false;
            const isCantrip = level === '0';
            const isSelected = selectedCantrip && selectedCantrip.id === spell.id;

            html += `
              <div class="spell-card ${spell.prepared ? 'prepared' : ''} ${isSelected ? 'selected' : ''}" style="position: relative; ${isSelected ? 'border: 2px solid var(--accent-color);' : ''}">
                <div class="spell-header" onclick="${isCantrip ? `selectCantrip('${spell.id}', ${level})` : `toggleSpellPrepared('${spell.id}', ${level})`}">
                  <div class="spell-icon">${spell.icon}</div>
                  <div class="spell-info">
                    <div class="spell-name">${spell.name} ${isDefault ? '(Default)' : ''} ${isSelected ? '(Selected)' : ''}</div>
                    ${spell.damage ? `<div class="spell-damage">${spell.damage}</div>` : ''}
                  </div>
                  ${spell.prepared ? '<div class="prepared-indicator">Prepared</div>' : ''}
                  ${isSelected ? '<div class="prepared-indicator" style="background: var(--accent-color);">Selected</div>' : ''}
                </div>
                <div class="spell-description">${spell.description}</div>
                ${spell.prepared && !isCantrip ? `<button
                  onclick="event.stopPropagation(); setDefaultSpell('${spell.id}', ${level})"
                  style="position: absolute; top: 10px; right: 10px; padding: 4px 8px; background: var(--accent-color); border: none; border-radius: 4px; color: white; font-size: 0.7rem; cursor: pointer;"
                >
                  ${isDefault ? 'Default ‚úì' : 'Set Default'}
                </button>` : ''}
              </div>
            `;
          });

          html += '</div>';
        });
      }

      abilitiesContent.innerHTML = html;
    }

    function updateSkills() {
      const profBonus = 2 + Math.floor((currentCharacter.level - 1) / 4);

      Object.entries(currentCharacter.skills).forEach(([skillName, [ability, proficiency]]) => {
        const abilityMod = Math.floor((currentCharacter.stats[ability] - 10) / 2);
        const profMod = proficiency * profBonus;
        const total = abilityMod + profMod;

        const skillId = 'skill-' + skillName.toLowerCase().replace(/\s+/g, '');
        const element = document.getElementById(skillId);
        if (element) {
          element.textContent = (total >= 0 ? '+' : '') + total;
        }
      });
    }

    function switchChatMode(mode) {
      currentChatMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Show/hide appropriate sections
      document.getElementById('conversationMode').style.display = mode === 'conversation' ? 'block' : 'none';
      document.getElementById('battleMode').style.display = mode === 'battle' ? 'block' : 'none';
    }

    function switchStatTab(tab) {
      // Remove active class from all tab buttons
      document.querySelectorAll('.stat-tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Show/hide appropriate tabs
      document.getElementById('statsTab').style.display = tab === 'stats' ? 'block' : 'none';
      document.getElementById('skillsTab').style.display = tab === 'skills' ? 'block' : 'none';
      document.getElementById('abilitiesTab').style.display = tab === 'abilities' ? 'block' : 'none';
      document.getElementById('inventoryTab').style.display = tab === 'inventory' ? 'block' : 'none';

      // Update content when switching tabs
      if (tab === 'inventory') {
        updateInventory();
      } else if (tab === 'abilities') {
        updateAbilitiesTab();
      }
    }

    function changeCharacterState() {
      currentState = document.getElementById('characterState').value;
      updateMessages();
    }

    function updateCharacterState() {
      const state = document.getElementById('characterStateStats').value;
      console.log('Character state changed to:', state);
      // This can be used to apply state-based modifiers or effects
      // For now, just log the state change
    }

    function updateMessages() {
      const stateConfig = currentCharacter.states?.[currentState];
      if (stateConfig && stateConfig.greeting) {
        document.getElementById('greetingMessage').textContent = stateConfig.greeting;
      } else {
        // Fallback if state doesn't exist
        console.warn(`State '${currentState}' not found for character ${currentCharacter.name}`);
        document.getElementById('greetingMessage').textContent = `${currentCharacter.name} is ready for adventure.`;
      }
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (!message) return;

      const messagesArea = document.getElementById('messagesArea');

      // Add player message
      messagesArea.innerHTML += `
        <div class="message player">
          <div class="message-avatar">üë§</div>
          <div class="message-content">
            <div class="message-text">${message}</div>
          </div>
        </div>
      `;

      input.value = '';

      // Simulate character response
      setTimeout(() => {
        const responses = [
          "That's an interesting point. Tell me more.",
          "I understand your concern. Let me think about this...",
          "Fascinating. I hadn't considered that perspective.",
          "We should proceed carefully. What do you suggest?",
          "Your wisdom is valuable. Together we can solve this."
        ];
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];

        messagesArea.innerHTML += `
          <div class="message">
            <div class="message-avatar">${currentCharacter.emoji}</div>
            <div class="message-content">
              <div class="message-header">${currentCharacter.name}</div>
              <div class="message-text">${randomResponse}</div>
            </div>
          </div>
        `;

        messagesArea.scrollTop = messagesArea.scrollHeight;
      }, 800);

      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function addBattleLog(message) {
      // If in conversation mode, don't add to battle log
      if (currentChatMode === 'conversation') return;

      const battleLog = document.getElementById('battleLog');
      if (!battleLog) return;

      // Clear placeholder if this is the first entry
      if (battleLog.innerHTML.includes('Battle actions and rolls will appear here')) {
        battleLog.innerHTML = '';
      }

      const timestamp = new Date().toLocaleTimeString();
      battleLog.innerHTML += `
        <div style="margin-bottom: 10px; padding: 8px; background: var(--surface-color); border-left: 3px solid var(--accent-color); border-radius: 4px;">
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">${timestamp}</div>
          <div style="color: var(--text-primary);">${message}</div>
        </div>
      `;
      battleLog.scrollTop = battleLog.scrollHeight;
    }

    function rollAttack() {
      // Legacy function - redirect to melee attack
      rollMeleeAttack();
    }

    function rollMeleeAttack() {
      const strMod = Math.floor((currentCharacter.stats.str - 10) / 2);
      const roll = Math.floor(Math.random() * 20) + 1;
      const total = roll + strMod;
      const breakdown = `1d20${strMod >= 0 ? '+' : ''}${strMod}`;

      showDiceRoll('Melee Attack', 'd20', roll, total, breakdown, roll === 20 ? 'success' : (roll === 1 ? 'fail' : null));
      addBattleLog(`‚öîÔ∏è ${currentCharacter.name} rolled Melee Attack: ${total} (${breakdown})`);

      // Roll damage if hit (not on nat 1)
      if (roll !== 1) {
        setTimeout(() => {
          const damageRoll = Math.floor(Math.random() * 8) + 1 + strMod;
          addBattleLog(`üí• Damage: ${damageRoll} (1d8${strMod >= 0 ? '+' : ''}${strMod})`);
        }, 500);
      }
    }

    function rollRangedAttack() {
      const dexMod = Math.floor((currentCharacter.stats.dex - 10) / 2);
      const roll = Math.floor(Math.random() * 20) + 1;
      const total = roll + dexMod;
      const breakdown = `1d20${dexMod >= 0 ? '+' : ''}${dexMod}`;

      showDiceRoll('Ranged Attack', 'd20', roll, total, breakdown, roll === 20 ? 'success' : (roll === 1 ? 'fail' : null));
      addBattleLog(`üèπ ${currentCharacter.name} rolled Ranged Attack: ${total} (${breakdown})`);

      // Roll damage if hit (not on nat 1)
      if (roll !== 1) {
        setTimeout(() => {
          const damageRoll = Math.floor(Math.random() * 8) + 1 + dexMod;
          addBattleLog(`üí• Damage: ${damageRoll} (1d8${dexMod >= 0 ? '+' : ''}${dexMod})`);
        }, 500);
      }
    }

    function rollDice(type, dice, modifier = 0) {
      const sides = parseInt(dice.substring(1));
      const roll = Math.floor(Math.random() * sides) + 1;
      const total = roll + modifier;
      const breakdown = modifier !== 0 ? `1${dice}${modifier >= 0 ? '+' : ''}${modifier}` : `1${dice}`;
      const isCritical = sides === 20 && (roll === 20 || roll === 1);

      showDiceRoll(type, dice, roll, total, breakdown, roll === 20 ? 'success' : (roll === 1 ? 'fail' : null));

      // Add to battle log
      if (currentChatMode === 'battle') {
        addBattleLog(`${currentCharacter.name} rolled ${type}: ${total} (${breakdown})`);
      }
    }

    function showDiceRoll(type, diceType, baseRoll, total, breakdown, critical) {
      const overlay = document.getElementById('diceOverlay');
      const result = document.getElementById('diceResult');
      const icon = document.getElementById('diceIcon');
      const typeEl = document.getElementById('diceType');
      const valueEl = document.getElementById('diceValue');
      const breakdownEl = document.getElementById('diceBreakdown');

      icon.textContent = 'üé≤';
      typeEl.textContent = type;
      valueEl.textContent = total;
      breakdownEl.textContent = breakdown;

      // Apply critical styling
      result.className = 'dice-result';
      if (critical === 'success') {
        result.classList.add('critical-success');
      } else if (critical === 'fail') {
        result.classList.add('critical-fail');
      }

      overlay.classList.add('show');

      setTimeout(() => {
        overlay.classList.remove('show');
      }, 2800);
    }

    function rollSkill(skillName, ability) {
      const skillKey = skillName.toLowerCase().replace(/\s+/g, '');
      const [, proficiency] = currentCharacter.skills[skillKey] || [ability, 0];

      const abilityMod = Math.floor((currentCharacter.stats[ability] - 10) / 2);
      const profBonus = 2 + Math.floor((currentCharacter.level - 1) / 4);
      const modifier = abilityMod + (proficiency * profBonus);

      const roll = Math.floor(Math.random() * 20) + 1;
      const total = roll + modifier;
      const breakdown = `1d20${modifier >= 0 ? '+' : ''}${modifier}`;

      // Get emoji from the clicked button if available
      const skillEmojiMap = {
        'Arcana': '‚ú®', 'History': 'üìú', 'Investigation': 'üîç', 'Nature': 'üåø', 'Religion': '‚õ™',
        'Animal Handling': 'üê∫', 'Insight': 'üí≠', 'Medicine': '‚öïÔ∏è', 'Perception': 'üëÅÔ∏è', 'Survival': 'üèïÔ∏è',
        'Deception': 'üé≠', 'Intimidation': 'üò†', 'Performance': 'üé™', 'Persuasion': 'ü§ù',
        'Acrobatics': 'ü§∏', 'Sleight of Hand': 'üëã', 'Stealth': 'ü•∑',
        'Athletics': 'üí™'
      };
      const displayEmoji = skillEmojiMap[skillName] || 'üé≤';

      showDiceRoll(skillName, 'd20', roll, total, breakdown, roll === 20 ? 'success' : (roll === 1 ? 'fail' : null));

      // Always add to battle log
      addBattleLog(`${displayEmoji} ${currentCharacter.name} rolled ${skillName}: ${total} (${breakdown})`);
    }

    function rollRandomDice() {
      const types = ['Attack Roll', 'Saving Throw', 'Ability Check', 'Damage Roll'];
      const type = types[Math.floor(Math.random() * types.length)];
      const modifier = Math.floor(Math.random() * 6);
      rollDice(type, 'd20', modifier);
    }

    function useAbility(abilityId) {
      const ability = currentCharacter.abilities.find(a => a.id === abilityId);
      if (!ability) return;

      // Add to battle log
      addBattleLog(`${currentCharacter.name} uses ${ability.icon} ${ability.name}!`);

      // Roll dice if ability has damage
      if (ability.damage) {
        setTimeout(() => {
          // Parse damage (e.g., "4d6", "2d8+4")
          const match = ability.damage.match(/(\d+)d(\d+)([+-]\d+)?/);
          if (match) {
            const count = parseInt(match[1]);
            const sides = parseInt(match[2]);
            const modifier = match[3] ? parseInt(match[3]) : 0;

            let total = modifier;
            for (let i = 0; i < count; i++) {
              total += Math.floor(Math.random() * sides) + 1;
            }

            const breakdown = `${count}d${sides}${modifier >= 0 && modifier !== 0 ? '+' : ''}${modifier !== 0 ? modifier : ''}`;
            showDiceRoll(ability.name, `d${sides}`, 0, total, breakdown, null);

            addBattleLog(`Damage: ${total} (${breakdown})`);
          }
        }, 500);
      }
    }

    function quickAction(action) {
      const messages = {
        dash: `${currentCharacter.name} dashes forward!`,
        dodge: `${currentCharacter.name} takes the Dodge action.`,
        help: `${currentCharacter.name} helps an ally!`
      };

      addBattleLog(messages[action] || 'Action performed!');
    }

    function castDefaultSpell() {
      // Find the default spell
      let defaultSpell = null;
      let spellLevel = null;

      if (currentCharacter.spells) {
        Object.keys(currentCharacter.spells).forEach(level => {
          currentCharacter.spells[level].forEach(spell => {
            if (spell.isDefault && spell.prepared) {
              defaultSpell = spell;
              spellLevel = level;
            }
          });
        });
      }

      if (!defaultSpell) {
        addBattleLog('‚ö†Ô∏è No default spell set! Go to the Abilities tab to set a default prepared spell.');
        return;
      }

      // Cast the spell
      const spellName = defaultSpell.name;
      const spellIcon = defaultSpell.icon || '‚ú®';

      addBattleLog(`${spellIcon} ${currentCharacter.name} casts ${spellName}!`);

      if (defaultSpell.damage) {
        // If spell has damage, roll it
        setTimeout(() => {
          const damageRoll = defaultSpell.damage.match(/(\d+)d(\d+)/);
          if (damageRoll) {
            const count = parseInt(damageRoll[1]);
            const sides = parseInt(damageRoll[2]);
            let total = 0;
            const rolls = [];

            for (let i = 0; i < count; i++) {
              const roll = Math.floor(Math.random() * sides) + 1;
              rolls.push(roll);
              total += roll;
            }

            addBattleLog(`üí• Spell Damage: ${total} (${rolls.join(' + ')})`);
          }
        }, 300);
      }
    }

    let selectedCantrip = null;

    function castCantrip() {
      if (!selectedCantrip) {
        addBattleLog('‚ö†Ô∏è No cantrip selected! Go to the Abilities tab and click on a cantrip to select it.');
        return;
      }

      const spellName = selectedCantrip.name;
      const spellIcon = selectedCantrip.icon || '‚ú®';
      const spellSaveDC = currentCharacter.computed?.spellSaveDC || (8 + 2 + Math.floor((currentCharacter.stats.wis - 10) / 2));

      addBattleLog(`${spellIcon} ${currentCharacter.name} casts ${spellName}!`);

      // Check if it's an attack spell or save spell
      if (selectedCantrip.attackRoll) {
        // Attack spell - roll to hit
        const intMod = Math.floor((currentCharacter.stats.int - 10) / 2);
        const profBonus = 2 + Math.floor((currentCharacter.level - 1) / 4);
        const spellAttack = intMod + profBonus;
        const roll = Math.floor(Math.random() * 20) + 1;
        const total = roll + spellAttack;

        addBattleLog(`üéØ Spell Attack: ${total} (1d20+${spellAttack})`);

        if (roll !== 1) {
          setTimeout(() => {
            if (selectedCantrip.damage) {
              const damageRoll = selectedCantrip.damage.match(/(\d+)d(\d+)/);
              if (damageRoll) {
                const count = parseInt(damageRoll[1]);
                const sides = parseInt(damageRoll[2]);
                let total = 0;
                const rolls = [];

                for (let i = 0; i < count; i++) {
                  const r = Math.floor(Math.random() * sides) + 1;
                  rolls.push(r);
                  total += r;
                }

                addBattleLog(`üí• Spell Damage: ${total} (${rolls.join(' + ')})`);
              }
            }
          }, 300);
        }
      } else {
        // Save spell - show DC
        addBattleLog(`üõ°Ô∏è Target must make a saving throw (DC ${spellSaveDC})`);

        if (selectedCantrip.damage) {
          setTimeout(() => {
            const damageRoll = selectedCantrip.damage.match(/(\d+)d(\d+)/);
            if (damageRoll) {
              const count = parseInt(damageRoll[1]);
              const sides = parseInt(damageRoll[2]);
              let total = 0;
              const rolls = [];

              for (let i = 0; i < count; i++) {
                const r = Math.floor(Math.random() * sides) + 1;
                rolls.push(r);
                total += r;
              }

              addBattleLog(`üí• Spell Damage on failed save: ${total} (${rolls.join(' + ')})`);
            }
          }, 300);
        }
      }
    }

    function selectCantrip(spellId, level) {
      // Find and set the selected cantrip
      if (currentCharacter.spells && currentCharacter.spells[level]) {
        const cantrip = currentCharacter.spells[level].find(s => s.id === spellId);
        if (cantrip) {
          selectedCantrip = cantrip;
          addBattleLog(`‚ú® Selected cantrip: ${cantrip.name}`);
          updateAbilitiesTab(); // Refresh the abilities tab to show selection
        }
      }
    }

    function updatePortraitExpression() {
      const expression = document.getElementById('portraitExpression').value;
      console.log('Portrait expression changed to:', expression);
      // This would trigger an API call to generate new portrait with the expression
      // For now, just log it
    }

    function nextTurn() {
      turnNumber++;
      document.getElementById('turnNumber').textContent = turnNumber;
      addBattleLog(`--- Turn ${turnNumber} ---`);
    }

    function takeDamage() {
      const damageInput = document.getElementById('damageAmount');
      const damage = parseInt(damageInput.value) || 10;
      currentCharacter.hp.current = Math.max(0, currentCharacter.hp.current - damage);
      updateCharacterDisplay();
      showDiceRoll('Damage Taken', 'd20', 0, damage, `${damage} damage`, null);
      addBattleLog(`${currentCharacter.name} takes ${damage} damage!`);
    }

    function heal() {
      const healing = Math.floor(Math.random() * 20) + 10;
      currentCharacter.hp.current = Math.min(currentCharacter.hp.max, currentCharacter.hp.current + healing);
      updateCharacterDisplay();
      showDiceRoll('Healing', 'd20', 0, healing, `${healing} HP`, null);
      addBattleLog(`${currentCharacter.name} heals ${healing} HP!`);
    }

    function rollCustomDice() {
      const numDice = parseInt(document.getElementById('numDice').value) || 1;
      const diceType = parseInt(document.getElementById('diceType').value) || 20;
      const modifier = parseInt(document.getElementById('diceModifier').value) || 0;

      let total = 0;
      let rolls = [];
      for (let i = 0; i < numDice; i++) {
        const roll = Math.floor(Math.random() * diceType) + 1;
        rolls.push(roll);
        total += roll;
      }

      const finalTotal = total + modifier;
      const breakdown = `${numDice}d${diceType}${modifier !== 0 ? (modifier >= 0 ? '+' : '') + modifier : ''}`;
      const isCritical = diceType === 20 && numDice === 1 && (rolls[0] === 20 || rolls[0] === 1);

      showDiceRoll('Custom Roll', `d${diceType}`, rolls[0] || total, finalTotal, breakdown,
        isCritical ? (rolls[0] === 20 ? 'success' : 'fail') : null);

      if (currentChatMode === 'battle') {
        addBattleLog(`${currentCharacter.name} rolled ${breakdown}: ${finalTotal}`);
      }
    }

    function changeLocation() {
      const newLocation = document.getElementById('locationSelect').value;
      currentCharacter.location = newLocation;

      const locationName = locations.find(l => l.id === newLocation)?.name || newLocation;

      // Update canvas display in footer
      const canvasDisplay = document.getElementById('canvasDisplay');
      if (canvasDisplay) {
        canvasDisplay.textContent = `Canvas preview: ${locationName}`;
      }

      addBattleLog(`${currentCharacter.name} moved to ${locationName}`);
    }

    let statsLocked = true;
    let tempModifiers = [];

    function addTempModifier() {
      const nameInput = document.getElementById('tempModName');
      const valueInput = document.getElementById('tempModValue');
      const name = nameInput.value.trim();
      const value = parseInt(valueInput.value);

      if (!name || isNaN(value)) {
        return;
      }

      tempModifiers.push({ name, value });
      updateTempModifiersList();

      // Clear inputs
      nameInput.value = '';
      valueInput.value = '';
    }

    function removeTempModifier(index) {
      tempModifiers.splice(index, 1);
      updateTempModifiersList();
    }

    function updateTempModifiersList() {
      const list = document.getElementById('tempModifiersList');
      if (tempModifiers.length === 0) {
        list.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.85rem; padding: 10px; text-align: center;">No temporary modifiers</div>';
        return;
      }

      let html = '';
      tempModifiers.forEach((mod, index) => {
        const sign = mod.value >= 0 ? '+' : '';
        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--surface-color); border-radius: 6px; margin-bottom: 6px;">
            <span style="color: var(--text-primary);">${mod.name}</span>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: ${mod.value >= 0 ? '#4caf50' : '#f44336'}; font-weight: 600;">${sign}${mod.value}</span>
              <button onclick="removeTempModifier(${index})" style="padding: 4px 8px; background: var(--battle-color); border: none; border-radius: 4px; color: white; font-size: 0.8rem; cursor: pointer;">Remove</button>
            </div>
          </div>
        `;
      });
      list.innerHTML = html;
    }

    function toggleStatsLock() {
      statsLocked = !statsLocked;
      const lockText = document.getElementById('lockText');
      const allStats = document.querySelectorAll('.stat-readonly');

      if (statsLocked) {
        lockText.textContent = 'Edit';

        // Remove onclick handlers and titles
        allStats.forEach(el => {
          el.onclick = null;
          el.title = '';
          el.style.cursor = 'default';
        });
      } else {
        lockText.textContent = 'Lock';

        // Add onclick handlers and titles
        allStats.forEach(el => {
          if (el.classList.contains('stat-value') || el.id.includes('Value') || el.id === 'acValue' || el.id.includes('hpCurrentEdit') || el.id.includes('hpMaxEdit')) {
            const statName = el.dataset.stat || (el.id.includes('hpCurrent') ? 'hpCurrent' : el.id.includes('hpMax') ? 'hpMax' : 'unknown');
            if (statName !== 'unknown') {
              el.onclick = function() { editStat(statName, this); };
              el.title = 'Click to edit';
              el.style.cursor = 'pointer';
            }
          }
        });
      }
    }

    function editStat(statName, element) {
      const currentValue = element.textContent;
      const input = document.createElement('input');
      input.type = 'number';
      input.value = parseInt(currentValue);
      input.style.width = '60px';
      input.style.padding = '4px';
      input.style.background = 'var(--background-color)';
      input.style.color = 'var(--text-primary)';
      input.style.border = '2px solid var(--accent-color)';
      input.style.borderRadius = '4px';
      input.style.textAlign = 'center';
      input.style.fontSize = element.style.fontSize || '1rem';

      input.onblur = function() {
        const newValue = parseInt(input.value);
        if (!isNaN(newValue) && newValue >= 0) {
          // Update character data
          if (statName === 'hpCurrent') {
            currentCharacter.hp.current = Math.min(newValue, currentCharacter.hp.max);
          } else if (statName === 'hpMax') {
            currentCharacter.hp.max = newValue;
            currentCharacter.hp.current = Math.min(currentCharacter.hp.current, newValue);
          } else if (statName === 'ac') {
            currentCharacter.ac = newValue;
          } else if (['str', 'dex', 'con', 'int', 'wis', 'cha'].includes(statName)) {
            currentCharacter.stats[statName] = newValue;
          }
          // Remove input first before updating display
          if (input.parentNode === element) {
            input.remove();
          }
          updateCharacterDisplay();
        } else {
          element.textContent = currentValue;
          if (input.parentNode === element) {
            input.remove();
          }
        }
      };

      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          input.blur();
        } else if (e.key === 'Escape') {
          element.textContent = currentValue;
          element.style.display = '';
          input.remove();
        }
      };

      element.textContent = '';
      element.appendChild(input);
      input.focus();
      input.select();
    }

    function editHeaderHP() {
      if (statsLocked) return;

      const element = document.getElementById('headerHpText');
      const currentText = element.textContent; // e.g., "85/85"
      const [currentHP, maxHP] = currentText.split('/').map(v => parseInt(v.trim()));

      // Create input for current HP
      const input = document.createElement('input');
      input.type = 'number';
      input.value = currentHP;
      input.style.width = '50px';
      input.style.padding = '2px';
      input.style.background = 'var(--background-color)';
      input.style.color = 'var(--text-primary)';
      input.style.border = '2px solid var(--accent-color)';
      input.style.borderRadius = '4px';
      input.style.textAlign = 'center';
      input.style.fontSize = '0.75rem';
      input.style.fontWeight = '700';

      input.onblur = function() {
        const newValue = parseInt(input.value);
        if (!isNaN(newValue) && newValue >= 0) {
          currentCharacter.hp.current = Math.min(newValue, currentCharacter.hp.max);
          updateCharacterDisplay();
        } else {
          element.textContent = currentText;
        }
      };

      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          input.blur();
        } else if (e.key === 'Escape') {
          element.textContent = currentText;
          updateCharacterDisplay();
        }
      };

      element.textContent = '';
      element.appendChild(input);
      input.focus();
      input.select();
    }

    function editModifier(statName, element) {
      const currentValue = element.textContent.replace(/[+\-]/g, '');
      const input = document.createElement('input');
      input.type = 'number';
      input.value = parseInt(currentValue);
      input.style.width = '50px';
      input.style.padding = '4px';
      input.style.background = 'var(--background-color)';
      input.style.color = 'var(--text-primary)';
      input.style.border = '2px solid var(--accent-color)';
      input.style.borderRadius = '4px';
      input.style.textAlign = 'center';
      input.style.fontSize = '0.9rem';

      input.onblur = function() {
        const newModifier = parseInt(input.value);
        if (!isNaN(newModifier) && newModifier >= -5 && newModifier <= 10) {
          // Back-calculate ability score from modifier
          // modifier = floor((score - 10) / 2)
          // score = (modifier * 2) + 10
          const newScore = (newModifier * 2) + 10;
          currentCharacter.stats[statName] = newScore;
          // Remove input first before updating display
          if (input.parentNode === element) {
            input.remove();
          }
          updateCharacterDisplay();
        } else {
          element.textContent = currentValue;
          if (input.parentNode === element) {
            input.remove();
          }
        }
      };

      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          input.blur();
        } else if (e.key === 'Escape') {
          element.textContent = (parseInt(currentValue) >= 0 ? '+' : '') + currentValue;
          element.style.display = '';
          input.remove();
        }
      };

      element.textContent = '';
      element.appendChild(input);
      input.focus();
      input.select();
    }

    function toggleSpellPrepared(spellId, level) {
      const spell = currentCharacter.spells[level].find(s => s.id === spellId);
      if (spell) {
        spell.prepared = !spell.prepared;
        updateAbilities();
        updateAbilitiesTab();
      }
    }

    function setDefaultAbility(abilityId) {
      // Clear any existing defaults
      currentCharacter.abilities.forEach(a => a.isDefault = false);

      // Set the new default
      const ability = currentCharacter.abilities.find(a => a.id === abilityId);
      if (ability) {
        ability.isDefault = true;
        updateAbilitiesTab();
      }
    }

    function setDefaultSpell(spellId, level) {
      // Clear any existing defaults across all spell levels
      Object.keys(currentCharacter.spells).forEach(lvl => {
        currentCharacter.spells[lvl].forEach(s => s.isDefault = false);
      });

      // Set the new default
      const spell = currentCharacter.spells[level].find(s => s.id === spellId);
      if (spell && spell.prepared) {
        spell.isDefault = true;
        updateAbilitiesTab();
      }
    }

    function updateInventory() {
      const inventoryGrid = document.getElementById('inventoryGrid');
      if (!currentCharacter.inventory) {
        inventoryGrid.innerHTML = '<p style="color: var(--text-secondary); padding: 20px;">No items in inventory.</p>';
        return;
      }

      let html = '';

      // Group inventory by type with custom order
      const grouped = {};
      currentCharacter.inventory.forEach(item => {
        if (!grouped[item.type]) grouped[item.type] = [];
        grouped[item.type].push(item);
      });

      // Custom sort order: weapons, armor, consumables, ammunition, gear (magic items)
      const typeOrder = ['weapon', 'armor', 'consumable', 'ammunition', 'gear'];
      const sortedTypes = typeOrder.filter(type => grouped[type]);

      sortedTypes.forEach(type => {
        const typeName = type.charAt(0).toUpperCase() + type.slice(1) + (type !== 'gear' ? 's' : '');
        html += `<div class="inventory-category">
          <div class="inventory-category-title">${typeName}</div>`;

        grouped[type].forEach(item => {
          const equippedIcon = item.equipped ? '‚ö° ' : '';
          const attunedIcon = item.attuned ? '‚ú® ' : '';
          const isConsumable = item.type === 'consumable' && item.quantity > 0;
          const clickHandler = isConsumable ? `onclick="consumeItem('${item.id}')" style="cursor: pointer;"` : '';

          html += `
            <div class="inventory-item ${item.equipped ? 'equipped' : ''} ${isConsumable ? 'consumable-item' : ''}" ${clickHandler}>
              <div class="inventory-item-info">
                <div class="inventory-item-name">${attunedIcon}${equippedIcon}${item.name}</div>
                <div class="inventory-item-type">${item.type}${isConsumable ? ' (click to use)' : ''}</div>
              </div>
              ${item.quantity ? `<div class="inventory-item-quantity">√ó${item.quantity}</div>` : ''}
              ${item.equipped ? '<div class="equipped-badge">Equipped</div>' : ''}
            </div>
          `;
        });

        html += '</div>';
      });

      // Attuned Magical Items Section (max 3 slots) - at bottom
      const attunedItems = currentCharacter.inventory.filter(item => item.attuned);
      html += `<div style="margin-top: 25px; padding: 15px; background: rgba(74, 144, 226, 0.1); border: 2px solid var(--accent-color); border-radius: 8px;">
        <div style="font-size: 0.9rem; color: var(--accent-color); text-transform: uppercase; margin-bottom: 12px; font-weight: 600; letter-spacing: 1px;">Attuned Magical Items (${attunedItems.length}/3)</div>
        <div style="display: grid; gap: 8px;">`;

      for (let i = 0; i < 3; i++) {
        const item = attunedItems[i];
        if (item) {
          html += `
            <div class="inventory-item equipped">
              <div class="inventory-item-info">
                <div class="inventory-item-name">‚ú® ${item.name}</div>
                <div class="inventory-item-type">${item.type}</div>
              </div>
              <div class="equipped-badge">Attuned</div>
            </div>
          `;
        } else {
          html += `
            <div style="padding: 15px; background: rgba(255,255,255,0.05); border: 2px dashed var(--border-color); border-radius: 8px; text-align: center; color: var(--text-secondary); font-size: 0.85rem;">
              Empty Attunement Slot
            </div>
          `;
        }
      }

      html += '</div></div>';

      inventoryGrid.innerHTML = html;
    }

    // Auto-update canvas based on HP percentage
    function getCharacterState() {
      const hpPercent = (currentCharacter.hp.current / currentCharacter.hp.max) * 100;

      if (hpPercent <= 0) return 'dead';
      if (hpPercent <= 25) return 'critical'; // Severely injured
      if (hpPercent <= 50) return 'injured';  // Moderately injured
      if (hpPercent <= 75) return 'wounded';  // Lightly injured
      return 'default';
    }

    function consumeItem(itemId) {
      const item = currentCharacter.inventory?.find(i => i.id === itemId);
      if (!item || item.type !== 'consumable' || !item.quantity || item.quantity <= 0) {
        return;
      }

      // Consume 1 of the item
      item.quantity--;

      // Apply effects based on item type
      let effect = '';
      if (item.name.toLowerCase().includes('healing')) {
        // Healing potion
        let healing = 7; // 2d4+2 average for regular potion
        if (item.name.toLowerCase().includes('greater')) {
          healing = 20; // 4d4+4 average for greater
        } else if (item.name.toLowerCase().includes('superior')) {
          healing = 28; // 8d4+8 average for superior
        }

        currentCharacter.hp.current = Math.min(currentCharacter.hp.max, currentCharacter.hp.current + healing);
        effect = `restored ${healing} HP`;
      } else if (item.name.toLowerCase().includes('ration')) {
        // Food ration
        const foodRestored = 30;
        if (currentCharacter.food) {
          currentCharacter.food.current = Math.min(currentCharacter.food.max, currentCharacter.food.current + foodRestored);
          effect = `restored ${foodRestored} satiety`;
        }
      } else {
        // Generic consumable
        effect = `used ${item.name}`;
      }

      updateCharacterDisplay();
      addBattleLog(`${currentCharacter.name} consumed ${item.name} and ${effect}!`);

      // Remove item if quantity reaches 0
      if (item.quantity === 0) {
        const index = currentCharacter.inventory.indexOf(item);
        if (index > -1) currentCharacter.inventory.splice(index, 1);
        addBattleLog(`‚ö†Ô∏è Out of ${item.name}!`);
      }
    }

    function toggleDicePopup() {
      const popup = document.getElementById('dicePopup');
      popup.classList.toggle('show');

      // Update combat buttons when popup is opened
      if (popup.classList.contains('show')) {
        updateDicePopupButtons();
      }
    }

    function updateDicePopupButtons() {
      const attackButtonsDiv = document.getElementById('attackButtons');
      const spellButtonsDiv = document.getElementById('spellButtons');

      if (!attackButtonsDiv || !spellButtonsDiv) return;

      let attackHtml = '';
      let spellHtml = '';

      // Add attack buttons (melee/ranged)
      if (currentCharacter.attacks) {
        if (currentCharacter.attacks.melee) {
          attackHtml += `<button class="test-btn" onclick="rollWeaponAttack('melee'); toggleDicePopup();" style="margin: 0; flex: 1; min-width: 120px;">‚öîÔ∏è ${currentCharacter.attacks.melee.name}</button>`;
        }
        if (currentCharacter.attacks.ranged) {
          attackHtml += `<button class="test-btn" onclick="rollWeaponAttack('ranged'); toggleDicePopup();" style="margin: 0; flex: 1; min-width: 120px;">üèπ ${currentCharacter.attacks.ranged.name}</button>`;
        }
      }

      // Add spell buttons (from prepared spells)
      if (currentCharacter.spells) {
        const preparedSpells = [];
        Object.keys(currentCharacter.spells).forEach(level => {
          if (Array.isArray(currentCharacter.spells[level])) {
            currentCharacter.spells[level].forEach(spell => {
              if (spell.prepared) {
                preparedSpells.push({ ...spell, level: parseInt(level) });
              }
            });
          }
        });

        // Show up to 4 prepared spells
        preparedSpells.slice(0, 4).forEach(spell => {
          spellHtml += `<button class="test-btn" onclick="rollSpellAttack('${spell.id}', ${spell.level}); toggleDicePopup();" style="margin: 0; flex: 1; min-width: 120px;">${spell.icon} ${spell.name}</button>`;
        });
      }

      attackButtonsDiv.innerHTML = attackHtml;
      spellButtonsDiv.innerHTML = spellHtml;

      // Hide combat rolls section if no attacks or spells
      const combatSection = document.getElementById('combatRollsSection');
      if (combatSection) {
        combatSection.style.display = (attackHtml || spellHtml) ? 'block' : 'none';
      }
    }

    function rollWeaponAttack(type) {
      const attack = type === 'melee' ? currentCharacter.attacks.melee : currentCharacter.attacks.ranged;
      if (!attack) return;

      // Roll attack (d20 + toHit)
      const attackRoll = Math.floor(Math.random() * 20) + 1;
      const attackTotal = attackRoll + attack.toHit;
      const attackBreakdown = `1d20+${attack.toHit}`;

      showDiceRoll(`${attack.name} Attack`, 'd20', attackRoll, attackTotal, attackBreakdown,
        attackRoll === 20 ? 'success' : (attackRoll === 1 ? 'fail' : null));

      addBattleLog(`${currentCharacter.name} attacks with ${attack.name}: ${attackTotal} to hit`);

      // If hit, prompt for damage roll or auto-roll
      if (attackRoll >= 10) { // Simplified - assume hits on 10+
        setTimeout(() => {
          // Parse damage (e.g., "1d8+4")
          const match = attack.damage.match(/(\d+)d(\d+)([\+\-]\d+)?/);
          if (match) {
            const numDice = parseInt(match[1]);
            const diceSize = parseInt(match[2]);
            const modifier = match[3] ? parseInt(match[3]) : 0;

            let damageTotal = 0;
            for (let i = 0; i < numDice; i++) {
              damageTotal += Math.floor(Math.random() * diceSize) + 1;
            }
            damageTotal += modifier;

            showDiceRoll(`${attack.name} Damage`, `d${diceSize}`, damageTotal - modifier, damageTotal, attack.damage, null);
            addBattleLog(`${attack.name} deals ${damageTotal} damage!`);
          }
        }, 1000);
      }
    }

    function rollSpellAttack(spellId, level) {
      // Find the spell
      let spell = null;
      if (currentCharacter.spells && currentCharacter.spells[level]) {
        spell = currentCharacter.spells[level].find(s => s.id === spellId);
      }

      if (!spell) return;

      // Calculate spell attack modifier (using primary stat)
      const statMod = currentCharacter.classType === 'caster'
        ? Math.floor((currentCharacter.stats.int - 10) / 2)
        : Math.floor((currentCharacter.stats.wis - 10) / 2);
      const profBonus = Math.ceil(currentCharacter.level / 4) + 1; // Proficiency bonus
      const spellAttackMod = statMod + profBonus;

      // Roll spell attack if it has damage
      if (spell.damage) {
        const attackRoll = Math.floor(Math.random() * 20) + 1;
        const attackTotal = attackRoll + spellAttackMod;
        const attackBreakdown = `1d20+${spellAttackMod}`;

        showDiceRoll(`${spell.name} Attack`, 'd20', attackRoll, attackTotal, attackBreakdown,
          attackRoll === 20 ? 'success' : (attackRoll === 1 ? 'fail' : null));

        addBattleLog(`${currentCharacter.name} casts ${spell.name}: ${attackTotal} to hit`);

        // Roll damage on hit
        if (attackRoll >= 10) {
          setTimeout(() => {
            const match = spell.damage.match(/(\d+)d(\d+)/);
            if (match) {
              const numDice = parseInt(match[1]);
              const diceSize = parseInt(match[2]);

              let damageTotal = 0;
              for (let i = 0; i < numDice; i++) {
                damageTotal += Math.floor(Math.random() * diceSize) + 1;
              }

              showDiceRoll(`${spell.name} Damage`, `d${diceSize}`, damageTotal, damageTotal, spell.damage, null);
              addBattleLog(`${spell.name} deals ${damageTotal} damage!`);
            }
          }, 1000);
        }
      } else {
        // Non-damage spell (utility/buff)
        addBattleLog(`${currentCharacter.name} casts ${spell.name}!`);
        showDiceRoll(spell.name, spell.icon, '‚ú®', '‚ú®', 'Cast successfully', 'success');
      }
    }
  </script>
</body>
</html>
